<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Usu√°rios de Exemplo - SIGEB</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: white;
      padding: 20px;
      text-align: center;
    }
    button {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background: rgba(40, 167, 69, 0.2); }
    .error { background: rgba(220, 53, 69, 0.2); }
  </style>
</head>
<body>
  <h1>Criar Usu√°rios de Exemplo</h1>
  <p>Este script criar√° usu√°rios de exemplo para testar o sistema de login</p>
  
  <div style="background: rgba(255,193,7,0.2); padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffc107;">
    <h3>‚ö†Ô∏è Configura√ß√£o Necess√°ria</h3>
    <p>Se voc√™ receber erro de permiss√£o, configure as regras do Firebase Database:</p>
    <ol style="text-align: left; max-width: 600px; margin: 0 auto;">
      <li>Acesse o <a href="https://console.firebase.google.com" target="_blank" style="color: #4facfe;">Firebase Console</a></li>
      <li>Selecione seu projeto SIGEB</li>
      <li>V√° em "Realtime Database" ‚Üí "Regras"</li>
      <li>Substitua as regras por:</li>
    </ol>
    <div style="background: #333; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; text-align: left;">
{<br>
&nbsp;&nbsp;"rules": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;".read": "auth != null",<br>
&nbsp;&nbsp;&nbsp;&nbsp;".write": "auth != null"<br>
&nbsp;&nbsp;}<br>
}
    </div>
    <p><strong>Clique em "Publicar" para salvar as regras</strong></p>
  </div>
  
  <button onclick="criarUsuarios()">Criar Usu√°rios de Exemplo</button>
  <button onclick="abrirFirebaseConsole()" style="background: #ff6b35;">Abrir Firebase Console</button>
  <button onclick="testarPermissoes()" style="background: #28a745;">Testar Permiss√µes</button>
  <a href="criar-usuarios-basicos.html" style="display: inline-block; background: #6c757d; color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; margin: 10px;">Vers√£o B√°sica (Sem DB)</a>
  <div id="status"></div>

  <!-- Scripts Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCkttFoV_FoPn91ClE7xFiknFvs9pXaCoQ",
      authDomain: "sigeb-ccd3f.firebaseapp.com",
      databaseURL: "https://sigeb-ccd3f-default-rtdb.firebaseio.com",
      projectId: "sigeb-ccd3f",
      storageBucket: "sigeb-ccd3f.firebasestorage.app",
      messagingSenderId: "209689711066",
      appId: "1:209689711066:web:5a99505e60bd34f29b70e3",
      measurementId: "G-VJBDW2B7HZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const usuariosExemplo = [
      {
        email: 'admin@sigeb.com',
        usuario: 'admin',
        senha: '123456',
        nome: 'Administrador do Sistema',
        tipo: 'administrador'
      },
      {
        email: 'bibliotecaria@sigeb.com',
        usuario: 'maria',
        senha: '123456',
        nome: 'Maria Silva Santos',
        tipo: 'bibliotecario'
      },
      {
        email: 'diretor@sigeb.com',
        usuario: 'joao',
        senha: '123456',
        nome: 'Jo√£o Carlos Oliveira',
        tipo: 'diretor'
      }
    ];

    function addStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      statusDiv.appendChild(div);
    }

    async function criarUsuarios() {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '';
      
      addStatus('Iniciando cria√ß√£o de usu√°rios...', 'success');
      addStatus('‚ö†Ô∏è IMPORTANTE: Este processo requer que voc√™ esteja logado como administrador', 'error');

      // Primeiro, fazer login como admin se n√£o estiver logado
      let currentUser = auth.currentUser;
      if (!currentUser) {
        addStatus('Tentando fazer login autom√°tico...', 'success');
        try {
          // Tentar login com credenciais padr√£o
          await auth.signInWithEmailAndPassword('admin@sigeb.com', '123456');
          currentUser = auth.currentUser;
          addStatus('‚úì Login realizado com sucesso', 'success');
        } catch (loginError) {
          addStatus('‚ùå Erro no login autom√°tico. Fa√ßa login manualmente primeiro.', 'error');
          addStatus('Redirecionando para p√°gina de login...', 'error');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 3000);
          return;
        }
      }

      for (const usuario of usuariosExemplo) {
        try {
          // Verificar se j√° existe (m√©todo alternativo)
          let usuarioExiste = false;
          try {
            const snapshot = await db.ref('usuarios').orderByChild('email').equalTo(usuario.email).once('value');
            usuarioExiste = snapshot.exists();
          } catch (checkError) {
            addStatus(`Verificando usu√°rio ${usuario.usuario} atrav√©s de m√©todo alternativo...`, 'success');
            // Se n√£o conseguir verificar, assume que n√£o existe e tenta criar
          }
          
          if (usuarioExiste) {
            addStatus(`Usu√°rio ${usuario.usuario} j√° existe`, 'error');
            continue;
          }

          // Criar no Firebase Auth
          let userCredential;
          try {
            userCredential = await auth.createUserWithEmailAndPassword(usuario.email, usuario.senha);
          } catch (authError) {
            if (authError.code === 'auth/email-already-in-use') {
              addStatus(`E-mail ${usuario.email} j√° est√° em uso`, 'error');
              continue;
            }
            throw authError;
          }
          
          const user = userCredential.user;

          // Salvar no banco com m√©todo seguro
          const dadosUsuario = {
            email: usuario.email,
            usuario: usuario.usuario,
            nome: usuario.nome,
            tipo: usuario.tipo,
            funcao: usuario.tipo,
            cadastroCompleto: true,
            ativo: true,
            dataCadastro: new Date().toISOString(),
            criadoPor: 'script-automatico'
          };

          try {
            await db.ref('usuarios/' + user.uid).set(dadosUsuario);
            addStatus(`‚úì Usu√°rio ${usuario.usuario} criado com sucesso!`, 'success');
          } catch (dbError) {
            addStatus(`‚úì Usu√°rio ${usuario.usuario} criado no Auth, mas erro ao salvar dados extras: ${dbError.message}`, 'error');
            addStatus(`O usu√°rio pode fazer login, mas precisar√° completar o cadastro`, 'error');
          }
          
        } catch (error) {
          addStatus(`‚úó Erro ao criar ${usuario.usuario}: ${error.message}`, 'error');
          
          // Sugest√µes espec√≠ficas baseadas no erro
          if (error.message.includes('permission')) {
            addStatus(`üí° Solu√ß√£o: Configure as regras do Firebase Database`, 'error');
          } else if (error.message.includes('network')) {
            addStatus(`üí° Solu√ß√£o: Verifique sua conex√£o com a internet`, 'error');
          }
        }
        
        // Pausa pequena entre cria√ß√µes para evitar rate limiting
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      addStatus('Processo finalizado!', 'success');
      addStatus('Se houver erros de permiss√£o, configure as regras do Firebase Database', 'error');
    }

    function abrirFirebaseConsole() {
      window.open('https://console.firebase.google.com/project/sigeb-ccd3f/database/sigeb-ccd3f-default-rtdb/rules', '_blank');
    }

    async function testarPermissoes() {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '';
      
      addStatus('Testando permiss√µes do Firebase...', 'success');
      
      try {
        // Verificar se est√° logado
        const user = auth.currentUser;
        if (!user) {
          addStatus('‚ùå Usu√°rio n√£o est√° logado', 'error');
          addStatus('Tentando login autom√°tico...', 'success');
          try {
            await auth.signInWithEmailAndPassword('admin@sigeb.com', '123456');
            addStatus('‚úì Login realizado com sucesso', 'success');
          } catch (loginError) {
            addStatus('‚ùå Falha no login autom√°tico. Fa√ßa login manualmente.', 'error');
            return;
          }
        } else {
          addStatus(`‚úì Logado como: ${user.email}`, 'success');
        }
        
        // Testar leitura
        try {
          const snapshot = await db.ref('usuarios').limitToFirst(1).once('value');
          addStatus('‚úì Permiss√£o de LEITURA: OK', 'success');
        } catch (readError) {
          addStatus('‚ùå Permiss√£o de LEITURA: NEGADA', 'error');
          addStatus(`Erro: ${readError.message}`, 'error');
        }
        
        // Testar escrita
        try {
          const testRef = db.ref('teste_permissao');
          await testRef.set({
            teste: true,
            timestamp: new Date().toISOString()
          });
          addStatus('‚úì Permiss√£o de ESCRITA: OK', 'success');
          
          // Limpar teste
          await testRef.remove();
          addStatus('‚úì Teste limpo com sucesso', 'success');
        } catch (writeError) {
          addStatus('‚ùå Permiss√£o de ESCRITA: NEGADA', 'error');
          addStatus(`Erro: ${writeError.message}`, 'error');
          addStatus('‚ö†Ô∏è Configure as regras do Firebase Database', 'error');
        }
        
      } catch (error) {
        addStatus(`‚ùå Erro no teste: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>

