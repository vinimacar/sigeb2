<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SIGEB - Empr√©stimos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
  (function(){
    emailjs.init("z2336X6tKP2xg_f9D"); // Chave p√∫blica do EmailJS configurada
    
    /* 
    CONFIGURA√á√ÉO DO TEMPLATE EMAIL:
    
    Template ID atual: "template_6f2r7op"
    Service ID: "service_70cadf4"
    
    Vari√°veis dispon√≠veis no template:
       - {{to_name}} - Nome do usu√°rio
       - {{to_email}} - Email do usu√°rio
       - {{user_name}} - Nome do usu√°rio
       - {{user_matricula}} - Matr√≠cula do usu√°rio
       - {{registro_numero}} - N√∫mero do registro
       - {{loan_date}} - Data do empr√©stimo
       - {{return_date}} - Data de devolu√ß√£o
       - {{books_list}} - Lista de livros (texto simples)
       - {{books_list_html}} - Lista de livros (HTML formatado)
       - {{school_name}} - Nome da escola
    
    Exemplo de template:
    ---
    Ol√° {{to_name}},
    
    Seu empr√©stimo foi registrado com sucesso!
    
    üìö Detalhes do Empr√©stimo:
    ‚Ä¢ Registro: {{registro_numero}}
    ‚Ä¢ Matr√≠cula: {{user_matricula}}
    ‚Ä¢ Livros: {{books_list}}
    ‚Ä¢ Data do Empr√©stimo: {{loan_date}}
    ‚Ä¢ Data de Devolu√ß√£o: {{return_date}}
    
    ‚ö†Ô∏è Importante: Devolva os livros at√© a data prevista.
    
    Atenciosamente,
    {{school_name}}
    Sistema SIGEB
    ---
    */
  })();
</script>
<style>
body {
font-family: 'Poppins', sans-serif;
background: #f0f2f5;
margin: 0;
padding: 0;
}
.sidebar {
position: fixed;
top: 0;
left: 0;
height: 100%;
width: 250px;
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
color: white;
padding: 20px;
transition: all 0.3s ease;
z-index: 1000;
}
.sidebar-header {
padding: 20px 0;
text-align: center;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.sidebar-header h3 {
background: linear-gradient(90deg, #00f2fe, #4facfe);
-webkit-background-clip: text;
background-clip: text;
-webkit-text-fill-color: transparent;
margin: 0;
font-weight: 600;
}
.menu-items {
padding: 20px 0;
}
.menu-item {
padding: 12px 20px;
color: white;
text-decoration: none;
display: flex;
align-items: center;
transition: all 0.3s ease;
border-radius: 8px;
margin-bottom: 5px;
}
.menu-item:hover, .menu-item.active {
background: rgba(255, 255, 255, 0.1);
color: #4facfe;
}
.menu-item i {
margin-right: 10px;
font-size: 1.2rem;
}
.main-content {
margin-left: 250px;
padding: 20px;
transition: all 0.3s ease;
}
.page-header {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}
.loans-table {
background: white;
border-radius: 15px;
padding: 20px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.table {
margin-bottom: 0;
}
.table th {
border-top: none;
font-weight: 600;
color: #1a1a2e;
}
.loan-status {
display: inline-block;
padding: 5px 10px;
border-radius: 20px;
font-size: 0.8rem;
}
.status-emprestado {
background: #e8f5e9;
color: #2e7d32;
}
.status-atrasado {
background: #ffebee;
color: #c62828;
}
.status-devolvido {
background: #e3f2fd;
color: #1565c0;
}
.add-button {
background: linear-gradient(90deg, #00f2fe, #4facfe);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.add-button:hover {
transform: translateY(-2px);
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.search-box {
display: flex;
gap: 10px;
margin-bottom: 20px;
}
.search-box input {
flex: 1;
padding: 10px 15px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 0.9rem;
}
.action-buttons {
display: flex;
gap: 10px;
}
.action-button {
background: none;
border: none;
padding: 5px;
cursor: pointer;
transition: all 0.3s ease;
}
.action-button:hover {
transform: translateY(-2px);
}
.return-button {
color: #4facfe;
}
.renew-button {
color: #2e7d32;
}
@media (max-width: 768px) {
.sidebar {
transform: translateX(-100%);
}
.main-content {
margin-left: 0;
}
.sidebar.active {
transform: translateX(0);
}
.table-responsive {
margin-bottom: 0;
}
}
#notReturnedBar {
position: relative;
overflow: hidden;
height: 48px;
min-height: 48px;
display: flex;
align-items: center;
}
#notReturnedBar .marquee {
display: inline-block;
white-space: nowrap;
will-change: transform;
/* Velocidade ajustada para leitura humana: 40s */
animation: marquee-bar 40s linear infinite;
}
@keyframes marquee-bar {
0% { transform: translateX(100%);}
100% { transform: translateX(-100%);}
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<!-- Firebase Initialization -->
<script>
// Corrigido: Removido import/export e inicializa√ß√£o modular
// Use apenas a vers√£o compat!
const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

// Inicializa Firebase usando compat
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// Se quiser analytics (opcional, s√≥ se a API key for v√°lida)
if (firebase.analytics) {
firebase.analytics();
}
</script>
<!-- Date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<!-- Importa√ß√£o do SheetJS para gera√ß√£o de relat√≥rios XLS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Biblioteca para assinatura digital -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<style>
body {
font-family: 'Poppins', sans-serif;
background: #f0f2f5;
margin: 0;
padding: 0;
}
.sidebar {
position: fixed;
top: 0;
left: 0;
height: 100%;
width: 250px;
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
color: white;
padding: 20px;
transition: all 0.3s ease;
z-index: 1000;
}
.sidebar-header {
padding: 20px 0;
text-align: center;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.sidebar-header h3 {
background: linear-gradient(90deg, #00f2fe, #4facfe);
-webkit-background-clip: text;
background-clip: text;
-webkit-text-fill-color: transparent;
margin: 0;
font-weight: 600;
}
.menu-items {
padding: 20px 0;
}
.menu-item {
padding: 12px 20px;
color: white;
text-decoration: none;
display: flex;
align-items: center;
transition: all 0.3s ease;
border-radius: 8px;
margin-bottom: 5px;
}
.menu-item:hover, .menu-item.active {
background: rgba(255, 255, 255, 0.1);
color: #4facfe;
}
.menu-item i {
margin-right: 10px;
font-size: 1.2rem;
}
.main-content {
margin-left: 250px;
padding: 20px;
transition: all 0.3s ease;
}
.page-header {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}
.loans-table {
background: white;
border-radius: 15px;
padding: 20px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.table {
margin-bottom: 0;
}
.table th {
border-top: none;
font-weight: 600;
color: #1a1a2e;
}
.loan-status {
display: inline-block;
padding: 5px 10px;
border-radius: 20px;
font-size: 0.8rem;
}
.status-emprestado {
background: #e8f5e9;
color: #2e7d32;
}
.status-atrasado {
background: #ffebee;
color: #c62828;
}
.status-devolvido {
background: #e3f2fd;
color: #1565c0;
}
.add-button {
background: linear-gradient(90deg, #00f2fe, #4facfe);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.add-button:hover {
transform: translateY(-2px);
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.search-box {
display: flex;
gap: 10px;
margin-bottom: 20px;
}
.search-box input {
flex: 1;
padding: 10px 15px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 0.9rem;
}
.action-buttons {
display: flex;
gap: 10px;
}
.action-button {
background: none;
border: none;
padding: 5px;
cursor: pointer;
transition: all 0.3s ease;
}
.action-button:hover {
transform: translateY(-2px);
}
.return-button {
color: #4facfe;
}
.renew-button {
color: #2e7d32;
}
@media (max-width: 768px) {
.sidebar {
transform: translateX(-100%);
}
.main-content {
margin-left: 0;
}
.sidebar.active {
transform: translateX(0);
}
.table-responsive {
margin-bottom: 0;
}
}
#notReturnedBar {
position: relative;
overflow: hidden;
height: 48px;
min-height: 48px;
display: flex;
align-items: center;
}
#notReturnedBar .marquee {
display: inline-block;
white-space: nowrap;
will-change: transform;
/* Velocidade ajustada para leitura humana: 40s */
animation: marquee-bar 40s linear infinite;
}
@keyframes marquee-bar {
0% { transform: translateX(100%);}
100% { transform: translateX(-100%);}
}
</style>
<!-- Adicione esta linha ANTES do seu <script> principal, logo ap√≥s os outros scripts externos -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
</head>
<body>
<div class="sidebar">
<div class="sidebar-header">
<h3>SIGEB</h3>
</div>
<div class="menu-items">
<a href="dashboard.html" class="menu-item">
<i class='bx bxs-dashboard'></i>
Dashboard
</a>
<a href="livros.html" class="menu-item">
<i class='bx bxs-book'></i>
Livros
</a>
<a href="usuarios.html" class="menu-item">
<i class='bx bxs-user'></i>
Usu√°rios
</a>
<a href="emprestimos.html" class="menu-item active">
<i class='bx bxs-bookmark'></i>
Empr√©stimos
</a>
<a href="relatorios.html" class="menu-item" title="Relat√≥rios do sistema">
<i class='bx bxs-report'></i>
Relat√≥rios
</a>
<a href="configuracoes.html" class="menu-item">
<i class='bx bxs-cog'></i>
Configura√ß√µes
</a>
<a href="index.html" class="menu-item">
<i class='bx bxs-log-out'></i>
Sair
</a>
</div>
</div>

<div class="main-content">
<div class="page-header">
<div>
<h2>Gerenciamento de Empr√©stimos</h2>
<p>Controle os empr√©stimos da biblioteca</p>
</div>
<div class="d-flex gap-2">
<button class="add-button" data-bs-toggle="modal" data-bs-target="#addLoanModal">
<i class='bx bx-plus'></i>
Novo Empr√©stimo
</button>
</div>
</div>

<!-- Barra piscante de atrasos -->
<div id="notReturnedBar" style="display:none; margin-bottom:20px;"></div>

<!-- Bot√µes de filtro estilo gr√°fico -->
<div id="loanStats" class="d-flex justify-content-center align-items-center mb-4" style="gap: 40px;">
<div class="pie-btn shadow-lg" id="btnEmprestado" onclick="showLoansByStatus('EMPRESTADO')">
<div class="pie-chart pie-emprestado">
<span id="countEmprestado"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-emprestado" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Emprestados</div>
</div>
<div class="pie-btn shadow-lg" id="btnAtrasado" onclick="showLoansByStatus('ATRASADO')">
<div class="pie-chart pie-atrasado">
<span id="countAtrasado"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-atrasado" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Atrasos</div>
</div>
<div class="pie-btn shadow-lg" id="btnDevolvido" onclick="showLoansByStatus('DEVOLVIDO')">
<div class="pie-chart pie-devolvido">
<span id="countDevolvido"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-devolvido" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Devolvidos</div>
</div>
<div class="pie-btn shadow-lg" onclick="showWarningsModal()">
<div class="pie-chart pie-warnings">
<span id="countWarnings">0</span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-warnings" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Advert√™ncias</div>
</div>
</div>
<style>
#loanStats {
margin-top: 40px;
margin-bottom: 40px;
gap: 40px;
}
.pie-btn {
display: flex;
flex-direction: column;
align-items: center;
cursor: pointer;
min-width: 120px;
transition: transform 0.18s, box-shadow 0.18s;
border-radius: 18px;
background: rgba(255,255,255,0.85);
box-shadow: 0 4px 24px 0 rgba(80,120,255,0.07);
padding: 18px 10px 10px 10px;
position: relative;
overflow: visible;
}
.pie-btn:hover {
transform: translateY(-4px) scale(1.06);
box-shadow: 0 8px 32px 0 rgba(80,120,255,0.13);
background: linear-gradient(120deg, #f8fbff 80%, #e3f2fd 100%);
}
.pie-chart {
width: 90px;
height: 90px;
border-radius: 50%;
position: relative;
margin-bottom: 10px;
display: flex;
align-items: center;
justify-content: center;
background: transparent;
}
.pie-chart span {
position: absolute;
left: 0; right: 0; top: 0; bottom: 0;
display: flex;
align-items: center;
justify-content: center;
font-size: 2.1rem;
font-weight: 700;
z-index: 2;
color: #222;
pointer-events: none;
text-shadow: 0 2px 8px #fff, 0 1px 0 #e3f2fd;
}
.pie-svg {
position: absolute;
left: 0; top: 0;
z-index: 1;
pointer-events: none;
}
.pie-bg {
fill: none;
stroke: #e3f2fd;
stroke-width: 10;
}
.pie-fg {
fill: none;
stroke-width: 10;
stroke-linecap: round;
transform: rotate(-90deg);
transform-origin: 50% 50%;
transition: stroke-dasharray 0.7s cubic-bezier(.4,2,.6,1), stroke 0.3s;
}
.pie-fg-emprestado { stroke: #4facfe; }
.pie-fg-atrasado { stroke: #c62828; }
.pie-fg-devolvido { stroke: #2e7d32; }
.pie-fg-warnings { stroke: #ff9800; }
.pie-label {
font-size: 1.13rem;
font-weight: 600;
margin-top: 8px;
color: #1a1a2e;
text-align: center;
letter-spacing: 0.01em;
text-shadow: 0 1px 0 #fff;
}
@media (max-width: 768px) {
#loanStats {
flex-direction: column !important;
gap: 24px !important;
}
.pie-btn {
min-width: 0;
}
}
</style>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Buscar por nome, matr√≠cula ou registro do empr√©stimo...">
<button class="add-button" onclick="searchLoans()">
<i class='bx bx-search'></i> Buscar Empr√©stimo
</button>
</div>

<!-- Lista dos √∫ltimos 15 empr√©stimos -->
<div class="loans-table mt-4" id="recentLoansTable">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>Livro</th>
<th>Usu√°rio</th>
<th>Data Empr√©stimo</th>
<th>Data Devolu√ß√£o</th>
<th>Status</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="loansTableBody">
<!-- Dados ser√£o carregados dinamicamente -->
</tbody>
</table>
</div>
</div>
<!-- Fim da lista dos √∫ltimos 15 empr√©stimos -->

</div>

<!-- Modal Novo Empr√©stimo Melhorado -->
<div class="modal fade" id="addLoanModal" tabindex="-1" aria-labelledby="addLoanModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<form id="addLoanForm" class="needs-validation" novalidate>
<div class="modal-header">
<h5 class="modal-title" id="addLoanModalLabel">Novo Empr√©stimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-4">
<label class="form-label" for="registroNumero">N¬∫ Registro</label>
<input type="text" class="form-control" id="registroNumero" readonly>
</div>
<div class="col-md-8">
<label class="form-label" for="userSearch">Usu√°rio*</label>
<div class="input-group">
<input type="text" class="form-control" id="userSearch" required placeholder="Digite nome ou matr√≠cula">
<button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
<i class='bx bx-search'></i>
</button>
</div>
<div id="userSearchResults" class="dropdown-menu w-100"></div>
<input type="hidden" id="selectedUserId">
<input type="hidden" id="selectedUserEmail">
<div class="form-text">Selecione o usu√°rio para o empr√©stimo.</div>
</div>
</div>
<!-- Email do usu√°rio e op√ß√£o de envio autom√°tico -->
<div class="row mb-3" id="emailSection" style="display: none;">
<div class="col-md-8">
<label class="form-label" for="userEmail">Email do Usu√°rio</label>
<input type="email" class="form-control" id="userEmail" readonly>
</div>
<div class="col-md-4 d-flex align-items-end">
<div class="form-check">
<input class="form-check-input" type="checkbox" id="sendEmailNotification" checked>
<label class="form-check-label" for="sendEmailNotification">
<i class="bx bx-envelope"></i> Enviar email autom√°tico
</label>
</div>
</div>
</div>
<div class="mb-3">
<label class="form-label">Livros*</label>
<div id="multiBookLoans">
<div class="loan-book-row row align-items-end mb-2">
<div class="col-md-6">
<label class="form-label visually-hidden" for="bookSearch0">Livro*</label>
<div class="input-group">
<input type="text" class="form-control bookSearch" id="bookSearch0" name="bookSearch0" required placeholder="Digite o t√≠tulo ou ISBN">
<button class="btn btn-outline-secondary" type="button" onclick="searchBooks(this)">
<i class='bx bx-search'></i>
</button>
</div>
<div class="bookSearchResults dropdown-menu w-100"></div>
<input type="hidden" class="selectedBookId" name="selectedBookId0" id="selectedBookId0">
</div>
<div class="col-md-3">
<label class="form-label visually-hidden" for="quantity0">Quantidade*</label>
<input type="number" class="form-control quantity" id="quantity0" name="quantity0" required min="1" value="1">
<div class="form-text">Dispon√≠vel: <span class="availableQuantity">-</span></div>
</div>
<div class="col-md-2">
<button type="button" class="btn btn-danger removeBookRow" style="display:none;" onclick="removeBookRow(this)">
<i class="bx bx-minus"></i>
</button>
</div>
</div>
</div>
<small class="text-muted d-block mt-2">Adicione v√°rios t√≠tulos diferentes para o mesmo usu√°rio neste empr√©stimo.</small>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label for="loanDate" class="form-label">Data do Empr√©stimo*</label>
<input type="text" class="form-control" id="loanDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<div class="form-text">Formato: DD/MM/AAAA (ex: 27/06/2025)</div>
</div>
<div class="col-md-6 mb-3">
<label for="returnDate" class="form-label">Data de Devolu√ß√£o*</label>
<div class="input-group">
<input type="text" class="form-control" id="returnDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<button class="btn btn-outline-secondary" type="button" id="setDefaultReturnDate" title="Definir 7 dias padr√£o">
<i class='bx bx-calendar-plus'></i> 7 dias
</button>
</div>
<div class="form-text">
<span class="text-primary">Padr√£o: 7 dias.</span> 
<span class="text-muted">Voc√™ pode alterar conforme necess√°rio.</span>
</div>
</div>
</div>
</div>
<!-- Rodap√© do modal com op√ß√µes de notifica√ß√£o -->
<div class="modal-footer d-flex justify-content-between align-items-center">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-success" id="btnEnviarWhatsappForm">
            <i class="bx bxl-whatsapp"></i> WhatsApp
        </button>
        <button type="button" class="btn btn-info" id="btnEnviarEmailForm" style="display: none;">
            <i class="bx bx-envelope"></i> Enviar Email
        </button>
    </div>
    <div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Registrar Empr√©stimo</button>
    </div>
</div>
<!-- Remova o bot√£o WhatsApp duplicado fora do modal, se existir -->
</form>
<!-- Exemplo: Adicione este bot√£o no modal de sucesso ou onde desejar -->
<button type="button" class="btn btn-success" id="btnEnviarWhatsapp" style="display:none; margin-top:10px;">
<i class="bx bxl-whatsapp"></i> Enviar Via WhatsApp
</button>
</div>
</div>
</div>

<!-- Modal Editar Empr√©stimo -->
<div class="modal fade" id="editLoanModal" tabindex="-1" aria-labelledby="editLoanModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="editLoanModalLabel">Editar Empr√©stimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<form id="editLoanForm" class="needs-validation" novalidate>
<input type="hidden" id="editLoanId">
<div class="row">
<div class="col-md-6 mb-3">
<label for="editLoanDate" class="form-label">Data do Empr√©stimo*</label>
<input type="text" class="form-control" id="editLoanDate" required>
</div>
<div class="col-md-6 mb-3">
<label for="editReturnDate" class="form-label">Data de Devolu√ß√£o*</label>
<div class="input-group">
<input type="text" class="form-control" id="editReturnDate" required>
<button class="btn btn-outline-secondary" type="button" id="setDefaultEditReturnDate" title="Definir 7 dias a partir da data do empr√©stimo">
<i class='bx bx-calendar-plus'></i> +7 dias
</button>
</div>
<div class="form-text text-muted">
Voc√™ pode alterar a data de devolu√ß√£o conforme necess√°rio.
</div>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" form="editLoanForm" class="btn btn-primary">Salvar Altera√ß√µes</button>
</div>
</div>
</div>
</div>

<!-- Modal Renovar Empr√©stimo -->
<div class="modal fade" id="renewLoanModal" tabindex="-1" aria-labelledby="renewLoanModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="renewLoanModalLabel">Renovar Empr√©stimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<form id="renewLoanForm" class="needs-validation" novalidate>
<input type="hidden" id="renewLoanId">

<div class="alert alert-info">
<i class="bx bx-info-circle me-2"></i>
<strong>Renova√ß√£o de Empr√©stimo</strong><br>
Defina a nova data de devolu√ß√£o para este empr√©stimo.
</div>

<div id="renewLoanInfo" class="mb-3">
<!-- Informa√ß√µes do empr√©stimo ser√£o carregadas aqui -->
</div>

<div class="mb-3">
<label for="renewReturnDate" class="form-label">Nova Data de Devolu√ß√£o*</label>
<div class="input-group">
<input type="text" class="form-control" id="renewReturnDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<button class="btn btn-outline-secondary" type="button" id="setDefaultRenewReturnDate" title="Definir 7 dias a partir de hoje">
<i class='bx bx-calendar-plus'></i> +7 dias
</button>
</div>
<div class="form-text">
<span class="text-primary">Padr√£o: 7 dias a partir de hoje.</span> 
<span class="text-muted">Voc√™ pode alterar conforme necess√°rio.</span>
</div>
</div>

<div class="alert alert-warning">
<i class="bx bx-info-circle me-2"></i>
<strong>Observa√ß√£o:</strong> A renova√ß√£o atualizar√° apenas a data de devolu√ß√£o. O empr√©stimo continuar√° ativo com o novo prazo.
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" form="renewLoanForm" class="btn btn-success">
<i class="bx bx-refresh me-2"></i>Renovar Empr√©stimo
</button>
</div>
</div>
</div>
</div>

<!-- Modal Comprovante de Empr√©stimo -->
<div class="modal fade" id="printLoanModal" tabindex="-1" aria-labelledby="printLoanModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content" id="printArea">
<div class="modal-header">
<h5 class="modal-title" id="printLoanModalLabel">Comprovante de Empr√©stimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div id="loanReceiptContent">
<!-- Conte√∫do preenchido via JS -->
</div>
<div class="mt-4">
<label for="userSignature" class="form-label">Assinatura do Usu√°rio:</label>
<div style="border:1px solid #ccc; height:60px; margin-bottom:10px;">
<canvas id="signaturePad" width="350" height="60" style="width:100%;height:60px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-secondary mb-2" onclick="clearSignature()">Limpar Assinatura</button>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-primary" onclick="printLoanReceipt()">Imprimir</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
</div>
</div>
</div>
</div>

<!-- Modal de Advert√™ncia por Atraso -->
<div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content" id="warningPrintArea">
<div class="modal-header bg-danger text-white">
<h5 class="modal-title" id="warningModalLabel">
<i class="bx bx-error-circle me-2"></i>Advert√™ncia por Atraso
</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="alert alert-danger mb-4">
<h6 class="alert-heading">
<i class="bx bx-time me-2"></i>Empr√©stimo em Atraso
</h6>
<p class="mb-0">Este documento constitui uma advert√™ncia formal devido ao atraso na devolu√ß√£o de material bibliogr√°fico.</p>
</div>

<div class="row mb-4">
<div class="col-md-6">
<div class="card">
<div class="card-header bg-light">
<h6 class="mb-0">Dados da Institui√ß√£o</h6>
</div>
<div class="card-body">
<p class="mb-1"><strong>${SYSTEM_CONFIG.schoolName}</strong></p>
<p class="mb-1">Sistema de Gerenciamento de Biblioteca</p>
<p class="mb-0">Data: <span id="warningDate"></span></p>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card">
<div class="card-header bg-light">
<h6 class="mb-0">Dados do Usu√°rio</h6>
</div>
<div class="card-body" id="warningUserData">
<!-- Preenchido via JavaScript -->
</div>
</div>
</div>
</div>

<div class="card mb-4">
<div class="card-header bg-light">
<h6 class="mb-0">Detalhes do Empr√©stimo</h6>
</div>
<div class="card-body" id="warningLoanDetails">
<!-- Preenchido via JavaScript -->
</div>
</div>

<div class="alert alert-warning" id="warningConsequences">
<!-- Preenchido dinamicamente via JavaScript baseado nos dias de atraso -->
</div>

<div class="alert alert-info">
<h6 class="alert-heading">A√ß√µes Necess√°rias:</h6>
<ol class="mb-0">
<li>Devolu√ß√£o imediata do material em atraso</li>
<li>Pagamento de eventual multa aplicada</li>
<li>Assinatura deste termo de advert√™ncia</li>
</ol>
</div>

<div class="mt-4">
<div class="row">
<div class="col-md-6">
<label class="form-label">Assinatura do Usu√°rio:</label>
<div style="border: 2px solid #dc3545; height: 80px; border-radius: 5px; margin-bottom: 10px; background-color: #fff;">
<canvas id="warningSignaturePad" width="400" height="80" style="width: 100%; height: 80px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearWarningSignature()">
<i class="bx bx-eraser me-1"></i>Limpar Assinatura
</button>
</div>
<div class="col-md-6">
<label class="form-label">Assinatura do Respons√°vel pela Biblioteca:</label>
<div style="border: 2px solid #dc3545; height: 80px; border-radius: 5px; margin-bottom: 10px; background-color: #fff;">
<canvas id="librarianSignaturePad" width="400" height="80" style="width: 100%; height: 80px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLibrarianSignature()">
<i class="bx bx-eraser me-1"></i>Limpar Assinatura
</button>
</div>
</div>
</div>

<div class="mt-4 p-3 bg-light border-start border-5 border-danger">
<p class="mb-2"><strong>Declara√ß√£o:</strong></p>
<p class="mb-0 small">
Declaro estar ciente das normas da biblioteca e das consequ√™ncias do atraso na devolu√ß√£o de materiais. 
Comprometo-me a devolver o material em atraso e a cumprir as penalidades aplicadas conforme regulamento interno.
</p>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-danger" onclick="printWarning()">
<i class="bx bx-printer me-2"></i>Imprimir Advert√™ncia
</button>
<button type="button" class="btn btn-success" onclick="saveWarning()" id="saveWarningBtn">
<i class="bx bx-save me-2"></i>Salvar Advert√™ncia
</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
<i class="bx bx-x me-2"></i>Fechar
</button>
</div>
</div>
</div>
</div>

<!-- Modal de Lista de Advert√™ncias Simplificado -->
<div class="modal fade" id="warningsListModal" tabindex="-1" aria-labelledby="warningsListModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header bg-warning text-dark">
<h5 class="modal-title" id="warningsListModalLabel">
<i class="bx bx-error-circle me-2"></i>Advert√™ncias Emitidas
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-6">
<div class="input-group">
<span class="input-group-text"><i class="bx bx-search"></i></span>
<input type="text" class="form-control" id="warningsSearchInput" placeholder="Buscar por nome do usu√°rio...">
</div>
</div>
<div class="col-md-3">
<button class="btn btn-primary w-100" onclick="loadSimpleWarnings()">
<i class="bx bx-refresh me-1"></i>Atualizar
</button>
</div>
<div class="col-md-3">
<button class="btn btn-success w-100" onclick="exportSimpleWarningsReport()">
<i class="bx bx-download me-1"></i>Exportar
</button>
</div>
</div>

<div class="alert alert-info">
<i class="bx bx-info-circle me-2"></i>
Total de advert√™ncias: <span id="warningsCountDisplay" class="fw-bold">0</span>
</div>

<div class="table-responsive">
<table class="table table-hover">
<thead class="table-warning">
<tr>
<th>Data</th>
<th>Usu√°rio</th>
<th>Livro(s)</th>
<th>Dias de Atraso</th>
<th>Tipo</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="simpleWarningsTableBody">
<tr>
<td colspan="6" class="text-center">Carregando advert√™ncias...</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
<i class="bx bx-x me-2"></i>Fechar
</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Configura√ß√µes do sistema
const SYSTEM_CONFIG = {
schoolName: "Escola Estadual Governador Bias Fortes", // Nome oficial da escola
systemName: "SIGEB - Sistema de Gerenciamento de Biblioteca",
defaultLoanDays: 14
};

// Fun√ß√£o para obter data/hora no hor√°rio de Bras√≠lia
function getDataBrasilia() {
// Cria uma nova data no hor√°rio UTC
const agora = new Date();

// Converte para o hor√°rio de Bras√≠lia (UTC-3)
// Durante hor√°rio de ver√£o seria UTC-2, mas vamos usar UTC-3 como padr√£o
const brasiliaOffset = -3; // UTC-3
const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
const brasilia = new Date(utc + (brasiliaOffset * 3600000));

return brasilia;
}

// Fun√ß√£o para formatar data no padr√£o brasileiro (DD/MM/AAAA)
function formatarDataBrasil(data) {
const day = String(data.getDate()).padStart(2, '0');
const month = String(data.getMonth() + 1).padStart(2, '0');
const year = data.getFullYear();
return `${day}/${month}/${year}`;
}

// Fun√ß√£o para adicionar dias a uma data (hor√°rio Bras√≠lia)
function adicionarDias(data, dias) {
const novaData = new Date(data);
novaData.setDate(novaData.getDate() + dias);
return novaData;
}

// Fun√ß√£o gen√©rica para enviar email
async function sendEmailNotification(templateId, userId, data, subject) {
try {
const userDoc = await db.collection('usuarios').doc(userId).get();
const userData = userDoc.data();

if (!userData || !userData.email) {
console.error('Email do usu√°rio n√£o encontrado ou dados do usu√°rio inv√°lidos');
return;
}

const templateParams = {
to_email: userData.email,
to_name: userData.nome,
subject: subject,
...data
};

await emailjs.send(
"service_70cadf4", // Service ID
templateId,
templateParams
);

console.log(`Email de ${subject} enviado com sucesso`);
} catch (error) {
console.error(`Erro ao enviar email de ${subject}:`, error);
showAlert('warning', `Houve um erro ao enviar o email de ${subject}`);
}
}

// Template do email de empr√©stimo (usando vari√°veis do Email.js)
const LOAN_EMAIL_TEMPLATE_ID = "SEU_TEMPLATE_ID_DO_EMAILJS_EMPRESTIMO"; // Crie um template no Email.js com estas vari√°veis
const LOAN_EMAIL_TEMPLATE_VARS = `
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
<div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
<h1 style="color: white; margin: 0; text-align: center;">${SYSTEM_CONFIG.systemName}</h1>
<h2 style="color: white; margin: 10px 0 0; text-align: center; font-size: 1.2em;">${SYSTEM_CONFIG.schoolName}</h2>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
<h2 style="color: #1a1a2e; margin-top: 0;">Comprovante de Empr√©stimo</h2>
<p><strong>Usu√°rio:</strong> {{userName}}</p>
<p><strong>Email:</strong> {{userEmail}}</p>
<p><strong>Livros:</strong></p>
<ul>{{booksList}}</ul>
<p><strong>Data do Empr√©stimo:</strong> {{loanDate}}</p>
<p><strong>Data de Devolu√ß√£o:</strong> {{returnDate}}</p>
</div>

<div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
<p style="color: #2e7d32; margin: 0;">
‚ö†Ô∏è Por favor, mantenha este comprovante para refer√™ncia futura.
</p>
</div>

<div style="text-align: center; color: #666;">
<p>Este √© um email autom√°tico, por favor n√£o responda.</p>
<p>${SYSTEM_CONFIG.schoolName}</p>
<p>${SYSTEM_CONFIG.systemName}</p>
</div>
</div>
`;

// Template do email de renova√ß√£o (usando vari√°veis do Email.js)
const RENEWAL_EMAIL_TEMPLATE_ID = "SEU_TEMPLATE_ID_DO_EMAILJS_RENOVACAO"; // Crie um template no Email.js com estas vari√°veis
const RENEWAL_EMAIL_TEMPLATE_VARS = `
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
<div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
<h1 style="color: white; margin: 0; text-align: center;">${SYSTEM_CONFIG.systemName}</h1>
<h2 style="color: white; margin: 10px 0 0; text-align: center; font-size: 1.2em;">${SYSTEM_CONFIG.schoolName}</h2>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
<h2 style="color: #1a1a2e; margin-top: 0;">Confirma√ß√£o de Renova√ß√£o</h2>
<p><strong>Usu√°rio:</strong> {{userName}}</p>
<p><strong>Email:</strong> {{userEmail}}</p>
<p><strong>Livro:</strong> {{bookTitle}}</p>
<p><strong>Nova Data de Devolu√ß√£o:</strong> {{newReturnDate}}</p>
</div>

<div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
<p style="color: #2e7d32; margin: 0;">
‚ö†Ô∏è Por favor, anote a nova data de devolu√ß√£o.
</p>
</div>

<div style="text-align: center; color: #666;">
<p>Este √© um email autom√°tico, por favor n√£o responda.</p>
<p>${SYSTEM_CONFIG.schoolName}</p>
<p>${SYSTEM_CONFIG.systemName}</p>
</div>
</div>
`;

// Fun√ß√£o para enviar email de empr√©stimo (agora usando a fun√ß√£o gen√©rica)
async function sendLoanConfirmationEmail(userId, books, loanDate, returnDate) {
let booksList = '';
for (const item of books) {
const bookDoc = await db.collection('livros').doc(item.bookId).get();
const bookData = bookDoc.data();
booksList += `<li>${bookData.titulo} - Quantidade: ${item.quantity}</li>`;
}

const emailData = {
userName: (await db.collection('usuarios').doc(userId).get()).data().nome,
userEmail: (await db.collection('usuarios').doc(userId).get()).data().email,
booksList: booksList,
loanDate: loanDate,
returnDate: returnDate
};

await sendEmailNotification(LOAN_EMAIL_TEMPLATE_ID, userId, emailData, `${SYSTEM_CONFIG.schoolName} - Comprovante de Empr√©stimo`);
}

// Fun√ß√£o para enviar email de renova√ß√£o (agora usando a fun√ß√£o gen√©rica)
async function sendRenewalConfirmationEmail(userId, bookTitle, newReturnDate) {
const emailData = {
userName: (await db.collection('usuarios').doc(userId).get()).data().nome,
userEmail: (await db.collection('usuarios').doc(userId).get()).data().email,
bookTitle: bookTitle,
newReturnDate: newReturnDate
};

await sendEmailNotification(RENEWAL_EMAIL_TEMPLATE_ID, userId, emailData, `${SYSTEM_CONFIG.schoolName} - Confirma√ß√£o de Renova√ß√£o`);
}

// Fun√ß√£o para enviar mensagem WhatsApp ao registrar novo empr√©stimo
async function sendWhatsAppOnLoan(userId, books, loanDate, returnDate) {
try {
const userDoc = await db.collection('usuarios').doc(userId).get();
const userData = userDoc.data();
if (!userData || !userData.telefone) {
console.warn('Telefone do usu√°rio n√£o encontrado.');
return;
}
// Monta a mensagem
let booksList = '';
for (const item of books) {
const bookDoc = await db.collection('livros').doc(item.bookId).get();
const bookData = bookDoc.data();
booksList += `\n- ${bookData ? bookData.titulo : item.bookId} (Qtd: ${item.quantity})`;
}
const msg = 
`Ol√° ${userData.nome}, seu empr√©stimo foi registrado na biblioteca!\n` +
`Livros:${booksList}\n` +
`Data do Empr√©stimo: ${loanDate}\n` +
`Data de Devolu√ß√£o: ${returnDate}\n` +
`Por favor, devolva os livros na data correta.`+
`Agradecemos a sua colabora√ß√£o.`+
`Atenciosamente, ${SYSTEM_CONFIG.schoolName}`+
`SIGEB - Sistema de Gerenciamento de Biblioteca`;



// Formata o telefone para padr√£o internacional (ex: 5511999999999)
let phone = userData.telefone.replace(/\D/g, '');
if (phone.length === 11 && !phone.startsWith('55')) {
phone = '55' + phone;
}

// Abre o WhatsApp Web em nova aba
const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
window.open(url, '_blank');
} catch (error) {
console.error('Erro ao enviar WhatsApp:', error);
}
}

// Fun√ß√£o para enviar email de notifica√ß√£o de empr√©stimo usando EmailJS
async function sendLoanNotificationEmail(userId, userEmail, books, loanDate, returnDate, registroNumero) {
try {
// Busca dados do usu√°rio
const userDoc = await db.collection('usuarios').doc(userId).get();
const userData = userDoc.data();

if (!userData) {
showAlert('danger', 'Dados do usu√°rio n√£o encontrados.');
return;
}

// Busca dados dos livros
let booksList = '';
let booksListHtml = '';
for (const item of books) {
const bookDoc = await db.collection('livros').doc(item.bookId).get();
const bookData = bookDoc.data();
const bookTitle = bookData ? bookData.titulo : 'Livro n√£o encontrado';
const bookAuthor = bookData ? (bookData.autor || 'Autor n√£o informado') : '';

booksList += `\n‚Ä¢ ${bookTitle} (Quantidade: ${item.quantity})`;
booksListHtml += `<li><strong>${bookTitle}</strong>${bookAuthor ? ` - ${bookAuthor}` : ''} (Quantidade: ${item.quantity})</li>`;
}

// Monta os dados para o template do EmailJS
const templateParams = {
to_email: userEmail,
to_name: userData.nome,
user_name: userData.nome,
user_matricula: userData.matricula || 'N/A',
registro_numero: registroNumero,
loan_date: loanDate,
return_date: returnDate,
books_list: booksList,
books_list_html: booksListHtml,
school_name: SYSTEM_CONFIG.schoolName || 'Escola Estadual Governador Bias Fortes',
from_name: 'SIGEB - Sistema de Biblioteca',
message: `Seu empr√©stimo foi registrado com sucesso! Por favor, devolva os livros na data indicada.`
};

// Envia o email usando EmailJS
showAlert('info', 'Enviando email de notifica√ß√£o...');

// Tenta primeiro com o template espec√≠fico, depois com template gen√©rico
let templateId = 'template_6f2r7op';
try {
const response = await emailjs.send('service_70cadf4', templateId, templateParams);
console.log('Email enviado com sucesso:', response);
showAlert('success', `Email de notifica√ß√£o enviado para ${userEmail}!`);
} catch (templateError) {
console.warn('Template espec√≠fico n√£o encontrado, tentando template gen√©rico:', templateError);
// Fallback para template gen√©rico se o espec√≠fico n√£o existir
try {
const response = await emailjs.send('service_70cadf4', 'template_default', templateParams);
console.log('Email enviado com template gen√©rico:', response);
showAlert('success', `Email de notifica√ß√£o enviado para ${userEmail}!`);
} catch (fallbackError) {
console.error('Erro ao enviar email mesmo com fallback:', fallbackError);
throw fallbackError;
}
}

} catch (error) {
console.error('Erro ao enviar email:', error);
if (error.text && error.text.includes('template ID not found')) {
showAlert('warning', `Template de email n√£o encontrado. Verifique se o template "template_6f2r7op" existe em:<br>
https://dashboard.emailjs.com/admin/templates<br>
Vari√°veis necess√°rias: {{to_name}}, {{registro_numero}}, {{books_list}}, {{loan_date}}, {{return_date}}, {{school_name}}`);
} else if (error.text) {
showAlert('danger', `Erro ao enviar email: ${error.text}`);
} else {
showAlert('danger', 'Erro ao enviar email de notifica√ß√£o. Verifique as configura√ß√µes.');
}
}
}

// Fun√ß√£o para exibir alertas de feedback ao usu√°rio
function showAlert(type, message, timeout = 4000) {
// Remove alertas antigos
document.querySelectorAll('.custom-alert').forEach(e => e.remove());
const alert = document.createElement('div');
alert.className = `alert alert-${type} custom-alert position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
alert.style.zIndex = 2000;
alert.innerHTML = message;
document.body.appendChild(alert);
setTimeout(() => alert.remove(), timeout);
}

// Fun√ß√£o para fechar o modal de novo empr√©stimo
function closeAddLoanModal() {
const modal = bootstrap.Modal.getInstance(document.getElementById('addLoanModal'));
if (modal) modal.hide();
}

// Corrige duplicidade de listeners e inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
// Flatpickr j√° inicializado acima

// Adiciona m√°scaras para os campos de data
const loanDateInput = document.getElementById('loanDate');
const returnDateInput = document.getElementById('returnDate');

// Fun√ß√£o para aplicar m√°scara de data
function applyDateMask(input) {
input.addEventListener('input', function(e) {
let value = e.target.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito

if (value.length >= 2) {
value = value.substring(0, 2) + '/' + value.substring(2);
}
if (value.length >= 5) {
value = value.substring(0, 5) + '/' + value.substring(5, 9);
}

e.target.value = value;
});

// Valida a data quando o usu√°rio sai do campo
input.addEventListener('blur', function(e) {
const dateValue = e.target.value;
if (dateValue && !isValidDateFormat(dateValue)) {
e.target.classList.add('is-invalid');
} else {
e.target.classList.remove('is-invalid');
}
});
}

// Fun√ß√£o para validar formato de data brasileira
function isValidDateFormat(dateString) {
const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
const match = dateString.match(regex);

if (!match) return false;

const day = parseInt(match[1], 10);
const month = parseInt(match[2], 10);
const year = parseInt(match[3], 10);

if (month < 1 || month > 12) return false;
if (day < 1 || day > 31) return false;
if (year < 1900 || year > 2100) return false;

// Verifica se a data √© v√°lida
const date = new Date(year, month - 1, day);
return date.getFullYear() === year && 
date.getMonth() === month - 1 && 
date.getDate() === day;
}

// Aplica m√°scaras aos campos de data
if (loanDateInput) applyDateMask(loanDateInput);
if (returnDateInput) applyDateMask(returnDateInput);

// Aplica m√°scara ao campo de data do modal de edi√ß√£o
const editLoanDateInput = document.getElementById('editLoanDate');
const editReturnDateInput = document.getElementById('editReturnDate');
if (editLoanDateInput) applyDateMask(editLoanDateInput);
if (editReturnDateInput) applyDateMask(editReturnDateInput);

// Aplica m√°scara ao campo de data do modal de renova√ß√£o
const renewReturnDateInput = document.getElementById('renewReturnDate');
if (renewReturnDateInput) applyDateMask(renewReturnDateInput);

// Listener para busca de usu√°rios
const userSearch = document.getElementById('userSearch');
if (userSearch) {
userSearch.addEventListener('input', searchUsers);
userSearch.addEventListener('focus', searchUsers);
}
const userSearchBtn = document.querySelector('#addLoanForm button[onclick="searchUsers()"]');
if (userSearchBtn) {
userSearchBtn.addEventListener('click', searchUsers);
}

// Listener para busca de livros na primeira linha
const firstBookSearch = document.querySelector('.bookSearch');
if (firstBookSearch) {
firstBookSearch.addEventListener('input', function() {
searchBooks(this);
});
firstBookSearch.addEventListener('focus', function() {
searchBooks(this);
});
}

// Listener para submiss√£o do formul√°rio de empr√©stimo
const addLoanForm = document.getElementById('addLoanForm');
if (addLoanForm) {
addLoanForm.addEventListener('submit', handleLoanSubmission);
}

// Adiciona valida√ß√£o em tempo real para campos de quantidade
function addQuantityValidation() {
document.querySelectorAll('.quantity').forEach(quantityInput => {
quantityInput.addEventListener('input', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

// Remove valida√ß√µes anteriores
this.classList.remove('is-invalid', 'is-valid');

if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
this.classList.add('is-invalid');
this.setCustomValidity('Quantidade deve ser um n√∫mero positivo');
} else if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
this.classList.add('is-invalid');
this.setCustomValidity(`Quantidade m√°xima dispon√≠vel: ${availableQuantity}`);
} else {
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

quantityInput.addEventListener('blur', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
showAlert('warning', `Quantidade solicitada (${requestedQuantity}) excede a dispon√≠vel (${availableQuantity}). Ajustando para o m√°ximo dispon√≠vel.`);
this.value = availableQuantity;
this.classList.remove('is-invalid');
this.classList.add('is-valid');
this.setCustomValidity('');
}
});
});
}

// Aplica valida√ß√£o inicial
addQuantityValidation();

// Gera n√∫mero de registro autom√°tico ao abrir modal
const addLoanModal = document.getElementById('addLoanModal');
if (addLoanModal) {
addLoanModal.addEventListener('show.bs.modal', async function () {
// Gera um n√∫mero sequencial simples (pode ser melhorado para produ√ß√£o)
const snapshot = await db.collection('emprestimos').orderBy('createdAt', 'desc').limit(1).get();
let nextNumber = 1;
if (!snapshot.empty) {
const last = snapshot.docs[0].data().registroNumero;
if (last && !isNaN(Number(last))) nextNumber = Number(last) + 1;
}
document.getElementById('registroNumero').value = String(nextNumber).padStart(6, '0');

// Define automaticamente as datas no formato brasileiro usando hor√°rio de Bras√≠lia
const hoje = getDataBrasilia();
const dataEmprestimo = formatarDataBrasil(hoje);

// Adiciona 7 dias para a data de devolu√ß√£o
const dataDevolucao = adicionarDias(hoje, 7);
const dataRetorno = formatarDataBrasil(dataDevolucao);

// Define os valores nos campos
document.getElementById('loanDate').value = dataEmprestimo;
document.getElementById('returnDate').value = dataRetorno;

console.log('Datas definidas automaticamente (Hor√°rio Bras√≠lia):', {
emprestimo: dataEmprestimo,
devolucao: dataRetorno
});
});

// Event listener para o bot√£o "7 dias" no modal de novo empr√©stimo
document.getElementById('setDefaultReturnDate').addEventListener('click', function() {
const loanDateInput = document.getElementById('loanDate');
const returnDateInput = document.getElementById('returnDate');

if (loanDateInput.value) {
// Parse da data do empr√©stimo
const [day, month, year] = loanDateInput.value.split('/');
const loanDate = new Date(year, month - 1, day);

// Adiciona 7 dias usando a fun√ß√£o utilit√°ria
const returnDate = adicionarDias(loanDate, 7);

// Formata para dd/mm/yyyy usando hor√°rio de Bras√≠lia
const formattedDate = formatarDataBrasil(returnDate);
returnDateInput.value = formattedDate;

showAlert('info', 'Data de devolu√ß√£o definida para 7 dias ap√≥s o empr√©stimo (Hor√°rio Bras√≠lia)', 2000);
} else {
showAlert('warning', 'Primeiro defina a data do empr√©stimo', 3000);
}
});

// Event listener para o bot√£o "+7 dias" no modal de edi√ß√£o
document.getElementById('setDefaultEditReturnDate').addEventListener('click', function() {
const editLoanDateInput = document.getElementById('editLoanDate');
const editReturnDateInput = document.getElementById('editReturnDate');

if (editLoanDateInput.value) {
// Parse da data do empr√©stimo
const [day, month, year] = editLoanDateInput.value.split('/');
const loanDate = new Date(year, month - 1, day);

// Adiciona 7 dias usando a fun√ß√£o utilit√°ria
const returnDate = adicionarDias(loanDate, 7);

// Formata para dd/mm/yyyy usando hor√°rio de Bras√≠lia
const formattedDate = formatarDataBrasil(returnDate);
editReturnDateInput.value = formattedDate;

showAlert('info', 'Data de devolu√ß√£o definida para 7 dias ap√≥s o empr√©stimo (Hor√°rio Bras√≠lia)', 2000);
} else {
showAlert('warning', 'Primeiro defina a data do empr√©stimo', 3000);
}
});

// Event listener para o bot√£o "+7 dias" no modal de renova√ß√£o
document.getElementById('setDefaultRenewReturnDate').addEventListener('click', function() {
const today = getDataBrasilia();
const dataComSeteDias = adicionarDias(today, 7);
const dataFormatada = formatarDataBrasil(dataComSeteDias);

document.getElementById('renewReturnDate').value = dataFormatada;
showAlert('info', 'Data de devolu√ß√£o definida para 7 dias a partir de hoje (Hor√°rio Bras√≠lia)', 2000);
});

// Limpa o formul√°rio quando o modal √© fechado
addLoanModal.addEventListener('hidden.bs.modal', function () {
// Reset do formul√°rio
document.getElementById('addLoanForm').reset();

// Limpa campos espec√≠ficos
document.getElementById('selectedUserId').value = '';
document.getElementById('selectedUserEmail').value = '';
document.getElementById('userSearchResults').innerHTML = '';

// Esconde se√ß√£o de email
document.getElementById('emailSection').style.display = 'none';
document.getElementById('userEmail').value = '';
document.getElementById('sendEmailNotification').checked = true;

// Esconde bot√µes de comunica√ß√£o
document.getElementById('btnEnviarEmailForm').style.display = 'none';

// Limpa bloco de detalhes do usu√°rio
const userDetailsBlock = document.getElementById('userDetailsBlock');
if (userDetailsBlock) {
userDetailsBlock.remove();
}

// Limpa resultados de busca de livros
document.querySelectorAll('.selectedBookId').forEach(input => input.value = '');
document.querySelectorAll('.bookSearchResults').forEach(div => div.innerHTML = '');
document.querySelectorAll('.availableQuantity').forEach(span => span.textContent = '-');

// Remove valida√ß√£o visual
document.getElementById('addLoanForm').classList.remove('was-validated');

console.log('Formul√°rio de empr√©stimo limpo');
});
}
}); // <-- Adiciona o fechamento do event listener aqui

document.getElementById('addLoanModal').addEventListener('shown.bs.modal', function () {
// Garante que o foco seja aplicado ao primeiro campo do modal ap√≥s ele ser exibido
const firstInput = document.querySelector('#addLoanModal input');
if (firstInput) {
firstInput.focus();
}
});
document.getElementById('addLoanModal').addEventListener('show.bs.modal', function () {
const modal = document.getElementById('addLoanModal');
modal.removeAttribute('aria-hidden');
});
// Fun√ß√£o para buscar e exibir os √∫ltimos 15 empr√©stimos
async function loadLoans() {
const tbody = document.getElementById('loansTableBody');
if (!tbody) return;
tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
try {
const snapshot = await db.collection('emprestimos')
.orderBy('createdAt', 'desc')
.limit(15)
.get();

tbody.innerHTML = '';
for (const doc of snapshot.docs) {
const data = doc.data();
// Monta lista de livros
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
// Busca nome do usu√°rio (corrigido para mostrar nome, n√£o id)
let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usu√°rio n√£o encontrado';
} catch {
userName = 'Usu√°rio n√£o encontrado';
}

// Verifica se o empr√©stimo est√° realmente atrasado baseado na data (hor√°rio Bras√≠lia)
let statusAtual = data.status;
const hoje = getDataBrasilia();
hoje.setHours(0, 0, 0, 0);

// Se o status for EMPRESTADO, verifica se est√° atrasado
if (data.status === 'EMPRESTADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);

// Se a data de devolu√ß√£o j√° passou, status √© ATRASADO
if (returnDate < hoje) {
statusAtual = 'ATRASADO';
// Atualiza o status no banco de dados
await db.collection('emprestimos').doc(doc.id).update({ status: 'ATRASADO' });
}
}
}

// Status visual baseado no status atual calculado
let statusClass = '';
if (statusAtual === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (statusAtual === 'ATRASADO') statusClass = 'status-atrasado';
else if (statusAtual === 'DEVOLVIDO') statusClass = 'status-devolvido';

// Calcula dias de atraso se aplic√°vel
let diffDays = 0;
if (statusAtual === 'ATRASADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(hoje - returnDate);
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

// Bot√µes de a√ß√£o baseados no status atual
let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;

// Adiciona bot√£o de advert√™ncia para qualquer atraso
if (statusAtual === 'ATRASADO' && diffDays > 0) {
const hasWarning = data.hasWarning ? 'text-warning' : 'text-danger';
const warningTitle = data.hasWarning ? 
`Advert√™ncia j√° emitida em ${data.warningDate || 'data n√£o dispon√≠vel'}` : 
`Atraso de ${diffDays} dias - Emitir advert√™ncia`;

actionBtns += `
<button class="btn btn-sm btn-outline-warning" title="${warningTitle}" onclick="openWarningModal('${doc.id}')">
<i class="bx bx-error ${hasWarning}"></i>
</button>
`;
}
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

// Monta o texto do status com informa√ß√µes de atraso
let statusText = statusAtual;
if (statusAtual === 'ATRASADO' && diffDays > 0) {
statusText = `ATRASADO (${diffDays} ${diffDays === 1 ? 'dia' : 'dias'})`;
}

tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status ${statusClass}">${statusText}</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
} catch (error) {
console.error('Erro ao carregar empr√©stimos:', error);
showAlert('danger', 'Erro ao carregar empr√©stimos.');
}
}

// Fun√ß√µes de busca (usu√°rios e livros)
let userSearchTimeout;
async function searchUsers() {
clearTimeout(userSearchTimeout);
userSearchTimeout = setTimeout(async () => {
const query = document.getElementById('userSearch').value.toLowerCase();
const userSearchResults = document.getElementById('userSearchResults');
userSearchResults.innerHTML = '';
if (query.length < 3) {
userSearchResults.classList.remove('show');
return;
}

try {
const snapshot = await db.collection('usuarios')
.where('nomeSearch', 'array-contains', query.split(' ')[0])
.limit(10)
.get();

if (snapshot.empty) {
userSearchResults.innerHTML = '<a class="dropdown-item">Nenhum usu√°rio encontrado</a>';
} else {
snapshot.docs.forEach(doc => {
const userData = doc.data();
let extraInfo = `<br><small>Fun√ß√£o: ${userData.funcao || '-'}</small>`;
if ((userData.funcao || '').toLowerCase() === 'aluno') {
extraInfo += `<br><small>S√©rie: ${userData.serie || '-'} | Turma: ${userData.turma || '-'} | Turno: ${userData.turno || '-'}</small>`;
}
const a = document.createElement('a');
a.className = 'dropdown-item';
a.href = '#';
a.innerHTML = `<strong>${userData.nome}</strong> (${userData.matricula || 'N/A'})${extraInfo}`;
a.onclick = (e) => {
e.preventDefault();
// Exibe os dados do usu√°rio selecionado em campos abaixo do input (ou em algum local desejado)
document.getElementById('selectedUserId').value = doc.id;
document.getElementById('selectedUserEmail').value = userData.email || '';

// Mostrar se√ß√£o de email se o usu√°rio tiver email
const emailSection = document.getElementById('emailSection');
const userEmailInput = document.getElementById('userEmail');
const btnEnviarEmail = document.getElementById('btnEnviarEmailForm');

if (userData.email && userData.email.trim() !== '') {
userEmailInput.value = userData.email;
emailSection.style.display = 'block';
btnEnviarEmail.style.display = 'inline-block';
} else {
emailSection.style.display = 'none';
btnEnviarEmail.style.display = 'none';
// Desmarca o checkbox se n√£o h√° email
document.getElementById('sendEmailNotification').checked = false;
}

// Exemplo: Mostra dados em um bloco abaixo do campo de busca
let userDetails = `
<div class="alert alert-info mt-2 mb-0 p-2">
<div><strong>Nome:</strong> ${userData.nome || '-'}</div>
<div><strong>Fun√ß√£o:</strong> ${userData.funcao || '-'}</div>
<div><strong>Email:</strong> ${userData.email || 'N√£o informado'}</div>
`;
if ((userData.funcao || '').toLowerCase() === 'aluno') {
userDetails += `
<div><strong>S√©rie:</strong> ${userData.serie || '-'}</div>
<div><strong>Turma:</strong> ${userData.turma || '-'}</div>
<div><strong>Turno:</strong> ${userData.turno || '-'}</div>
`;
}
userDetails += `</div>`;
// Cria ou atualiza o bloco de detalhes
let detailsDiv = document.getElementById('userDetailsBlock');
if (!detailsDiv) {
detailsDiv = document.createElement('div');
detailsDiv.id = 'userDetailsBlock';
document.getElementById('userSearch').parentNode.parentNode.appendChild(detailsDiv);
}
detailsDiv.innerHTML = userDetails;

userSearchResults.classList.remove('show');
};
userSearchResults.appendChild(a);
});
}
userSearchResults.classList.add('show');
} catch (error) {
console.error('Erro ao buscar usu√°rios:', error);
showAlert('danger', 'Erro ao buscar usu√°rios.');
}
}, 300);
}

let bookSearchTimeout;
async function searchBooks(inputElement) {
clearTimeout(bookSearchTimeout);
bookSearchTimeout = setTimeout(async () => {
const query = inputElement.value.toLowerCase();
const bookSearchResults = inputElement.closest('.input-group').nextElementSibling;
bookSearchResults.innerHTML = '';
if (query.length < 3) {
bookSearchResults.classList.remove('show');
return;
}

try {
const snapshot = await db.collection('livros')
.where('tituloSearch', 'array-contains', query.split(' ')[0]) // Busca por primeira palavra do t√≠tulo
.limit(10)
.get();

if (snapshot.empty) {
bookSearchResults.innerHTML = '<a class="dropdown-item">Nenhum livro encontrado</a>';
} else {
for (const doc of snapshot.docs) {
const bookData = doc.data();

// Busca a quantidade atualizada diretamente do banco
const currentBookDoc = await db.collection('livros').doc(doc.id).get();
const currentBookData = currentBookDoc.data();
const currentAvailable = currentBookData?.quantidadeDisponivel || 0;

const a = document.createElement('a');
a.className = 'dropdown-item';
a.href = '#';

// Mostra quantidade dispon√≠vel e adiciona indicador visual se n√£o houver estoque
if (currentAvailable > 0) {
a.innerHTML = `<strong>${bookData.titulo}</strong><br><small class="text-success">Dispon√≠vel: ${currentAvailable} unidades</small>`;
} else {
a.innerHTML = `<strong>${bookData.titulo}</strong><br><small class="text-danger">Indispon√≠vel (0 unidades)</small>`;
a.classList.add('disabled');
}

a.onclick = (e) => {
e.preventDefault();
if (currentAvailable <= 0) {
showAlert('warning', `O livro "${bookData.titulo}" n√£o possui unidades dispon√≠veis para empr√©stimo.`);
return;
}

inputElement.value = bookData.titulo;
inputElement.closest('.loan-book-row').querySelector('.selectedBookId').value = doc.id;
inputElement.closest('.loan-book-row').querySelector('.availableQuantity').textContent = currentAvailable;

// Atualiza o campo de quantidade m√°xima permitida
const quantityInput = inputElement.closest('.loan-book-row').querySelector('.quantity');
quantityInput.max = currentAvailable;
quantityInput.title = `M√°ximo dispon√≠vel: ${currentAvailable}`;

bookSearchResults.classList.remove('show');
};
bookSearchResults.appendChild(a);
}
}
bookSearchResults.classList.add('show');
} catch (error) {
console.error('Erro ao buscar livros:', error);
showAlert('danger', 'Erro ao buscar livros.');
}
}, 300);
}

// Fun√ß√µes de adicionar/remover linha de livro no modal de empr√©stimo
function addBookRow() {
const multiBookLoans = document.getElementById('multiBookLoans');
const rowCount = multiBookLoans.querySelectorAll('.loan-book-row').length;
const newRow = multiBookLoans.querySelector('.loan-book-row').cloneNode(true);

// Limpa valores e define IDs √∫nicos
const bookInput = newRow.querySelector('.bookSearch');
const quantityInput = newRow.querySelector('.quantity');
bookInput.value = '';
bookInput.id = `bookSearch${rowCount}`;
quantityInput.value = '1';
quantityInput.id = `quantity${rowCount}`;
newRow.querySelector('.selectedBookId').value = '';
newRow.querySelector('.availableQuantity').textContent = '-';
newRow.querySelector('.bookSearchResults').innerHTML = '';
newRow.querySelector('.bookSearchResults').classList.remove('show');
newRow.querySelector('.removeBookRow').style.display = 'block';

// Adiciona listeners para busca din√¢mica
bookInput.addEventListener('input', function() { searchBooks(this); });
bookInput.addEventListener('focus', function() { searchBooks(this); });

// Adiciona valida√ß√£o de quantidade para a nova linha
quantityInput.addEventListener('input', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

// Remove valida√ß√µes anteriores
this.classList.remove('is-invalid', 'is-valid');

if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
this.classList.add('is-invalid');
this.setCustomValidity('Quantidade deve ser um n√∫mero positivo');
} else if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
this.classList.add('is-invalid');
this.setCustomValidity(`Quantidade m√°xima dispon√≠vel: ${availableQuantity}`);
} else {
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

quantityInput.addEventListener('blur', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
showAlert('warning', `Quantidade solicitada (${requestedQuantity}) excede a dispon√≠vel (${availableQuantity}). Ajustando para o m√°ximo dispon√≠vel.`);
this.value = availableQuantity;
this.classList.remove('is-invalid');
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

multiBookLoans.appendChild(newRow);
}

function removeBookRow(button) {
button.closest('.loan-book-row').remove();
}

// Fun√ß√£o para lidar com a submiss√£o do formul√°rio de empr√©stimo
async function handleLoanSubmission(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const registroNumero = document.getElementById('registroNumero').value;
const userId = document.getElementById('selectedUserId').value;
const loanDate = document.getElementById('loanDate').value;
const returnDate = document.getElementById('returnDate').value;

const bookRows = document.querySelectorAll('#multiBookLoans .loan-book-row');
const books = [];
let hasError = false;

// Consulta atual da quantidade dispon√≠vel de cada livro no banco de dados
for (const row of bookRows) {
const bookId = row.querySelector('.selectedBookId').value;
const quantity = parseInt(row.querySelector('.quantity').value);

if (!bookId) {
showAlert('danger', 'Por favor, selecione um livro para todas as linhas.');
hasError = true;
break;
}
if (isNaN(quantity) || quantity <= 0) {
showAlert('danger', 'A quantidade do livro deve ser um n√∫mero positivo.');
hasError = true;
break;
}

// Consulta a quantidade atual dispon√≠vel no banco de dados
try {
const bookDoc = await db.collection('livros').doc(bookId).get();
if (!bookDoc.exists) {
showAlert('danger', 'Livro n√£o encontrado no banco de dados.');
hasError = true;
break;
}

const bookData = bookDoc.data();
const currentAvailable = bookData.quantidadeDisponivel || 0;
const bookTitle = bookData.titulo || 'Livro sem t√≠tulo';

if (quantity > currentAvailable) {
showAlert('danger', `Quantidade solicitada para "${bookTitle}" (${quantity}) excede a dispon√≠vel (${currentAvailable}).`);
hasError = true;
break;
}

// Verifica se o livro j√° foi adicionado na lista (para evitar duplicatas)
const existingBook = books.find(b => b.bookId === bookId);
if (existingBook) {
const totalQuantity = existingBook.quantity + quantity;
if (totalQuantity > currentAvailable) {
showAlert('danger', `Quantidade total solicitada para "${bookTitle}" (${totalQuantity}) excede a dispon√≠vel (${currentAvailable}).`);
hasError = true;
break;
}
existingBook.quantity = totalQuantity;
} else {
books.push({ bookId, quantity });
}

} catch (error) {
console.error('Erro ao consultar livro:', error);
showAlert('danger', 'Erro ao consultar disponibilidade do livro.');
hasError = true;
break;
}
}

if (hasError) return;

if (!userId) {
showAlert('danger', 'Por favor, selecione um usu√°rio.');
return;
}

try {
// Determina o status inicial baseado na data de devolu√ß√£o (hor√°rio Bras√≠lia)
const [day, month, year] = returnDate.split('/');
const loanReturnDate = new Date(year, month - 1, day);
loanReturnDate.setHours(0, 0, 0, 0);

const todayForStatus = getDataBrasilia();
todayForStatus.setHours(0, 0, 0, 0);

// Para novos empr√©stimos, geralmente ser√° EMPRESTADO, mas por seguran√ßa verificamos
const initialStatus = loanReturnDate < todayForStatus ? 'ATRASADO' : 'EMPRESTADO';

// Adiciona o empr√©stimo ao Firestore
const loanRef = await db.collection('emprestimos').add({
registroNumero: registroNumero,
userId: userId,
books: books,
loanDate: loanDate,
returnDate: returnDate,
status: initialStatus,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
}); // Atualiza a quantidade de livros no estoque usando opera√ß√µes at√¥micas
const updatePromises = [];
for (const book of books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
updatePromises.push(
bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(-book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(-book.quantity),
emprestados: firebase.firestore.FieldValue.increment(book.quantity)
})
);
}

// Executa todas as atualiza√ß√µes de estoque em paralelo
await Promise.all(updatePromises);

// Fecha o modal e mostra mensagem de sucesso
showAlert('success', 'Empr√©stimo registrado com sucesso!');

// Configura bot√µes de comunica√ß√£o
document.getElementById('btnEnviarWhatsappForm').style.display = 'inline-block';
document.getElementById('btnEnviarWhatsappForm').onclick = function() {
sendWhatsAppOnLoan(userId, books, loanDate, returnDate);
};

// Verifica se deve enviar email autom√°tico
const userEmail = document.getElementById('selectedUserEmail').value;
const sendEmailAuto = document.getElementById('sendEmailNotification').checked;

if (userEmail && sendEmailAuto) {
// Envia email automaticamente
try {
await sendLoanNotificationEmail(userId, userEmail, books, loanDate, returnDate, registroNumero);
showAlert('info', 'Email de notifica√ß√£o enviado automaticamente!');
} catch (error) {
console.error('Erro ao enviar email autom√°tico:', error);
showAlert('warning', 'Empr√©stimo registrado, mas n√£o foi poss√≠vel enviar o email autom√°tico.');
}
}

// Configura bot√£o de email manual
if (userEmail) {
document.getElementById('btnEnviarEmailForm').style.display = 'inline-block';
document.getElementById('btnEnviarEmailForm').onclick = function() {
sendLoanNotificationEmail(userId, userEmail, books, loanDate, returnDate, registroNumero);
};
}
const addLoanModal = bootstrap.Modal.getInstance(document.getElementById('addLoanModal'));
if (addLoanModal) addLoanModal.hide();
setTimeout(() => {
document.getElementById('btnEnviarWhatsapp').focus();
}, 500);
loadLoans();
updateLoanStats();
updateNotReturnedBar();

} catch (error) {
console.error('Erro ao registrar empr√©stimo:', error);
showAlert('danger', 'Erro ao registrar empr√©stimo.');
}
}


// Fun√ß√µes de edi√ß√£o, devolu√ß√£o, renova√ß√£o e exclus√£o de empr√©stimos
async function openEditLoanModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (doc.exists) {
const data = doc.data();
document.getElementById('editLoanId').value = doc.id;
document.getElementById('editLoanDate').value = data.loanDate;
document.getElementById('editReturnDate').value = data.returnDate;
const editLoanModal = new bootstrap.Modal(document.getElementById('editLoanModal'));
editLoanModal.show();
}
} catch (error) {
console.error('Erro ao abrir modal de edi√ß√£o:', error);
showAlert('danger', 'Erro ao carregar dados do empr√©stimo para edi√ß√£o.');
}
}

document.getElementById('editLoanForm').addEventListener('submit', async function(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const loanId = document.getElementById('editLoanId').value;
const loanDate = document.getElementById('editLoanDate').value;
const returnDate = document.getElementById('editReturnDate').value;

try {
await db.collection('emprestimos').doc(loanId).update({
loanDate: loanDate,
returnDate: returnDate
});
showAlert('success', 'Empr√©stimo atualizado com sucesso!');
bootstrap.Modal.getInstance(document.getElementById('editLoanModal')).hide();
loadLoans();
} catch (error) {
console.error('Erro ao atualizar empr√©stimo:', error);
showAlert('danger', 'Erro ao atualizar empr√©stimo.');
}
});

// Event listener para o formul√°rio de renova√ß√£o
document.getElementById('renewLoanForm').addEventListener('submit', async function(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const loanId = document.getElementById('renewLoanId').value;
const returnDate = document.getElementById('renewReturnDate').value;

// Valida√ß√£o de data
if (!isValidDateFormat(returnDate)) {
showAlert('danger', 'Data de devolu√ß√£o deve estar no formato DD/MM/AAAA');
return;
}

// Verificar se a nova data n√£o est√° no passado (usando hor√°rio de Bras√≠lia)
const [day, month, year] = returnDate.split('/');
const newReturnDate = new Date(year, month - 1, day);
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
newReturnDate.setHours(0, 0, 0, 0);

if (newReturnDate < today) {
showAlert('warning', 'A nova data de devolu√ß√£o n√£o pode ser anterior √† data atual (Hor√°rio Bras√≠lia)');
return;
}

try {
// Determina o status correto baseado na nova data de devolu√ß√£o (hor√°rio Bras√≠lia)
const [day2, month2, year2] = returnDate.split('/');
const renewReturnDate = new Date(year2, month2 - 1, day2);
renewReturnDate.setHours(0, 0, 0, 0);

const todayForStatus = getDataBrasilia();
todayForStatus.setHours(0, 0, 0, 0);

// Define o status baseado na compara√ß√£o de datas
const newStatus = renewReturnDate < todayForStatus ? 'ATRASADO' : 'EMPRESTADO';

await db.collection('emprestimos').doc(loanId).update({
returnDate: returnDate,
status: newStatus, // Status determinado dinamicamente baseado na data
renewedAt: firebase.firestore.FieldValue.serverTimestamp(),
renewedDate: formatarDataBrasil(getDataBrasilia())
});

showAlert('success', 'Empr√©stimo renovado com sucesso!');
bootstrap.Modal.getInstance(document.getElementById('renewLoanModal')).hide();
loadLoans();
} catch (error) {
console.error('Erro ao renovar empr√©stimo:', error);
showAlert('danger', 'Erro ao renovar empr√©stimo.');
}
});

async function returnLoan(loanId) {
if (!confirm('Tem certeza que deseja registrar a devolu√ß√£o deste empr√©stimo?')) return;
try {
// Busca os dados do empr√©stimo
const loanDoc = await db.collection('emprestimos').doc(loanId).get();
if (!loanDoc.exists) {
showAlert('danger', 'Empr√©stimo n√£o encontrado.');
return;
}

const loanData = loanDoc.data();

// Verifica se o empr√©stimo j√° foi devolvido
if (loanData.status === 'DEVOLVIDO') {
showAlert('warning', 'Este empr√©stimo j√° foi devolvido.');
return;
}

// Atualiza o status do empr√©stimo usando hor√°rio de Bras√≠lia
const dataDevolucao = getDataBrasilia();
await db.collection('emprestimos').doc(loanId).update({
status: 'DEVOLVIDO',
returnedAt: firebase.firestore.FieldValue.serverTimestamp(),
actualReturnDate: formatarDataBrasil(dataDevolucao)
}); // Retorna a quantidade de livros ao estoque
const updatePromises = [];
for (const book of loanData.books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
updatePromises.push(
bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(book.quantity),
emprestados: firebase.firestore.FieldValue.increment(-book.quantity)
})
);
}

// Executa todas as atualiza√ß√µes de estoque em paralelo
await Promise.all(updatePromises);

console.log(`Estoque atualizado para ${loanData.books.length} livro(s)`);
showAlert('success', 'Empr√©stimo devolvido com sucesso! Estoque atualizado.');

// Atualiza a interface
loadLoans();
updateLoanStats();

} catch (error) {
console.error('Erro ao devolver empr√©stimo:', error);
showAlert('danger', 'Erro ao devolver empr√©stimo: ' + error.message);
}
}

async function renewLoan(loanId) {
try {
// Busca os dados do empr√©stimo
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empr√©stimo n√£o encontrado.');
return;
}

const data = doc.data();

// Verifica se o empr√©stimo pode ser renovado
if (data.status === 'DEVOLVIDO') {
showAlert('warning', 'Este empr√©stimo j√° foi devolvido e n√£o pode ser renovado.');
return;
}

// Preenche o modal com os dados do empr√©stimo
document.getElementById('renewLoanId').value = loanId;

// Busca informa√ß√µes do usu√°rio e livros
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${b.quantity})`);
else bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
} catch {
bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
}
}
}

// Preenche as informa√ß√µes do empr√©stimo no modal
document.getElementById('renewLoanInfo').innerHTML = `
<div class="card">
<div class="card-body">
<h6 class="card-title">Informa√ß√µes do Empr√©stimo</h6>
<p class="mb-1"><strong>Usu√°rio:</strong> ${userName}</p>
<p class="mb-1"><strong>Livro(s):</strong> ${bookTitles.join(', ')}</p>
<p class="mb-1"><strong>Data do Empr√©stimo:</strong> ${data.loanDate}</p>
<p class="mb-0"><strong>Data de Devolu√ß√£o Atual:</strong> ${data.returnDate}</p>
</div>
</div>
`;

// Define a data padr√£o (7 dias a partir de hoje) usando hor√°rio de Bras√≠lia
const today = getDataBrasilia();
const dataComSeteDias = adicionarDias(today, 7);
const dataFormatada = formatarDataBrasil(dataComSeteDias);
document.getElementById('renewReturnDate').value = dataFormatada;

// Abre o modal
const renewLoanModal = new bootstrap.Modal(document.getElementById('renewLoanModal'));
renewLoanModal.show();

} catch (error) {
console.error('Erro ao abrir modal de renova√ß√£o:', error);
showAlert('danger', 'Erro ao carregar dados do empr√©stimo para renova√ß√£o.');
}
}

async function deleteLoan(loanId) {
if (!confirm('Tem certeza que deseja excluir este empr√©stimo? Esta a√ß√£o √© irrevers√≠vel.')) return;
try {
// Opcional: Reverter quantidade de livros se o empr√©stimo n√£o foi devolvido
const loanDoc = await db.collection('emprestimos').doc(loanId).get();
const loanData = loanDoc.data(); if (loanData.status !== 'DEVOLVIDO') {
for (const book of loanData.books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
await bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(book.quantity),
emprestados: firebase.firestore.FieldValue.increment(-book.quantity)
});
}
}

await db.collection('emprestimos').doc(loanId).delete();
showAlert('success', 'Empr√©stimo exclu√≠do com sucesso!');
loadLoans();
} catch (error) {
console.error('Erro ao excluir empr√©stimo:', error);
showAlert('danger', 'Erro ao excluir empr√©stimo.');
}
}

// Fun√ß√µes de relat√≥rio e barra de atrasos
async function generateLoanReport() {
try {
const snapshot = await db.collection('emprestimos').get();
const loans = [];

for (const doc of snapshot.docs) {
const data = doc.data();
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${b.quantity})`);
else bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
} catch (e) {
bookTitles.push(`${b.bookId} (Qtd: ${b.quantity}) - Erro ao carregar`);
}
}
}

loans.push({
'Registro': data.registroNumero,
'Usu√°rio': userName,
'Livros': bookTitles.join('; '),
'Data Empr√©stimo': data.loanDate,
'Data Devolu√ß√£o': data.returnDate,
'Status': data.status
});
}

const ws = XLSX.utils.json_to_sheet(loans);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Empr√©stimos");
XLSX.writeFile(wb, "relatorio_emprestimos.xlsx");
showAlert('success', 'Relat√≥rio gerado com sucesso!');
} catch (error) {
console.error('Erro ao gerar relat√≥rio:', error);
showAlert('danger', 'Erro ao gerar relat√≥rio de empr√©stimos.');
}
}

async function updateNotReturnedBar() {
try {
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

const snapshot = await db.collection('emprestimos')
.where('status', 'in', ['EMPRESTADO', 'ATRASADO'])
.get();

let overdueLoans = [];
let notReturnedCount = 0;

for (const doc of snapshot.docs) {
const data = doc.data();
const returnDate = new Date(data.returnDate);
returnDate.setHours(0, 0, 0, 0);

if (returnDate < today) {
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(bookDoc.data().titulo);
else bookTitles.push(b.bookId);
} catch (e) {}
}
}
overdueLoans.push(`${userName} - ${bookTitles.join(', ')} (Devolu√ß√£o: ${data.returnDate})`);
notReturnedCount++;

// Atualiza status para ATRASADO se ainda for EMPRESTADO
if (data.status === 'EMPRESTADO') {
await db.collection('emprestimos').doc(doc.id).update({ status: 'ATRASADO' });
}
}
}

const notReturnedBar = document.getElementById('notReturnedBar');
if (notReturnedCount > 0) {
notReturnedBar.style.display = 'block';
notReturnedBar.innerHTML = `
<div class="marquee" style="color: #c62828; font-weight: bold; background-color: #ffebee; padding: 10px; border-radius: 8px;">
${overdueLoans.map(loan => `<span>${loan}</span>`).join('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')}
</div>
`;
} else {
notReturnedBar.style.display = 'none';
}
} catch (error) {
console.error('Erro ao atualizar barra de atrasos:', error);
}
}

// Fun√ß√µes de gr√°ficos de status
async function updateLoanStats() {
try {
const snapshot = await db.collection('emprestimos').get();
let emprestadoCount = 0;
let atrasadoCount = 0;
let devolvidoCount = 0;
let warningsCount = 0;

const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();
if (data.status === 'EMPRESTADO') {
// Converte a data de devolu√ß√£o do formato DD/MM/AAAA para Date
let returnDate;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
}
}

if (returnDate && returnDate < today) {
atrasadoCount++;
warningsCount++; // Cada empr√©stimo atrasado gera uma advert√™ncia
} else {
emprestadoCount++;
}
} else if (data.status === 'ATRASADO') {
atrasadoCount++;
warningsCount++; // Cada empr√©stimo atrasado gera uma advert√™ncia
} else if (data.status === 'DEVOLVIDO') {
devolvidoCount++;
}
}

document.getElementById('countEmprestado').textContent = emprestadoCount;
document.getElementById('countAtrasado').textContent = atrasadoCount;
document.getElementById('countDevolvido').textContent = devolvidoCount;
document.getElementById('countWarnings').textContent = warningsCount;

// Atualiza os gr√°ficos de pizza
updatePieChart('emprestado', emprestadoCount, snapshot.size);
updatePieChart('atrasado', atrasadoCount, snapshot.size);
updatePieChart('devolvido', devolvidoCount, snapshot.size);
updatePieChart('warnings', warningsCount, snapshot.size);

} catch (error) {
console.error('Erro ao atualizar estat√≠sticas de empr√©stimos:', error);
}
}

// Fun√ß√£o de teste para verificar parsing de datas (pode ser executada no console)
function testDateParsing() {
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

console.log('=== TESTE DE PARSING DE DATAS ===');
console.log('Data de hoje:', today.toLocaleDateString('pt-BR'));

// Teste com diferentes datas
const testDates = [
'28/06/2025', // 3 dias atr√°s
'29/06/2025', // 2 dias atr√°s
'30/06/2025', // 1 dia atr√°s
'01/07/2025', // hoje
'02/07/2025', // amanh√£
'08/07/2025' // 7 dias √† frente
];

testDates.forEach(dateStr => {
const dateParts = dateStr.split('/');
const parsedDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
parsedDate.setHours(0, 0, 0, 0);

const isLate = parsedDate < today;
const daysDiff = Math.ceil(Math.abs(today - parsedDate) / (1000 * 60 * 60 * 24));

console.log(`Data: ${dateStr} | Parsed: ${parsedDate.toLocaleDateString('pt-BR')} | Atrasado: ${isLate} | Diferen√ßa: ${daysDiff} dias`);
});
}

function updatePieChart(status, count, total) {
const circumference = 2 * Math.PI * 38; // 2 * PI * raio
const percentage = total > 0 ? (count / total) : 0;
const strokeDashoffset = circumference * (1 - percentage);
document.querySelector(`.pie-fg-${status}`).style.strokeDasharray = `${circumference} ${circumference}`;
document.querySelector(`.pie-fg-${status}`).style.strokeDashoffset = strokeDashoffset;
} function showLoansByStatus(status) {
const tbody = document.getElementById('loansTableBody');
tbody.innerHTML = '<tr><td colspan="6">Buscando...</td></tr>';

// Para atrasos, busca empr√©stimos ativos e verifica as datas
if (status === 'ATRASADO') {
db.collection('emprestimos')
.where('status', 'in', ['EMPRESTADO', 'ATRASADO'])
.get()
.then(async (snapshot) => {
tbody.innerHTML = '';
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0); // Zera as horas para comparar apenas a data (hor√°rio Bras√≠lia)

const overdueLoans = [];

for (const doc of snapshot.docs) {
const data = doc.data();

// Converte a data de devolu√ß√£o para Date
let returnDate;
if (data.returnDate) {
// Assume formato DD/MM/AAAA - usando o mesmo m√©todo da fun√ß√£o loadLoans
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
}
}

// Verifica se est√° atrasado (data de devolu√ß√£o menor que hoje)
if (returnDate && returnDate < today) {
overdueLoans.push({ doc, data });
}
}

if (overdueLoans.length === 0) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empr√©stimo atrasado encontrado.</td></tr>';
return;
}

for (const { doc, data } of overdueLoans) {
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}

let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usu√°rio n√£o encontrado';
} catch {
userName = 'Usu√°rio n√£o encontrado';
}

// Calcula dias de atraso usando o mesmo m√©todo da fun√ß√£o loadLoans
let diffDays = 0;
if (returnDate) {
const diffTime = Math.abs(today - returnDate);
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

tbody.innerHTML += `
<tr style="background-color: #ffe6e6;">
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status status-atrasado">ATRASADO (${diffDays} dias)</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
})
.catch((error) => {
console.error('Erro ao buscar empr√©stimos atrasados:', error);
showAlert('danger', 'Erro ao buscar empr√©stimos atrasados.');
});
} else {
// Para outros status, mant√©m a l√≥gica original
db.collection('emprestimos')
.where('status', '==', status)
.get()
.then(async (snapshot) => {
tbody.innerHTML = '';
if (snapshot.empty) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empr√©stimo encontrado.</td></tr>';
return;
}
for (const doc of snapshot.docs) {
const data = doc.data();
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usu√°rio n√£o encontrado';
} catch {
userName = 'Usu√°rio n√£o encontrado';
}
let statusClass = '';
if (data.status === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (data.status === 'ATRASADO') statusClass = 'status-atrasado';
else if (data.status === 'DEVOLVIDO') statusClass = 'status-devolvido';

// Calcula dias de atraso se aplic√°vel
let diffDays = 0;
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
if (data.status === 'ATRASADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (data.status === 'EMPRESTADO' || data.status === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;

// Adiciona bot√£o de advert√™ncia para qualquer atraso
if (data.status === 'ATRASADO' && diffDays > 0) {
const hasWarning = data.hasWarning ? 'text-warning' : 'text-danger';
const warningTitle = data.hasWarning ? 
`Advert√™ncia j√° emitida em ${data.warningDate || 'data n√£o dispon√≠vel'}` : 
`Atraso de ${diffDays} dias - Emitir advert√™ncia`;

actionBtns += `
<button class="btn btn-sm btn-outline-warning" title="${warningTitle}" onclick="openWarningModal('${doc.id}')">
<i class="bx bx-error ${hasWarning}"></i>
</button>
`;
}
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

// Monta o texto do status com informa√ß√µes de atraso
let statusText = data.status;
if (data.status === 'ATRASADO' && diffDays > 0) {
statusText = `ATRASADO (${diffDays} ${diffDays === 1 ? 'dia' : 'dias'})`;
}

tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status ${statusClass}">${statusText}</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
})
.catch((error) => {
console.error('Erro ao buscar empr√©stimos:', error);
showAlert('danger', 'Erro ao buscar empr√©stimos.');
});
}
}

// Fun√ß√µes de impress√£o de comprovante
let signaturePad = null;
async function openPrintLoanModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (doc.exists) {
const data = doc.data();
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let booksHtml = '';
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) booksHtml += `<li>${bookDoc.data().titulo} (Qtd: ${b.quantity})</li>`;
else booksHtml += `<li>${b.bookId} (Qtd: ${b.quantity}) - Livro n√£o encontrado</li>`;
} catch (e) {
booksHtml += `<li>${b.bookId} (Qtd: ${b.quantity}) - Erro ao carregar livro</li>`;
}
}
}

const receiptContent = `
<p><strong>Registro:</strong> ${data.registroNumero}</p>
<p><strong>Usu√°rio:</strong> ${userName}</p>
<p><strong>Livros:</strong></p>
<ul>${booksHtml}</ul>
<p><strong>Data do Empr√©stimo:</strong> ${data.loanDate}</p>
<p><strong>Data de Devolu√ß√£o:</strong> ${data.returnDate}</p>
<p><strong>Status:</strong> ${data.status}</p>
`;
document.getElementById('loanReceiptContent').innerHTML = receiptContent;

const canvas = document.getElementById('signaturePad');
signaturePad = new SignaturePad(canvas);

const printLoanModal = new bootstrap.Modal(document.getElementById('printLoanModal'));
printLoanModal.show();
}
} catch (error) {
console.error('Erro ao abrir modal de impress√£o:', error);
showAlert('danger', 'Erro ao carregar dados do empr√©stimo para impress√£o.');
}
}

function clearSignature() {
if (signaturePad) {
signaturePad.clear();
}
}

function printLoanReceipt() {
const printArea = document.getElementById('printArea');
if (!printArea) {
showAlert('danger', 'Erro ao encontrar √°rea de impress√£o.');
return;
}
// Abre uma nova janela para impress√£o, preservando o layout do comprovante
const printWindow = window.open('', '', 'width=800,height=600');
printWindow.document.write(`
<html>
<head>
<title>Comprovante de Empr√©stimo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
body { font-family: 'Poppins', Arial, sans-serif; margin: 30px; }
</style>
</head>
<body>
${printArea.innerHTML}
</body>
</html>
`);
printWindow.document.close();
printWindow.focus();
printWindow.print();
printWindow.close();
}

// Vari√°veis globais para assinaturas da advert√™ncia
let warningSignaturePad = null;
let librarianSignaturePad = null;
let currentWarningLoanId = null;

// Fun√ß√£o para abrir modal de advert√™ncia
async function openWarningModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empr√©stimo n√£o encontrado.');
return;
}

const loanData = doc.data();
currentWarningLoanId = loanId;

// Calcula dias de atraso
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

let returnDate;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
}
}

const diffTime = Math.abs(today - returnDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays < 1) {
showAlert('info', `Este empr√©stimo n√£o est√° em atraso. Advert√™ncia aplic√°vel apenas para empr√©stimos atrasados.`);
return;
}

// Busca dados do usu√°rio
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : null;

// Busca t√≠tulos dos livros
let bookTitles = [];
if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${book.quantity})`);
} else {
bookTitles.push(`${book.bookId} (Qtd: ${book.quantity})`);
}
} catch (e) {
bookTitles.push(`${book.bookId} (Qtd: ${book.quantity}) - Erro ao carregar`);
}
}
}

// Preenche dados do usu√°rio
const userDataHtml = userData ? `
<p class="mb-1"><strong>Nome:</strong> ${userData.nome || 'N/A'}</p>
<p class="mb-1"><strong>Matr√≠cula:</strong> ${userData.matricula || 'N/A'}</p>
<p class="mb-1"><strong>Fun√ß√£o:</strong> ${userData.funcao || 'N/A'}</p>
${userData.funcao === 'aluno' ? `
<p class="mb-1"><strong>S√©rie:</strong> ${userData.serie || 'N/A'}</p>
<p class="mb-1"><strong>Turma:</strong> ${userData.turma || 'N/A'}</p>
<p class="mb-0"><strong>Turno:</strong> ${userData.turno || 'N/A'}</p>
` : `
<p class="mb-0"><strong>Email:</strong> ${userData.email || 'N/A'}</p>
`}
` : '<p class="mb-0">Dados do usu√°rio n√£o encontrados</p>';

document.getElementById('warningUserData').innerHTML = userDataHtml;

// Preenche detalhes do empr√©stimo
const loanDetailsHtml = `
<div class="row">
<div class="col-md-6">
<p class="mb-1"><strong>Registro:</strong> ${loanData.registroNumero || 'N/A'}</p>
<p class="mb-1"><strong>Data do Empr√©stimo:</strong> ${loanData.loanDate}</p>
<p class="mb-1"><strong>Data de Devolu√ß√£o:</strong> ${loanData.returnDate}</p>
</div>
<div class="col-md-6">
<p class="mb-1"><strong>Dias de Atraso:</strong> <span class="text-danger fw-bold">${diffDays} dias</span></p>
<p class="mb-1"><strong>Status:</strong> <span class="badge bg-danger">ATRASADO</span></p>
</div>
</div>
<div class="mt-3">
<p class="mb-1"><strong>Livros em Atraso:</strong></p>
<ul class="mb-0">
${bookTitles.map(title => `<li>${title}</li>`).join('')}
</ul>
</div>
`;

document.getElementById('warningLoanDetails').innerHTML = loanDetailsHtml;

// Preenche consequ√™ncias baseadas no tempo de atraso
let consequencesHtml = '<h6 class="alert-heading">Consequ√™ncias do Atraso:</h6><ul class="mb-0">';

if (diffDays >= 1) {
consequencesHtml += '<li>Orienta√ß√£o sobre a import√¢ncia da devolu√ß√£o no prazo</li>';
}
if (diffDays >= 3) {
consequencesHtml += '<li>Advert√™ncia formal por escrito</li>';
}
if (diffDays >= 7) {
consequencesHtml += '<li>Suspens√£o tempor√°ria do direito a novos empr√©stimos</li>';
consequencesHtml += '<li>Aplica√ß√£o de multa conforme regulamento interno</li>';
}
if (diffDays >= 14) {
consequencesHtml += '<li>Registro em ficha disciplinar (para estudantes)</li>';
consequencesHtml += '<li>Comunica√ß√£o aos pais/respons√°veis (se menor de idade)</li>';
}
if (diffDays >= 30) {
consequencesHtml += '<li>Suspens√£o prolongada de empr√©stimos (at√© 30 dias ap√≥s devolu√ß√£o)</li>';
consequencesHtml += '<li>Avalia√ß√£o para substitui√ß√£o do material em caso de perda</li>';
}

consequencesHtml += '<li>Em caso de perda ou dano, ressarcimento do valor do material</li>';
consequencesHtml += '</ul>';

document.getElementById('warningConsequences').innerHTML = consequencesHtml;

// Define data da advert√™ncia
const dataAdvertencia = getDataBrasilia();
document.getElementById('warningDate').textContent = formatarDataBrasil(dataAdvertencia);

// Inicializa pads de assinatura
const warningCanvas = document.getElementById('warningSignaturePad');
const librarianCanvas = document.getElementById('librarianSignaturePad');

warningSignaturePad = new SignaturePad(warningCanvas, {
backgroundColor: '#ffffff',
penColor: '#000000'
});

librarianSignaturePad = new SignaturePad(librarianCanvas, {
backgroundColor: '#ffffff',
penColor: '#000000'
});

// Abre o modal
const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
warningModal.show();

} catch (error) {
console.error('Erro ao abrir modal de advert√™ncia:', error);
showAlert('danger', 'Erro ao carregar dados para advert√™ncia.');
}
}

// Fun√ß√£o para limpar assinatura do usu√°rio
function clearWarningSignature() {
if (warningSignaturePad) {
warningSignaturePad.clear();
}
}

// Fun√ß√£o para limpar assinatura do bibliotec√°rio
function clearLibrarianSignature() {
if (librarianSignaturePad) {
librarianSignaturePad.clear();
}
}

// Fun√ß√£o para salvar advert√™ncia no banco de dados
async function saveWarning() {
try {
if (!currentWarningLoanId) {
showAlert('danger', 'ID do empr√©stimo n√£o encontrado.');
return;
}

if (!warningSignaturePad || warningSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, colete a assinatura do usu√°rio antes de salvar.');
return;
}

if (!librarianSignaturePad || librarianSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, adicione a assinatura do respons√°vel pela biblioteca.');
return;
}

const saveBtn = document.getElementById('saveWarningBtn');
saveBtn.disabled = true;
saveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Salvando...';

// Converte assinaturas para base64
const userSignature = warningSignaturePad.toDataURL();
const librarianSignature = librarianSignaturePad.toDataURL();

// Salva a advert√™ncia
const dataAdvertenciaSalvar = getDataBrasilia();
await db.collection('advertencias').add({
loanId: currentWarningLoanId,
createdAt: firebase.firestore.FieldValue.serverTimestamp(),
warningDate: formatarDataBrasil(dataAdvertenciaSalvar),
userSignature: userSignature,
librarianSignature: librarianSignature,
status: 'EMITIDA'
});

// Atualiza o empr√©stimo com flag de advert√™ncia
const dataAdvertenciaUpdate = getDataBrasilia();
await db.collection('emprestimos').doc(currentWarningLoanId).update({
hasWarning: true,
warningDate: formatarDataBrasil(dataAdvertenciaUpdate)
});

showAlert('success', 'Advert√™ncia salva com sucesso!');

// Fecha o modal
const warningModal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
if (warningModal) warningModal.hide();

// Atualiza a tabela
loadLoans();

} catch (error) {
console.error('Erro ao salvar advert√™ncia:', error);
showAlert('danger', 'Erro ao salvar advert√™ncia: ' + error.message);
} finally {
const saveBtn = document.getElementById('saveWarningBtn');
saveBtn.disabled = false;
saveBtn.innerHTML = '<i class="bx bx-save me-2"></i>Salvar Advert√™ncia';
}
}

// Fun√ß√£o para imprimir advert√™ncia
function printWarning() {
if (!warningSignaturePad || warningSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, colete a assinatura do usu√°rio antes de imprimir.');
return;
}

if (!librarianSignaturePad || librarianSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, adicione a assinatura do respons√°vel pela biblioteca.');
return;
}

const printArea = document.getElementById('warningPrintArea');
if (!printArea) {
showAlert('danger', 'Erro ao encontrar √°rea de impress√£o.');
return;
}

// Abre uma nova janela para impress√£o
const printWindow = window.open('', '', 'width=800,height=600');
printWindow.document.write(`
<html>
<head>
<title>Advert√™ncia por Atraso - ${SYSTEM_CONFIG.schoolName}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
body { 
font-family: 'Arial', sans-serif; 
margin: 20px; 
font-size: 12px;
line-height: 1.4;
}
.print-header {
text-align: center;
border-bottom: 2px solid #dc3545;
padding-bottom: 15px;
margin-bottom: 20px;
display: flex;
align-items: center;
justify-content: center;
gap: 20px;
}
.print-header-content {
flex: 1;
}
.logo {
width: 60px;
height: 60px;
object-fit: contain;
}
.alert { 
border: 1px solid #dc3545 !important;
background-color: #f8d7da !important;
color: #721c24 !important;
padding: 8px 12px;
margin-bottom: 15px;
}
.card { 
border: 1px solid #ddd; 
margin-bottom: 15px;
}
.card-header { 
background-color: #f8f9fa; 
border-bottom: 1px solid #ddd;
padding: 8px 12px;
font-weight: bold;
}
.card-body { 
padding: 12px;
}
.signature-area {
border: 2px solid #dc3545;
height: 80px;
margin: 10px 0;
background-image: url('${warningSignaturePad.toDataURL()}');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
}
.librarian-signature-area {
border: 2px solid #dc3545;
height: 80px;
margin: 10px 0;
background-image: url('${librarianSignaturePad.toDataURL()}');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
}
@media print {
.modal-header, .modal-footer { display: none !important; }
.btn-close { display: none !important; }
}

/* Email notification section styles */
.email-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 15px;
    margin-top: 15px;
}

.email-info {
    background-color: #d1ecf1;
    color: #0c5460;
    padding: 10px;
    border-radius: 0.25rem;
    margin-bottom: 10px;
    border-left: 4px solid #bee5eb;
}

.email-icon {
    color: #17a2b8;
    margin-right: 5px;
}

.email-checkbox {
    margin-left: 5px;
}
</style>
</head>
<body>
<div class="print-header">
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'">
<div class="print-header-content">
<h3 style="color: #dc3545; margin: 0;">ADVERT√äNCIA POR ATRASO</h3>
<h5 style="margin: 5px 0 0 0;">${SYSTEM_CONFIG.schoolName}</h5>
<p style="margin: 5px 0 0 0;">Sistema de Gerenciamento de Biblioteca</p>
</div>
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'" style="opacity: 0.3;">
</div>
${printArea.querySelector('.modal-body').innerHTML}
<div style="margin-top: 30px; display: flex; justify-content: space-between;">
<div style="text-align: center; width: 45%;">
<div class="signature-area"></div>
<p style="margin: 5px 0; border-top: 1px solid #000; padding-top: 5px;">
<strong>Assinatura do Usu√°rio</strong>
</p>
</div>
<div style="text-align: center; width: 45%;">
<div class="librarian-signature-area"></div>
<p style="margin: 5px 0; border-top: 1px solid #000; padding-top: 5px;">
<strong>Assinatura do Respons√°vel</strong>
</p>
</div>
</div>
</body>
</html>
`);
printWindow.document.close();
printWindow.focus();
printWindow.print();
printWindow.close();
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
loadLoans();
updateNotReturnedBar();
updateLoanStats();
loadSimpleWarnings(); // Carrega a contagem inicial de advert√™ncias

// Inicializa Flatpickr para campos de data
flatpickr("#loanDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#returnDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#editLoanDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#editReturnDate", {
dateFormat: "d/m/Y",
locale: "pt"
});

// Adiciona listener para o bot√£o de gerar relat√≥rio
const generateReportBtn = document.getElementById('generateReportBtn');
if (generateReportBtn) {
generateReportBtn.addEventListener('click', generateLoanReport);
}

// Adiciona listener para o bot√£o de busca principal
const searchButton = document.querySelector('.search-box button');
if (searchButton) {
searchButton.addEventListener('click', searchLoans);
}

// Adiciona listener para o input de busca principal
const searchInput = document.getElementById('searchInput');
if (searchInput) {
searchInput.addEventListener('keypress', function(event) {
if (event.key === 'Enter') {
searchLoans();
}
});

}

// Carrega os dados iniciais dos gr√°ficos
updateLoanStats();
});

// Fun√ß√£o de busca principal para a tabela de empr√©stimos
async function searchLoans() {
const query = document.getElementById('searchInput').value.toLowerCase();
const tbody = document.getElementById('loansTableBody');
tbody.innerHTML = '<tr><td colspan="6">Buscando...</td></tr>';

try {
let snapshot;
if (query) {
// Busca por registroNumero exato
snapshot = await db.collection('emprestimos')
.where('registroNumero', '==', query)
.get();

// Se n√£o encontrar por registro, tenta buscar por nome de usu√°rio ou livro
if (snapshot.empty) {
const allLoansSnapshot = await db.collection('emprestimos').get();
const filteredLoans = [];

for (const doc of allLoansSnapshot.docs) {
const data = doc.data();
let match = false;

// Busca por nome de usu√°rio
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists && userDoc.data().nome.toLowerCase().includes(query)) {
match = true;
}
} catch {}

// Busca por t√≠tulo de livro
if (!match && Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists && bookDoc.data().titulo.toLowerCase().includes(query)) {
match = true;
break;
}
} catch {}
}
}

if (match) {
filteredLoans.push(doc);
}
}
snapshot = { docs: filteredLoans }; // Simula um snapshot para o loop abaixo
}

} else {
// Se a busca estiver vazia, carrega os √∫ltimos 15 empr√©stimos
snapshot = await db.collection('emprestimos')
.orderBy('createdAt', 'desc')
.limit(15)
.get();
}



tbody.innerHTML = '';
if (snapshot.docs.length === 0) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empr√©stimo encontrado.</td></tr>';
return;
}

for (const doc of snapshot.docs) {
const data = doc.data();
let livros = '';
if ( Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
let userName = data.userId;
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let statusClass = '';
if (data.status === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (data.status === 'ATRASADO') statusClass = 'status-atrasado';
else if (data.status === 'DEVOLVIDO') statusClass = 'status-devolvido';

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (data.status === 'EMPRESTADO' || data.status === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status ${statusClass}">${data.status}</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
} catch (error) {
console.error('Erro ao buscar empr√©stimos:', error);
showAlert('danger', 'Erro ao buscar empr√©stimos.');
}
}

// Fun√ß√£o simplificada para abrir modal de advert√™ncias
function showWarningsModal() {
const warningsModal = new bootstrap.Modal(document.getElementById('warningsListModal'));
warningsModal.show();
}

// Fun√ß√£o simplificada para carregar advert√™ncias
async function loadSimpleWarnings() {
try {
const tbody = document.getElementById('simpleWarningsTableBody');
tbody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';

// Busca todos os empr√©stimos atrasados
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

tbody.innerHTML = '';
let count = 0;
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();

// Calcula dias de atraso
let daysLate = 0;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue; // S√≥ mostra se realmente est√° atrasado

// Busca dados do usu√°rio
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

// Busca t√≠tulos dos livros
let bookTitles = [];
if (Array.isArray(data.books)) {
for (const book of data.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(bookDoc.data().titulo);
} else {
bookTitles.push('Livro n√£o encontrado');
}
} catch {
bookTitles.push('Erro ao carregar livro');
}
}
}

// Determina o tipo de advert√™ncia baseado nos dias de atraso
let warningType = '';
let warningClass = '';
if (daysLate >= 1 && daysLate <= 2) {
warningType = 'Orienta√ß√£o';
warningClass = 'bg-info text-white';
} else if (daysLate >= 3 && daysLate <= 6) {
warningType = 'Advert√™ncia Leve';
warningClass = 'bg-warning text-dark';
} else if (daysLate >= 7 && daysLate <= 13) {
warningType = 'Advert√™ncia Grave';
warningClass = 'bg-danger text-white';
} else if (daysLate >= 14) {
warningType = 'Suspens√£o';
warningClass = 'bg-dark text-white';
}

const formattedDate = formatarDataBrasil(getDataBrasilia());

count++;
tbody.innerHTML += `
<tr>
<td>${formattedDate}</td>
<td>${userName}</td>
<td>${bookTitles.join(', ')}</td>
<td><span class="badge bg-danger">${daysLate} dias</span></td>
<td><span class="badge ${warningClass}">${warningType}</span></td>
<td>
<div class="btn-group btn-group-sm">
<button class="btn btn-outline-primary" onclick="printSimpleWarning('${doc.id}', '${daysLate}', '${warningType}')" title="Imprimir">
<i class="bx bx-printer"></i>
</button>
<button class="btn btn-outline-info" onclick="sendWarningEmail('${doc.id}')" title="Enviar Email">
<i class="bx bx-envelope"></i>
</button>
</div>
</td>
</tr>
`;
}

if (count === 0) {
tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma advert√™ncia pendente</td></tr>';
}

document.getElementById('warningsCountDisplay').textContent = count;
document.getElementById('countWarnings').textContent = count;

} catch (error) {
console.error('Erro ao carregar advert√™ncias:', error);
document.getElementById('simpleWarningsTableBody').innerHTML = 
'<tr><td colspan="6" class="text-center text-danger">Erro ao carregar advert√™ncias</td></tr>';
}
}

// Fun√ß√£o para imprimir advert√™ncia simples
async function printSimpleWarning(loanId, daysLate, warningType) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empr√©stimo n√£o encontrado.');
return;
}

const loanData = doc.data();

// Busca dados do usu√°rio
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : {};

// Busca t√≠tulos dos livros
let bookTitles = [];
if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${book.quantity})`);
}
} catch {}
}
}

const currentDate = formatarDataBrasil(getDataBrasilia());

// Cria conte√∫do para impress√£o
const printContent = `
<html>
<head>
<title>Advert√™ncia - ${SYSTEM_CONFIG.schoolName}</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; font-size: 14px; }
.header { 
text-align: center; 
border-bottom: 2px solid #dc3545; 
padding-bottom: 15px; 
margin-bottom: 20px; 
display: flex;
align-items: center;
justify-content: center;
gap: 20px;
}
.header-content {
flex: 1;
}
.logo {
width: 80px;
height: 80px;
object-fit: contain;
}
.warning-box { border: 2px solid #dc3545; padding: 15px; margin: 20px 0; background-color: #fff5f5; }
.info-box { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 15px 0; }
.signature-line { border-bottom: 1px solid #000; margin-top: 40px; text-align: center; padding-top: 5px; }
@media print {
.logo { width: 60px; height: 60px; }
}
</style>
</head>
<body>
<div class="header">
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'">
<div class="header-content">
<h2 style="color: #dc3545; margin: 0;">ADVERT√äNCIA POR ATRASO</h2>
<h4 style="margin: 5px 0;">${SYSTEM_CONFIG.schoolName}</h4>
<p style="margin: 5px 0;">Sistema de Gerenciamento de Biblioteca</p>
<p style="margin: 5px 0;">Data: ${currentDate}</p>
</div>
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'" style="opacity: 0.3;">
</div>

<div class="warning-box">
<h3 style="color: #dc3545; margin-top: 0;">TIPO: ${warningType.toUpperCase()}</h3>
<p><strong>Dias de Atraso:</strong> ${daysLate} dias</p>
</div>

<div class="info-box">
<h4>Dados do Usu√°rio:</h4>
<p><strong>Nome:</strong> ${userData.nome || 'N/A'}</p>
<p><strong>Matr√≠cula:</strong> ${userData.matricula || 'N/A'}</p>
<p><strong>Fun√ß√£o:</strong> ${userData.funcao || 'N/A'}</p>
</div>

<div class="info-box">
<h4>Detalhes do Empr√©stimo:</h4>
<p><strong>Registro:</strong> ${loanData.registroNumero || 'N/A'}</p>
<p><strong>Data do Empr√©stimo:</strong> ${loanData.loanDate}</p>
<p><strong>Data de Devolu√ß√£o:</strong> ${loanData.returnDate}</p>
<p><strong>Livros:</strong></p>
<ul>
${bookTitles.map(title => `<li>${title}</li>`).join('')}
</ul>
</div>

<div class="warning-box">
<h4>A√ß√£o Necess√°ria:</h4>
<p>Devolu√ß√£o imediata do(s) material(is) em atraso.</p>
<p>O n√£o cumprimento desta advert√™ncia poder√° resultar em suspens√£o de novos empr√©stimos.</p>
</div>

<div style="margin-top: 60px;">
<div style="display: flex; justify-content: space-between;">
<div style="width: 45%;">
<div class="signature-line">Assinatura do Usu√°rio</div>
</div>
<div style="width: 45%;">
<div class="signature-line">Assinatura do Respons√°vel</div>
</div>
</div>
</div>

<p style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
Este documento foi gerado automaticamente pelo Sistema SIGEB<br>
${SYSTEM_CONFIG.schoolName}
</p>
</body>
</html>
`;

// Abre janela de impress√£o
const printWindow = window.open('', '_blank');
printWindow.document.write(printContent);
printWindow.document.close();
printWindow.focus();
printWindow.print();

showAlert('success', 'Advert√™ncia enviada para impress√£o!');

} catch (error) {
console.error('Erro ao imprimir advert√™ncia:', error);
showAlert('danger', 'Erro ao gerar advert√™ncia para impress√£o.');
}
}

// Fun√ß√£o para enviar advert√™ncia por email
async function sendWarningEmail(loanId) {
try {
showAlert('info', 'Funcionalidade de email em desenvolvimento...');
} catch (error) {
console.error('Erro ao enviar email:', error);
showAlert('danger', 'Erro ao enviar email.');
}
}

// Fun√ß√£o para exportar relat√≥rio simples
async function exportSimpleWarningsReport() {
try {
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

const warnings = [];
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();

// Calcula dias de atraso
let daysLate = 0;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue;

// Busca dados do usu√°rio
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

// Busca t√≠tulos dos livros
let bookTitles = [];
if (Array.isArray(data.books)) {
for (const book of data.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(bookDoc.data().titulo);
}
} catch {}
}
}

// Tipo de advert√™ncia
let warningType = '';
if (daysLate >= 1 && daysLate <= 2) warningType = 'Orienta√ß√£o';
else if (daysLate >= 3 && daysLate <= 6) warningType = 'Advert√™ncia Leve';
else if (daysLate >= 7 && daysLate <= 13) warningType = 'Advert√™ncia Grave';
else if (daysLate >= 14) warningType = 'Suspens√£o';

warnings.push({
'Data': formatarDataBrasil(getDataBrasilia()),
'Usu√°rio': userName,
'Livros': bookTitles.join('; '),
'Dias de Atraso': daysLate,
'Tipo de Advert√™ncia': warningType,
'Data do Empr√©stimo': data.loanDate,
'Data de Devolu√ß√£o': data.returnDate
});
}

if (warnings.length === 0) {
showAlert('warning', 'Nenhuma advert√™ncia encontrada para exportar');
return;
}

const ws = XLSX.utils.json_to_sheet(warnings);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Advert√™ncias");

const now = getDataBrasilia();
const fileName = `advertencias_${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}_${now.getDate().toString().padStart(2, '0')}.xlsx`;

XLSX.writeFile(wb, fileName);
showAlert('success', 'Relat√≥rio de advert√™ncias exportado com sucesso!');

} catch (error) {
console.error('Erro ao exportar relat√≥rio:', error);
showAlert('danger', 'Erro ao exportar relat√≥rio de advert√™ncias');
}
}

// Carregar advert√™ncias quando o modal for aberto
document.getElementById('warningsListModal').addEventListener('shown.bs.modal', function () {
loadSimpleWarnings();
});

// Configurar busca em tempo real para advert√™ncias
document.getElementById('warningsSearchInput').addEventListener('input', function() {
clearTimeout(this.searchTimeout);
this.searchTimeout = setTimeout(() => {
loadSimpleWarnings();
}, 500);
});

// Atualize todos os usu√°rios para ter o campo nomeSearch
db.collection('usuarios').get().then(snapshot => {
snapshot.forEach(doc => {
const nome = doc.data().nome || '';
const nomeSearch = nome.toLowerCase().split(' ');
db.collection('usuarios').doc(doc.id).update({ nomeSearch });
});
});
db.collection('livros').get().then(snapshot => {
snapshot.forEach(doc => {
const titulo = doc.data().titulo || '';
const tituloSearch = titulo.toLowerCase().split(' ');
db.collection('livros').doc(doc.id).update({ tituloSearch });
});
}); </script>
<script>
document.addEventListener('focusin', function(e) {
let el = e.target;
while (el) {
if (el.getAttribute && el.getAttribute('aria-hidden') === 'true') {
// Remove o foco se estiver dentro de um aria-hidden
if (typeof el.blur === 'function') el.blur();
// Move o foco para o body
document.body.focus();
break;
}
el = el.parentElement;
}
});

</script>
<script>
// Garante que aria-hidden="true" seja removido de modais abertos
function fixAriaHiddenOnOpenModals() {
document.querySelectorAll('.modal').forEach(function(modal) {
const isVisible = window.getComputedStyle(modal).display === 'block';
if (isVisible) {
// Remove aria-hidden se existir
if (modal.hasAttribute('aria-hidden')) {
modal.removeAttribute('aria-hidden');
}
}
});
}

// Monitora abertura de modais Bootstrap para garantir acessibilidade
document.addEventListener('shown.bs.modal', fixAriaHiddenOnOpenModals);
document.addEventListener('DOMContentLoaded', function() {
// Corrige ao carregar a p√°gina caso algum modal esteja aberto
fixAriaHiddenOnOpenModals();
});

// Tamb√©m corrige ao abrir modal programaticamente (ex: printLoanModal)
const printLoanModal = document.getElementById('printLoanModal');
if (printLoanModal) {
printLoanModal.addEventListener('shown.bs.modal', function() {
if (printLoanModal.hasAttribute('aria-hidden')) {
printLoanModal.removeAttribute('aria-hidden');
}
});
}
</script>
</body>
</html>
