<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SIGEB - Empréstimos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
body {
font-family: 'Poppins', sans-serif;
background: #f0f2f5;
margin: 0;
padding: 0;
}
.sidebar {
position: fixed;
top: 0;
left: 0;
height: 100%;
width: 250px;
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
color: white;
padding: 20px;
transition: all 0.3s ease;
z-index: 1000;
}
.sidebar-header {
padding: 20px 0;
text-align: center;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.sidebar-header h3 {
background: linear-gradient(90deg, #00f2fe, #4facfe);
-webkit-background-clip: text;
background-clip: text;
-webkit-text-fill-color: transparent;
margin: 0;
font-weight: 600;
}
.menu-items {
padding: 20px 0;
}
.menu-item {
padding: 12px 20px;
color: white;
text-decoration: none;
display: flex;
align-items: center;
transition: all 0.3s ease;
border-radius: 8px;
margin-bottom: 5px;
}
.menu-item:hover, .menu-item.active {
background: rgba(255, 255, 255, 0.1);
color: #4facfe;
}
.menu-item i {
margin-right: 10px;
font-size: 1.2rem;
}
.main-content {
margin-left: 250px;
padding: 20px;
transition: all 0.3s ease;
}
.page-header {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}
.loans-table {
background: white;
border-radius: 15px;
padding: 20px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.table {
margin-bottom: 0;
}
.table th {
border-top: none;
font-weight: 600;
color: #1a1a2e;
}
.loan-status {
display: inline-block;
padding: 5px 10px;
border-radius: 20px;
font-size: 0.8rem;
}
.status-emprestado {
background: #e8f5e9;
color: #2e7d32;
}
.status-atrasado {
background: #ffebee;
color: #c62828;
}
.status-devolvido {
background: #e3f2fd;
color: #1565c0;
}
.add-button {
background: linear-gradient(90deg, #00f2fe, #4facfe);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.add-button:hover {
transform: translateY(-2px);
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.search-box {
display: flex;
gap: 10px;
margin-bottom: 20px;
}
.search-box input {
flex: 1;
padding: 10px 15px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 0.9rem;
}
.action-buttons {
display: flex;
gap: 10px;
}
.action-button {
background: none;
border: none;
padding: 5px;
cursor: pointer;
transition: all 0.3s ease;
}
.action-button:hover {
transform: translateY(-2px);
}
.return-button {
color: #4facfe;
}
.renew-button {
color: #2e7d32;
}
@media (max-width: 768px) {
.sidebar {
transform: translateX(-100%);
}
.main-content {
margin-left: 0;
}
.sidebar.active {
transform: translateX(0);
}
.table-responsive {
margin-bottom: 0;
}
}
#notReturnedBar {
position: relative;
overflow: hidden;
height: 48px;
min-height: 48px;
display: flex;
align-items: center;
}
#notReturnedBar .marquee {
display: inline-block;
white-space: nowrap;
will-change: transform;
/* Velocidade ajustada para leitura humana: 40s */
animation: marquee-bar 40s linear infinite;
}
@keyframes marquee-bar {
0% { transform: translateX(100%);}
100% { transform: translateX(-100%);}
}

@keyframes pulse {
0% { transform: scale(1); box-shadow: 0 0 5px rgba(25, 135, 84, 0.3); }
50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(25, 135, 84, 0.6); }
100% { transform: scale(1); box-shadow: 0 0 5px rgba(25, 135, 84, 0.3); }
}

/* Estilo para badges de atraso */
.badge-atraso {
background: linear-gradient(45deg, #c62828, #d32f2f) !important;
color: white !important;
font-weight: bold;
font-size: 0.75rem !important;
padding: 0.375rem 0.75rem;
border-radius: 0.375rem;
box-shadow: 0 2px 4px rgba(198, 40, 40, 0.3);
animation: pulse-danger 2s infinite;
}

@keyframes pulse-danger {
0% { box-shadow: 0 2px 4px rgba(198, 40, 40, 0.3); }
50% { box-shadow: 0 4px 8px rgba(198, 40, 40, 0.6); }
100% { box-shadow: 0 2px 4px rgba(198, 40, 40, 0.3); }
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<!-- Firebase Initialization -->
<script>
// Corrigido: Removido import/export e inicialização modular
// Use apenas a versão compat!
const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

// Inicializa Firebase usando compat
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// Se quiser analytics (opcional, só se a API key for válida)
if (firebase.analytics) {
firebase.analytics();
}
</script>
<!-- Date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<!-- Importação do SheetJS para geração de relatórios XLS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Biblioteca para assinatura digital -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<style>
body {
font-family: 'Poppins', sans-serif;
background: #f0f2f5;
margin: 0;
padding: 0;
}
.sidebar {
position: fixed;
top: 0;
left: 0;
height: 100%;
width: 250px;
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
color: white;
padding: 20px;
transition: all 0.3s ease;
z-index: 1000;
}
.sidebar-header {
padding: 20px 0;
text-align: center;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.sidebar-header h3 {
background: linear-gradient(90deg, #00f2fe, #4facfe);
-webkit-background-clip: text;
background-clip: text;
-webkit-text-fill-color: transparent;
margin: 0;
font-weight: 600;
}
.menu-items {
padding: 20px 0;
}
.menu-item {
padding: 12px 20px;
color: white;
text-decoration: none;
display: flex;
align-items: center;
transition: all 0.3s ease;
border-radius: 8px;
margin-bottom: 5px;
}
.menu-item:hover, .menu-item.active {
background: rgba(255, 255, 255, 0.1);
color: #4facfe;
}
.menu-item i {
margin-right: 10px;
font-size: 1.2rem;
}
.main-content {
margin-left: 250px;
padding: 20px;
transition: all 0.3s ease;
}
.page-header {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}
.loans-table {
background: white;
border-radius: 15px;
padding: 20px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.table {
margin-bottom: 0;
}
.table th {
border-top: none;
font-weight: 600;
color: #1a1a2e;
}
.loan-status {
display: inline-block;
padding: 5px 10px;
border-radius: 20px;
font-size: 0.8rem;
}
.status-emprestado {
background: #e8f5e9;
color: #2e7d32;
}
.status-atrasado {
background: #ffebee;
color: #c62828;
}
.status-devolvido {
background: #e3f2fd;
color: #1565c0;
}
.add-button {
background: linear-gradient(90deg, #00f2fe, #4facfe);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.add-button:hover {
transform: translateY(-2px);
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.search-box {
display: flex;
gap: 10px;
margin-bottom: 20px;
}
.search-box input {
flex: 1;
padding: 10px 15px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 0.9rem;
}
.action-buttons {
display: flex;
gap: 10px;
}
.action-button {
background: none;
border: none;
padding: 5px;
cursor: pointer;
transition: all 0.3s ease;
}
.action-button:hover {
transform: translateY(-2px);
}
.return-button {
color: #4facfe;
}
.renew-button {
color: #2e7d32;
}
@media (max-width: 768px) {
.sidebar {
transform: translateX(-100%);
}
.main-content {
margin-left: 0;
}
.sidebar.active {
transform: translateX(0);
}
.table-responsive {
margin-bottom: 0;
}
}
#notReturnedBar {
position: relative;
overflow: hidden;
height: 48px;
min-height: 48px;
display: flex;
align-items: center;
}
#notReturnedBar .marquee {
display: inline-block;
white-space: nowrap;
will-change: transform;
/* Velocidade ajustada para leitura humana: 40s */
animation: marquee-bar 40s linear infinite;
}
@keyframes marquee-bar {
0% { transform: translateX(100%);}
100% { transform: translateX(-100%);}
}
</style>
<!-- Adicione esta linha ANTES do seu <script> principal, logo após os outros scripts externos -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
</head>
<body>
<div class="sidebar">
<div class="sidebar-header">
<h3>SIGEB</h3>
</div>
<div class="menu-items">
<a href="dashboard.html" class="menu-item">
<i class='bx bxs-dashboard'></i>
Dashboard
</a>
<a href="livros.html" class="menu-item">
<i class='bx bxs-book'></i>
Livros
</a>
<a href="usuarios.html" class="menu-item">
<i class='bx bxs-user'></i>
Usuários
</a>
<a href="emprestimos.html" class="menu-item active">
<i class='bx bxs-bookmark'></i>
Empréstimos
</a>
<a href="relatorios.html" class="menu-item" title="Relatórios do sistema">
<i class='bx bxs-report'></i>
Relatórios
</a>
<a href="configuracoes.html" class="menu-item">
<i class='bx bxs-cog'></i>
Configurações
</a>
<a href="index.html" class="menu-item">
<i class='bx bxs-log-out'></i>
Sair
</a>
</div>
</div>

<div class="main-content">
<div class="page-header">
<div>
<h2>Gerenciamento de Empréstimos</h2>
<p>Controle os empréstimos da biblioteca</p>
</div>
<div class="d-flex gap-2">

<button class="add-button" data-bs-toggle="modal" data-bs-target="#addLoanModal">
<i class='bx bx-plus'></i>
Novo Empréstimo
</button>
</div>
</div>

<!-- Barra piscante de atrasos -->
<div id="notReturnedBar" style="display:none; margin-bottom:20px;"></div>

<!-- Botões de filtro estilo gráfico -->
<div id="loanStats" class="d-flex justify-content-center align-items-center mb-4" style="gap: 40px;">
<div class="pie-btn shadow-lg" id="btnEmprestado" onclick="showLoansByStatus('EMPRESTADO')">
<div class="pie-chart pie-emprestado">
<span id="countEmprestado"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-emprestado" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Emprestados</div>
</div>
<div class="pie-btn shadow-lg" id="btnAtrasado" onclick="showLoansByStatus('ATRASADO')">
<div class="pie-chart pie-atrasado">
<span id="countAtrasado"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-atrasado" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Atrasos</div>
</div>
<div class="pie-btn shadow-lg" id="btnDevolvido" onclick="showLoansByStatus('DEVOLVIDO')">
<div class="pie-chart pie-devolvido">
<span id="countDevolvido"></span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-devolvido" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Devolvidos</div>
</div>
<div class="pie-btn shadow-lg" onclick="showWarningsModal()">
<div class="pie-chart pie-warnings">
<span id="countWarnings">0</span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-warnings" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Advertências</div>
</div>
<div class="pie-btn shadow-lg" onclick="showBlockedUsersModal()">
<div class="pie-chart pie-blocked">
<span id="countBlockedUsers">0</span>
<svg class="pie-svg" width="90" height="90">
<circle class="pie-bg" cx="45" cy="45" r="38"/>
<circle class="pie-fg pie-fg-blocked" cx="45" cy="45" r="38"/>
</svg>
</div>
<div class="pie-label">Bloqueados</div>
</div>
</div>
<style>
#loanStats {
margin-top: 40px;
margin-bottom: 40px;
gap: 40px;
}
.pie-btn {
display: flex;
flex-direction: column;
align-items: center;
cursor: pointer;
min-width: 120px;
transition: transform 0.18s, box-shadow 0.18s;
border-radius: 18px;
background: rgba(255,255,255,0.85);
box-shadow: 0 4px 24px 0 rgba(80,120,255,0.07);
padding: 18px 10px 10px 10px;
position: relative;
overflow: visible;
}
.pie-btn:hover {
transform: translateY(-4px) scale(1.06);
box-shadow: 0 8px 32px 0 rgba(80,120,255,0.13);
background: linear-gradient(120deg, #f8fbff 80%, #e3f2fd 100%);
}
.pie-chart {
width: 90px;
height: 90px;
border-radius: 50%;
position: relative;
margin-bottom: 10px;
display: flex;
align-items: center;
justify-content: center;
background: transparent;
}
.pie-chart span {
position: absolute;
left: 0; right: 0; top: 0; bottom: 0;
display: flex;
align-items: center;
justify-content: center;
font-size: 2.1rem;
font-weight: 700;
z-index: 2;
color: #222;
pointer-events: none;
text-shadow: 0 2px 8px #fff, 0 1px 0 #e3f2fd;
}
.pie-svg {
position: absolute;
left: 0; top: 0;
z-index: 1;
pointer-events: none;
}
.pie-bg {
fill: none;
stroke: #e3f2fd;
stroke-width: 10;
}
.pie-fg {
fill: none;
stroke-width: 10;
stroke-linecap: round;
transform: rotate(-90deg);
transform-origin: 50% 50%;
transition: stroke-dasharray 0.7s cubic-bezier(.4,2,.6,1), stroke 0.3s;
}
.pie-fg-emprestado { stroke: #4facfe; }
.pie-fg-atrasado { stroke: #c62828; }
.pie-fg-devolvido { stroke: #2e7d32; }
.pie-fg-warnings { stroke: #ff9800; }
.pie-fg-blocked { stroke: #9c27b0; }
.pie-label {
font-size: 1.13rem;
font-weight: 600;
margin-top: 8px;
color: #1a1a2e;
text-align: center;
letter-spacing: 0.01em;
text-shadow: 0 1px 0 #fff;
}
@media (max-width: 768px) {
#loanStats {
flex-direction: column !important;
gap: 24px !important;
}
.pie-btn {
min-width: 0;
}
}
</style>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Buscar por nome, matrícula ou registro do empréstimo...">
<button class="add-button" onclick="searchLoans()">
<i class='bx bx-search'></i> Buscar Empréstimo
</button>
</div>

<!-- Lista dos últimos 15 empréstimos -->
<div class="loans-table mt-4" id="recentLoansTable">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>Livro</th>
<th>Usuário</th>
<th>Data Empréstimo</th>
<th>Data Devolução</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="loansTableBody">
<!-- Dados serão carregados dinamicamente -->
</tbody>
</table>
</div>
</div>
<!-- Fim da lista dos últimos 15 empréstimos -->

</div>

<!-- Modal Novo Empréstimo Melhorado -->
<div class="modal fade" id="addLoanModal" tabindex="-1" aria-labelledby="addLoanModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<form id="addLoanForm" class="needs-validation" novalidate>
<div class="modal-header">
<h5 class="modal-title" id="addLoanModalLabel">Novo Empréstimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-4">
<label class="form-label" for="registroNumero">Nº Registro</label>
<input type="text" class="form-control" id="registroNumero" readonly>
</div>
<div class="col-md-8">
<label class="form-label" for="userSearch">Usuário*</label>
<div class="input-group">
<input type="text" class="form-control" id="userSearch" required placeholder="Digite nome ou matrícula">
<button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
<i class='bx bx-search'></i>
</button>
</div>
<div id="userSearchResults" class="dropdown-menu w-100"></div>
<input type="hidden" id="selectedUserId">
<input type="hidden" id="selectedUserPhone">
<div class="form-text">Selecione o usuário para o empréstimo.</div>
</div>
</div>
<!-- WhatsApp do usuário -->
<div class="row mb-3" id="whatsappSection" style="display: none;">
<div class="col-md-8">
<label class="form-label" for="userPhone">
    <i class="bx bxl-whatsapp me-1"></i>WhatsApp do Usuário
</label>
<input type="tel" class="form-control" id="userPhone" readonly>
</div>
<div class="col-md-4 d-flex align-items-end">

</div>
</div>
<div class="mb-3">
<label class="form-label">Livros*</label>
<div id="multiBookLoans">
<div class="loan-book-row row align-items-end mb-2">
<div class="col-md-6">
<label class="form-label visually-hidden" for="bookSearch0">Livro*</label>
<div class="input-group">
<input type="text" class="form-control bookSearch" id="bookSearch0" name="bookSearch0" required placeholder="Digite o título ou ISBN">
<button class="btn btn-outline-secondary" type="button" onclick="searchBooks(this)">
<i class='bx bx-search'></i>
</button>
</div>
<div class="bookSearchResults dropdown-menu w-100"></div>
<input type="hidden" class="selectedBookId" name="selectedBookId0" id="selectedBookId0">
</div>
<div class="col-md-3">
<label class="form-label visually-hidden" for="quantity0">Quantidade*</label>
<input type="number" class="form-control quantity" id="quantity0" name="quantity0" required min="1" value="1">
<div class="form-text">Disponível: <span class="availableQuantity">-</span></div>
</div>
<div class="col-md-2">
<button type="button" class="btn btn-danger removeBookRow" style="display:none;" onclick="removeBookRow(this)">
<i class="bx bx-minus"></i>
</button>
</div>
</div>
</div>
<small class="text-muted d-block mt-2">Adicione vários títulos diferentes para o mesmo usuário neste empréstimo.</small>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label for="loanDate" class="form-label">Data do Empréstimo*</label>
<input type="text" class="form-control" id="loanDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<div class="form-text">Formato: DD/MM/AAAA (ex: 27/06/2025)</div>
</div>
<div class="col-md-6 mb-3">
<label for="returnDate" class="form-label">Data de Devolução*</label>
<div class="input-group">
<input type="text" class="form-control" id="returnDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<button class="btn btn-outline-secondary" type="button" id="setDefaultReturnDate" title="Definir 7 dias padrão">
<i class='bx bx-calendar-plus'></i> 7 dias
</button>
</div>
<div class="form-text">
<span class="text-primary">Padrão: 7 dias.</span> 
<span class="text-muted">Você pode alterar conforme necessário.</span>
</div>
</div>
</div>
</div>
<!-- Rodapé do modal com opções de notificação -->
<div class="modal-footer d-flex justify-content-between align-items-center">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-success" id="btnEnviarWhatsappForm" style="display: none;">
            <i class="bx bxl-whatsapp"></i> WhatsApp
        </button>
    </div>
    <div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Registrar Empréstimo</button>
    </div>
</div>
<!-- Remova o botão WhatsApp duplicado fora do modal, se existir -->
</form>
<!-- Exemplo: Adicione este botão no modal de sucesso ou onde desejar -->
<button type="button" class="btn btn-success" id="btnEnviarWhatsapp" style="display:none; margin-top:10px;">
<i class="bx bxl-whatsapp"></i> Enviar Via WhatsApp
</button>
</div>
</div>
</div>

<!-- Modal Editar Empréstimo -->
<div class="modal fade" id="editLoanModal" tabindex="-1" aria-labelledby="editLoanModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="editLoanModalLabel">Editar Empréstimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<form id="editLoanForm" class="needs-validation" novalidate>
<input type="hidden" id="editLoanId">
<div class="row">
<div class="col-md-6 mb-3">
<label for="editLoanDate" class="form-label">Data do Empréstimo*</label>
<input type="text" class="form-control" id="editLoanDate" required>
</div>
<div class="col-md-6 mb-3">
<label for="editReturnDate" class="form-label">Data de Devolução*</label>
<div class="input-group">
<input type="text" class="form-control" id="editReturnDate" required>
<button class="btn btn-outline-secondary" type="button" id="setDefaultEditReturnDate" title="Definir 7 dias a partir da data do empréstimo">
<i class='bx bx-calendar-plus'></i> +7 dias
</button>
</div>
<div class="form-text text-muted">
Você pode alterar a data de devolução conforme necessário.
</div>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" form="editLoanForm" class="btn btn-primary">Salvar Alterações</button>
</div>
</div>
</div>
</div>

<!-- Modal Renovar Empréstimo -->
<div class="modal fade" id="renewLoanModal" tabindex="-1" aria-labelledby="renewLoanModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="renewLoanModalLabel">Renovar Empréstimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<form id="renewLoanForm" class="needs-validation" novalidate>
<input type="hidden" id="renewLoanId">

<div class="alert alert-info">
<i class="bx bx-info-circle me-2"></i>
<strong>Renovação de Empréstimo</strong><br>
Defina a nova data de devolução para este empréstimo.
</div>

<div id="renewLoanInfo" class="mb-3">
<!-- Informações do empréstimo serão carregadas aqui -->
</div>

<div class="mb-3">
<label for="renewReturnDate" class="form-label">Nova Data de Devolução*</label>
<div class="input-group">
<input type="text" class="form-control" id="renewReturnDate" required autocomplete="off" placeholder="dd/mm/aaaa">
<button class="btn btn-outline-secondary" type="button" id="setDefaultRenewReturnDate" title="Definir 7 dias a partir de hoje">
<i class='bx bx-calendar-plus'></i> +7 dias
</button>
</div>
<div class="form-text">
<span class="text-primary">Padrão: 7 dias a partir de hoje.</span> 
<span class="text-muted">Você pode alterar conforme necessário.</span>
</div>
</div>

<div class="alert alert-warning">
<i class="bx bx-info-circle me-2"></i>
<strong>Observação:</strong> A renovação atualizará apenas a data de devolução. O empréstimo continuará ativo com o novo prazo.
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" form="renewLoanForm" class="btn btn-success">
<i class="bx bx-refresh me-2"></i>Renovar Empréstimo
</button>
</div>
</div>
</div>
</div>

<!-- Modal Comprovante de Empréstimo -->
<div class="modal fade" id="printLoanModal" tabindex="-1" aria-labelledby="printLoanModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content" id="printArea">
<div class="modal-header">
<h5 class="modal-title" id="printLoanModalLabel">Comprovante de Empréstimo</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div id="loanReceiptContent">
<!-- Conteúdo preenchido via JS -->
</div>
<div class="mt-4">
<label for="userSignature" class="form-label">Assinatura do Usuário:</label>
<div style="border:1px solid #ccc; height:60px; margin-bottom:10px;">
<canvas id="signaturePad" width="350" height="60" style="width:100%;height:60px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-secondary mb-2" onclick="clearSignature()">Limpar Assinatura</button>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-primary" onclick="printLoanReceipt()">Imprimir</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
</div>
</div>
</div>
</div>

<!-- Modal de Advertência por Atraso -->
<div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content" id="warningPrintArea">
<div class="modal-header bg-danger text-white">
<h5 class="modal-title" id="warningModalLabel">
<i class="bx bx-error-circle me-2"></i>Advertência por Atraso
</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="alert alert-danger mb-4">
<h6 class="alert-heading">
<i class="bx bx-time me-2"></i>Empréstimo em Atraso
</h6>
<p class="mb-0">Este documento constitui uma advertência formal devido ao atraso na devolução de material bibliográfico.</p>
</div>

<div class="row mb-4">
<div class="col-md-6">
<div class="card">
<div class="card-header bg-light">
<h6 class="mb-0">Dados da Instituição</h6>
</div>
<div class="card-body">
<p class="mb-1"><strong>${SYSTEM_CONFIG.schoolName}</strong></p>
<p class="mb-1">Sistema de Gerenciamento de Biblioteca</p>
<p class="mb-0">Data: <span id="warningDate"></span></p>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card">
<div class="card-header bg-light">
<h6 class="mb-0">Dados do Usuário</h6>
</div>
<div class="card-body" id="warningUserData">
<!-- Preenchido via JavaScript -->
</div>
</div>
</div>
</div>

<div class="card mb-4">
<div class="card-header bg-light">
<h6 class="mb-0">Detalhes do Empréstimo</h6>
</div>
<div class="card-body" id="warningLoanDetails">
<!-- Preenchido via JavaScript -->
</div>
</div>

<div class="alert alert-warning" id="warningConsequences">
<!-- Preenchido dinamicamente via JavaScript baseado nos dias de atraso -->
</div>

<div class="alert alert-info">
<h6 class="alert-heading">Ações Necessárias:</h6>
<ol class="mb-0">
<li>Devolução imediata do material em atraso</li>
<li>Pagamento de eventual multa aplicada</li>
<li>Assinatura deste termo de advertência</li>
</ol>
</div>

<div class="mt-4">
<div class="row">
<div class="col-md-6">
<label class="form-label">Assinatura do Usuário:</label>
<div style="border: 2px solid #dc3545; height: 80px; border-radius: 5px; margin-bottom: 10px; background-color: #fff;">
<canvas id="warningSignaturePad" width="400" height="80" style="width: 100%; height: 80px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearWarningSignature()">
<i class="bx bx-eraser me-1"></i>Limpar Assinatura
</button>
</div>
<div class="col-md-6">
<label class="form-label">Assinatura do Responsável pela Biblioteca:</label>
<div style="border: 2px solid #dc3545; height: 80px; border-radius: 5px; margin-bottom: 10px; background-color: #fff;">
<canvas id="librarianSignaturePad" width="400" height="80" style="width: 100%; height: 80px;"></canvas>
</div>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLibrarianSignature()">
<i class="bx bx-eraser me-1"></i>Limpar Assinatura
</button>
</div>
</div>
</div>

<div class="mt-4 p-3 bg-light border-start border-5 border-danger">
<p class="mb-2"><strong>Declaração:</strong></p>
<p class="mb-0 small">
Declaro estar ciente das normas da biblioteca e das consequências do atraso na devolução de materiais. 
Comprometo-me a devolver o material em atraso e a cumprir as penalidades aplicadas conforme regulamento interno.
</p>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-danger" onclick="printWarning()">
<i class="bx bx-printer me-2"></i>Imprimir Advertência
</button>
<button type="button" class="btn btn-success" onclick="saveWarning()" id="saveWarningBtn">
<i class="bx bx-save me-2"></i>Salvar Advertência
</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
<i class="bx bx-x me-2"></i>Fechar
</button>
</div>
</div>
</div>
</div>

<!-- Modal de Lista de Advertências Simplificado -->
<div class="modal fade" id="warningsListModal" tabindex="-1" aria-labelledby="warningsListModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header bg-warning text-dark">
<h5 class="modal-title" id="warningsListModalLabel">
<i class="bx bx-error-circle me-2"></i>Advertências Emitidas
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-6">
<div class="input-group">
<span class="input-group-text"><i class="bx bx-search"></i></span>
<input type="text" class="form-control" id="warningsSearchInput" placeholder="Buscar por nome do usuário...">
</div>
</div>
<div class="col-md-3">
<button class="btn btn-primary w-100" onclick="loadSimpleWarnings()">
<i class="bx bx-refresh me-1"></i>Atualizar
</button>
</div>
<div class="col-md-3">
<button class="btn btn-success w-100" onclick="exportSimpleWarningsReport()">
<i class="bx bx-download me-1"></i>Exportar
</button>
</div>
</div>

<div class="alert alert-info">
<i class="bx bx-info-circle me-2"></i>
Total de advertências: <span id="warningsCountDisplay" class="fw-bold">0</span>
</div>

<div class="table-responsive">
<table class="table table-hover">
<thead class="table-warning">
<tr>
<th>Data</th>
<th>Usuário</th>
<th>Livro(s)</th>
<th>Dias de Atraso</th>
<th>Tipo</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="simpleWarningsTableBody">
<tr>
<td colspan="6" class="text-center">Carregando advertências...</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
<i class="bx bx-x me-2"></i>Fechar
</button>
</div>
</div>
</div>
</div>

<!-- Modal de Usuários Bloqueados -->
<div class="modal fade" id="blockedUsersModal" tabindex="-1" aria-labelledby="blockedUsersModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header bg-purple text-white" style="background-color: #9c27b0 !important;">
<h5 class="modal-title" id="blockedUsersModalLabel">
<i class="bx bx-block me-2"></i>Usuários Bloqueados por Atraso
</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-6">
<div class="input-group">
<span class="input-group-text"><i class="bx bx-search"></i></span>
<input type="text" class="form-control" id="blockedUsersSearchInput" placeholder="Buscar por nome do usuário...">
</div>
</div>
<div class="col-md-3">
<button class="btn btn-primary w-100" onclick="loadBlockedUsers()">
<i class="bx bx-refresh me-1"></i>Atualizar
</button>
</div>
<div class="col-md-3">
<button class="btn btn-success w-100" onclick="exportBlockedUsersReport()">
<i class="bx bx-download me-1"></i>Exportar
</button>
</div>
</div>

<div class="table-responsive">
<table class="table table-hover table-striped">
<thead class="table-light">
<tr>
<th>Usuário</th>
<th>Livro(s) em Atraso</th>
<th>Dias de Atraso</th>
<th>Data de Empréstimo</th>
<th>Data de Devolução</th>
<th>Contato</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="blockedUsersTableBody">
<tr>
<td colspan="7" class="text-center">Carregando usuários bloqueados...</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
<i class="bx bx-x me-2"></i>Fechar
</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Proteção contra erros de extensões de navegador
window.addEventListener('error', function(event) {
    // Filtra erros conhecidos de extensões do Chrome
    if (event.filename && (
        event.filename.includes('contentscript') || 
        event.filename.includes('chrome-extension') ||
        event.filename.includes('moz-extension')
    )) {
        console.warn('Erro de extensão de navegador filtrado:', event.message);
        event.preventDefault();
        return false;
    }
    
    // Filtra erros específicos de jQuery de extensões
    if (event.message && (
        event.message.includes("Cannot read properties of undefined (reading 'html')") ||
        event.message.includes("Cannot read property 'html' of undefined")
    )) {
        console.warn('Erro de jQuery de extensão filtrado:', event.message);
        event.preventDefault();
        return false;
    }
});

// Configurações do sistema
const SYSTEM_CONFIG = {
    schoolName: "Escola Estadual Governador Bias Fortes", // Nome oficial da escola
    systemName: "SIGEB - Sistema de Gerenciamento de Biblioteca",
    defaultLoanDays: 14
};

// Função para obter data/hora no horário de Brasília
function getDataBrasilia() {
// Cria uma nova data no horário UTC
const agora = new Date();

// Converte para o horário de Brasília (UTC-3)
// Durante horário de verão seria UTC-2, mas vamos usar UTC-3 como padrão
const brasiliaOffset = -3; // UTC-3
const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
const brasilia = new Date(utc + (brasiliaOffset * 3600000));

return brasilia;
}

// Função para formatar data no padrão brasileiro (DD/MM/AAAA)
function formatarDataBrasil(data) {
const day = String(data.getDate()).padStart(2, '0');
const month = String(data.getMonth() + 1).padStart(2, '0');
const year = data.getFullYear();
return `${day}/${month}/${year}`;
}

// Função para adicionar dias a uma data (horário Brasília)
function adicionarDias(data, dias) {
const novaData = new Date(data);
novaData.setDate(novaData.getDate() + dias);
return novaData;
}

// Função para enviar mensagem WhatsApp ao registrar novo empréstimo
async function sendWhatsAppOnLoan(userId, books, loanDate, returnDate) {
try {
const userDoc = await db.collection('usuarios').doc(userId).get();
const userData = userDoc.data();
if (!userData || !userData.telefone) {
console.warn('Telefone do usuário não encontrado.');
return;
}
// Monta a mensagem
let booksList = '';
for (const item of books) {
const bookDoc = await db.collection('livros').doc(item.bookId).get();
const bookData = bookDoc.data();
booksList += `\n- ${bookData ? bookData.titulo : item.bookId} (Qtd: ${item.quantity})`;
}
const msg = 
`Olá ${userData.nome}, seu empréstimo foi registrado na biblioteca!\n` +
`Livros:${booksList}\n` +
`Data do Empréstimo: ${loanDate}\n` +
`Data de Devolução: ${returnDate}\n` +
`Por favor, devolva os livros na data correta.`+
`Agradecemos a sua colaboração.`+
`Atenciosamente, ${SYSTEM_CONFIG.schoolName}`+
`SIGEB - Sistema de Gerenciamento de Biblioteca`;



// Formata o telefone para padrão internacional (ex: 5511999999999)
let phone = userData.telefone.replace(/\D/g, '');
if (phone.length === 11 && !phone.startsWith('55')) {
phone = '55' + phone;
}

// Abre o WhatsApp Web em nova aba
const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
window.open(url, '_blank');
} catch (error) {
console.error('Erro ao enviar WhatsApp:', error);
}
}

// Função para exibir alertas de feedback ao usuário
function showAlert(type, message, timeout = 4000) {
// Remove alertas antigos
document.querySelectorAll('.custom-alert').forEach(e => e.remove());
const alert = document.createElement('div');
alert.className = `alert alert-${type} custom-alert position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
alert.style.zIndex = 2000;
alert.innerHTML = message;
document.body.appendChild(alert);
setTimeout(() => alert.remove(), timeout);
}

// Função para fechar o modal de novo empréstimo
function closeAddLoanModal() {
const modal = bootstrap.Modal.getInstance(document.getElementById('addLoanModal'));
if (modal) modal.hide();
}

// Corrige duplicidade de listeners e inicialização
document.addEventListener('DOMContentLoaded', function() {
// Flatpickr já inicializado acima

// Adiciona máscaras para os campos de data
const loanDateInput = document.getElementById('loanDate');
const returnDateInput = document.getElementById('returnDate');

// Função para aplicar máscara de data
function applyDateMask(input) {
input.addEventListener('input', function(e) {
let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito

if (value.length >= 2) {
value = value.substring(0, 2) + '/' + value.substring(2);
}
if (value.length >= 5) {
value = value.substring(0, 5) + '/' + value.substring(5, 9);
}

e.target.value = value;
});

// Valida a data quando o usuário sai do campo
input.addEventListener('blur', function(e) {
const dateValue = e.target.value;
if (dateValue && !isValidDateFormat(dateValue)) {
e.target.classList.add('is-invalid');
} else {
e.target.classList.remove('is-invalid');
}
});
}

// Função para validar formato de data brasileira
function isValidDateFormat(dateString) {
const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
const match = dateString.match(regex);

if (!match) return false;

const day = parseInt(match[1], 10);
const month = parseInt(match[2], 10);
const year = parseInt(match[3], 10);

if (month < 1 || month > 12) return false;
if (day < 1 || day > 31) return false;
if (year < 1900 || year > 2100) return false;

// Verifica se a data é válida
const date = new Date(year, month - 1, day);
return date.getFullYear() === year && 
date.getMonth() === month - 1 && 
date.getDate() === day;
}

// Aplica máscaras aos campos de data
if (loanDateInput) applyDateMask(loanDateInput);
if (returnDateInput) applyDateMask(returnDateInput);

// Aplica máscara ao campo de data do modal de edição
const editLoanDateInput = document.getElementById('editLoanDate');
const editReturnDateInput = document.getElementById('editReturnDate');
if (editLoanDateInput) applyDateMask(editLoanDateInput);
if (editReturnDateInput) applyDateMask(editReturnDateInput);

// Aplica máscara ao campo de data do modal de renovação
const renewReturnDateInput = document.getElementById('renewReturnDate');
if (renewReturnDateInput) applyDateMask(renewReturnDateInput);

// Listener para busca de usuários
const userSearch = document.getElementById('userSearch');
if (userSearch) {
userSearch.addEventListener('input', searchUsers);
userSearch.addEventListener('focus', searchUsers);
}
const userSearchBtn = document.querySelector('#addLoanForm button[onclick="searchUsers()"]');
if (userSearchBtn) {
userSearchBtn.addEventListener('click', searchUsers);
}

// Listener para busca de livros na primeira linha
const firstBookSearch = document.querySelector('.bookSearch');
if (firstBookSearch) {
firstBookSearch.addEventListener('input', function() {
searchBooks(this);
});
firstBookSearch.addEventListener('focus', function() {
searchBooks(this);
});
}

// Listener para submissão do formulário de empréstimo
const addLoanForm = document.getElementById('addLoanForm');
if (addLoanForm) {
addLoanForm.addEventListener('submit', handleLoanSubmission);
}

// Adiciona validação em tempo real para campos de quantidade
function addQuantityValidation() {
document.querySelectorAll('.quantity').forEach(quantityInput => {
quantityInput.addEventListener('input', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

// Remove validações anteriores
this.classList.remove('is-invalid', 'is-valid');

if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
this.classList.add('is-invalid');
this.setCustomValidity('Quantidade deve ser um número positivo');
} else if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
this.classList.add('is-invalid');
this.setCustomValidity(`Quantidade máxima disponível: ${availableQuantity}`);
} else {
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

quantityInput.addEventListener('blur', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
showAlert('warning', `Quantidade solicitada (${requestedQuantity}) excede a disponível (${availableQuantity}). Ajustando para o máximo disponível.`);
this.value = availableQuantity;
this.classList.remove('is-invalid');
this.classList.add('is-valid');
this.setCustomValidity('');
}
});
});
}

// Aplica validação inicial
addQuantityValidation();

// Gera número de registro automático ao abrir modal
const addLoanModal = document.getElementById('addLoanModal');
if (addLoanModal) {
addLoanModal.addEventListener('show.bs.modal', async function () {
// Oculta botão WhatsApp inicialmente
document.getElementById('btnEnviarWhatsappForm').style.display = 'none';

// Remove alertas anteriores de pendências/atrasos
const modalBody = document.querySelector('#addLoanModal .modal-body');
if (modalBody) {
const existingAlerts = modalBody.querySelectorAll('.alert-danger, .alert-warning, .alert-info');
existingAlerts.forEach(alert => alert.remove());
}

// Gera um número sequencial simples (pode ser melhorado para produção)
const snapshot = await db.collection('emprestimos').orderBy('createdAt', 'desc').limit(1).get();
let nextNumber = 1;
if (!snapshot.empty) {
const last = snapshot.docs[0].data().registroNumero;
if (last && !isNaN(Number(last))) nextNumber = Number(last) + 1;
}
document.getElementById('registroNumero').value = String(nextNumber).padStart(6, '0');

// Define automaticamente as datas no formato brasileiro usando horário de Brasília
const hoje = getDataBrasilia();
const dataEmprestimo = formatarDataBrasil(hoje);

// Adiciona 7 dias para a data de devolução
const dataDevolucao = adicionarDias(hoje, 7);
const dataRetorno = formatarDataBrasil(dataDevolucao);

// Define os valores nos campos
document.getElementById('loanDate').value = dataEmprestimo;
document.getElementById('returnDate').value = dataRetorno;

console.log('Datas definidas automaticamente (Horário Brasília):', {
emprestimo: dataEmprestimo,
devolucao: dataRetorno
});
});

// Event listener para o botão "7 dias" no modal de novo empréstimo
document.getElementById('setDefaultReturnDate').addEventListener('click', function() {
const loanDateInput = document.getElementById('loanDate');
const returnDateInput = document.getElementById('returnDate');

if (loanDateInput.value) {
// Parse da data do empréstimo
const [day, month, year] = loanDateInput.value.split('/');
const loanDate = new Date(year, month - 1, day);

// Adiciona 7 dias usando a função utilitária
const returnDate = adicionarDias(loanDate, 7);

// Formata para dd/mm/yyyy usando horário de Brasília
const formattedDate = formatarDataBrasil(returnDate);
returnDateInput.value = formattedDate;

showAlert('info', 'Data de devolução definida para 7 dias após o empréstimo (Horário Brasília)', 2000);
} else {
showAlert('warning', 'Primeiro defina a data do empréstimo', 3000);
}
});

// Event listener para o botão "+7 dias" no modal de edição
document.getElementById('setDefaultEditReturnDate').addEventListener('click', function() {
const editLoanDateInput = document.getElementById('editLoanDate');
const editReturnDateInput = document.getElementById('editReturnDate');

if (editLoanDateInput.value) {
// Parse da data do empréstimo
const [day, month, year] = editLoanDateInput.value.split('/');
const loanDate = new Date(year, month - 1, day);

// Adiciona 7 dias usando a função utilitária
const returnDate = adicionarDias(loanDate, 7);

// Formata para dd/mm/yyyy usando horário de Brasília
const formattedDate = formatarDataBrasil(returnDate);
editReturnDateInput.value = formattedDate;

showAlert('info', 'Data de devolução definida para 7 dias após o empréstimo (Horário Brasília)', 2000);
} else {
showAlert('warning', 'Primeiro defina a data do empréstimo', 3000);
}
});

// Event listener para o botão "+7 dias" no modal de renovação
document.getElementById('setDefaultRenewReturnDate').addEventListener('click', function() {
const today = getDataBrasilia();
const dataComSeteDias = adicionarDias(today, 7);
const dataFormatada = formatarDataBrasil(dataComSeteDias);

document.getElementById('renewReturnDate').value = dataFormatada;
showAlert('info', 'Data de devolução definida para 7 dias a partir de hoje (Horário Brasília)', 2000);
});

// Limpa o formulário quando o modal é fechado
addLoanModal.addEventListener('hidden.bs.modal', function () {
// Reset do formulário
document.getElementById('addLoanForm').reset();

// Limpa campos específicos
document.getElementById('selectedUserId').value = '';
document.getElementById('selectedUserPhone').value = '';
document.getElementById('userSearchResults').innerHTML = '';

// Esconde seção de WhatsApp
document.getElementById('whatsappSection').style.display = 'none';
document.getElementById('userPhone').value = '';

// Oculta botão WhatsApp
document.getElementById('btnEnviarWhatsappForm').style.display = 'none';

// Limpa bloco de detalhes do usuário
const userDetailsBlock = document.getElementById('userDetailsBlock');
if (userDetailsBlock) {
userDetailsBlock.remove();
}

// Limpa resultados de busca de livros
document.querySelectorAll('.selectedBookId').forEach(input => input.value = '');
document.querySelectorAll('.bookSearchResults').forEach(div => div.innerHTML = '');
document.querySelectorAll('.availableQuantity').forEach(span => span.textContent = '-');

// Remove validação visual
document.getElementById('addLoanForm').classList.remove('was-validated');

console.log('Formulário de empréstimo limpo');
});
}
}); // <-- Adiciona o fechamento do event listener aqui

document.getElementById('addLoanModal').addEventListener('shown.bs.modal', function () {
// Garante que o foco seja aplicado ao primeiro campo do modal após ele ser exibido
const firstInput = document.querySelector('#addLoanModal input');
if (firstInput) {
firstInput.focus();
}
});
document.getElementById('addLoanModal').addEventListener('show.bs.modal', function () {
const modal = document.getElementById('addLoanModal');
modal.removeAttribute('aria-hidden');
});
// Função para buscar e exibir os últimos 15 empréstimos
async function loadLoans() {
const tbody = document.getElementById('loansTableBody');
if (!tbody) return;
tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
try {
const snapshot = await db.collection('emprestimos')
.orderBy('createdAt', 'desc')
.limit(15)
.get();

tbody.innerHTML = '';
for (const doc of snapshot.docs) {
const data = doc.data();
// Monta lista de livros
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
// Busca nome do usuário (corrigido para mostrar nome, não id)
let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usuário não encontrado';
} catch {
userName = 'Usuário não encontrado';
}

// Verifica se o empréstimo está realmente atrasado baseado na data (horário Brasília)
let statusAtual = data.status;
const hoje = getDataBrasilia();
hoje.setHours(0, 0, 0, 0);

// Se o status for EMPRESTADO, verifica se está atrasado
if (data.status === 'EMPRESTADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);

// Se a data de devolução já passou, status é ATRASADO
if (returnDate < hoje) {
statusAtual = 'ATRASADO';
// Atualiza o status no banco de dados
await db.collection('emprestimos').doc(doc.id).update({ status: 'ATRASADO' });
}
}
}

// Status visual baseado no status atual calculado
let statusClass = '';
if (statusAtual === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (statusAtual === 'ATRASADO') statusClass = 'status-atrasado';
else if (statusAtual === 'DEVOLVIDO') statusClass = 'status-devolvido';

// Calcula dias de atraso se aplicável
let diffDays = 0;
if (statusAtual === 'ATRASADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(hoje - returnDate);
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

// Botões de ação baseados no status atual
let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;

// Adiciona botão de advertência para qualquer atraso (apenas visual)
if (statusAtual === 'ATRASADO' && diffDays > 0) {
const hasWarning = data.hasWarning ? 'text-warning' : 'text-danger';
const warningTitle = data.hasWarning ? 
`Advertência já emitida em ${data.warningDate || 'data não disponível'}` : 
`Atraso de ${diffDays} dias - Advertência necessária`;

actionBtns += `
<span class="btn btn-sm btn-outline-warning disabled" title="${warningTitle}" style="cursor: default; pointer-events: none;">
<i class="bx bx-error ${hasWarning}"></i>
</span>
`;
}
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

// Monta o texto do status com informações de atraso
let statusText = statusAtual;
if (statusAtual === 'ATRASADO' && diffDays > 0) {
statusText = `ATRASADO (${diffDays} ${diffDays === 1 ? 'dia' : 'dias'})`;
}

tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status ${statusClass}">${statusText}</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
} catch (error) {
console.error('Erro ao carregar empréstimos:', error);
showAlert('danger', 'Erro ao carregar empréstimos.');
}
}

// Funções de busca (usuários e livros)
let userSearchTimeout;
async function searchUsers() {
clearTimeout(userSearchTimeout);
userSearchTimeout = setTimeout(async () => {
const query = document.getElementById('userSearch').value.toLowerCase();
const userSearchResults = document.getElementById('userSearchResults');
userSearchResults.innerHTML = '';
if (query.length < 3) {
userSearchResults.classList.remove('show');
return;
}

try {
const snapshot = await db.collection('usuarios')
.where('nomeSearch', 'array-contains', query.split(' ')[0])
.limit(10)
.get();

if (snapshot.empty) {
userSearchResults.innerHTML = '<a class="dropdown-item">Nenhum usuário encontrado</a>';
} else {
snapshot.docs.forEach(doc => {
const userData = doc.data();
let extraInfo = `<br><small>Função: ${userData.funcao || '-'}</small>`;
if ((userData.funcao || '').toLowerCase() === 'aluno') {
extraInfo += `<br><small>Série: ${userData.serie || '-'} | Turma: ${userData.turma || '-'} | Turno: ${userData.turno || '-'}</small>`;
}
const a = document.createElement('a');
a.className = 'dropdown-item';
a.href = '#';
a.innerHTML = `<strong>${userData.nome}</strong> (${userData.matricula || 'N/A'})${extraInfo}`;
a.onclick = (e) => {
e.preventDefault();
// Exibe os dados do usuário selecionado em campos abaixo do input (ou em algum local desejado)
document.getElementById('selectedUserId').value = doc.id;
document.getElementById('selectedUserPhone').value = userData.telefone || '';

// Verificar pendências do usuário imediatamente
verificarEmprestimosPendentesAoSelecionar(doc.id);

// Mostrar seção de WhatsApp se o usuário tiver telefone
const whatsappSection = document.getElementById('whatsappSection');
const userPhoneInput = document.getElementById('userPhone');

if (userData.telefone && userData.telefone.trim() !== '') {
    userPhoneInput.value = userData.telefone;
    whatsappSection.style.display = 'block';
} else {
    whatsappSection.style.display = 'none';
    // Limpa o campo se não há telefone
}// Exemplo: Mostra dados em um bloco abaixo do campo de busca
let userDetails = `
<div class="alert alert-info mt-2 mb-0 p-2">
<div><strong>Nome:</strong> ${userData.nome || '-'}</div>
<div><strong>Função:</strong> ${userData.funcao || '-'}</div>
<div><strong>Email:</strong> ${userData.email || 'Não informado'}</div>
`;
if ((userData.funcao || '').toLowerCase() === 'aluno') {
userDetails += `
<div><strong>Série:</strong> ${userData.serie || '-'}</div>
<div><strong>Turma:</strong> ${userData.turma || '-'}</div>
<div><strong>Turno:</strong> ${userData.turno || '-'}</div>
`;
}
userDetails += `</div>`;
// Cria ou atualiza o bloco de detalhes
let detailsDiv = document.getElementById('userDetailsBlock');
if (!detailsDiv) {
detailsDiv = document.createElement('div');
detailsDiv.id = 'userDetailsBlock';
document.getElementById('userSearch').parentNode.parentNode.appendChild(detailsDiv);
}
detailsDiv.innerHTML = userDetails;

userSearchResults.classList.remove('show');
};
userSearchResults.appendChild(a);
});
}
userSearchResults.classList.add('show');
} catch (error) {
console.error('Erro ao buscar usuários:', error);
showAlert('danger', 'Erro ao buscar usuários.');
}
}, 300);
}

let bookSearchTimeout;
async function searchBooks(inputElement) {
clearTimeout(bookSearchTimeout);
bookSearchTimeout = setTimeout(async () => {
const query = inputElement.value.toLowerCase();
const bookSearchResults = inputElement.closest('.input-group').nextElementSibling;
bookSearchResults.innerHTML = '';
if (query.length < 3) {
bookSearchResults.classList.remove('show');
return;
}

try {
const snapshot = await db.collection('livros')
.where('tituloSearch', 'array-contains', query.split(' ')[0]) // Busca por primeira palavra do título
.limit(10)
.get();

if (snapshot.empty) {
bookSearchResults.innerHTML = '<a class="dropdown-item">Nenhum livro encontrado</a>';
} else {
for (const doc of snapshot.docs) {
const bookData = doc.data();

// Busca a quantidade atualizada diretamente do banco
const currentBookDoc = await db.collection('livros').doc(doc.id).get();
const currentBookData = currentBookDoc.data();
const currentAvailable = currentBookData?.quantidadeDisponivel || 0;

const a = document.createElement('a');
a.className = 'dropdown-item';
a.href = '#';

// Mostra quantidade disponível e adiciona indicador visual se não houver estoque
if (currentAvailable > 0) {
a.innerHTML = `<strong>${bookData.titulo}</strong><br><small class="text-success">Disponível: ${currentAvailable} unidades</small>`;
} else {
a.innerHTML = `<strong>${bookData.titulo}</strong><br><small class="text-danger">Indisponível (0 unidades)</small>`;
a.classList.add('disabled');
}

a.onclick = (e) => {
e.preventDefault();
if (currentAvailable <= 0) {
showAlert('warning', `O livro "${bookData.titulo}" não possui unidades disponíveis para empréstimo.`);
return;
}

inputElement.value = bookData.titulo;
inputElement.closest('.loan-book-row').querySelector('.selectedBookId').value = doc.id;
inputElement.closest('.loan-book-row').querySelector('.availableQuantity').textContent = currentAvailable;

// Atualiza o campo de quantidade máxima permitida
const quantityInput = inputElement.closest('.loan-book-row').querySelector('.quantity');
quantityInput.max = currentAvailable;
quantityInput.title = `Máximo disponível: ${currentAvailable}`;

bookSearchResults.classList.remove('show');
};
bookSearchResults.appendChild(a);
}
}
bookSearchResults.classList.add('show');
} catch (error) {
console.error('Erro ao buscar livros:', error);
showAlert('danger', 'Erro ao buscar livros.');
}
}, 300);
}

// Funções de adicionar/remover linha de livro no modal de empréstimo
function addBookRow() {
const multiBookLoans = document.getElementById('multiBookLoans');
const rowCount = multiBookLoans.querySelectorAll('.loan-book-row').length;
const newRow = multiBookLoans.querySelector('.loan-book-row').cloneNode(true);

// Limpa valores e define IDs únicos
const bookInput = newRow.querySelector('.bookSearch');
const quantityInput = newRow.querySelector('.quantity');
bookInput.value = '';
bookInput.id = `bookSearch${rowCount}`;
quantityInput.value = '1';
quantityInput.id = `quantity${rowCount}`;
newRow.querySelector('.selectedBookId').value = '';
newRow.querySelector('.availableQuantity').textContent = '-';
newRow.querySelector('.bookSearchResults').innerHTML = '';
newRow.querySelector('.bookSearchResults').classList.remove('show');
newRow.querySelector('.removeBookRow').style.display = 'block';

// Adiciona listeners para busca dinâmica
bookInput.addEventListener('input', function() { searchBooks(this); });
bookInput.addEventListener('focus', function() { searchBooks(this); });

// Adiciona validação de quantidade para a nova linha
quantityInput.addEventListener('input', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

// Remove validações anteriores
this.classList.remove('is-invalid', 'is-valid');

if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
this.classList.add('is-invalid');
this.setCustomValidity('Quantidade deve ser um número positivo');
} else if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
this.classList.add('is-invalid');
this.setCustomValidity(`Quantidade máxima disponível: ${availableQuantity}`);
} else {
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

quantityInput.addEventListener('blur', function() {
const row = this.closest('.loan-book-row');
const availableQuantitySpan = row.querySelector('.availableQuantity');
const availableQuantity = parseInt(availableQuantitySpan.textContent);
const requestedQuantity = parseInt(this.value);

if (!isNaN(availableQuantity) && requestedQuantity > availableQuantity) {
showAlert('warning', `Quantidade solicitada (${requestedQuantity}) excede a disponível (${availableQuantity}). Ajustando para o máximo disponível.`);
this.value = availableQuantity;
this.classList.remove('is-invalid');
this.classList.add('is-valid');
this.setCustomValidity('');
}
});

multiBookLoans.appendChild(newRow);
}

function removeBookRow(button) {
button.closest('.loan-book-row').remove();
}

// Função para verificar pendências quando usuário é selecionado (não bloqueia, apenas informa)
async function verificarEmprestimosPendentesAoSelecionar(userId) {
try {
const verificacao = await verificarEmprestimosPendentes(userId);

// Remove alertas anteriores
const modalBody = document.querySelector('#addLoanModal .modal-body');
if (modalBody) {
const existingAlerts = modalBody.querySelectorAll('.alert-danger, .alert-warning, .alert-info');
existingAlerts.forEach(alert => alert.remove());
}

// Verifica se verificacao tem as propriedades necessárias
if (!verificacao || typeof verificacao !== 'object') {
console.warn('Verificação retornou dados inválidos:', verificacao);
return;
}

if (verificacao.temAtrasos && verificacao.emprestimosAtrasados && verificacao.emprestimosAtrasados.length > 0) {
let mensagemAtraso = '<div class="alert alert-danger mb-3"><h5><i class="bx bx-error-circle"></i> ⚠️ Usuário com Livros em Atraso</h5>';
mensagemAtraso += '<p><strong>Este usuário possui livros em atraso e não poderá retirar novos materiais.</strong></p>';
mensagemAtraso += '<h6>Livros em Atraso:</h6><ul class="mb-2">';

verificacao.emprestimosAtrasados.forEach(emp => {
mensagemAtraso += `<li class="mb-2"><strong>Registro:</strong> ${emp.registro || 'N/A'}<br>`;
mensagemAtraso += `<strong>Vencimento:</strong> ${emp.dataVencimento || 'N/A'}<br>`;
mensagemAtraso += `<strong>Atraso:</strong> <span class="text-danger fw-bold">${emp.diasAtraso || 0} dia(s)</span><br>`;
mensagemAtraso += `<strong>Livros:</strong> ${emp.livros && emp.livros.length > 0 ? emp.livros.join(', ') : 'N/A'}</li>`;
});
mensagemAtraso += '</ul>';
mensagemAtraso += '<p class="mb-0"><strong>⚠️ Empréstimos bloqueados até regularização.</strong></p></div>';

if (modalBody) {
modalBody.insertAdjacentHTML('afterbegin', mensagemAtraso);
}
} else if (verificacao.emprestimosAtivos && verificacao.emprestimosAtivos.length > 0) {
let mensagemAtivos = `<div class="alert alert-info mb-3"><h6><i class="bx bx-info-circle"></i> Informação sobre Empréstimos</h6>`;
mensagemAtivos += `<p class="mb-0">Este usuário possui <strong>${verificacao.emprestimosAtivos.length} empréstimo(s) ativo(s)</strong> ainda no prazo. ✅ Pode realizar novos empréstimos.</p></div>`;

if (modalBody) {
modalBody.insertAdjacentHTML('afterbegin', mensagemAtivos);
}
}

} catch (error) {
console.error('Erro ao verificar pendências ao selecionar usuário:', error);
}
}

// Função para verificar se o usuário tem empréstimos pendentes ou atrasados
async function verificarEmprestimosPendentes(userId) {
try {
const snapshot = await db.collection('emprestimos')
.where('userId', '==', userId)
.where('status', 'in', ['EMPRESTADO', 'ATRASADO'])
.get();

if (snapshot.empty) {
return { temPendencias: false };
}

const hoje = new Date();
hoje.setHours(0, 0, 0, 0);

let emprestimosAtrasados = [];
let emprestimosAtivos = [];

for (const doc of snapshot.docs) {
const emprestimo = doc.data();

// Verificar se está atrasado baseado na data de devolução
if (emprestimo.returnDate) {
const dateParts = emprestimo.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);

if (returnDate < hoje) {
// Calcular dias de atraso
const diffTime = hoje.getTime() - returnDate.getTime();
const diasAtraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// Buscar títulos dos livros
let livrosTitulos = [];
if (Array.isArray(emprestimo.books)) {
for (const book of emprestimo.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
livrosTitulos.push(`${bookDoc.data().titulo} (Qtd: ${book.quantity})`);
} else {
livrosTitulos.push(`Livro ${book.bookId} (Qtd: ${book.quantity})`);
}
} catch (e) {
livrosTitulos.push(`Livro ${book.bookId} (Qtd: ${book.quantity})`);
}
}
}

emprestimosAtrasados.push({
registro: emprestimo.registroNumero,
dataVencimento: emprestimo.returnDate,
diasAtraso: diasAtraso,
livros: livrosTitulos
});
} else {
// Empréstimo ainda no prazo
emprestimosAtivos.push({
registro: emprestimo.registroNumero,
dataVencimento: emprestimo.returnDate
});
}
}
}
}

return {
temPendencias: emprestimosAtrasados.length > 0 || emprestimosAtivos.length > 0,
temAtrasos: emprestimosAtrasados.length > 0,
emprestimosAtrasados: emprestimosAtrasados,
emprestimosAtivos: emprestimosAtivos
};

} catch (error) {
console.error('Erro ao verificar empréstimos pendentes:', error);
throw new Error('Erro ao verificar pendências do usuário');
}
}

// Função para lidar com a submissão do formulário de empréstimo
async function handleLoanSubmission(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const registroNumero = document.getElementById('registroNumero').value;
const userId = document.getElementById('selectedUserId').value;
const loanDate = document.getElementById('loanDate').value;
const returnDate = document.getElementById('returnDate').value;

// VERIFICAÇÃO DE EMPRÉSTIMOS PENDENTES E ATRASOS
if (userId) {
try {
const verificacao = await verificarEmprestimosPendentes(userId);

// Verifica se verificacao tem as propriedades necessárias
if (!verificacao || typeof verificacao !== 'object') {
console.warn('Verificação retornou dados inválidos:', verificacao);
showAlert('warning', 'Não foi possível verificar pendências. Empréstimo pode continuar.');
} else {
if (verificacao.temAtrasos && verificacao.emprestimosAtrasados && verificacao.emprestimosAtrasados.length > 0) {
let mensagemAtraso = '<div class="alert alert-danger mb-3"><h5><i class="bx bx-error-circle"></i> Empréstimo Bloqueado</h5>';
mensagemAtraso += '<p><strong>Este usuário possui livros em atraso e não pode retirar novos materiais.</strong></p>';
mensagemAtraso += '<h6>Livros em Atraso:</h6><ul class="mb-2">';

verificacao.emprestimosAtrasados.forEach(emp => {
mensagemAtraso += `<li class="mb-2"><strong>Registro:</strong> ${emp.registro || 'N/A'}<br>`;
mensagemAtraso += `<strong>Vencimento:</strong> ${emp.dataVencimento || 'N/A'}<br>`;
mensagemAtraso += `<strong>Atraso:</strong> <span class="text-danger fw-bold">${emp.diasAtraso || 0} dia(s)</span><br>`;
mensagemAtraso += `<strong>Livros:</strong> ${emp.livros && emp.livros.length > 0 ? emp.livros.join(', ') : 'N/A'}</li>`;
});
mensagemAtraso += '</ul>';
mensagemAtraso += '<p class="mb-0"><strong>Ação necessária:</strong> O usuário deve devolver os livros em atraso antes de realizar novos empréstimos.</p></div>';

// Exibe o alerta no topo do modal de empréstimo
const modalBody = document.querySelector('#addLoanModal .modal-body');
if (modalBody) {
// Remove alertas anteriores
const existingAlerts = modalBody.querySelectorAll('.alert');
existingAlerts.forEach(alert => alert.remove());

// Adiciona o novo alerta no início do modal
modalBody.insertAdjacentHTML('afterbegin', mensagemAtraso);
}

showAlert('danger', 'Empréstimo bloqueado! Usuário possui livros em atraso.', 6000);
return; // Impede a continuação do processo
}

if (verificacao.emprestimosAtivos && verificacao.emprestimosAtivos.length > 0) {
// Mostrar aviso sobre empréstimos ativos (permite continuar)
let mensagemAtivos = `<div class="alert alert-info mb-3"><h6><i class="bx bx-info-circle"></i> Informação</h6>`;
mensagemAtivos += `<p class="mb-0">Este usuário possui <strong>${verificacao.emprestimosAtivos.length} empréstimo(s) ativo(s)</strong> ainda no prazo.</p></div>`;

const modalBody = document.querySelector('#addLoanModal .modal-body');
if (modalBody) {
// Remove apenas alertas de informação anteriores
const existingInfoAlerts = modalBody.querySelectorAll('.alert-info');
existingInfoAlerts.forEach(alert => alert.remove());

// Adiciona o aviso no início do modal
modalBody.insertAdjacentHTML('afterbegin', mensagemAtivos);
}
}
}

} catch (error) {
console.error('Erro ao verificar pendências:', error);
showAlert('danger', 'Erro ao verificar pendências do usuário. Tente novamente.');
return;
}
}

const bookRows = document.querySelectorAll('#multiBookLoans .loan-book-row');
const books = [];
let hasError = false;

// Consulta atual da quantidade disponível de cada livro no banco de dados
for (const row of bookRows) {
const bookId = row.querySelector('.selectedBookId').value;
const quantity = parseInt(row.querySelector('.quantity').value);

if (!bookId) {
showAlert('danger', 'Por favor, selecione um livro para todas as linhas.');
hasError = true;
break;
}
if (isNaN(quantity) || quantity <= 0) {
showAlert('danger', 'A quantidade do livro deve ser um número positivo.');
hasError = true;
break;
}

// Consulta a quantidade atual disponível no banco de dados
try {
const bookDoc = await db.collection('livros').doc(bookId).get();
if (!bookDoc.exists) {
showAlert('danger', 'Livro não encontrado no banco de dados.');
hasError = true;
break;
}

const bookData = bookDoc.data();
const currentAvailable = bookData.quantidadeDisponivel || 0;
const bookTitle = bookData.titulo || 'Livro sem título';

if (quantity > currentAvailable) {
showAlert('danger', `Quantidade solicitada para "${bookTitle}" (${quantity}) excede a disponível (${currentAvailable}).`);
hasError = true;
break;
}

// Verifica se o livro já foi adicionado na lista (para evitar duplicatas)
const existingBook = books.find(b => b.bookId === bookId);
if (existingBook) {
const totalQuantity = existingBook.quantity + quantity;
if (totalQuantity > currentAvailable) {
showAlert('danger', `Quantidade total solicitada para "${bookTitle}" (${totalQuantity}) excede a disponível (${currentAvailable}).`);
hasError = true;
break;
}
existingBook.quantity = totalQuantity;
} else {
books.push({ bookId, quantity });
}

} catch (error) {
console.error('Erro ao consultar livro:', error);
showAlert('danger', 'Erro ao consultar disponibilidade do livro.');
hasError = true;
break;
}
}

if (hasError) return;

if (!userId) {
showAlert('danger', 'Por favor, selecione um usuário.');
return;
}

try {
// Determina o status inicial baseado na data de devolução (horário Brasília)
const [day, month, year] = returnDate.split('/');
const loanReturnDate = new Date(year, month - 1, day);
loanReturnDate.setHours(0, 0, 0, 0);

const todayForStatus = getDataBrasilia();
todayForStatus.setHours(0, 0, 0, 0);

// Para novos empréstimos, geralmente será EMPRESTADO, mas por segurança verificamos
const initialStatus = loanReturnDate < todayForStatus ? 'ATRASADO' : 'EMPRESTADO';

// Adiciona o empréstimo ao Firestore
const loanRef = await db.collection('emprestimos').add({
registroNumero: registroNumero,
userId: userId,
books: books,
loanDate: loanDate,
returnDate: returnDate,
status: initialStatus,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
}); // Atualiza a quantidade de livros no estoque usando operações atômicas
const updatePromises = [];
for (const book of books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
updatePromises.push(
bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(-book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(-book.quantity),
emprestados: firebase.firestore.FieldValue.increment(book.quantity)
})
);
}

// Executa todas as atualizações de estoque em paralelo
await Promise.all(updatePromises);

// Configura botões de comunicação ANTES de fechar o modal
const whatsappBtn = document.getElementById('btnEnviarWhatsappForm');
whatsappBtn.style.display = 'inline-block';
whatsappBtn.style.animation = 'pulse 1s infinite';
whatsappBtn.onclick = function() {
sendWhatsAppOnLoan(userId, books, loanDate, returnDate);
// Remove a animação após clicar
whatsappBtn.style.animation = '';
};

// Mostra mensagem de sucesso
showAlert('success', 'Empréstimo registrado com sucesso! Clique no botão WhatsApp para notificar o usuário.', 5000);

// Aguarda 3 segundos antes de fechar o modal para dar tempo de ver o botão WhatsApp
setTimeout(() => {
const addLoanModal = bootstrap.Modal.getInstance(document.getElementById('addLoanModal'));
if (addLoanModal) addLoanModal.hide();
}, 3000);

loadLoans();
updateLoanStats();
updateNotReturnedBar();

} catch (error) {
console.error('Erro ao registrar empréstimo:', error);
showAlert('danger', 'Erro ao registrar empréstimo.');
}
}


// Funções de edição, devolução, renovação e exclusão de empréstimos
async function openEditLoanModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (doc.exists) {
const data = doc.data();
document.getElementById('editLoanId').value = doc.id;
document.getElementById('editLoanDate').value = data.loanDate;
document.getElementById('editReturnDate').value = data.returnDate;
const editLoanModal = new bootstrap.Modal(document.getElementById('editLoanModal'));
editLoanModal.show();
}
} catch (error) {
console.error('Erro ao abrir modal de edição:', error);
showAlert('danger', 'Erro ao carregar dados do empréstimo para edição.');
}
}

document.getElementById('editLoanForm').addEventListener('submit', async function(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const loanId = document.getElementById('editLoanId').value;
const loanDate = document.getElementById('editLoanDate').value;
const returnDate = document.getElementById('editReturnDate').value;

try {
await db.collection('emprestimos').doc(loanId).update({
loanDate: loanDate,
returnDate: returnDate
});
showAlert('success', 'Empréstimo atualizado com sucesso!');
bootstrap.Modal.getInstance(document.getElementById('editLoanModal')).hide();
loadLoans();
} catch (error) {
console.error('Erro ao atualizar empréstimo:', error);
showAlert('danger', 'Erro ao atualizar empréstimo.');
}
});

// Event listener para o formulário de renovação
document.getElementById('renewLoanForm').addEventListener('submit', async function(event) {
event.preventDefault();
const form = event.target;
if (!form.checkValidity()) {
form.classList.add('was-validated');
return;
}

const loanId = document.getElementById('renewLoanId').value;
const returnDate = document.getElementById('renewReturnDate').value;

// Validação de data
if (!isValidDateFormat(returnDate)) {
showAlert('danger', 'Data de devolução deve estar no formato DD/MM/AAAA');
return;
}

// Verificar se a nova data não está no passado (usando horário de Brasília)
const [day, month, year] = returnDate.split('/');
const newReturnDate = new Date(year, month - 1, day);
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
newReturnDate.setHours(0, 0, 0, 0);

if (newReturnDate < today) {
showAlert('warning', 'A nova data de devolução não pode ser anterior à data atual (Horário Brasília)');
return;
}

try {
// Determina o status correto baseado na nova data de devolução (horário Brasília)
const [day2, month2, year2] = returnDate.split('/');
const renewReturnDate = new Date(year2, month2 - 1, day2);
renewReturnDate.setHours(0, 0, 0, 0);

const todayForStatus = getDataBrasilia();
todayForStatus.setHours(0, 0, 0, 0);

// Define o status baseado na comparação de datas
const newStatus = renewReturnDate < todayForStatus ? 'ATRASADO' : 'EMPRESTADO';

await db.collection('emprestimos').doc(loanId).update({
returnDate: returnDate,
status: newStatus, // Status determinado dinamicamente baseado na data
renewedAt: firebase.firestore.FieldValue.serverTimestamp(),
renewedDate: formatarDataBrasil(getDataBrasilia())
});

showAlert('success', 'Empréstimo renovado com sucesso!');
bootstrap.Modal.getInstance(document.getElementById('renewLoanModal')).hide();
loadLoans();
} catch (error) {
console.error('Erro ao renovar empréstimo:', error);
showAlert('danger', 'Erro ao renovar empréstimo.');
}
});

async function returnLoan(loanId) {
if (!confirm('Tem certeza que deseja registrar a devolução deste empréstimo?')) return;
try {
// Busca os dados do empréstimo
const loanDoc = await db.collection('emprestimos').doc(loanId).get();
if (!loanDoc.exists) {
showAlert('danger', 'Empréstimo não encontrado.');
return;
}

const loanData = loanDoc.data();

// Verifica se o empréstimo já foi devolvido
if (loanData.status === 'DEVOLVIDO') {
showAlert('warning', 'Este empréstimo já foi devolvido.');
return;
}

// Atualiza o status do empréstimo usando horário de Brasília
const dataDevolucao = getDataBrasilia();
await db.collection('emprestimos').doc(loanId).update({
status: 'DEVOLVIDO',
returnedAt: firebase.firestore.FieldValue.serverTimestamp(),
actualReturnDate: formatarDataBrasil(dataDevolucao)
}); // Retorna a quantidade de livros ao estoque
const updatePromises = [];
for (const book of loanData.books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
updatePromises.push(
bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(book.quantity),
emprestados: firebase.firestore.FieldValue.increment(-book.quantity)
})
);
}

// Executa todas as atualizações de estoque em paralelo
await Promise.all(updatePromises);

console.log(`Estoque atualizado para ${loanData.books.length} livro(s)`);
showAlert('success', 'Empréstimo devolvido com sucesso! Estoque atualizado.');

// Atualiza a interface
loadLoans();
updateLoanStats();

} catch (error) {
console.error('Erro ao devolver empréstimo:', error);
showAlert('danger', 'Erro ao devolver empréstimo: ' + error.message);
}
}

async function renewLoan(loanId) {
try {
// Busca os dados do empréstimo
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empréstimo não encontrado.');
return;
}

const data = doc.data();

// Verifica se o empréstimo pode ser renovado
if (data.status === 'DEVOLVIDO') {
showAlert('warning', 'Este empréstimo já foi devolvido e não pode ser renovado.');
return;
}

// Preenche o modal com os dados do empréstimo
document.getElementById('renewLoanId').value = loanId;

// Busca informações do usuário e livros
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${b.quantity})`);
else bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
} catch {
bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
}
}
}

// Preenche as informações do empréstimo no modal
document.getElementById('renewLoanInfo').innerHTML = `
<div class="card">
<div class="card-body">
<h6 class="card-title">Informações do Empréstimo</h6>
<p class="mb-1"><strong>Usuário:</strong> ${userName}</p>
<p class="mb-1"><strong>Livro(s):</strong> ${bookTitles.join(', ')}</p>
<p class="mb-1"><strong>Data do Empréstimo:</strong> ${data.loanDate}</p>
<p class="mb-0"><strong>Data de Devolução Atual:</strong> ${data.returnDate}</p>
</div>
</div>
`;

// Define a data padrão (7 dias a partir de hoje) usando horário de Brasília
const today = getDataBrasilia();
const dataComSeteDias = adicionarDias(today, 7);
const dataFormatada = formatarDataBrasil(dataComSeteDias);
document.getElementById('renewReturnDate').value = dataFormatada;

// Abre o modal
const renewLoanModal = new bootstrap.Modal(document.getElementById('renewLoanModal'));
renewLoanModal.show();

} catch (error) {
console.error('Erro ao abrir modal de renovação:', error);
showAlert('danger', 'Erro ao carregar dados do empréstimo para renovação.');
}
}

async function deleteLoan(loanId) {
if (!confirm('Tem certeza que deseja excluir este empréstimo? Esta ação é irreversível.')) return;
try {
// Opcional: Reverter quantidade de livros se o empréstimo não foi devolvido
const loanDoc = await db.collection('emprestimos').doc(loanId).get();
const loanData = loanDoc.data(); if (loanData.status !== 'DEVOLVIDO') {
for (const book of loanData.books) {
const bookDocRef = db.collection('livros').doc(book.bookId);
await bookDocRef.update({
quantidade: firebase.firestore.FieldValue.increment(book.quantity),
quantidadeDisponivel: firebase.firestore.FieldValue.increment(book.quantity),
emprestados: firebase.firestore.FieldValue.increment(-book.quantity)
});
}
}

await db.collection('emprestimos').doc(loanId).delete();
showAlert('success', 'Empréstimo excluído com sucesso!');
loadLoans();
} catch (error) {
console.error('Erro ao excluir empréstimo:', error);
showAlert('danger', 'Erro ao excluir empréstimo.');
}
}

// Funções de relatório e barra de atrasos
async function generateLoanReport() {
try {
const snapshot = await db.collection('emprestimos').get();
const loans = [];

for (const doc of snapshot.docs) {
const data = doc.data();
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${b.quantity})`);
else bookTitles.push(`${b.bookId} (Qtd: ${b.quantity})`);
} catch (e) {
bookTitles.push(`${b.bookId} (Qtd: ${b.quantity}) - Erro ao carregar`);
}
}
}

loans.push({
'Registro': data.registroNumero,
'Usuário': userName,
'Livros': bookTitles.join('; '),
'Data Empréstimo': data.loanDate,
'Data Devolução': data.returnDate,
'Status': data.status
});
}

const ws = XLSX.utils.json_to_sheet(loans);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Empréstimos");
XLSX.writeFile(wb, "relatorio_emprestimos.xlsx");
showAlert('success', 'Relatório gerado com sucesso!');
} catch (error) {
console.error('Erro ao gerar relatório:', error);
showAlert('danger', 'Erro ao gerar relatório de empréstimos.');
}
}

async function updateNotReturnedBar() {
try {
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

const snapshot = await db.collection('emprestimos')
.where('status', 'in', ['EMPRESTADO', 'ATRASADO'])
.get();

let overdueLoans = [];
let notReturnedCount = 0;

for (const doc of snapshot.docs) {
const data = doc.data();
const returnDate = new Date(data.returnDate);
returnDate.setHours(0, 0, 0, 0);

if (returnDate < today) {
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let bookTitles = [];
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) bookTitles.push(bookDoc.data().titulo);
else bookTitles.push(b.bookId);
} catch (e) {}
}
}
overdueLoans.push(`${userName} - ${bookTitles.join(', ')} (Devolução: ${data.returnDate})`);
notReturnedCount++;

// Atualiza status para ATRASADO se ainda for EMPRESTADO
if (data.status === 'EMPRESTADO') {
await db.collection('emprestimos').doc(doc.id).update({ status: 'ATRASADO' });
}
}
}

const notReturnedBar = document.getElementById('notReturnedBar');
if (notReturnedCount > 0) {
notReturnedBar.style.display = 'block';
notReturnedBar.innerHTML = `
<div class="marquee" style="color: #c62828; font-weight: bold; background-color: #ffebee; padding: 10px; border-radius: 8px;">
${overdueLoans.map(loan => `<span>${loan}</span>`).join('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')}
</div>
`;
} else {
notReturnedBar.style.display = 'none';
}
} catch (error) {
console.error('Erro ao atualizar barra de atrasos:', error);
}
}

// Funções de gráficos de status
async function updateLoanStats() {
try {
const snapshot = await db.collection('emprestimos').get();
let emprestadoCount = 0;
let atrasadoCount = 0;
let devolvidoCount = 0;
let warningsCount = 0;

const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();
if (data.status === 'EMPRESTADO') {
// Converte a data de devolução do formato DD/MM/AAAA para Date
let returnDate;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
}
}

if (returnDate && returnDate < today) {
atrasadoCount++;
warningsCount++; // Cada empréstimo atrasado gera uma advertência
} else {
emprestadoCount++;
}
} else if (data.status === 'ATRASADO') {
atrasadoCount++;
warningsCount++; // Cada empréstimo atrasado gera uma advertência
} else if (data.status === 'DEVOLVIDO') {
devolvidoCount++;
}
}

document.getElementById('countEmprestado').textContent = emprestadoCount;
document.getElementById('countAtrasado').textContent = atrasadoCount;
document.getElementById('countDevolvido').textContent = devolvidoCount;
document.getElementById('countWarnings').textContent = warningsCount;

// Atualiza contador de usuários bloqueados
await updateBlockedUsersCount();

// Atualiza os gráficos de pizza
updatePieChart('emprestado', emprestadoCount, snapshot.size);
updatePieChart('atrasado', atrasadoCount, snapshot.size);
updatePieChart('devolvido', devolvidoCount, snapshot.size);
updatePieChart('warnings', warningsCount, snapshot.size);
updatePieChart('blocked', await getBlockedUsersCount(), snapshot.size);

} catch (error) {
console.error('Erro ao atualizar estatísticas de empréstimos:', error);
}
}

// Função para contar usuários bloqueados
async function getBlockedUsersCount() {
try {
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

const uniqueUsers = new Set();

for (const doc of snapshot.docs) {
const loanData = doc.data();

// Calcula dias de atraso usando returnDate (formato DD/MM/AAAA)
let daysLate = 0;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate > 0) {
uniqueUsers.add(loanData.userId);
}
}

return uniqueUsers.size;
} catch (error) {
console.error('Erro ao contar usuários bloqueados:', error);
return 0;
}
}

// Função para atualizar contador de usuários bloqueados
async function updateBlockedUsersCount() {
try {
const count = await getBlockedUsersCount();
const countElement = document.getElementById('countBlockedUsers');
if (countElement) {
countElement.textContent = count;
}
} catch (error) {
console.error('Erro ao atualizar contador de usuários bloqueados:', error);
}
}

// Função de teste para verificar parsing de datas (pode ser executada no console)
function testDateParsing() {
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

console.log('=== TESTE DE PARSING DE DATAS ===');
console.log('Data de hoje:', today.toLocaleDateString('pt-BR'));

// Teste com diferentes datas
const testDates = [
'28/06/2025', // 3 dias atrás
'29/06/2025', // 2 dias atrás
'30/06/2025', // 1 dia atrás
'01/07/2025', // hoje
'02/07/2025', // amanhã
'08/07/2025' // 7 dias à frente
];

testDates.forEach(dateStr => {
const dateParts = dateStr.split('/');
const parsedDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
parsedDate.setHours(0, 0, 0, 0);

const isLate = parsedDate < today;
const daysDiff = Math.ceil(Math.abs(today - parsedDate) / (1000 * 60 * 60 * 24));

console.log(`Data: ${dateStr} | Parsed: ${parsedDate.toLocaleDateString('pt-BR')} | Atrasado: ${isLate} | Diferença: ${daysDiff} dias`);
});
}

function updatePieChart(status, count, total) {
const circumference = 2 * Math.PI * 38; // 2 * PI * raio
const percentage = total > 0 ? (count / total) : 0;
const strokeDashoffset = circumference * (1 - percentage);
document.querySelector(`.pie-fg-${status}`).style.strokeDasharray = `${circumference} ${circumference}`;
document.querySelector(`.pie-fg-${status}`).style.strokeDashoffset = strokeDashoffset;
} function showLoansByStatus(status) {
try {
// Proteção contra extensões de navegador
if (typeof jQuery !== 'undefined' && window.chrome && window.chrome.runtime) {
// Detecta possível interferência de extensão
console.warn('Extensão de navegador detectada, aplicando proteções...');
}

const tbody = document.getElementById('loansTableBody');
if (!tbody) {
console.error('Elemento loansTableBody não encontrado');
return;
}

// Proteção adicional: garantir que o elemento não foi removido
setTimeout(() => {
if (!document.getElementById('loansTableBody')) {
console.error('Elemento loansTableBody foi removido inesperadamente');
return;
}
}, 100);

tbody.innerHTML = '<tr><td colspan="6">Buscando...</td></tr>';

// Para atrasos, busca empréstimos ativos e verifica as datas
if (status === 'ATRASADO') {
db.collection('emprestimos')
.where('status', 'in', ['EMPRESTADO', 'ATRASADO'])
.get()
.then(async (snapshot) => {
if (tbody) {
tbody.innerHTML = '';
}
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0); // Zera as horas para comparar apenas a data (horário Brasília)

const overdueLoans = [];

for (const doc of snapshot.docs) {
const data = doc.data();

// Log para debug - identificar empréstimos problemáticos
console.log(`Processando empréstimo ${doc.id} com returnDate: ${data.returnDate}`);

// Converte a data de devolução para Date
let returnDate = null;
if (data.returnDate) {
// Assume formato DD/MM/AAAA - usando o mesmo método da função loadLoans
const dateParts = data.returnDate.split('/');
console.log(`Empréstimo ${doc.id}: dateParts =`, dateParts);
if (dateParts.length === 3) {
const day = parseInt(dateParts[0], 10);
const month = parseInt(dateParts[1], 10) - 1; // Mês em JavaScript é 0-indexado
const year = parseInt(dateParts[2], 10);

console.log(`Empréstimo ${doc.id}: day=${day}, month=${month}, year=${year}`);

// Verifica se os valores são válidos
if (!isNaN(day) && !isNaN(month) && !isNaN(year) && 
day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
const tempDate = new Date(year, month, day);
tempDate.setHours(0, 0, 0, 0);
console.log(`Empréstimo ${doc.id}: tempDate criada =`, tempDate);
console.log(`Empréstimo ${doc.id}: tempDate.getTime() =`, tempDate.getTime());
// Verifica se a data criada é válida
if (tempDate instanceof Date && !isNaN(tempDate.getTime())) {
returnDate = tempDate;
console.log(`Empréstimo ${doc.id}: returnDate definida com sucesso =`, returnDate);
} else {
console.warn('Data criada é inválida:', data.returnDate, 'tempDate:', tempDate);
}
} else {
console.warn('Valores de data inválidos:', {day, month, year, returnDate: data.returnDate});
}
} else {
console.warn('Formato de data inválido:', data.returnDate);
}
}

// Verifica se está atrasado (data de devolução menor que hoje)
if (returnDate && returnDate instanceof Date && !isNaN(returnDate.getTime()) && 
    today && today instanceof Date && !isNaN(today.getTime()) && returnDate < today) {
overdueLoans.push({ doc, data });
} else if (data.returnDate) {
console.warn(`Empréstimo ${doc.id} tem returnDate "${data.returnDate}" mas não pôde ser processado como data válida`);
}
}

if (overdueLoans.length === 0) {
if (tbody) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empréstimo atrasado encontrado.</td></tr>';
}
return;
}

for (const { doc, data } of overdueLoans) {
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}

let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usuário não encontrado';
} catch {
userName = 'Usuário não encontrado';
}

// Calcula dias de atraso usando o mesmo método da função loadLoans
let diffDays = 0;
if (returnDate && returnDate instanceof Date && !isNaN(returnDate.getTime()) && 
    today && today instanceof Date && !isNaN(today.getTime())) {
const diffTime = Math.abs(today.getTime() - returnDate.getTime());
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

// Garantir que diffDays seja um número válido
if (isNaN(diffDays) || diffDays < 0) {
diffDays = 0;
}

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

if (tbody) {
tbody.innerHTML += `
<tr style="background-color: #ffe6e6;">
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td>
<span class="loan-status status-atrasado">ATRASADO</span><br>
<span class="badge badge-atraso">${diffDays} ${diffDays === 1 ? 'dia' : 'dias'} de atraso</span>
</td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
}
})
.catch((error) => {
console.error('Erro ao buscar empréstimos atrasados:', error);
if (error.message && error.message.includes('getTime')) {
console.error('Erro específico de data detectado. Verifique os dados de returnDate no Firestore.');
showAlert('danger', 'Erro no processamento de datas. Verifique os dados dos empréstimos.');
} else {
showAlert('danger', 'Erro ao buscar empréstimos atrasados.');
}
});
} else {
// Para outros status, mantém a lógica original
db.collection('emprestimos')
.where('status', '==', status)
.get()
.then(async (snapshot) => {
if (tbody) {
tbody.innerHTML = '';
}
if (snapshot.empty) {
if (tbody) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empréstimo encontrado.</td></tr>';
}
return;
}
for (const doc of snapshot.docs) {
const data = doc.data();
let livros = '';
if (Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
let userName = '';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
else userName = 'Usuário não encontrado';
} catch {
userName = 'Usuário não encontrado';
}
let statusClass = '';
if (data.status === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (data.status === 'ATRASADO') statusClass = 'status-atrasado';
else if (data.status === 'DEVOLVIDO') statusClass = 'status-devolvido';

// Calcula dias de atraso se aplicável
let diffDays = 0;
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
if (data.status === 'ATRASADO' && data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const day = parseInt(dateParts[0], 10);
const month = parseInt(dateParts[1], 10) - 1; // Mês em JavaScript é 0-indexado
const year = parseInt(dateParts[2], 10);

// Verifica se os valores são válidos
if (!isNaN(day) && !isNaN(month) && !isNaN(year) && 
day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
const returnDate = new Date(year, month, day);
returnDate.setHours(0, 0, 0, 0);

// Verifica se as datas são válidas antes de calcular a diferença
if (returnDate instanceof Date && !isNaN(returnDate.getTime()) && 
    today instanceof Date && !isNaN(today.getTime())) {
const diffTime = Math.abs(today.getTime() - returnDate.getTime());
diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
} else {
console.warn('Data de retorno inválida:', data.returnDate);
}
}

// Garantir que diffDays seja um número válido
if (isNaN(diffDays) || diffDays < 0) {
diffDays = 0;
}
}

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (data.status === 'EMPRESTADO' || data.status === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;

// Adiciona botão de advertência para qualquer atraso
if (data.status === 'ATRASADO' && diffDays > 0) {
const hasWarning = data.hasWarning ? 'text-warning' : 'text-danger';
const warningTitle = data.hasWarning ? 
`Advertência já emitida em ${data.warningDate || 'data não disponível'}` : 
`Atraso de ${diffDays} dias - Emitir advertência`;

actionBtns += `
<span class="btn btn-sm btn-outline-warning disabled" title="${warningTitle}" style="cursor: default; pointer-events: none;">
<i class="bx bx-error ${hasWarning}"></i>
</span>
`;
}
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

// Monta o texto do status com informações de atraso
let statusText = data.status;
let statusDisplay = `<span class="loan-status ${statusClass}">${statusText}</span>`;

if (data.status === 'ATRASADO' && diffDays > 0) {
statusDisplay = `
<span class="loan-status ${statusClass}">ATRASADO</span><br>
<span class="badge badge-atraso">${diffDays} ${diffDays === 1 ? 'dia' : 'dias'} de atraso</span>
`;
}

if (tbody) {
tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td>${statusDisplay}</td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
}
})
.catch((error) => {
console.error('Erro ao buscar empréstimos:', error);
showAlert('danger', 'Erro ao buscar empréstimos.');
});
}
} catch (error) {
console.error('Erro na função showLoansByStatus:', error);
showAlert('danger', 'Erro ao exibir empréstimos por status.');
}
}

// Funções de impressão de comprovante
let signaturePad = null;
async function openPrintLoanModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (doc.exists) {
const data = doc.data();
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let booksHtml = '';
if (Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists) booksHtml += `<li>${bookDoc.data().titulo} (Qtd: ${b.quantity})</li>`;
else booksHtml += `<li>${b.bookId} (Qtd: ${b.quantity}) - Livro não encontrado</li>`;
} catch (e) {
booksHtml += `<li>${b.bookId} (Qtd: ${b.quantity}) - Erro ao carregar livro</li>`;
}
}
}

const receiptContent = `
<p><strong>Registro:</strong> ${data.registroNumero}</p>
<p><strong>Usuário:</strong> ${userName}</p>
<p><strong>Livros:</strong></p>
<ul>${booksHtml}</ul>
<p><strong>Data do Empréstimo:</strong> ${data.loanDate}</p>
<p><strong>Data de Devolução:</strong> ${data.returnDate}</p>
<p><strong>Status:</strong> ${data.status}</p>
`;
document.getElementById('loanReceiptContent').innerHTML = receiptContent;

const canvas = document.getElementById('signaturePad');
signaturePad = new SignaturePad(canvas);

const printLoanModal = new bootstrap.Modal(document.getElementById('printLoanModal'));
printLoanModal.show();
}
} catch (error) {
console.error('Erro ao abrir modal de impressão:', error);
showAlert('danger', 'Erro ao carregar dados do empréstimo para impressão.');
}
}

function clearSignature() {
if (signaturePad) {
signaturePad.clear();
}
}

function printLoanReceipt() {
const printArea = document.getElementById('printArea');
if (!printArea) {
showAlert('danger', 'Erro ao encontrar área de impressão.');
return;
}
// Abre uma nova janela para impressão, preservando o layout do comprovante
const printWindow = window.open('', '', 'width=800,height=600');
printWindow.document.write(`
<html>
<head>
<title>Comprovante de Empréstimo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
body { font-family: 'Poppins', Arial, sans-serif; margin: 30px; }
</style>
</head>
<body>
${printArea.innerHTML}
</body>
</html>
`);
printWindow.document.close();
printWindow.focus();
printWindow.print();
printWindow.close();
}

// Variáveis globais para assinaturas da advertência
let warningSignaturePad = null;
let librarianSignaturePad = null;
let currentWarningLoanId = null;

// Função para abrir modal de advertência
async function openWarningModal(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empréstimo não encontrado.');
return;
}

const loanData = doc.data();
currentWarningLoanId = loanId;

// Calcula dias de atraso
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

let returnDate;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
}
}

const diffTime = Math.abs(today - returnDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays < 1) {
showAlert('info', `Este empréstimo não está em atraso. Advertência aplicável apenas para empréstimos atrasados.`);
return;
}

// Busca dados do usuário
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : null;

// Busca títulos dos livros
let bookTitles = [];
if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${book.quantity})`);
} else {
bookTitles.push(`${book.bookId} (Qtd: ${book.quantity})`);
}
} catch (e) {
bookTitles.push(`${book.bookId} (Qtd: ${book.quantity}) - Erro ao carregar`);
}
}
}

// Preenche dados do usuário
const userDataHtml = userData ? `
<p class="mb-1"><strong>Nome:</strong> ${userData.nome || 'N/A'}</p>
<p class="mb-1"><strong>Matrícula:</strong> ${userData.matricula || 'N/A'}</p>
<p class="mb-1"><strong>Função:</strong> ${userData.funcao || 'N/A'}</p>
${userData.funcao === 'aluno' ? `
<p class="mb-1"><strong>Série:</strong> ${userData.serie || 'N/A'}</p>
<p class="mb-1"><strong>Turma:</strong> ${userData.turma || 'N/A'}</p>
<p class="mb-0"><strong>Turno:</strong> ${userData.turno || 'N/A'}</p>
` : `
<p class="mb-0"><strong>Email:</strong> ${userData.email || 'N/A'}</p>
`}
` : '<p class="mb-0">Dados do usuário não encontrados</p>';

document.getElementById('warningUserData').innerHTML = userDataHtml;

// Preenche detalhes do empréstimo
const loanDetailsHtml = `
<div class="row">
<div class="col-md-6">
<p class="mb-1"><strong>Registro:</strong> ${loanData.registroNumero || 'N/A'}</p>
<p class="mb-1"><strong>Data do Empréstimo:</strong> ${loanData.loanDate}</p>
<p class="mb-1"><strong>Data de Devolução:</strong> ${loanData.returnDate}</p>
</div>
<div class="col-md-6">
<p class="mb-1"><strong>Dias de Atraso:</strong> <span class="text-danger fw-bold">${diffDays} dias</span></p>
<p class="mb-1"><strong>Status:</strong> <span class="badge bg-danger">ATRASADO</span></p>
</div>
</div>
<div class="mt-3">
<p class="mb-1"><strong>Livros em Atraso:</strong></p>
<ul class="mb-0">
${bookTitles.map(title => `<li>${title}</li>`).join('')}
</ul>
</div>
`;

document.getElementById('warningLoanDetails').innerHTML = loanDetailsHtml;

// Preenche consequências baseadas no tempo de atraso
let consequencesHtml = '<h6 class="alert-heading">Consequências do Atraso:</h6><ul class="mb-0">';

if (diffDays >= 1) {
consequencesHtml += '<li>Orientação sobre a importância da devolução no prazo</li>';
}
if (diffDays >= 3) {
consequencesHtml += '<li>Advertência formal por escrito</li>';
}
if (diffDays >= 7) {
consequencesHtml += '<li>Suspensão temporária do direito a novos empréstimos</li>';
consequencesHtml += '<li>Aplicação de multa conforme regulamento interno</li>';
}
if (diffDays >= 14) {
consequencesHtml += '<li>Registro em ficha disciplinar (para estudantes)</li>';
consequencesHtml += '<li>Comunicação aos pais/responsáveis (se menor de idade)</li>';
}
if (diffDays >= 30) {
consequencesHtml += '<li>Suspensão prolongada de empréstimos (até 30 dias após devolução)</li>';
consequencesHtml += '<li>Avaliação para substituição do material em caso de perda</li>';
}

consequencesHtml += '<li>Em caso de perda ou dano, ressarcimento do valor do material</li>';
consequencesHtml += '</ul>';

document.getElementById('warningConsequences').innerHTML = consequencesHtml;

// Define data da advertência
const dataAdvertencia = getDataBrasilia();
document.getElementById('warningDate').textContent = formatarDataBrasil(dataAdvertencia);

// Inicializa pads de assinatura
const warningCanvas = document.getElementById('warningSignaturePad');
const librarianCanvas = document.getElementById('librarianSignaturePad');

warningSignaturePad = new SignaturePad(warningCanvas, {
backgroundColor: '#ffffff',
penColor: '#000000'
});

librarianSignaturePad = new SignaturePad(librarianCanvas, {
backgroundColor: '#ffffff',
penColor: '#000000'
});

// Abre o modal
const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
warningModal.show();

} catch (error) {
console.error('Erro ao abrir modal de advertência:', error);
showAlert('danger', 'Erro ao carregar dados para advertência.');
}
}

// Função para limpar assinatura do usuário
function clearWarningSignature() {
if (warningSignaturePad) {
warningSignaturePad.clear();
}
}

// Função para limpar assinatura do bibliotecário
function clearLibrarianSignature() {
if (librarianSignaturePad) {
librarianSignaturePad.clear();
}
}

// Função para salvar advertência no banco de dados
async function saveWarning() {
try {
if (!currentWarningLoanId) {
showAlert('danger', 'ID do empréstimo não encontrado.');
return;
}

if (!warningSignaturePad || warningSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, colete a assinatura do usuário antes de salvar.');
return;
}

if (!librarianSignaturePad || librarianSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, adicione a assinatura do responsável pela biblioteca.');
return;
}

const saveBtn = document.getElementById('saveWarningBtn');
saveBtn.disabled = true;
saveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Salvando...';

// Converte assinaturas para base64
const userSignature = warningSignaturePad.toDataURL();
const librarianSignature = librarianSignaturePad.toDataURL();

// Salva a advertência
const dataAdvertenciaSalvar = getDataBrasilia();
await db.collection('advertencias').add({
loanId: currentWarningLoanId,
createdAt: firebase.firestore.FieldValue.serverTimestamp(),
warningDate: formatarDataBrasil(dataAdvertenciaSalvar),
userSignature: userSignature,
librarianSignature: librarianSignature,
status: 'EMITIDA'
});

// Atualiza o empréstimo com flag de advertência
const dataAdvertenciaUpdate = getDataBrasilia();
await db.collection('emprestimos').doc(currentWarningLoanId).update({
hasWarning: true,
warningDate: formatarDataBrasil(dataAdvertenciaUpdate)
});

showAlert('success', 'Advertência salva com sucesso!');

// Fecha o modal
const warningModal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
if (warningModal) warningModal.hide();

// Atualiza a tabela
loadLoans();

} catch (error) {
console.error('Erro ao salvar advertência:', error);
showAlert('danger', 'Erro ao salvar advertência: ' + error.message);
} finally {
const saveBtn = document.getElementById('saveWarningBtn');
saveBtn.disabled = false;
saveBtn.innerHTML = '<i class="bx bx-save me-2"></i>Salvar Advertência';
}
}

// Função para imprimir advertência
function printWarning() {
if (!warningSignaturePad || warningSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, colete a assinatura do usuário antes de imprimir.');
return;
}

if (!librarianSignaturePad || librarianSignaturePad.isEmpty()) {
showAlert('warning', 'Por favor, adicione a assinatura do responsável pela biblioteca.');
return;
}

const printArea = document.getElementById('warningPrintArea');
if (!printArea) {
showAlert('danger', 'Erro ao encontrar área de impressão.');
return;
}

// Abre uma nova janela para impressão
const printWindow = window.open('', '', 'width=800,height=600');
printWindow.document.write(`
<html>
<head>
<title>Advertência por Atraso - ${SYSTEM_CONFIG.schoolName}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
@page {
size: A4;
margin: 15mm 15mm 15mm 15mm;
}
body { 
font-family: 'Arial', sans-serif; 
margin: 0; 
padding: 0;
font-size: 10px;
line-height: 1.3;
width: 100%;
max-width: 210mm;
height: 100vh;
box-sizing: border-box;
}
.print-container {
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
justify-content: space-between;
padding: 5px;
box-sizing: border-box;
}
.print-header {
text-align: center;
border-bottom: 1px solid #dc3545;
padding-bottom: 8px;
margin-bottom: 10px;
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
flex-shrink: 0;
}
.print-header-content {
flex: 1;
}
.print-header h3 {
color: #dc3545; 
margin: 0;
font-size: 14px;
}
.print-header h5 {
margin: 3px 0 0 0;
font-size: 12px;
}
.print-header p {
margin: 3px 0 0 0;
font-size: 9px;
}
.logo {
width: 45px;
height: 45px;
object-fit: contain;
}
.system-logo {
width: 70px;
height: auto;
object-fit: contain;
margin: 5px 0;
}
.print-content {
flex: 1;
overflow: hidden;
}
.alert { 
border: 1px solid #dc3545 !important;
background-color: #f8d7da !important;
color: #721c24 !important;
padding: 5px 8px;
margin-bottom: 8px;
font-size: 9px;
}
.card { 
border: 1px solid #ddd; 
margin-bottom: 8px;
}
.card-header { 
background-color: #f8f9fa; 
border-bottom: 1px solid #ddd;
padding: 5px 8px;
font-weight: bold;
font-size: 9px;
}
.card-body { 
padding: 8px;
font-size: 9px;
}
.card-body p {
margin-bottom: 3px;
}
.card-body ul {
margin-bottom: 5px;
padding-left: 15px;
}
.signature-section {
display: flex;
justify-content: space-between;
margin-top: 15px;
flex-shrink: 0;
gap: 20px;
}
.signature-area {
border-top: 1px solid #000;
height: 40px;
margin: 0 0 5px 0;
background-image: url('${warningSignaturePad.toDataURL()}');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
width: 100%;
}
.librarian-signature-area {
border-top: 1px solid #000;
height: 40px;
margin: 0 0 5px 0;
background-image: url('${librarianSignaturePad.toDataURL()}');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
width: 100%;
}
.signature-item {
text-align: center;
width: 45%;
}
.signature-item p {
margin: 3px 0 0 0;
font-weight: bold;
font-size: 9px;
}
@media print {
.modal-header, .modal-footer { display: none !important; }
.btn-close { display: none !important; }
body { 
print-color-adjust: exact;
-webkit-print-color-adjust: exact;
}
.print-container {
height: auto;
min-height: 100vh;
}
}

/* Email notification section styles */
.email-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 8px;
    margin-top: 8px;
    font-size: 9px;
}

.email-info {
    background-color: #d1ecf1;
    color: #0c5460;
    padding: 5px;
    border-radius: 0.25rem;
    margin-bottom: 5px;
    border-left: 2px solid #bee5eb;
    font-size: 8px;
}

.email-icon {
    color: #17a2b8;
    margin-right: 3px;
}

.email-checkbox {
    margin-left: 3px;
}
</style>
</head>
<body>
<div class="print-container">
<div class="print-header">
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'">
<div class="print-header-content">
<h3>ADVERTÊNCIA POR ATRASO</h3>
<h5>${SYSTEM_CONFIG.schoolName}</h5>
<img src="SISTEMA DE GERENCIAMENTO DE BIBLIOTECA.png" alt="Logo do Sistema" class="system-logo" onerror="this.style.display='none'">
<p>Sistema de Gerenciamento de Biblioteca</p>
</div>
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'" style="opacity: 0.3;">
</div>
<div class="print-content">
${printArea.querySelector('.modal-body').innerHTML}
</div>
<div class="signature-section">
<div class="signature-item">
<div class="signature-area"></div>
<p>Assinatura do Usuário</p>
</div>
<div class="signature-item">
<div class="librarian-signature-area"></div>
<p>Assinatura do Responsável</p>
</div>
</div>
</div>
</body>
</html>
`);
printWindow.document.close();
printWindow.focus();
printWindow.print();
printWindow.close();
}

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
loadLoans();
updateNotReturnedBar();
updateLoanStats();
loadSimpleWarnings(); // Carrega a contagem inicial de advertências

// Inicializa Flatpickr para campos de data
flatpickr("#loanDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#returnDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#editLoanDate", {
dateFormat: "d/m/Y",
locale: "pt"
});
flatpickr("#editReturnDate", {
dateFormat: "d/m/Y",
locale: "pt"
});

// Adiciona listener para o botão de gerar relatório
const generateReportBtn = document.getElementById('generateReportBtn');
if (generateReportBtn) {
generateReportBtn.addEventListener('click', generateLoanReport);
}

// Adiciona listener para o botão de busca principal
const searchButton = document.querySelector('.search-box button');
if (searchButton) {
searchButton.addEventListener('click', searchLoans);
}

// Adiciona listener para o input de busca principal
const searchInput = document.getElementById('searchInput');
if (searchInput) {
searchInput.addEventListener('keypress', function(event) {
if (event.key === 'Enter') {
searchLoans();
}
});

}

// Carrega os dados iniciais dos gráficos
updateLoanStats();
});

// Função de busca principal para a tabela de empréstimos
async function searchLoans() {
const query = document.getElementById('searchInput').value.toLowerCase();
const tbody = document.getElementById('loansTableBody');
tbody.innerHTML = '<tr><td colspan="6">Buscando...</td></tr>';

try {
let snapshot;
if (query) {
// Busca por registroNumero exato
snapshot = await db.collection('emprestimos')
.where('registroNumero', '==', query)
.get();

// Se não encontrar por registro, tenta buscar por nome de usuário ou livro
if (snapshot.empty) {
const allLoansSnapshot = await db.collection('emprestimos').get();
const filteredLoans = [];

for (const doc of allLoansSnapshot.docs) {
const data = doc.data();
let match = false;

// Busca por nome de usuário
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists && userDoc.data().nome.toLowerCase().includes(query)) {
match = true;
}
} catch {}

// Busca por título de livro
if (!match && Array.isArray(data.books)) {
for (const b of data.books) {
try {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
if (bookDoc.exists && bookDoc.data().titulo.toLowerCase().includes(query)) {
match = true;
break;
}
} catch {}
}
}

if (match) {
filteredLoans.push(doc);
}
}
snapshot = { docs: filteredLoans }; // Simula um snapshot para o loop abaixo
}

} else {
// Se a busca estiver vazia, carrega os últimos 15 empréstimos
snapshot = await db.collection('emprestimos')
.orderBy('createdAt', 'desc')
.limit(15)
.get();
}



tbody.innerHTML = '';
if (snapshot.docs.length === 0) {
tbody.innerHTML = '<tr><td colspan="6">Nenhum empréstimo encontrado.</td></tr>';
return;
}

for (const doc of snapshot.docs) {
const data = doc.data();
let livros = '';
if ( Array.isArray(data.books)) {
const titles = await Promise.all(
data.books.map(async (b) => {
const bookDoc = await db.collection('livros').doc(b.bookId).get();
const bookData = bookDoc.data();
return bookData ? `${bookData.titulo} (Qtd: ${b.quantity})` : b.bookId;
})
);
livros = titles.join('<br>');
}
let userName = data.userId;
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

let statusClass = '';
if (data.status === 'EMPRESTADO') statusClass = 'status-emprestado';
else if (data.status === 'ATRASADO') statusClass = 'status-atrasado';
else if (data.status === 'DEVOLVIDO') statusClass = 'status-devolvido';

let actionBtns = `
<button class="btn btn-sm btn-outline-secondary" title="Editar" onclick="openEditLoanModal('${doc.id}')">
<i class="bx bx-edit"></i>
</button>
`;
if (data.status === 'EMPRESTADO' || data.status === 'ATRASADO') {
actionBtns += `
<button class="btn btn-sm btn-outline-info return-button" title="Devolver" onclick="returnLoan('${doc.id}')">
<i class="bx bx-check-circle"></i>
</button>
<button class="btn btn-sm btn-outline-success renew-button" title="Renovar" onclick="renewLoan('${doc.id}')">
<i class="bx bx-refresh"></i>
</button>
`;
}
actionBtns += `
<button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="deleteLoan('${doc.id}')">
<i class="bx bx-trash"></i>
</button>
<button class="btn btn-sm btn-outline-primary" title="Imprimir Comprovante" onclick="openPrintLoanModal('${doc.id}')">
<i class="bx bx-printer"></i>
</button>
`;

tbody.innerHTML += `
<tr>
<td>${livros}</td>
<td>${userName}</td>
<td>${data.loanDate}</td>
<td>${data.returnDate}</td>
<td><span class="loan-status ${statusClass}">${data.status}</span></td>
<td>
<div class="action-buttons">
${actionBtns}
</div>
</td>
</tr>
`;
}
} catch (error) {
console.error('Erro ao buscar empréstimos:', error);
showAlert('danger', 'Erro ao buscar empréstimos.');
}
}

// Função simplificada para abrir modal de advertências
function showWarningsModal() {
const warningsModal = new bootstrap.Modal(document.getElementById('warningsListModal'));
warningsModal.show();
}

// Função simplificada para carregar advertências
async function loadSimpleWarnings() {
try {
const tbody = document.getElementById('simpleWarningsTableBody');
tbody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';

// Busca todos os empréstimos atrasados
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

tbody.innerHTML = '';
let count = 0;
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();

// Calcula dias de atraso
let daysLate = 0;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue; // Só mostra se realmente está atrasado

// Busca dados do usuário
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

// Busca títulos dos livros
let bookTitles = [];
if (Array.isArray(data.books)) {
for (const book of data.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(bookDoc.data().titulo);
} else {
bookTitles.push('Livro não encontrado');
}
} catch {
bookTitles.push('Erro ao carregar livro');
}
}
}

// Determina o tipo de advertência baseado nos dias de atraso
let warningType = '';
let warningClass = '';
if (daysLate >= 1 && daysLate <= 2) {
warningType = 'Orientação';
warningClass = 'bg-info text-white';
} else if (daysLate >= 3 && daysLate <= 6) {
warningType = 'Advertência Leve';
warningClass = 'bg-warning text-dark';
} else if (daysLate >= 7 && daysLate <= 13) {
warningType = 'Advertência Grave';
warningClass = 'bg-danger text-white';
} else if (daysLate >= 14) {
warningType = 'Suspensão';
warningClass = 'bg-dark text-white';
}

const formattedDate = formatarDataBrasil(getDataBrasilia());

count++;
tbody.innerHTML += `
<tr>
<td>${formattedDate}</td>
<td>${userName}</td>
<td>${bookTitles.join(', ')}</td>
<td><span class="badge bg-danger">${daysLate} dias</span></td>
<td><span class="badge ${warningClass}">${warningType}</span></td>
<td>
<div class="btn-group btn-group-sm">
<button class="btn btn-outline-primary" onclick="printSimpleWarning('${doc.id}', '${daysLate}', '${warningType}')" title="Imprimir">
<i class="bx bx-printer"></i>
</button>
<button class="btn btn-outline-success" onclick="sendWarningWhatsApp('${doc.id}')" title="Enviar WhatsApp">
<i class="bx bxl-whatsapp"></i>
</button>
</div>
</td>
</tr>
`;
}

if (count === 0) {
tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma advertência pendente</td></tr>';
}

document.getElementById('warningsCountDisplay').textContent = count;
document.getElementById('countWarnings').textContent = count;

} catch (error) {
console.error('Erro ao carregar advertências:', error);
document.getElementById('simpleWarningsTableBody').innerHTML = 
'<tr><td colspan="6" class="text-center text-danger">Erro ao carregar advertências</td></tr>';
}
}

// Função para mostrar modal de usuários bloqueados
function showBlockedUsersModal() {
const blockedModal = new bootstrap.Modal(document.getElementById('blockedUsersModal'));
blockedModal.show();
loadBlockedUsers();
}

// Função para carregar usuários bloqueados
async function loadBlockedUsers() {
try {
const tbody = document.getElementById('blockedUsersTableBody');
tbody.innerHTML = '<tr><td colspan="7" class="text-center">Carregando...</td></tr>';

// Obter termo de busca
const searchTerm = document.getElementById('blockedUsersSearchInput')?.value.toLowerCase().trim() || '';

// Busca todos os empréstimos atrasados
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

tbody.innerHTML = '';
let count = 0;
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

// Map para agrupar empréstimos por usuário
const userLoansMap = new Map();

for (const doc of snapshot.docs) {
const loanData = doc.data();

// Calcula dias de atraso usando returnDate (formato DD/MM/AAAA)
let daysLate = 0;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue; // Só inclui se realmente está atrasado

// Se o usuário já existe no mapa, adiciona este empréstimo
if (userLoansMap.has(loanData.userId)) {
const userData = userLoansMap.get(loanData.userId);
userData.loans.push({
...loanData,
id: doc.id,
daysLate: daysLate
});
userData.maxDaysLate = Math.max(userData.maxDaysLate, daysLate);
} else {
// Busca dados do usuário
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : {};

userLoansMap.set(loanData.userId, {
...userData,
loans: [{
...loanData,
id: doc.id,
daysLate: daysLate
}],
maxDaysLate: daysLate
});
}
}

// Ordena usuários por dias de atraso (maior primeiro)
const sortedUsers = Array.from(userLoansMap.values())
.sort((a, b) => b.maxDaysLate - a.maxDaysLate);

for (const userData of sortedUsers) {
// Busca títulos dos livros para todos os empréstimos do usuário
let allBookTitles = [];
let allLoanDates = [];
let allReturnDates = [];

for (const loan of userData.loans) {
if (Array.isArray(loan.books)) {
for (const book of loan.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
allBookTitles.push(`${bookDoc.data().titulo} (${book.quantity})`);
}
} catch (error) {
console.error('Erro ao buscar livro:', error);
allBookTitles.push(`Livro não encontrado (${book.quantity})`);
}
}
}
allLoanDates.push(loan.loanDate || 'Data não informada');
allReturnDates.push(loan.returnDate || 'Data não informada');
}

// Formatação para WhatsApp
const telefone = userData.telefone || '';
const whatsappNumber = telefone.replace(/\D/g, ''); // Remove caracteres não numéricos
const userName = userData.nome || 'Usuário não encontrado';
const userClass = userData.turma || 'Turma não informada';
const maxDaysLate = userData.maxDaysLate;

// Aplicar filtro de busca
if (searchTerm && !userName.toLowerCase().includes(searchTerm)) {
continue; // Pula este usuário se não corresponder à busca
}

// Mensagem personalizada para WhatsApp
const whatsappMessage = encodeURIComponent(
`Olá ${userName}!\n\n` +
`A biblioteca da ${SYSTEM_CONFIG.schoolName} está entrando em contato para informar que você possui livro(s) em atraso:\n\n` +
`📚 Livro(s): ${allBookTitles.join(', ')}\n` +
`📅 Dias de atraso: ${maxDaysLate} dias\n` +
`⚠️ Status: Usuário bloqueado para novos empréstimos\n\n` +
`Por favor, compareça à biblioteca o mais breve possível para regularizar a situação.\n\n` +
`Obrigado!\nBiblioteca ${SYSTEM_CONFIG.schoolName}`
);

count++;
tbody.innerHTML += `
<tr>
<td>
<div class="d-flex align-items-center">
<div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center me-2">
<i class="bx bx-user text-muted"></i>
</div>
<div>
<div class="fw-bold">${userName}</div>
<small class="text-muted">${userClass}</small>
</div>
</div>
</td>
<td>
<div class="d-flex flex-wrap gap-1">
${allBookTitles.map(title => `<span class="badge bg-secondary">${title}</span>`).join('')}
</div>
</td>
<td><span class="badge bg-danger fs-6">${maxDaysLate} dias</span></td>
<td><small>${allLoanDates.join('<br>')}</small></td>
<td><small>${allReturnDates.join('<br>')}</small></td>
<td>
${telefone ? `
<small class="text-muted d-block">
<i class="bx bx-phone me-1"></i>${telefone}
</small>
` : '<small class="text-muted">Sem telefone</small>'}
</td>
<td>
<div class="btn-group btn-group-sm">
${whatsappNumber ? `
<a href="https://wa.me/55${whatsappNumber}?text=${whatsappMessage}" 
   target="_blank" 
   class="btn btn-success" 
   title="Enviar WhatsApp">
<i class="bx bxl-whatsapp"></i>
</a>
` : ''}
<button class="btn btn-outline-primary" 
        onclick="printBlockedUserWarning('${userData.loans[0].userId}', '${userData.loans.map(l => l.id).join(',')}')" 
        title="Imprimir Advertência">
<i class="bx bx-printer"></i>
</button>
</div>
</td>
</tr>
`;
}

if (count === 0) {
tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum usuário bloqueado</td></tr>';
}

// Atualiza contador no card
document.getElementById('countBlockedUsers').textContent = count;

} catch (error) {
console.error('Erro ao carregar usuários bloqueados:', error);
document.getElementById('blockedUsersTableBody').innerHTML = 
'<tr><td colspan="7" class="text-center text-danger">Erro ao carregar usuários bloqueados</td></tr>';
}
}

// Função para exportar relatório de usuários bloqueados
async function exportBlockedUsersReport() {
try {
const { jsPDF } = window.jspdf;
const doc = new jsPDF('l', 'mm', 'a4'); // Formato paisagem para mais espaço

// Cabeçalho
doc.setFontSize(16);
doc.setFont(undefined, 'bold');
doc.text(SYSTEM_CONFIG.schoolName, 20, 20);
doc.setFontSize(14);
doc.text('Relatório de Usuários Bloqueados por Atraso', 20, 30);

// Data do relatório
doc.setFontSize(10);
doc.setFont(undefined, 'normal');
doc.text(`Gerado em: ${formatarDataBrasil(getDataBrasilia())}`, 20, 40);

// Preparar dados
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

const userLoansMap = new Map();

for (const docSnap of snapshot.docs) {
const loanData = docSnap.data();

// Calcula dias de atraso usando returnDate (formato DD/MM/AAAA)
let daysLate = 0;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue;

if (userLoansMap.has(loanData.userId)) {
const userData = userLoansMap.get(loanData.userId);
userData.loans.push({ ...loanData, id: docSnap.id, daysLate });
userData.maxDaysLate = Math.max(userData.maxDaysLate, daysLate);
} else {
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : {};
userLoansMap.set(loanData.userId, {
...userData,
loans: [{ ...loanData, id: docSnap.id, daysLate }],
maxDaysLate: daysLate
});
}
}

// Dados da tabela
const tableData = [];
for (const userData of userLoansMap.values()) {
let bookTitles = [];
for (const loan of userData.loans) {
if (Array.isArray(loan.books)) {
for (const book of loan.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(`${bookDoc.data().titulo} (${book.quantity})`);
}
} catch (error) {
bookTitles.push(`Livro não encontrado (${book.quantity})`);
}
}
}
}

tableData.push([
userData.nome || 'Nome não informado',
userData.turma || 'Turma não informada',
bookTitles.join(', '),
`${userData.maxDaysLate} dias`,
userData.telefone || 'Não informado'
]);
}

// Tabela
doc.autoTable({
head: [['Nome', 'Turma', 'Livros em Atraso', 'Dias de Atraso', 'Telefone']],
body: tableData,
startY: 50,
styles: { fontSize: 8 },
headStyles: { fillColor: [156, 39, 176] }, // Cor roxa
columnStyles: {
2: { cellWidth: 80 }, // Coluna dos livros mais larga
},
margin: { left: 20, right: 20 }
});

// Salvar PDF
doc.save(`Usuarios_Bloqueados_${formatarDataBrasil(getDataBrasilia()).replace(/\//g, '-')}.pdf`);

showAlert('success', 'Relatório exportado com sucesso!');

} catch (error) {
console.error('Erro ao exportar relatório:', error);
showAlert('danger', 'Erro ao exportar relatório.');
}
}

// Função para imprimir relatório de usuário bloqueado específico
async function printBlockedUserReport(loanIds) {
try {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

// Cabeçalho
doc.setFontSize(16);
doc.setFont(undefined, 'bold');
doc.text(SYSTEM_CONFIG.schoolName, 20, 20);
doc.setFontSize(14);
doc.text('Notificação de Bloqueio por Atraso', 20, 30);

// Buscar dados dos empréstimos
const loanIdArray = loanIds.split(',');
let userData = null;
let allBooks = [];

for (const loanId of loanIdArray) {
const loanDoc = await db.collection('emprestimos').doc(loanId).get();
if (loanDoc.exists) {
const loanData = loanDoc.data();

if (!userData) {
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
userData = userDoc.exists ? userDoc.data() : {};
}

if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
// Converte returnDate do formato DD/MM/AAAA para Date
let returnDate = null;
if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
}
}

allBooks.push({
...bookDoc.data(),
quantity: book.quantity,
returnDate: returnDate || new Date()
});
}
}
}
}
}

if (!userData) {
showAlert('danger', 'Usuário não encontrado.');
return;
}

// Conteúdo da notificação
doc.setFontSize(12);
doc.setFont(undefined, 'normal');
doc.text(`Data: ${formatarDataBrasil(getDataBrasilia())}`, 20, 50);
doc.text(`Usuário: ${userData.nome || 'Nome não informado'}`, 20, 60);
doc.text(`Turma: ${userData.turma || 'Turma não informada'}`, 20, 70);

doc.setFont(undefined, 'bold');
doc.text('SITUAÇÃO: USUÁRIO BLOQUEADO PARA NOVOS EMPRÉSTIMOS', 20, 90);

doc.setFont(undefined, 'normal');
doc.text('Motivo: Atraso na devolução de livro(s)', 20, 100);

let yPosition = 120;
doc.text('Livro(s) em atraso:', 20, yPosition);
yPosition += 10;

allBooks.forEach(book => {
const returnDate = book.returnDate ? formatarDataBrasil(book.returnDate) : 'Data inválida';
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
const daysLate = book.returnDate ? Math.ceil((today - book.returnDate) / (1000 * 60 * 60 * 24)) : 0;

doc.text(`• ${book.titulo} (Qtd: ${book.quantity}) - Deveria ter sido devolvido em: ${returnDate} (${daysLate} dias de atraso)`, 25, yPosition);
yPosition += 10;
});

yPosition += 10;
doc.setFont(undefined, 'bold');
doc.text('ORIENTAÇÕES:', 20, yPosition);
yPosition += 10;
doc.setFont(undefined, 'normal');
doc.text('1. Compareça à biblioteca para regularizar a situação', 20, yPosition);
yPosition += 10;
doc.text('2. Novos empréstimos só serão liberados após a devolução', 20, yPosition);
yPosition += 10;
doc.text('3. Em caso de perda ou dano, procure a coordenação', 20, yPosition);

// Rodapé
doc.setFontSize(10);
doc.text('Biblioteca - ' + SYSTEM_CONFIG.schoolName, 20, 280);

// Salvar PDF
doc.save(`Notificacao_Bloqueio_${userData.nome?.replace(/\s+/g, '_') || 'Usuario'}.pdf`);

} catch (error) {
console.error('Erro ao imprimir relatório:', error);
showAlert('danger', 'Erro ao imprimir relatório.');
}
}

// Função para imprimir advertência de usuário bloqueado
async function printBlockedUserWarning(userId, loanIds) {
try {
    // Busca dados do usuário
    const userDoc = await db.collection('usuarios').doc(userId).get();
    if (!userDoc.exists) {
        showAlert('danger', 'Usuário não encontrado.');
        return;
    }
    
    const userData = userDoc.data();
    
    // Busca dados dos empréstimos em atraso
    const loanIdsArray = loanIds.split(',');
    const loanPromises = loanIdsArray.map(id => db.collection('emprestimos').doc(id).get());
    const loanDocs = await Promise.all(loanPromises);
    
    const today = getDataBrasilia();
    today.setHours(0, 0, 0, 0);
    
    let maxDaysLate = 0;
    let totalBooks = [];
    let loanDetails = [];
    
    // Processa cada empréstimo
    for (const loanDoc of loanDocs) {
        if (!loanDoc.exists) continue;
        
        const loanData = loanDoc.data();
        
        // Calcula dias de atraso
        let daysLate = 0;
        if (loanData.returnDate) {
            const dateParts = loanData.returnDate.split('/');
            if (dateParts.length === 3) {
                const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                returnDate.setHours(0, 0, 0, 0);
                const diffTime = Math.abs(today - returnDate);
                daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
        }
        
        maxDaysLate = Math.max(maxDaysLate, daysLate);
        
        // Busca títulos dos livros
        if (Array.isArray(loanData.books)) {
            for (const book of loanData.books) {
                try {
                    const bookDoc = await db.collection('livros').doc(book.bookId).get();
                    if (bookDoc.exists) {
                        totalBooks.push(`${bookDoc.data().titulo} (${book.quantity})`);
                    }
                } catch (error) {
                    console.error('Erro ao buscar livro:', error);
                }
            }
        }
        
        loanDetails.push({
            registroNumero: loanData.registroNumero,
            loanDate: loanData.loanDate,
            returnDate: loanData.returnDate,
            daysLate: daysLate
        });
    }
    
    // Determina tipo de advertência baseado no maior atraso
    let warningType = '';
    if (maxDaysLate >= 1 && maxDaysLate <= 2) warningType = 'Orientação';
    else if (maxDaysLate >= 3 && maxDaysLate <= 6) warningType = 'Advertência Leve';
    else if (maxDaysLate >= 7 && maxDaysLate <= 13) warningType = 'Advertência Grave';
    else if (maxDaysLate >= 14) warningType = 'Suspensão';
    
    const currentDate = formatarDataBrasil(getDataBrasilia());
    
    // Gera o HTML para impressão
    const printContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Advertência por Atraso - ${userData.nome}</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            line-height: 1.6;
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 20px;
        }
        .header-content {
            text-align: center;
            flex-grow: 1;
        }
        .logo { 
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
        }
        .system-logo { 
            width: 120px; 
            height: auto; 
            object-fit: contain; 
            margin: 10px 0; 
        }
        .warning-box { 
            border: 2px solid #dc3545; 
            padding: 15px; 
            margin: 20px 0; 
            background-color: #fff5f5; 
            border-radius: 5px;
        }
        .info-box { 
            background-color: #f8f9fa; 
            padding: 15px; 
            border-left: 4px solid #007bff; 
            margin: 15px 0; 
            border-radius: 0 5px 5px 0;
        }
        .signature-section { 
            margin-top: 60px; 
            display: flex; 
            justify-content: space-between; 
            gap: 30px;
        }
        .signature-box { 
            width: 45%; 
            text-align: center;
        }
        .signature-line { 
            border-top: 1px solid #000; 
            margin-bottom: 5px; 
            height: 60px;
            margin-top: 0;
        }
        .signature-label {
            font-weight: bold;
            margin-top: 10px;
        }
        .loan-detail {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        @media print {
            .logo { width: 60px; height: 60px; }
            .system-logo { width: 100px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'">
        <div class="header-content">
            <h2 style="color: #dc3545; margin: 0;">ADVERTÊNCIA POR ATRASO</h2>
            <h4 style="margin: 5px 0;">${SYSTEM_CONFIG.schoolName}</h4>
            <img src="SISTEMA DE GERENCIAMENTO DE BIBLIOTECA.png" alt="Logo do Sistema" class="system-logo" onerror="this.style.display='none'">
            <p style="margin: 5px 0;">Sistema de Gerenciamento de Biblioteca</p>
            <p style="margin: 5px 0;">Data: ${currentDate}</p>
        </div>
        <img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'" style="opacity: 0.3;">
    </div>

    <div class="warning-box">
        <h3 style="color: #dc3545; margin-top: 0;">TIPO: ${warningType.toUpperCase()}</h3>
        <p><strong>Máximo de Dias de Atraso:</strong> ${maxDaysLate} dias</p>
        <p><strong>Status:</strong> <span style="color: #dc3545; font-weight: bold;">USUÁRIO BLOQUEADO</span></p>
    </div>

    <div class="info-box">
        <h4>Dados do Usuário:</h4>
        <p><strong>Nome:</strong> ${userData.nome || 'N/A'}</p>
        <p><strong>Matrícula:</strong> ${userData.matricula || 'N/A'}</p>
        <p><strong>Função:</strong> ${userData.funcao || 'N/A'}</p>
        ${userData.telefone ? `<p><strong>Telefone:</strong> ${userData.telefone}</p>` : ''}
    </div>

    <div class="info-box">
        <h4>Detalhes dos Empréstimos em Atraso:</h4>
        ${loanDetails.map(loan => `
            <div class="loan-detail">
                <p><strong>Registro:</strong> ${loan.registroNumero || 'N/A'}</p>
                <p><strong>Data do Empréstimo:</strong> ${loan.loanDate}</p>
                <p><strong>Data de Devolução:</strong> ${loan.returnDate}</p>
                <p><strong>Dias de Atraso:</strong> ${loan.daysLate} dias</p>
            </div>
        `).join('')}
        
        <h5 style="margin-top: 20px;">Livros em Atraso:</h5>
        <ul>
            ${totalBooks.map(title => `<li>${title}</li>`).join('')}
        </ul>
    </div>

    <div class="warning-box">
        <h4>Consequências do Bloqueio:</h4>
        <ul>
            <li>Impossibilidade de realizar novos empréstimos</li>
            <li>Bloqueio permanente até regularização</li>
            <li>Possível aplicação de multa conforme regulamento</li>
        </ul>
        
        <h4>Ações Necessárias:</h4>
        <ol>
            <li>Devolução imediata de todos os materiais em atraso</li>
            <li>Pagamento de eventual multa aplicada</li>
            <li>Assinatura deste termo de advertência</li>
            <li>Comparecimento à coordenação da biblioteca</li>
        </ol>
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">Assinatura do Usuário</div>
        </div>
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">Assinatura do Responsável</div>
        </div>
    </div>

    <p style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
        Este documento foi gerado automaticamente pelo Sistema SIGEB<br>
        ${SYSTEM_CONFIG.schoolName}<br>
        Usuário encontra-se <strong>BLOQUEADO</strong> até regularização da situação
    </p>
</body>
</html>
`;

    // Abre janela de impressão
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();

    showAlert('success', 'Advertência de usuário bloqueado enviada para impressão!');

} catch (error) {
    console.error('Erro ao imprimir advertência:', error);
    showAlert('danger', 'Erro ao gerar advertência para impressão.');
}
}

// Função para enviar advertência via WhatsApp
async function sendWarningWhatsApp(loanId) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empréstimo não encontrado.');
return;
}

const loanData = doc.data();

// Busca dados do usuário
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
if (!userDoc.exists) {
showAlert('danger', 'Usuário não encontrado.');
return;
}

const userData = userDoc.data();

// Verifica se o usuário tem telefone
if (!userData.telefone) {
showAlert('warning', 'Usuário não possui telefone cadastrado para envio via WhatsApp.');
return;
}

// Calcula dias de atraso
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);
let daysLate = 0;

if (loanData.returnDate) {
const dateParts = loanData.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

// Busca títulos dos livros
let bookTitles = [];
if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(bookDoc.data().titulo);
}
} catch (error) {
console.error('Erro ao buscar livro:', error);
}
}
}

// Determina tipo de advertência
let warningType = '';
if (daysLate >= 1 && daysLate <= 2) warningType = 'Orientação';
else if (daysLate >= 3 && daysLate <= 6) warningType = 'Advertência Leve';
else if (daysLate >= 7 && daysLate <= 13) warningType = 'Advertência Grave';
else if (daysLate >= 14) warningType = 'Suspensão';

// Monta a mensagem do WhatsApp
const message = `🚨 *${warningType.toUpperCase()}* - ${SYSTEM_CONFIG.schoolName}

📚 *Livro(s) em atraso:*
${bookTitles.map(title => `• ${title}`).join('\n')}

👤 *Usuário:* ${userData.nome}
📅 *Data de Devolução:* ${loanData.returnDate}
⏰ *Dias de Atraso:* ${daysLate} dias

⚠️ *Ação Necessária:*
Devolução imediata do(s) material(is) em atraso.

O não cumprimento desta advertência poderá resultar em suspensão de novos empréstimos.

---
📧 Sistema SIGEB - ${SYSTEM_CONFIG.schoolName}`;

// Limpa o telefone (remove caracteres especiais)
let phoneNumber = userData.telefone.replace(/\D/g, '');

// Adiciona código do país se não tiver (assume Brasil)
if (phoneNumber.length === 11 && phoneNumber.startsWith('0')) {
phoneNumber = '55' + phoneNumber.substring(1);
} else if (phoneNumber.length === 10) {
phoneNumber = '55' + phoneNumber;
} else if (phoneNumber.length === 11 && !phoneNumber.startsWith('55')) {
phoneNumber = '55' + phoneNumber;
}

// Codifica a mensagem para URL
const encodedMessage = encodeURIComponent(message);

// Monta URL do WhatsApp
const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

// Abre WhatsApp Web
window.open(whatsappUrl, '_blank');

showAlert('success', `Mensagem de advertência enviada para ${userData.nome} via WhatsApp!`);

} catch (error) {
console.error('Erro ao enviar WhatsApp:', error);
showAlert('danger', 'Erro ao enviar mensagem via WhatsApp.');
}
}

// Função para imprimir advertência simples
async function printSimpleWarning(loanId, daysLate, warningType) {
try {
const doc = await db.collection('emprestimos').doc(loanId).get();
if (!doc.exists) {
showAlert('danger', 'Empréstimo não encontrado.');
return;
}

const loanData = doc.data();

// Busca dados do usuário
const userDoc = await db.collection('usuarios').doc(loanData.userId).get();
const userData = userDoc.exists ? userDoc.data() : {};

// Busca títulos dos livros
let bookTitles = [];
if (Array.isArray(loanData.books)) {
for (const book of loanData.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(`${bookDoc.data().titulo} (Qtd: ${book.quantity})`);
}
} catch {}
}
}

const currentDate = formatarDataBrasil(getDataBrasilia());

// Cria conteúdo para impressão
const printContent = `
<html>
<head>
<title>Advertência - ${SYSTEM_CONFIG.schoolName}</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; font-size: 14px; }
.header { 
text-align: center; 
border-bottom: 2px solid #dc3545; 
padding-bottom: 15px; 
margin-bottom: 20px; 
display: flex;
align-items: center;
justify-content: center;
gap: 20px;
}
.header-content {
flex: 1;
}
.logo {
width: 80px;
height: 80px;
object-fit: contain;
}
.system-logo {
width: 120px;
height: auto;
object-fit: contain;
margin: 10px 0;
}
.warning-box { border: 2px solid #dc3545; padding: 15px; margin: 20px 0; background-color: #fff5f5; }
.info-box { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 15px 0; }
.signature-section { 
margin-top: 60px; 
display: flex; 
justify-content: space-between; 
gap: 30px;
}
.signature-box { 
width: 45%; 
text-align: center;
}
.signature-line { 
border-top: 1px solid #000; 
margin-bottom: 5px; 
height: 60px;
margin-top: 0;
}
.signature-label {
font-weight: bold;
margin-top: 10px;
}
@media print {
.logo { width: 60px; height: 60px; }
.system-logo { width: 100px; }
}
</style>
</head>
<body>
<div class="header">
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'">
<div class="header-content">
<h2 style="color: #dc3545; margin: 0;">ADVERTÊNCIA POR ATRASO</h2>
<h4 style="margin: 5px 0;">${SYSTEM_CONFIG.schoolName}</h4>
<img src="SISTEMA DE GERENCIAMENTO DE BIBLIOTECA.png" alt="Logo do Sistema" class="system-logo" onerror="this.style.display='none'">
<p style="margin: 5px 0;">Sistema de Gerenciamento de Biblioteca</p>
<p style="margin: 5px 0;">Data: ${currentDate}</p>
</div>
<img src="logobias.png" alt="Logo da Escola" class="logo" onerror="this.style.display='none'" style="opacity: 0.3;">
</div>

<div class="warning-box">
<h3 style="color: #dc3545; margin-top: 0;">TIPO: ${warningType.toUpperCase()}</h3>
<p><strong>Dias de Atraso:</strong> ${daysLate} dias</p>
</div>

<div class="info-box">
<h4>Dados do Usuário:</h4>
<p><strong>Nome:</strong> ${userData.nome || 'N/A'}</p>
<p><strong>Matrícula:</strong> ${userData.matricula || 'N/A'}</p>
<p><strong>Função:</strong> ${userData.funcao || 'N/A'}</p>
</div>

<div class="info-box">
<h4>Detalhes do Empréstimo:</h4>
<p><strong>Registro:</strong> ${loanData.registroNumero || 'N/A'}</p>
<p><strong>Data do Empréstimo:</strong> ${loanData.loanDate}</p>
<p><strong>Data de Devolução:</strong> ${loanData.returnDate}</p>
<p><strong>Livros:</strong></p>
<ul>
${bookTitles.map(title => `<li>${title}</li>`).join('')}
</ul>
</div>

<div class="warning-box">
<h4>Ação Necessária:</h4>
<p>Devolução imediata do(s) material(is) em atraso.</p>
<p>O não cumprimento desta advertência poderá resultar em suspensão de novos empréstimos.</p>
</div>

<div class="signature-section">
<div class="signature-box">
<div class="signature-line"></div>
<div class="signature-label">Assinatura do Usuário</div>
</div>
<div class="signature-box">
<div class="signature-line"></div>
<div class="signature-label">Assinatura do Responsável</div>
</div>
</div>

<p style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
Este documento foi gerado automaticamente pelo Sistema SIGEB<br>
${SYSTEM_CONFIG.schoolName}
</p>
</body>
</html>
`;

// Abre janela de impressão
const printWindow = window.open('', '_blank');
printWindow.document.write(printContent);
printWindow.document.close();
printWindow.focus();
printWindow.print();

showAlert('success', 'Advertência enviada para impressão!');

} catch (error) {
console.error('Erro ao imprimir advertência:', error);
showAlert('danger', 'Erro ao gerar advertência para impressão.');
}
}

// Função para exportar relatório simples
async function exportSimpleWarningsReport() {
try {
const snapshot = await db.collection('emprestimos')
.where('status', '==', 'ATRASADO')
.get();

const warnings = [];
const today = getDataBrasilia();
today.setHours(0, 0, 0, 0);

for (const doc of snapshot.docs) {
const data = doc.data();

// Calcula dias de atraso
let daysLate = 0;
if (data.returnDate) {
const dateParts = data.returnDate.split('/');
if (dateParts.length === 3) {
const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
returnDate.setHours(0, 0, 0, 0);
const diffTime = Math.abs(today - returnDate);
daysLate = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
}

if (daysLate <= 0) continue;

// Busca dados do usuário
let userName = 'N/A';
try {
const userDoc = await db.collection('usuarios').doc(data.userId).get();
if (userDoc.exists) userName = userDoc.data().nome;
} catch {}

// Busca títulos dos livros
let bookTitles = [];
if (Array.isArray(data.books)) {
for (const book of data.books) {
try {
const bookDoc = await db.collection('livros').doc(book.bookId).get();
if (bookDoc.exists) {
bookTitles.push(bookDoc.data().titulo);
}
} catch {}
}
}

// Tipo de advertência
let warningType = '';
if (daysLate >= 1 && daysLate <= 2) warningType = 'Orientação';
else if (daysLate >= 3 && daysLate <= 6) warningType = 'Advertência Leve';
else if (daysLate >= 7 && daysLate <= 13) warningType = 'Advertência Grave';
else if (daysLate >= 14) warningType = 'Suspensão';

warnings.push({
'Data': formatarDataBrasil(getDataBrasilia()),
'Usuário': userName,
'Livros': bookTitles.join('; '),
'Dias de Atraso': daysLate,
'Tipo de Advertência': warningType,
'Data do Empréstimo': data.loanDate,
'Data de Devolução': data.returnDate
});
}

if (warnings.length === 0) {
showAlert('warning', 'Nenhuma advertência encontrada para exportar');
return;
}

const ws = XLSX.utils.json_to_sheet(warnings);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Advertências");

const now = getDataBrasilia();
const fileName = `advertencias_${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}_${now.getDate().toString().padStart(2, '0')}.xlsx`;

XLSX.writeFile(wb, fileName);
showAlert('success', 'Relatório de advertências exportado com sucesso!');

} catch (error) {
console.error('Erro ao exportar relatório:', error);
showAlert('danger', 'Erro ao exportar relatório de advertências');
}
}

// Carregar advertências quando o modal for aberto
document.getElementById('warningsListModal').addEventListener('shown.bs.modal', function () {
loadSimpleWarnings();
});

// Configurar busca em tempo real para advertências
document.getElementById('warningsSearchInput').addEventListener('input', function() {
clearTimeout(this.searchTimeout);
this.searchTimeout = setTimeout(() => {
loadSimpleWarnings();
}, 500);
});

// Configurar busca em tempo real para usuários bloqueados
document.getElementById('blockedUsersSearchInput').addEventListener('input', function() {
clearTimeout(this.searchTimeout);
this.searchTimeout = setTimeout(() => {
loadBlockedUsers();
}, 500);
});

// Atualize todos os usuários para ter o campo nomeSearch
db.collection('usuarios').get().then(snapshot => {
snapshot.forEach(doc => {
const nome = doc.data().nome || '';
const nomeSearch = nome.toLowerCase().split(' ');
db.collection('usuarios').doc(doc.id).update({ nomeSearch });
});
});
db.collection('livros').get().then(snapshot => {
snapshot.forEach(doc => {
const titulo = doc.data().titulo || '';
const tituloSearch = titulo.toLowerCase().split(' ');
db.collection('livros').doc(doc.id).update({ tituloSearch });
});
}); </script>
<script>
document.addEventListener('focusin', function(e) {
let el = e.target;
while (el) {
if (el.getAttribute && el.getAttribute('aria-hidden') === 'true') {
// Remove o foco se estiver dentro de um aria-hidden
if (typeof el.blur === 'function') el.blur();
// Move o foco para o body
document.body.focus();
break;
}
el = el.parentElement;
}
});

</script>
<script>
// Garante que aria-hidden="true" seja removido de modais abertos
function fixAriaHiddenOnOpenModals() {
document.querySelectorAll('.modal').forEach(function(modal) {
const isVisible = window.getComputedStyle(modal).display === 'block';
if (isVisible) {
// Remove aria-hidden se existir
if (modal.hasAttribute('aria-hidden')) {
modal.removeAttribute('aria-hidden');
}
}
});
}

// Monitora abertura de modais Bootstrap para garantir acessibilidade
document.addEventListener('shown.bs.modal', fixAriaHiddenOnOpenModals);
document.addEventListener('DOMContentLoaded', function() {
    // Log da configuração atual
    console.log('🔧 Sistema SIGEB carregado');
    
    // Corrige ao carregar a página caso algum modal esteja aberto
    fixAriaHiddenOnOpenModals();
});

// Também corrige ao abrir modal programaticamente (ex: printLoanModal)
const printLoanModal = document.getElementById('printLoanModal');
if (printLoanModal) {
printLoanModal.addEventListener('shown.bs.modal', function() {
if (printLoanModal.hasAttribute('aria-hidden')) {
printLoanModal.removeAttribute('aria-hidden');
}
});
}
</script>
</body>
</html>
