<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGEB - Relatórios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Reset e configurações base */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Overlay para melhor contraste */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at top, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.2));
      pointer-events: none;
      z-index: -1;
    }
    
    /* Sidebar melhorada */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 260px;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 25px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-header {
      padding: 25px 0;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      margin-bottom: 25px;
    }
    
    .sidebar-header h3 {
      background: linear-gradient(135deg, #00f2fe, #4facfe, #00c9ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 1px;
      text-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    }
    
    .menu-items {
      padding: 0;
    }
    
    .menu-item {
      padding: 15px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(79, 172, 254, 0.2), rgba(0, 242, 254, 0.2));
      transition: width 0.3s ease;
    }
    
    .menu-item:hover::before, .menu-item.active::before {
      width: 100%;
    }
    
    .menu-item:hover, .menu-item.active {
      color: #4facfe;
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);
    }
    
    .menu-item i {
      margin-right: 15px;
      font-size: 1.3rem;
      z-index: 1;
      position: relative;
    }
    
    .menu-item span {
      z-index: 1;
      position: relative;
      font-weight: 500;
    }

    /* Main Content melhorado */
    .main-content {
      margin-left: 260px;
      padding: 30px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 100vh;
    }

    /* Header da página */
    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #4facfe);
    }
    
    .page-header h2 {
      margin: 0 0 10px 0;
      color: #1e293b;
      font-weight: 700;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .page-header p {
      margin: 0;
      color: #64748b;
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Cards do sistema (relatórios, filtros, etc.) */
    .settings-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .settings-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .settings-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }
    
    .settings-card h4, .settings-card h5 {
      color: #1e293b;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .settings-card h4::before, .settings-card h5::before {
      content: '';
      width: 4px;
      height: 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    /* Report type cards */
    .report-type-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .report-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .report-card:hover::before {
      opacity: 1;
    }

    .report-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      border-color: rgba(102, 126, 234, 0.4);
    }

    .report-card.active {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transform: translateY(-5px);
    }

    .report-card-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 2rem;
      color: white;
      position: relative;
    }

    .report-card-icon.books { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .report-card-icon.users { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .report-card-icon.loans { background: linear-gradient(135deg, #FFD54F 0%, #FF9800 100%); }
    .report-card-icon.readers { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .report-card-icon.warnings { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }

    .report-card h4 {
      color: #1e293b;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .report-card h4::before {
      display: none;
    }

    .report-card p {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.4;
      margin: 0;
    }

    /* Form elements melhorados */
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255, 255, 255, 0.95);
      outline: none;
    }

    /* Botões melhorados */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-gradient:hover::before {
      left: 100%;
    }
    
    .btn-gradient:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    .btn-outline-light {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #374151;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    /* Feature highlight */
    .feature-highlight {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
    }
    
    .feature-highlight h6 {
      color: #1e293b;
      margin-bottom: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Table styling */
    .table {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
    }

    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 15px;
    }

    .table tbody tr {
      transition: all 0.3s ease;
      border: none;
    }

    .table tbody tr:hover {
      background-color: rgba(102, 126, 234, 0.05);
      transform: scale(1.01);
    }

    .table tbody td {
      border-color: rgba(0, 0, 0, 0.05);
      padding: 12px 15px;
    }

    /* Stats cards */
    .stats-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .stats-label {
      color: #64748b;
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Tooltips */
    .tooltip-info {
      position: relative;
      display: inline-block;
      margin-left: 8px;
      cursor: help;
    }

    .tooltip-info .tooltip-text {
      visibility: hidden;
      width: 250px;
      background: rgba(30, 41, 59, 0.95);
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tooltip-info:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar { 
        position: static; 
        width: 100%; 
        height: auto;
      }
      .main-content { 
        margin-left: 0; 
        padding: 20px;
      }
      .report-type-cards {
        grid-template-columns: 1fr;
      }
      .page-header h2 {
        font-size: 1.8rem;
      }
      .page-header, .settings-card {
        padding: 20px;
      }
    }

    @media (max-width: 576px) {
      .main-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>SIGEB</h3>
    </div>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">
        <i class='bx bxs-dashboard'></i>
        <span>Dashboard</span>
      </a>
      <a href="livros.html" class="menu-item">
        <i class='bx bxs-book'></i>
        <span>Livros</span>
      </a>
      <a href="usuarios.html" class="menu-item">
        <i class='bx bxs-user'></i>
        <span>Usuários</span>
      </a>
      <a href="emprestimos.html" class="menu-item">
        <i class='bx bxs-bookmark'></i>
        <span>Empréstimos</span>
      </a>
      <a href="relatorios.html" class="menu-item active">
        <i class='bx bxs-report'></i>
        <span>Relatórios</span>
      </a>
      <a href="configuracoes.html" class="menu-item">
        <i class='bx bxs-cog'></i>
        <span>Configurações</span>
      </a>
      <a href="index.html" class="menu-item">
        <i class='bx bxs-log-out'></i>
        <span>Sair</span>
      </a>
    </div>
  </div>
  <div class="main-content">
    <!-- Cabeçalho da Página -->
    <div class="page-header">
      <h2><i class='bx bxs-report'></i> Relatórios do Sistema</h2>
      <p>Gere relatórios detalhados para análise e acompanhamento da biblioteca</p>
    </div>

    <!-- Seletor de Tipo de Relatório -->
    <div class="settings-card">
      <h4>
        <i class='bx bx-list-check'></i> Escolha o Tipo de Relatório
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Selecione um dos relatórios disponíveis. Cada um oferece informações específicas sobre diferentes aspectos da biblioteca.</span>
        </span>
      </h4>
      
      <div class="report-type-cards">
        <div class="report-card" data-type="livros">
          <div class="report-card-icon books">
            <i class='bx bxs-book'></i>
          </div>
          <h4>Relatório de Livros</h4>
          <p>Visualize todos os livros cadastrados, com filtros por gênero, disponibilidade e estatísticas do acervo</p>
        </div>
        
        <div class="report-card" data-type="usuarios">
          <div class="report-card-icon users">
            <i class='bx bxs-user-detail'></i>
          </div>
          <h4>Relatório de Usuários</h4>
          <p>Lista completa de usuários cadastrados com informações de contato, status e função no sistema</p>
        </div>
        
        <div class="report-card" data-type="emprestimos">
          <div class="report-card-icon loans">
            <i class='bx bxs-bookmark'></i>
          </div>
          <h4>Relatório de Empréstimos</h4>
          <p>Histórico detalhado de empréstimos com filtros por período, status e situação das devoluções</p>
        </div>
        
        <div class="report-card" data-type="leitores">
          <div class="report-card-icon readers">
            <i class='bx bxs-trophy'></i>
          </div>
          <h4>Ranking de Leitores</h4>
          <p>Classificação dos usuários mais ativos, incentivando a leitura e reconhecendo os melhores leitores</p>
        </div>
        
        <div class="report-card" data-type="advertencias">
          <div class="report-card-icon warnings">
            <i class='bx bxs-error-alt'></i>
          </div>
          <h4>Relatório de Advertências</h4>
          <p>Acompanhe empréstimos em atraso e situações que necessitam atenção especial</p>
        </div>
      </div>

      <!-- Campo oculto para manter compatibilidade -->
      <select class="form-select d-none" id="reportType" name="reportType">
        <option value="livros">Livros</option>
        <option value="usuarios">Usuários</option>
        <option value="emprestimos">Empréstimos</option>
        <option value="leitores">Ranking de Leitores</option>
        <option value="advertencias">Advertências</option>
      </select>
    </div>

    <!-- Filtros e Configurações -->
    <div class="settings-card">
      <h5>
        <i class='bx bx-filter-alt'></i> Filtros e Configurações
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Configure os filtros específicos para personalizar seu relatório conforme suas necessidades.</span>
        </span>
      </h5>
      
      <div class="feature-highlight d-none" id="reportHelp">
        <h6><i class='bx bx-bulb'></i> Dica:</h6>
        <p id="reportHelpText">Selecione um tipo de relatório acima para ver as opções de filtros disponíveis.</p>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3 d-none" id="livrosFilters">
          <label class="form-label" for="livrosGenero">
            <i class='bx bx-category'></i> Filtrar por Gênero
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Selecione um gênero específico ou deixe "Todos" para incluir todos os gêneros no relatório.</span>
            </span>
          </label>
          <select class="form-select" id="livrosGenero" name="livrosGenero">
            <option value="">Todos os Gêneros</option>
            <option value="AVENTURA">Aventura</option>
            <option value="AUTOAJUDA">Autoajuda</option>
            <option value="BIOGRAFIA">Biografia</option>
            <option value="CIENCIAS">Ciências</option>
            <option value="DRAMA">Drama</option>
            <option value="EDUCACAO">Educação</option>
            <option value="FANTASIA">Fantasia</option>
            <option value="FICCAO_CIENTIFICA">Ficção Científica</option>
            <option value="HISTORIA">História</option>
            <option value="INFANTIL">Infantil</option>
            <option value="MISTERIO">Mistério</option>
            <option value="OUTROS">Outros</option>
            <option value="POESIA">Poesia</option>
            <option value="ROMANCE">Romance</option>
            <option value="TECNOLOGIA">Tecnologia</option>
            <option value="TERROR">Terror</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="usuariosFilters">
          <label class="form-label" for="usuariosStatus">
            <i class='bx bx-user-check'></i> Status do Usuário
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Filtre usuários por status: Ativos (podem fazer empréstimos) ou Inativos (bloqueados).</span>
            </span>
          </label>
          <select class="form-select" id="usuariosStatus" name="usuariosStatus">
            <option value="">Todos os Status</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="emprestimosFilters">
          <label class="form-label" for="emprestimosSituacao">
            <i class='bx bx-time'></i> Situação
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Ativo: ainda não devolvido | Finalizado: já devolvido | Atrasado: vencido</span>
            </span>
          </label>
          <select class="form-select" id="emprestimosSituacao" name="emprestimosSituacao">
            <option value="">Todas as Situações</option>
            <option value="Ativo">Ativo</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Atrasado">Atrasado</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="leitoresFilters">
          <label class="form-label" for="leitoresOrdem">
            <i class='bx bx-sort'></i> Ordenação
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Escolha como ordenar o ranking: dos que mais leram para os que menos leram ou vice-versa.</span>
            </span>
          </label>
          <select class="form-select" id="leitoresOrdem" name="leitoresOrdem">
            <option value="desc">Maior para Menor</option>
            <option value="asc">Menor para Maior</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <button class="btn btn-gradient w-100" id="btnGerarRelatorio" disabled>
            <i class='bx bx-search-alt'></i> Gerar Relatório
          </button>
        </div>
      </div>
      <!-- Filtros de data para empréstimos -->
      <div class="row g-3 align-items-end mt-2" id="emprestimosDateFilters" style="display: none;">
        <div class="col-md-3" id="emprestimosDataInicioFilter">
          <label class="form-label" for="dataInicio">
            <i class='bx bx-calendar'></i> Data Início
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empréstimos realizados a partir desta data serão incluídos no relatório.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataInicio" name="dataInicio">
        </div>
        <div class="col-md-3" id="emprestimosDataFimFilter">
          <label class="form-label" for="dataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empréstimos realizados até esta data serão incluídos no relatório.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataFim" name="dataFim">
        </div>
        <div class="col-md-3">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF"><i class='bx bx-download'></i> Baixar PDF</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('dataInicio').value=''; document.getElementById('dataFim').value='';">
            <i class='bx bx-refresh'></i> Limpar Datas
          </button>
        </div>
      </div>
      <!-- Filtros de data para ranking de leitores -->
      <div class="row g-3 align-items-end mt-2" id="leitoresDateFilters" style="display: none;">
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataInicio">
            <i class='bx bx-calendar'></i> Data Início
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devoluções realizadas a partir desta data serão consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataInicio" name="leitoresDataInicio">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devoluções realizadas até esta data serão consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataFim" name="leitoresDataFim">
        </div>
        <div class="col-md-2">
          <label class="form-label" for="leitoresLimite">
            <i class='bx bx-list-ol'></i> Limite de Resultados
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Defina quantos leitores serão exibidos no ranking (ex: Top 10, Top 20, etc.).</span>
            </span>
          </label>
          <select class="form-select" id="leitoresLimite" name="leitoresLimite">
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" id="btnBaixarPDFLeitores"><i class='bx bx-download'></i> PDF</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('leitoresDataInicio').value=''; document.getElementById('leitoresDataFim').value=''; document.getElementById('leitoresLimite').value='10';">
            <i class='bx bx-refresh'></i> Limpar
          </button>
        </div>
      </div>
      <!-- Ações para outros relatórios -->
      <div class="row g-3 align-items-end mt-2" id="otherReportsActions">
        <div class="col-md-4">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF2">
            <i class='bx bx-download'></i> Baixar PDF
          </button>
        </div>
        <div class="col-md-8">
          <div class="feature-highlight">
            <h6><i class='bx bx-info-circle'></i> Dica de Exportação:</h6>
            <p class="mb-0">Após gerar o relatório, clique em "Baixar PDF" para salvar uma versão profissional do documento com o logo da escola.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Seção de Resultados -->
    <div class="settings-card" id="reportResult">
      <div class="text-center py-5">
        <div class="mb-4">
          <i class='bx bx-file-blank' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
        </div>
        <h4 class="text-dark mb-3">Selecione um Tipo de Relatório</h4>
        <p class="text-muted mb-4">Escolha um dos cards acima para começar a gerar seu relatório personalizado</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <div class="stats-card">
            <div class="stats-number">📊</div>
            <div class="stats-label">Análises Detalhadas</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">📱</div>
            <div class="stats-label">Interface Intuitiva</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">💾</div>
            <div class="stats-label">Export em PDF</div>
          </div>
        </div>
      </div>
    </div>
    
    <span id="quantidadeLivros" style="display:none;"></span>
    </tbody>
    </table> 
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  let nomeEscola = 'Escola Exemplo';

  async function buscarEscolaUsuario() {
    if (auth.currentUser) {
      const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
      if (userDoc.exists && userDoc.data().escolaId) {
        const escolaDoc = await db.collection('escolas').doc(userDoc.data().escolaId).get();
        if (escolaDoc.exists && escolaDoc.data().nome) {
          nomeEscola = escolaDoc.data().nome;
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
    const reportType = document.getElementById('reportType');
    const reportResult = document.getElementById('reportResult');
    const btnBaixarPDF = document.getElementById('btnBaixarPDF');
    const reportCards = document.querySelectorAll('.report-card');
    const reportHelp = document.getElementById('reportHelp');
    const reportHelpText = document.getElementById('reportHelpText');

    // Textos de ajuda para cada tipo de relatório
    const helpTexts = {
      livros: "Este relatório mostra todos os livros do acervo. Você pode filtrar por gênero específico para análises mais direcionadas.",
      usuarios: "Lista todos os usuários cadastrados no sistema. Filtre por status para ver apenas usuários ativos ou inativos.",
      emprestimos: "Mostra o histórico completo de empréstimos. Use os filtros de data e situação para análises específicas de período.",
      leitores: "Ranking dos usuários mais ativos na biblioteca. Configure o período e a quantidade de resultados para análises customizadas.",
      advertencias: "Relatório de empréstimos em atraso para acompanhamento pedagógico e gestão da biblioteca."
    };

    // Função para atualizar o card ativo
    function updateActiveCard(type) {
      reportCards.forEach(card => {
        card.classList.remove('active');
        if (card.dataset.type === type) {
          card.classList.add('active');
        }
      });
      
      // Atualizar o select oculto para manter compatibilidade
      reportType.value = type;
      
      // Mostrar ajuda específica
      if (helpTexts[type]) {
        reportHelpText.textContent = helpTexts[type];
        reportHelp.classList.remove('d-none');
      }
      
      // Habilitar o botão de gerar relatório
      btnGerarRelatorio.disabled = false;
      btnGerarRelatorio.innerHTML = '<i class="bx bx-search-alt"></i> Gerar Relatório';
      
      // Disparar evento de mudança para mostrar filtros
      reportType.dispatchEvent(new Event('change'));
    }

    // Event listeners para os cards de relatório
    reportCards.forEach(card => {
      card.addEventListener('click', function() {
        const type = this.dataset.type;
        updateActiveCard(type);
        
        // Animação de feedback visual
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = '';
        }, 150);
      });
    });

    // Inicializar com o primeiro tipo (livros) se necessário
    // updateActiveCard('livros');

    btnGerarRelatorio.addEventListener('click', async function () {
      // Animação de loading
      const originalText = this.innerHTML;
      this.innerHTML = '<span class="loading-spinner"></span>Gerando...';
      this.disabled = true;
      
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
          <h5 class="text-dark">Carregando dados...</h5>
          <p class="text-muted">Por favor, aguarde enquanto processamos as informações</p>
        </div>
      `;
      
      let html = '';

      try {
        if (reportType.value === 'livros') {
          const genero = document.getElementById('livrosGenero').value;
          let query = db.collection('livros');
          if (genero) {
            query = query.where('genero', '==', genero);
          }

          const snapshot = await query.get();
          if (snapshot.empty) {
            html = `
              <div class="text-center py-5">
                <i class='bx bx-book' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Nenhum livro encontrado</h5>
                <p class="text-muted">Não há livros cadastrados com os filtros selecionados.</p>
              </div>
            `;
          } else {
            // Ordena os livros por título (alfabético)
            const livrosOrdenados = snapshot.docs
              .map(doc => doc.data())
              .sort((a, b) => (a.titulo || '').localeCompare(b.titulo || '', 'pt-BR', { sensitivity: 'base' }));

            // Estatísticas resumidas no topo
            const totalLivros = snapshot.size;
            const totalExemplares = livrosOrdenados.reduce((total, l) => total + (l.quantidade || 0), 0);
            const disponiveis = livrosOrdenados.reduce((total, l) => total + (l.quantidadeDisponivel || 0), 0);
            const emprestados = livrosOrdenados.reduce((total, l) => total + (l.emprestados || 0), 0);

            html = `
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalLivros}</div>
                    <div class="stats-label">Títulos Cadastrados</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalExemplares}</div>
                    <div class="stats-label">Total de Exemplares</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #28a745;">${disponiveis}</div>
                    <div class="stats-label">Disponíveis</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #ffc107;">${emprestados}</div>
                    <div class="stats-label">Emprestados</div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead>
                    <tr>
                      <th><i class='bx bx-book'></i> Título</th>
                      <th><i class='bx bx-user'></i> Autor</th>
                      <th><i class='bx bx-category'></i> Gênero</th>
                      <th><i class='bx bx-package'></i> Qtd Total</th>
                      <th><i class='bx bx-check-circle'></i> Disponível</th>
                      <th><i class='bx bx-bookmark'></i> Emprestados</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            livrosOrdenados.forEach(l => {
              const quantidade = l.quantidade || 0;
              const disponivel = l.quantidadeDisponivel || 0;
              const emprestados = l.emprestados || 0;
              const autores = Array.isArray(l.autores) ? l.autores.join(', ') : (l.autores || l.autor || 'Autor não informado');
              
              // Cor baseada na disponibilidade
              let rowClass = '';
              if (disponivel === 0 && quantidade > 0) rowClass = 'table-warning'; // Todos emprestados
              else if (quantidade === 0) rowClass = 'table-secondary'; // Sem exemplares

              html += `
                <tr class="${rowClass}">
                  <td><strong>${l.titulo || 'Sem título'}</strong></td>
                  <td>${autores}</td>
                  <td>
                    <span class="badge bg-secondary">${l.genero || 'Não informado'}</span>
                  </td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">
                    <span class="badge ${disponivel > 0 ? 'bg-success' : 'bg-warning'}">${disponivel}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge ${emprestados > 0 ? 'bg-primary' : 'bg-light text-dark'}">${emprestados}</span>
                  </td>
                </tr>
              `;
            });
            html += '</tbody></table></div>';

            // Adicionar informações adicionais
            if (genero) {
              html += `
                <div class="feature-highlight mt-4">
                  <h6><i class='bx bx-filter'></i> Filtro Aplicado:</h6>
                  <p>Mostrando apenas livros do gênero: <strong>${genero}</strong></p>
                </div>
              `;
            }
          }
        }

        if (reportType.value === 'usuarios') {
        const status = document.getElementById('usuariosStatus').value;
        let query = db.collection('usuarios');
        if (status) {
          query = query.where('status', '==', status);
        }

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum usuário encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Nome</th><th>Email</th><th>Matrícula</th><th>Função</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            snapshot.forEach(doc => {
              const u = doc.data();
              html += `
                <tr>
                  <td>${u.nome || 'Nome não informado'}</td>
                  <td>${u.email || 'Email não informado'}</td>
                  <td>${u.matricula || 'Não informado'}</td>
                  <td>${u.funcao || u.papel || 'Não informado'}</td>
                  <td><span class="badge ${(u.status === 'Ativo' || !u.status) ? 'bg-success' : 'bg-secondary'}">${u.status || 'Ativo'}</span></td>
                </tr>
              `;
            });
            html += '</tbody></table>';
            
            // Adiciona estatísticas resumidas
            html += `
              <div class="mt-3">
                <h5>Resumo:</h5>
                <p><strong>Total de usuários:</strong> ${snapshot.size}</p>
              </div>
            `;
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar usuários: ${error.message}</p>`;
          console.error('Erro ao buscar usuários:', error);
        }
      }

      if (reportType.value === 'emprestimos') {
        const situacaoFiltro = document.getElementById('emprestimosSituacao').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        let query = db.collection('emprestimos');

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum empréstimo encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Usuário</th><th>Livro(s)</th><th>Data Empréstimo</th><th>Data Devolução</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // Converter datas do filtro para objetos Date para comparação
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }
            
            let emprestimosExibidos = 0;
            
            for (const doc of snapshot.docs) {
              const e = doc.data();
              
              // Filtro por data
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                // Converter data do empréstimo para Date
                let dataEmprestimoObj = null;
                if (e.loanDate) {
                  const dateParts = e.loanDate.split('/');
                  if (dateParts.length === 3) {
                    dataEmprestimoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataEmprestimoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataEmprestimoObj) {
                  if (dataInicioObj && dataEmprestimoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataEmprestimoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se não conseguir converter a data, não exibe se há filtro de data
                  if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;
              
              // Buscar nome do usuário
              let nomeUsuario = 'Usuário não encontrado';
              try {
                if (e.userId) {
                  const userDoc = await db.collection('usuarios').doc(e.userId).get();
                  if (userDoc.exists) {
                    nomeUsuario = userDoc.data().nome || 'Nome não informado';
                  }
                }
              } catch (error) {
                console.error('Erro ao buscar usuário:', error);
              }

              // Buscar nomes dos livros
              let nomesLivros = 'Livros não encontrados';
              try {
                if (Array.isArray(e.books)) {
                  const livrosPromises = e.books.map(async (book) => {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    const livroData = livroDoc.exists ? livroDoc.data() : null;
                    const titulo = livroData ? livroData.titulo : book.bookId;
                    return `${titulo} (Qtd: ${book.quantity})`;
                  });
                  const livrosArray = await Promise.all(livrosPromises);
                  nomesLivros = livrosArray.join(', ');
                }
              } catch (error) {
                console.error('Erro ao buscar livros:', error);
              }

              // Determinar status real
              let statusAtual = e.status || 'EMPRESTADO';
              
              // Verificar se está atrasado baseado na data
              if (e.returnDate && (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO')) {
                const dateParts = e.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    statusAtual = 'ATRASADO';
                  }
                }
              }

              // Mapear status para filtro
              let statusFiltro = '';
              if (statusAtual === 'EMPRESTADO') statusFiltro = 'Ativo';
              else if (statusAtual === 'ATRASADO') statusFiltro = 'Atrasado';
              else if (statusAtual === 'DEVOLVIDO') statusFiltro = 'Finalizado';

              // Aplicar filtro de situação
              if (situacaoFiltro && situacaoFiltro !== statusFiltro) {
                continue; // Pula este empréstimo
              }

              emprestimosExibidos++;

              html += `
                <tr>
                  <td>${nomeUsuario}</td>
                  <td>${nomesLivros}</td>
                  <td>${e.loanDate || 'Data não informada'}</td>
                  <td>${e.returnDate || 'Data não informada'}</td>
                  <td><span class="badge ${statusAtual === 'DEVOLVIDO' ? 'bg-success' : statusAtual === 'ATRASADO' ? 'bg-danger' : 'bg-primary'}">${statusAtual}</span></td>
                </tr>
              `;
            }
            
            if (emprestimosExibidos === 0) {
              html = '<p>Nenhum empréstimo encontrado com os filtros selecionados.</p>';
            } else {
              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas
              html += `
                <div class="mt-3">
                  <h5>Resumo:</h5>
                  <p><strong>Total de empréstimos encontrados:</strong> ${emprestimosExibidos}</p>
                  <p><strong>Total de empréstimos no sistema:</strong> ${snapshot.size}</p>
                  ${dataInicio || dataFim ? `<p><strong>Período:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'Início'} até ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar empréstimos: ${error.message}</p>`;
          console.error('Erro ao buscar empréstimos:', error);
        }
      }

      if (reportType.value === 'advertencias') {
        try {
          const snapshotEmprestimos = await db.collection('emprestimos').get();
          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum empréstimo encontrado para verificar advertências.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Data Empréstimo</th>
                    <th>Data Prevista Devolução</th>
                    <th>Usuário</th>
                    <th>Livro(s)</th>
                    <th>Dias de Atraso</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(23, 59, 59, 999); // Fim do dia atual
            
            let totalAdvertencias = 0;
            
            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Verificar apenas empréstimos ativos ou já marcados como atrasados
              if (emprestimo.status === 'DEVOLVIDO') {
                continue;
              }
              
              // Calcular dias de atraso
              let diasAtraso = 0;
              let dataVencimento = null;
              let statusEmprestimo = emprestimo.status || 'EMPRESTADO';
              
              if (emprestimo.returnDate) {
                const dateParts = emprestimo.returnDate.split('/');
                if (dateParts.length === 3) {
                  dataVencimento = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  dataVencimento.setHours(23, 59, 59, 999);
                  
                  if (hoje > dataVencimento) {
                    const diffTime = hoje.getTime() - dataVencimento.getTime();
                    diasAtraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    statusEmprestimo = 'ATRASADO';
                  }
                }
              }
              
              // Só exibe se houver atraso (advertência)
              if (diasAtraso > 0) {
                totalAdvertencias++;
                
                // Buscar nome do usuário
                let nomeUsuario = 'Usuário não encontrado';
                let matriculaUsuario = '';
                try {
                  if (emprestimo.userId) {
                    const userDoc = await db.collection('usuarios').doc(emprestimo.userId).get();
                    if (userDoc.exists) {
                      const userData = userDoc.data();
                      nomeUsuario = userData.nome || 'Nome não informado';
                      matriculaUsuario = userData.matricula ? ` (Mat: ${userData.matricula})` : '';
                    }
                  }
                } catch (error) {
                  console.error('Erro ao buscar usuário:', error);
                }

                // Buscar nomes dos livros
                let nomesLivros = 'Livros não encontrados';
                try {
                  if (Array.isArray(emprestimo.books)) {
                    const livrosPromises = emprestimo.books.map(async (book) => {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      const livroData = livroDoc.exists ? livroDoc.data() : null;
                      const titulo = livroData ? livroData.titulo : book.bookId;
                      return `${titulo} (Qtd: ${book.quantity})`;
                    });
                    const livrosArray = await Promise.all(livrosPromises);
                    nomesLivros = livrosArray.join('<br>');
                  }
                } catch (error) {
                  console.error('Erro ao buscar livros:', error);
                }

                // Calcular quantidade de livros para informação
                const quantidadeLivros = Array.isArray(emprestimo.books) 
                  ? emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0)
                  : 1;

                // Definir cor do badge baseado nos dias de atraso
                let badgeClass = 'bg-warning';
                if (diasAtraso > 15) badgeClass = 'bg-danger';
                else if (diasAtraso > 7) badgeClass = 'bg-warning';
                else badgeClass = 'bg-info';

                html += `
                  <tr class="${diasAtraso > 15 ? 'table-danger' : diasAtraso > 7 ? 'table-warning' : ''}">
                    <td>${emprestimo.loanDate || 'Data não informada'}</td>
                    <td>${emprestimo.returnDate || 'Data não informada'}</td>
                    <td>
                      <strong>${nomeUsuario}</strong>${matriculaUsuario}
                    </td>
                    <td style="max-width: 200px;">${nomesLivros}</td>
                    <td>
                      <span class="badge ${badgeClass} fs-6">
                        ${diasAtraso} dia${diasAtraso > 1 ? 's' : ''}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-danger">ATRASADO</span>
                    </td>
                  </tr>
                `;
              }
            }
            
            if (totalAdvertencias === 0) {
              html = `
                <div class="alert alert-success">
                  <h5><i class='bx bx-check-circle'></i> Parabéns!</h5>
                  <p class="mb-0">Não há empréstimos em atraso no momento. Todos os usuários estão em dia com suas devoluções.</p>
                </div>
              `;
            } else {
              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas com alertas coloridos
              html += `
                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="alert alert-danger">
                      <h6><i class='bx bx-error-circle'></i> Total de Advertências</h6>
                      <h4 class="mb-0">${totalAdvertencias}</h4>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="alert alert-info">
                      <h6><i class='bx bx-calendar'></i> Data da Consulta</h6>
                      <h6 class="mb-0">${hoje.toLocaleDateString('pt-BR')}</h6>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <h5>Legenda de Gravidade:</h5>
                  <div class="d-flex flex-wrap gap-3">
                    <span><span class="badge bg-info">1-7 dias</span> Atraso Leve</span>
                    <span><span class="badge bg-warning">8-15 dias</span> Atraso Moderado</span>
                    <span><span class="badge bg-danger">16+ dias</span> Atraso Grave</span>
                  </div>
                  <small class="text-muted mt-2 d-block">
                    <strong>Nota:</strong> As advertências servem como orientação pedagógica para conscientização sobre a importância da devolução no prazo.
                  </small>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar advertências: ${error.message}</p>`;
          console.error('Erro ao buscar advertências:', error);
        }
      }

      if (reportType.value === 'leitores') {
        const ordem = document.getElementById('leitoresOrdem').value;
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;

        try {
          const snapshotEmprestimos = await db.collection('emprestimos')
            .where('status', '==', 'DEVOLVIDO')
            .get();

          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum livro foi devolvido ainda para gerar o ranking de leitores.</p>';
          } else {
            // Converter datas do filtro para objetos Date para comparação
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }

            // Mapa para contar livros por usuário
            const leitoresPorUsuario = new Map();

            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Filtro por data de devolução real
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                let dataDevolucaoObj = null;
                if (emprestimo.actualReturnDate) {
                  const dateParts = emprestimo.actualReturnDate.split('/');
                  if (dateParts.length === 3) {
                    dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataDevolucaoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataDevolucaoObj) {
                  if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se não há data de devolução real, usar data de empréstimo como fallback
                  if (emprestimo.loanDate) {
                    const dateParts = emprestimo.loanDate.split('/');
                    if (dateParts.length === 3) {
                      dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                      dataDevolucaoObj.setHours(0, 0, 0, 0);
                      
                      if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                        passaFiltroPorData = false;
                      }
                      if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                        passaFiltroPorData = false;
                      }
                    } else if (dataInicioObj || dataFimObj) {
                      passaFiltroPorData = false;
                    }
                  } else if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;

              // Contar livros por usuário
              if (Array.isArray(emprestimo.books)) {
                const totalLivros = emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0);
                
                if (leitoresPorUsuario.has(emprestimo.userId)) {
                  leitoresPorUsuario.get(emprestimo.userId).totalLivros += totalLivros;
                  leitoresPorUsuario.get(emprestimo.userId).emprestimos += 1;
                } else {
                  leitoresPorUsuario.set(emprestimo.userId, {
                    userId: emprestimo.userId,
                    totalLivros: totalLivros,
                    emprestimos: 1,
                    nomeUsuario: 'Carregando...',
                    matriculaUsuario: '',
                    funcaoUsuario: ''
                  });
                }
              }
            }

            // Buscar dados dos usuários
            for (const [userId, userData] of leitoresPorUsuario) {
              try {
                const userDoc = await db.collection('usuarios').doc(userId).get();
                if (userDoc.exists) {
                  const user = userDoc.data();
                  userData.nomeUsuario = user.nome || 'Nome não informado';
                  userData.matriculaUsuario = user.matricula || '';
                  userData.funcaoUsuario = user.funcao || user.papel || '';
                }
              } catch (error) {
                console.error('Erro ao buscar usuário:', error);
                userData.nomeUsuario = 'Erro ao carregar';
              }
            }

            // Converter para array e ordenar
            let leitoresArray = Array.from(leitoresPorUsuario.values());
            
            // Ordenar por total de livros
            if (ordem === 'desc') {
              leitoresArray.sort((a, b) => b.totalLivros - a.totalLivros);
            } else {
              leitoresArray.sort((a, b) => a.totalLivros - b.totalLivros);
            }

            // Aplicar limite se especificado
            if (limite && parseInt(limite) > 0) {
              leitoresArray = leitoresArray.slice(0, parseInt(limite));
            }

            if (leitoresArray.length === 0) {
              html = '<p>Nenhum leitor encontrado com os filtros selecionados.</p>';
            } else {
              html = `
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card text-center border-success">
                      <div class="card-body">
                        <h4 class="text-success mb-1">${leitoresArray.length}</h4>
                        <small class="text-muted">Leitores Ativos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-primary">
                      <div class="card-body">
                        <h4 class="text-primary mb-1">${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</h4>
                        <small class="text-muted">Total de Livros Lidos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-warning">
                      <div class="card-body">
                        <h4 class="text-warning mb-1">${Math.round(leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0) / leitoresArray.length)}</h4>
                        <small class="text-muted">Média por Leitor</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <table class="table table-bordered table-sm">
                  <thead class="table-primary">
                    <tr>
                      <th>Posição</th>
                      <th>Nome</th>
                      <th>Matrícula</th>
                      <th>Função</th>
                      <th>Livros Lidos</th>
                      <th>Empréstimos</th>
                      <th>Média por Empréstimo</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              leitoresArray.forEach((leitor, index) => {
                const posicao = index + 1;
                const mediaPorEmprestimo = (leitor.totalLivros / leitor.emprestimos).toFixed(1);
                
                // Definir classe CSS baseada na posição
                let rowClass = '';
                if (posicao === 1) rowClass = 'table-warning'; // Ouro
                else if (posicao === 2) rowClass = 'table-secondary'; // Prata
                else if (posicao === 3) rowClass = 'table-info'; // Bronze

                // Ícone de medalha para os 3 primeiros
                let medalha = '';
                if (posicao === 1) medalha = '🥇';
                else if (posicao === 2) medalha = '🥈';
                else if (posicao === 3) medalha = '🥉';

                html += `
                  <tr class="${rowClass}">
                    <td class="text-center">
                      <strong>${medalha} ${posicao}º</strong>
                    </td>
                    <td><strong>${leitor.nomeUsuario}</strong></td>
                    <td>${leitor.matriculaUsuario || 'N/A'}</td>
                    <td>${leitor.funcaoUsuario || 'N/A'}</td>
                    <td class="text-center">
                      <span class="badge bg-success fs-6">${leitor.totalLivros}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary">${leitor.emprestimos}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">${mediaPorEmprestimo}</span>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas
              html += `
                <div class="mt-4">
                  <h5>Resumo do Ranking:</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Total de leitores encontrados:</strong> ${leitoresArray.length}</p>
                      <p><strong>Livros lidos no período:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Empréstimos concluídos:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.emprestimos, 0)}</p>
                      ${dataInicio || dataFim ? `<p><strong>Período:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'Início'} até ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                    </div>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <h6><i class='bx bx-info-circle'></i> Como interpretar este ranking:</h6>
                    <ul class="mb-0">
                      <li><strong>Livros Lidos:</strong> Total de livros devolvidos pelo usuário</li>
                      <li><strong>Empréstimos:</strong> Número de vezes que o usuário fez empréstimos</li>
                      <li><strong>Média por Empréstimo:</strong> Quantos livros em média o usuário lê por empréstimo</li>
                      <li><strong>🥇🥈🥉:</strong> Medalhas para os 3 primeiros colocados</li>
                    </ul>
                  </div>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar ranking de leitores: ${error.message}</p>`;
          console.error('Erro ao buscar ranking de leitores:', error);
        }
      }

      reportResult.innerHTML = html;
      
      // Restaurar botão
      this.innerHTML = originalText;
      this.disabled = false;
      
    } catch (error) {
      // Tratamento de erro geral
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <i class='bx bx-error' style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
          <h5 class="text-white">Erro ao gerar relatório</h5>
          <p class="text-danger">${error.message}</p>
          <button class="btn btn-outline-light mt-3" onclick="location.reload()">
            <i class='bx bx-refresh'></i> Tentar Novamente
          </button>
        </div>
      `;
      console.error('Erro geral:', error);
      
      // Restaurar botão
      this.innerHTML = originalText;
      this.disabled = false;
    }
    });

    // Exibe/esconde filtros conforme o tipo de relatório
    reportType.addEventListener('change', function () {
      document.getElementById('livrosFilters').classList.toggle('d-none', this.value !== 'livros');
      document.getElementById('usuariosFilters').classList.toggle('d-none', this.value !== 'usuarios');
      document.getElementById('emprestimosFilters').classList.toggle('d-none', this.value !== 'emprestimos');
      document.getElementById('leitoresFilters').classList.toggle('d-none', this.value !== 'leitores');
      
      // Controla a exibição dos filtros de data
      const emprestimosDateFilters = document.getElementById('emprestimosDateFilters');
      const leitoresDateFilters = document.getElementById('leitoresDateFilters');
      const otherReportsActions = document.getElementById('otherReportsActions');
      
      if (this.value === 'emprestimos') {
        emprestimosDateFilters.style.display = 'flex';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'none';
      } else if (this.value === 'leitores') {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'flex';
        otherReportsActions.style.display = 'none';
      } else {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'flex';
      }
    });

    // Função para criar imagens de medalhas para o PDF
    function criarImagemMedalha(tipo) {
      const canvas = document.createElement('canvas');
      canvas.width = 40;
      canvas.height = 40;
      const ctx = canvas.getContext('2d');
      
      // Limpar canvas
      ctx.clearRect(0, 0, 40, 40);
      
      // Desenhar sombra
      ctx.beginPath();
      ctx.arc(21, 21, 18, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fill();
      
      // Desenhar círculo base
      ctx.beginPath();
      ctx.arc(20, 20, 18, 0, 2 * Math.PI);
      
      // Definir cores baseadas no tipo
      if (tipo === 1) {
        // Medalha de Ouro
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#FFF700');
        gradient.addColorStop(0.5, '#FFD700');
        gradient.addColorStop(1, '#B8860B');
        ctx.fillStyle = gradient;
      } else if (tipo === 2) {
        // Medalha de Prata
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#E8E8E8');
        gradient.addColorStop(0.5, '#C0C0C0');
        gradient.addColorStop(1, '#808080');
        ctx.fillStyle = gradient;
      } else if (tipo === 3) {
        // Medalha de Bronze
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#DEB887');
        gradient.addColorStop(0.5, '#CD7F32');
        gradient.addColorStop(1, '#8B4513');
        ctx.fillStyle = gradient;
      }
      
      ctx.fill();
      
      // Adicionar borda externa escura
      ctx.strokeStyle = '#2C2C2C';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Adicionar borda interna brilhante
      ctx.beginPath();
      ctx.arc(20, 20, 15, 0, 2 * Math.PI);
      ctx.strokeStyle = tipo === 1 ? '#FFFF99' : tipo === 2 ? '#F0F0F0' : '#F4A460';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // Adicionar número
      ctx.fillStyle = '#FFFFFF';
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1;
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.strokeText(tipo.toString(), 20, 20);
      ctx.fillText(tipo.toString(), 20, 20);
      
      return canvas.toDataURL('image/png');
    }

    // Função para baixar PDF (duplicada para os dois botões)
    function baixarPDF() {
      const reportType = document.getElementById('reportType').value;
      const reportResult = document.getElementById('reportResult');
      const doc = new jspdf.jsPDF();

      let titulo = '';
      if (reportType === 'livros') titulo = 'Relatório de Livros';
      if (reportType === 'usuarios') titulo = 'Relatório de Usuários';
      if (reportType === 'emprestimos') titulo = 'Relatório de Empréstimos';
      if (reportType === 'leitores') titulo = 'Ranking de Leitores';
      if (reportType === 'advertencias') titulo = 'Relatório de Advertências';

      // Adiciona informações de filtro ao título
      if (reportType === 'emprestimos') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const situacao = document.getElementById('emprestimosSituacao').value;
        
        if (dataInicio || dataFim || situacao) {
          let filtros = [];
          if (situacao) filtros.push(`Situação: ${situacao}`);
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`Até: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'leitores') {
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;
        const ordem = document.getElementById('leitoresOrdem').value;
        
        if (dataInicio || dataFim || limite || ordem !== 'desc') {
          let filtros = [];
          if (limite) filtros.push(`Top ${limite}`);
          if (ordem === 'asc') filtros.push('Menor para Maior');
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`Até: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'advertencias') {
        titulo += ` - Gerado em ${new Date().toLocaleDateString('pt-BR')}`;
      }

      // Função para adicionar logo e cabeçalho
      function adicionarCabecalho() {
        // Adicionar logo ABA.png
        try {
          const logoImg = new Image();
          logoImg.onload = function() {
            // Adicionar logo no canto superior esquerdo
            doc.addImage(logoImg, 'PNG', 14, 10, 30, 30);
            
            // Adicionar informações da escola
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Escola Estadual Governador Bias Fortes', 50, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema de Gestão de Biblioteca - SIGEB', 50, 28);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(titulo, 50, 38);
            
            // Adicionar data de geração
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, 50);
            
            // Linha separadora
            doc.setLineWidth(0.5);
            doc.line(14, 55, 196, 55);
            
            // Gerar tabela
            const table = reportResult.querySelector('table');
            if (table) {
              // Configurações especiais para o relatório de advertências
              let autoTableConfig = { 
                html: table, 
                startY: 60,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [13, 40, 71] },
                theme: 'striped'
              };

              // Para relatório de ranking de leitores, adicionar medalhas
              if (reportType === 'leitores') {
                autoTableConfig.styles.fontSize = 9;
                autoTableConfig.columnStyles = {
                  0: { cellWidth: 25, halign: 'center' }, // Coluna posição com medalha
                  1: { cellWidth: 50 }, // Nome
                  2: { cellWidth: 25 }, // Matrícula
                  3: { cellWidth: 30 }, // Função
                  4: { halign: 'center' }, // Total livros
                  5: { halign: 'center' }, // Empréstimos
                  6: { halign: 'center' } // Média
                };
                
                // Remover emojis do texto e manter só os números
                autoTableConfig.didParseCell = function(data) {
                  if (data.column.index === 0) {
                    if (data.row.index < 3) {
                      // Para as 3 primeiras posições, limpar o texto (será adicionado manualmente)
                      data.cell.text = [''];
                    } else {
                      // Para outras posições, remover emojis e manter só o número
                      data.cell.text = data.cell.text.map(text => {
                        return text.replace(/🥇|🥈|🥉/g, '').trim();
                      });
                    }
                  }
                  // Remover HTML de outras células
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
                
                // Adicionar medalhas após desenhar a célula
                autoTableConfig.didDrawCell = function(data) {
                  if (data.column.index === 0 && data.row.index < 3) {
                    // Adicionar medalha como imagem para as 3 primeiras posições (exceto a primeira)
                    const posicao = data.row.index + 1;
                    
                    if (posicao > 1) { // Só adiciona medalha para 2º e 3º lugar
                      const medalhaImg = criarImagemMedalha(posicao);
                      
                      // Posicionar a medalha no centro-esquerda da célula
                      const medalhaX = data.cell.x + 2;
                      const medalhaY = data.cell.y + (data.cell.height - 10) / 2;
                      doc.addImage(medalhaImg, 'PNG', medalhaX, medalhaY, 10, 10);
                      
                      // Ajustar o texto para ficar ao lado da medalha
                      doc.setFontSize(9);
                      doc.setFont('helvetica', 'bold');
                      doc.text(`${posicao}º`, medalhaX + 12, medalhaY + 5.5);
                    } else {
                      // Para o 1º lugar, apenas mostrar o número sem medalha
                      doc.setFontSize(9);
                      doc.setFont('helvetica', 'bold');
                      doc.text(`${posicao}`, data.cell.x + 2, data.cell.y + (data.cell.height + 3) / 2);
                    }
                  }
                };
              }

              // Para relatório de advertências, ajustar configurações
              if (reportType === 'advertencias') {
                autoTableConfig.styles.fontSize = 7;
                autoTableConfig.columnStyles = {
                  3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
                  4: { halign: 'center' }, // Dias de atraso centralizado
                  5: { halign: 'center' } // Status centralizado
                };
                
                // Processar dados para remover HTML das células
                autoTableConfig.didParseCell = function(data) {
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      // Remove tags HTML
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
              }

              doc.autoTable(autoTableConfig);
              
              // Adicionar resumo específico para advertências
              if (reportType === 'advertencias') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados do resumo da tela
                const alertasResumo = reportResult.querySelectorAll('.alert h4');
                if (alertasResumo.length >= 1) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`• Total de Advertências: ${alertasResumo[0].textContent}`, 14, finalY + 10);
                  doc.text('• Advertências servem como orientação pedagógica para conscientização', 14, finalY + 18);
                  doc.text('  sobre a importância da devolução no prazo.', 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Legenda de Gravidade:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
                }
              }

              // Adicionar resumo específico para ranking de leitores
              if (reportType === 'leitores') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados dos cards de estatísticas
                const statsCards = reportResult.querySelectorAll('.card h4');
                if (statsCards.length >= 3) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`• Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
                  doc.text(`• Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
                  doc.text(`• Média por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Sistema de Medalhas:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  
                  // Adicionar pequenas medalhas na legenda
                  const medalhaOuro = criarImagemMedalha(1);
                  const medalhaPrata = criarImagemMedalha(2);
                  const medalhaBronze = criarImagemMedalha(3);
                  
                  doc.addImage(medalhaOuro, 'PNG', 14, finalY + 42, 6, 6);
                  doc.text('1º Lugar (Ouro)', 22, finalY + 46);
                  
                  doc.addImage(medalhaPrata, 'PNG', 60, finalY + 42, 6, 6);
                  doc.text('2º Lugar (Prata)', 68, finalY + 46);
                  
                  doc.addImage(medalhaBronze, 'PNG', 120, finalY + 42, 6, 6);
                  doc.text('3º Lugar (Bronze)', 128, finalY + 46);
                  
                  doc.text('Ranking baseado no total de livros devolvidos com sucesso', 14, finalY + 54);
                }
              }
            } else {
              doc.text('Nenhum dado para exportar.', 14, 70);
            }
            
            // Adicionar rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Página ${i} de ${pageCount}`, 14, 285);
              doc.text('© 2025 SIGEB - Sistema de Gestão de Biblioteca', 120, 285);
            }
            
            doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
          };
          
          logoImg.onerror = function() {
            console.warn('Erro ao carregar logo, gerando PDF sem logo');
            gerarPDFSemLogo();
          };
          
          logoImg.src = 'logobias.png';
        } catch (error) {
          console.warn('Erro ao processar logo:', error);
          gerarPDFSemLogo();
        }
      }

      // Função alternativa sem logo
      function gerarPDFSemLogo() {
        // Adicionar informações da escola
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Escola Estadual Governador Bias Fortes', 14, 20);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Gestão de Biblioteca - SIGEB', 14, 28);
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(titulo, 14, 38);
        
        // Adicionar data de geração
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, 48);
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(14, 52, 196, 52);

        const table = reportResult.querySelector('table');
        if (table) {
          // Configurações especiais para o relatório de advertências
          let autoTableConfig = { 
            html: table, 
            startY: 58,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 40, 71] },
            theme: 'striped'
          };

          // Para relatório de advertências, ajustar configurações
          if (reportType === 'advertencias') {
            autoTableConfig.styles.fontSize = 7;
            autoTableConfig.columnStyles = {
              3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
              4: { halign: 'center' }, // Dias de atraso centralizado
              5: { halign: 'center' } // Status centralizado
            };
            
            // Processar dados para remover HTML das células
            autoTableConfig.didParseCell = function(data) {
              if (data.cell.text && Array.isArray(data.cell.text)) {
                data.cell.text = data.cell.text.map(text => {
                  // Remove tags HTML
                  return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                });
              }
            };
          }

          doc.autoTable(autoTableConfig);
          
          // Adicionar resumo específico para advertências
          if (reportType === 'advertencias') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados do resumo da tela
            const alertasResumo = reportResult.querySelectorAll('.alert h4');
            if (alertasResumo.length >= 2) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`• Total de Advertências: ${alertasResumo[0].textContent}`, 14, finalY + 10);
              doc.text(`• Multa Total Acumulada: ${alertasResumo[1].textContent}`, 14, finalY + 18);
              doc.text('• Multa: R$ 0,50 por dia de atraso, por livro emprestado', 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Legenda de Gravidade:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
            }
          }

          // Adicionar resumo específico para ranking de leitores
          if (reportType === 'leitores') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados dos cards de estatísticas
            const statsCards = reportResult.querySelectorAll('.card h4');
            if (statsCards.length >= 3) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`• Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
              doc.text(`• Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
              doc.text(`• Média por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Como interpretar:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('🥇🥈🥉 Medalhas para os 3 primeiros colocados | Ranking baseado em livros devolvidos', 14, finalY + 44);
            }
          }
        } else {
          doc.text('Nenhum dado para exportar.', 14, 68);
        }
        
        // Adicionar rodapé
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`Página ${i} de ${pageCount}`, 14, 285);
          doc.text('© 2025 SIGEB - Sistema de Gestão de Biblioteca', 120, 285);
        }
        
        doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
      }

      // Iniciar processo de geração
      adicionarCabecalho();
    }

    btnBaixarPDF.addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDF2').addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDFLeitores').addEventListener('click', baixarPDF);

    // Exemplo para buscar a quantidade total de livros cadastrados no Firestore
    async function buscarQuantidadeLivros() {
      try {
        const snapshot = await db.collection('livros').get();
        const quantidade = snapshot.size; // Número total de documentos (livros)
        console.log('Quantidade de livros:', quantidade);
        // Exemplo: exibir na tela
        document.getElementById('quantidadeLivros').textContent = quantidade;
      } catch (e) {
        console.error('Erro ao buscar quantidade de livros:', e);
      }
    }

    // Chame a função ao carregar a página
    buscarQuantidadeLivros();

    // Buscar todos os empréstimos do Firestore
    async function buscarEmprestimos() {
      const snapshot = await db.collection('emprestimos').get();
      const emprestimos = [];
      snapshot.forEach(doc => {
        emprestimos.push({ id: doc.id, ...doc.data() });
      });
      console.log(emprestimos);
      return emprestimos;
    }
  });
</script>
</body>
</html>
