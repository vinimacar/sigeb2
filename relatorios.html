<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGEB - Relatórios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Reset e configurações base */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Overlay para melhor contraste */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at top, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.2));
      pointer-events: none;
      z-index: -1;
    }
    
    /* Sidebar melhorada */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 260px;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 25px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-header {
      padding: 25px 0;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      margin-bottom: 25px;
    }
    
    .sidebar-header h3 {
      background: linear-gradient(135deg, #00f2fe, #4facfe, #00c9ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 1px;
      text-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    }
    
    .menu-items {
      padding: 0;
    }
    
    .menu-item {
      padding: 15px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(79, 172, 254, 0.2), rgba(0, 242, 254, 0.2));
      transition: width 0.3s ease;
    }
    
    .menu-item:hover::before, .menu-item.active::before {
      width: 100%;
    }
    
    .menu-item:hover, .menu-item.active {
      color: #4facfe;
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);
    }
    
    .menu-item i {
      margin-right: 15px;
      font-size: 1.3rem;
      z-index: 1;
      position: relative;
    }
    
    .menu-item span {
      z-index: 1;
      position: relative;
      font-weight: 500;
    }

    /* Main Content melhorado */
    .main-content {
      margin-left: 260px;
      padding: 30px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 100vh;
    }

    /* Header da página */
    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #4facfe);
    }
    
    .page-header h2 {
      margin: 0 0 10px 0;
      color: #1e293b;
      font-weight: 700;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .page-header p {
      margin: 0;
      color: #64748b;
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Cards do sistema (relatórios, filtros, etc.) */
    .settings-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .settings-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .settings-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }
    
    .settings-card h4, .settings-card h5 {
      color: #1e293b;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .settings-card h4::before, .settings-card h5::before {
      content: '';
      width: 4px;
      height: 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    /* Report type cards */
    .report-type-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .report-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .report-card:hover::before {
      opacity: 1;
    }

    .report-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      border-color: rgba(102, 126, 234, 0.4);
    }

    .report-card.active {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transform: translateY(-5px);
    }

    .report-card-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 2rem;
      color: white;
      position: relative;
    }

    .report-card-icon.books { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .report-card-icon.users { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .report-card-icon.loans { background: linear-gradient(135deg, #FFD54F 0%, #FF9800 100%); }
    .report-card-icon.readers { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .report-card-icon.warnings { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }

    .report-card h4 {
      color: #1e293b;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .report-card h4::before {
      display: none;
    }

    .report-card p {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.4;
      margin: 0;
    }

    /* Form elements melhorados */
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255, 255, 255, 0.95);
      outline: none;
    }

    /* Botões melhorados */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-gradient:hover::before {
      left: 100%;
    }
    
    .btn-gradient:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    .btn-outline-light {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #374151;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    /* Feature highlight */
    .feature-highlight {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
    }
    
    .feature-highlight h6 {
      color: #1e293b;
      margin-bottom: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Table styling */
    .table {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
    }

    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 15px;
    }

    .table tbody tr {
      transition: all 0.3s ease;
      border: none;
    }

    .table tbody tr:hover {
      background-color: rgba(102, 126, 234, 0.05);
      transform: scale(1.01);
    }

    .table tbody td {
      border-color: rgba(0, 0, 0, 0.05);
      padding: 12px 15px;
    }

    /* Stats cards */
    .stats-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .stats-label {
      color: #64748b;
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Tooltips */
    .tooltip-info {
      position: relative;
      display: inline-block;
      margin-left: 8px;
      cursor: help;
    }

    .tooltip-info .tooltip-text {
      visibility: hidden;
      width: 250px;
      background: rgba(30, 41, 59, 0.95);
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tooltip-info:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar { 
        position: static; 
        width: 100%; 
        height: auto;
      }
      .main-content { 
        margin-left: 0; 
        padding: 20px;
      }
      .report-type-cards {
        grid-template-columns: 1fr;
      }
      .page-header h2 {
        font-size: 1.8rem;
      }
      .page-header, .settings-card {
        padding: 20px;
      }
    }

    @media (max-width: 576px) {
      .main-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>SIGEB</h3>
    </div>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">
        <i class='bx bxs-dashboard'></i>
        <span>Dashboard</span>
      </a>
      <a href="livros.html" class="menu-item">
        <i class='bx bxs-book'></i>
        <span>Livros</span>
      </a>
      <a href="usuarios.html" class="menu-item">
        <i class='bx bxs-user'></i>
        <span>Usuários</span>
      </a>
      <a href="emprestimos.html" class="menu-item">
        <i class='bx bxs-bookmark'></i>
        <span>Empréstimos</span>
      </a>
      <a href="relatorios.html" class="menu-item active">
        <i class='bx bxs-report'></i>
        <span>Relatórios</span>
      </a>
      <a href="configuracoes.html" class="menu-item">
        <i class='bx bxs-cog'></i>
        <span>Configurações</span>
      </a>
      <a href="index.html" class="menu-item">
        <i class='bx bxs-log-out'></i>
        <span>Sair</span>
      </a>
    </div>
  </div>
  <div class="main-content">
    <!-- Cabeçalho da Página -->
    <div class="page-header">
      <h2><i class='bx bxs-report'></i> Relatórios do Sistema</h2>
      <p>Gere relatórios detalhados para análise e acompanhamento da biblioteca</p>
    </div>

    <!-- Seletor de Tipo de Relatório -->
    <div class="settings-card">
      <h4>
        <i class='bx bx-list-check'></i> Escolha o Tipo de Relatório
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Selecione um dos relatórios disponíveis. Cada um oferece informações específicas sobre diferentes aspectos da biblioteca.</span>
        </span>
      </h4>
      
      <div class="report-type-cards">
        <div class="report-card" data-type="livros">
          <div class="report-card-icon books">
            <i class='bx bxs-book'></i>
          </div>
          <h4>Relatório de Livros</h4>
          <p>Visualize todos os livros cadastrados, com filtros por gênero, disponibilidade e estatísticas do acervo</p>
        </div>
        
        <div class="report-card" data-type="usuarios">
          <div class="report-card-icon users">
            <i class='bx bxs-user-detail'></i>
          </div>
          <h4>Relatório de Usuários</h4>
          <p>Lista completa de usuários cadastrados com informações de contato, status e função no sistema</p>
        </div>
        
        <div class="report-card" data-type="emprestimos">
          <div class="report-card-icon loans">
            <i class='bx bxs-bookmark'></i>
          </div>
          <h4>Relatório de Empréstimos</h4>
          <p>Histórico detalhado de empréstimos com filtros por período, status e situação das devoluções</p>
        </div>
        
        <div class="report-card" data-type="leitores">
          <div class="report-card-icon readers">
            <i class='bx bxs-trophy'></i>
          </div>
          <h4>Ranking de Leitores</h4>
          <p>Classificação dos usuários mais ativos, incentivando a leitura e reconhecendo os melhores leitores</p>
        </div>
        
        <div class="report-card" data-type="advertencias">
          <div class="report-card-icon warnings">
            <i class='bx bxs-error-alt'></i>
          </div>
          <h4>Relatório de Advertências</h4>
          <p>Acompanhe empréstimos em atraso e situações que necessitam atenção especial</p>
        </div>
      </div>

      <!-- Cards de Análises Detalhadas -->
      <div class="settings-card mt-4">
        <h5>
          <i class='bx bx-chart-bar'></i> Análises Detalhadas
          <span class="tooltip-info">
            <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
            <span class="tooltip-text">Relatórios avançados com análises estatísticas e insights da biblioteca.</span>
          </span>
        </h5>
        
        <div class="report-type-cards mt-3">
          <div class="report-card" data-type="estatisticas">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class='bx bx-bar-chart-alt-2'></i>
            </div>
            <h4>Estatísticas Gerais</h4>
            <p>Análise completa do acervo, empréstimos e usuários com gráficos e métricas detalhadas</p>
          </div>
          
          <div class="report-card" data-type="tendencias">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
              <i class='bx bx-trending-up'></i>
            </div>
            <h4>Análise de Tendências</h4>
            <p>Identificação de padrões de empréstimo, livros mais populares e comportamento dos usuários</p>
          </div>
          
          <div class="report-card" data-type="performance">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #FFD54F 0%, #FF9800 100%);">
              <i class='bx bx-line-chart'></i>
            </div>
            <h4>Performance da Biblioteca</h4>
            <p>Métricas de desempenho, rotatividade do acervo e eficiência do sistema</p>
          </div>
          
          <div class="report-card" data-type="analytics">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
              <i class='bx bx-stats'></i>
            </div>
            <h4>Analytics Avançado</h4>
            <p>Análises preditivas, correlações e insights estratégicos para gestão da biblioteca</p>
          </div>
        </div>
      </div>

      <!-- Campo oculto para manter compatibilidade -->
      <select class="form-select d-none" id="reportType" name="reportType">
        <option value="livros">Livros</option>
        <option value="usuarios">Usuários</option>
        <option value="emprestimos">Empréstimos</option>
        <option value="leitores">Ranking de Leitores</option>
        <option value="advertencias">Advertências</option>
        <option value="estatisticas">Estatísticas Gerais</option>
        <option value="tendencias">Análise de Tendências</option>
        <option value="performance">Performance da Biblioteca</option>
        <option value="analytics">Analytics Avançado</option>
      </select>
    </div>

    <!-- Filtros e Configurações -->
    <div class="settings-card">
      <h5>
        <i class='bx bx-filter-alt'></i> Filtros e Configurações
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Configure os filtros específicos para personalizar seu relatório conforme suas necessidades.</span>
        </span>
      </h5>
      
      <div class="feature-highlight d-none" id="reportHelp">
        <h6><i class='bx bx-bulb'></i> Dica:</h6>
        <p id="reportHelpText">Selecione um tipo de relatório acima para ver as opções de filtros disponíveis.</p>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3 d-none" id="livrosFilters">
          <label class="form-label" for="livrosGenero">
            <i class='bx bx-category'></i> Filtrar por Gênero
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Selecione um gênero específico ou deixe "Todos" para incluir todos os gêneros no relatório.</span>
            </span>
          </label>
          <select class="form-select" id="livrosGenero" name="livrosGenero">
            <option value="">Todos os Gêneros</option>
            <option value="AVENTURA">Aventura</option>
            <option value="AUTOAJUDA">Autoajuda</option>
            <option value="BIOGRAFIA">Biografia</option>
            <option value="CIENCIAS">Ciências</option>
            <option value="DRAMA">Drama</option>
            <option value="EDUCACAO">Educação</option>
            <option value="FANTASIA">Fantasia</option>
            <option value="FICCAO_CIENTIFICA">Ficção Científica</option>
            <option value="HISTORIA">História</option>
            <option value="INFANTIL">Infantil</option>
            <option value="MISTERIO">Mistério</option>
            <option value="OUTROS">Outros</option>
            <option value="POESIA">Poesia</option>
            <option value="ROMANCE">Romance</option>
            <option value="TECNOLOGIA">Tecnologia</option>
            <option value="TERROR">Terror</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="usuariosFilters">
          <label class="form-label" for="usuariosStatus">
            <i class='bx bx-user-check'></i> Status do Usuário
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Filtre usuários por status: Ativos (podem fazer empréstimos) ou Inativos (bloqueados).</span>
            </span>
          </label>
          <select class="form-select" id="usuariosStatus" name="usuariosStatus">
            <option value="">Todos os Status</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="emprestimosFilters">
          <label class="form-label" for="emprestimosSituacao">
            <i class='bx bx-time'></i> Situação
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Ativo: ainda não devolvido | Finalizado: já devolvido | Atrasado: vencido</span>
            </span>
          </label>
          <select class="form-select" id="emprestimosSituacao" name="emprestimosSituacao">
            <option value="">Todas as Situações</option>
            <option value="Ativo">Ativo</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Atrasado">Atrasado</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="leitoresFilters">
          <label class="form-label" for="leitoresOrdem">
            <i class='bx bx-sort'></i> Ordenação
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Escolha como ordenar o ranking: dos que mais leram para os que menos leram ou vice-versa.</span>
            </span>
          </label>
          <select class="form-select" id="leitoresOrdem" name="leitoresOrdem">
            <option value="desc">Maior para Menor</option>
            <option value="asc">Menor para Maior</option>
          </select>
        </div>
        
        <!-- Filtros para Análises Detalhadas -->
        <div class="col-md-3 d-none" id="estatisticasFilters">
          <label class="form-label" for="estatisticasPeriodo">
            <i class='bx bx-calendar'></i> Período de Análise
          </label>
          <select class="form-select" id="estatisticasPeriodo" name="estatisticasPeriodo">
            <option value="atual">Mês Atual</option>
            <option value="trimestre">Último Trimestre</option>
            <option value="semestre">Último Semestre</option>
            <option value="ano">Último Ano</option>
            <option value="completo">Histórico Completo</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="tendenciasFilters">
          <label class="form-label" for="tendenciasMetrica">
            <i class='bx bx-trending-up'></i> Métrica Principal
          </label>
          <select class="form-select" id="tendenciasMetrica" name="tendenciasMetrica">
            <option value="emprestimos">Tendência de Empréstimos</option>
            <option value="generos">Popularidade por Gênero</option>
            <option value="usuarios">Atividade dos Usuários</option>
            <option value="sazonalidade">Análise Sazonal</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="performanceFilters">
          <label class="form-label" for="performanceIndicador">
            <i class='bx bx-line-chart'></i> Indicador
          </label>
          <select class="form-select" id="performanceIndicador" name="performanceIndicador">
            <option value="rotatividade">Taxa de Rotatividade</option>
            <option value="tempo-medio">Tempo Médio de Empréstimo</option>
            <option value="eficiencia">Eficiência do Sistema</option>
            <option value="satisfacao">Índice de Satisfação</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="analyticsFilters">
          <label class="form-label" for="analyticsModelo">
            <i class='bx bx-stats'></i> Modelo de Análise
          </label>
          <select class="form-select" id="analyticsModelo" name="analyticsModelo">
            <option value="correlacao">Análise de Correlação</option>
            <option value="predicao">Previsões Futuras</option>
            <option value="segmentacao">Segmentação de Usuários</option>
            <option value="otimizacao">Sugestões de Otimização</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <button class="btn btn-gradient w-100" id="btnGerarRelatorio" disabled>
            <i class='bx bx-search-alt'></i> Gerar Relatório
          </button>
        </div>
      </div>
      <!-- Filtros de data para empréstimos -->
      <div class="row g-3 align-items-end mt-2" id="emprestimosDateFilters" style="display: none;">
        <div class="col-md-3" id="emprestimosDataInicioFilter">
          <label class="form-label" for="dataInicio">
            <i class='bx bx-calendar'></i> Data Início
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empréstimos realizados a partir desta data serão incluídos no relatório.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataInicio" name="dataInicio">
        </div>
        <div class="col-md-3" id="emprestimosDataFimFilter">
          <label class="form-label" for="dataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empréstimos realizados até esta data serão incluídos no relatório.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataFim" name="dataFim">
        </div>
        <div class="col-md-3">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF"><i class='bx bx-download'></i> Baixar PDF</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('dataInicio').value=''; document.getElementById('dataFim').value='';">
            <i class='bx bx-refresh'></i> Limpar Datas
          </button>
        </div>
      </div>
      <!-- Filtros de data para ranking de leitores -->
      <div class="row g-3 align-items-end mt-2" id="leitoresDateFilters" style="display: none;">
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataInicio">
            <i class='bx bx-calendar'></i> Data Início
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devoluções realizadas a partir desta data serão consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataInicio" name="leitoresDataInicio">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devoluções realizadas até esta data serão consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataFim" name="leitoresDataFim">
        </div>
        <div class="col-md-2">
          <label class="form-label" for="leitoresLimite">
            <i class='bx bx-list-ol'></i> Limite de Resultados
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Defina quantos leitores serão exibidos no ranking (ex: Top 10, Top 20, etc.).</span>
            </span>
          </label>
          <select class="form-select" id="leitoresLimite" name="leitoresLimite">
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" id="btnBaixarPDFLeitores"><i class='bx bx-download'></i> PDF</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('leitoresDataInicio').value=''; document.getElementById('leitoresDataFim').value=''; document.getElementById('leitoresLimite').value='10';">
            <i class='bx bx-refresh'></i> Limpar
          </button>
        </div>
      </div>
      <!-- Ações para outros relatórios -->
      <div class="row g-3 align-items-end mt-2" id="otherReportsActions">
        <div class="col-md-4">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF2">
            <i class='bx bx-download'></i> Baixar PDF
          </button>
        </div>
        <div class="col-md-8">
          <div class="feature-highlight">
            <h6><i class='bx bx-info-circle'></i> Dica de Exportação:</h6>
            <p class="mb-0">Após gerar o relatório, clique em "Baixar PDF" para salvar uma versão profissional do documento com o logo da escola.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Seção de Resultados -->
    <div class="settings-card" id="reportResult">
      <div class="text-center py-5">
        <div class="mb-4">
          <i class='bx bx-file-blank' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
        </div>
        <h4 class="text-dark mb-3">Selecione um Tipo de Relatório</h4>
        <p class="text-muted mb-4">Escolha um dos cards acima para começar a gerar seu relatório personalizado</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <div class="stats-card">
            <div class="stats-number">📊</div>
            <div class="stats-label">Análises Detalhadas</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">📱</div>
            <div class="stats-label">Interface Intuitiva</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">💾</div>
            <div class="stats-label">Export em PDF</div>
          </div>
        </div>
      </div>
    </div>
    
    <span id="quantidadeLivros" style="display:none;"></span>
    </tbody>
    </table> 
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  let nomeEscola = 'Escola Exemplo';

  async function buscarEscolaUsuario() {
    if (auth.currentUser) {
      const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
      if (userDoc.exists && userDoc.data().escolaId) {
        const escolaDoc = await db.collection('escolas').doc(userDoc.data().escolaId).get();
        if (escolaDoc.exists && escolaDoc.data().nome) {
          nomeEscola = escolaDoc.data().nome;
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
    const reportType = document.getElementById('reportType');
    const reportResult = document.getElementById('reportResult');
    const btnBaixarPDF = document.getElementById('btnBaixarPDF');
    const reportCards = document.querySelectorAll('.report-card');
    const reportHelp = document.getElementById('reportHelp');
    const reportHelpText = document.getElementById('reportHelpText');

    // Textos de ajuda para cada tipo de relatório
    const helpTexts = {
      livros: "Este relatório mostra todos os livros do acervo. Você pode filtrar por gênero específico para análises mais direcionadas.",
      usuarios: "Lista todos os usuários cadastrados no sistema. Filtre por status para ver apenas usuários ativos ou inativos.",
      emprestimos: "Mostra o histórico completo de empréstimos. Use os filtros de data e situação para análises específicas de período.",
      leitores: "Ranking dos usuários mais ativos na biblioteca. Configure o período e a quantidade de resultados para análises customizadas.",
      advertencias: "Relatório de empréstimos em atraso para acompanhamento pedagógico e gestão da biblioteca.",
      estatisticas: "Análise estatística completa da biblioteca com métricas de acervo, usuários e empréstimos em formato visual.",
      tendencias: "Identificação de padrões sazonais, livros em alta e comportamento dos usuários ao longo do tempo.",
      performance: "Métricas de desempenho da biblioteca incluindo taxa de rotatividade, tempo médio de empréstimo e eficiência.",
      analytics: "Análises avançadas com correlações, previsões e insights estratégicos para tomada de decisões."
    };

    // Função para atualizar o card ativo
    function updateActiveCard(type) {
      reportCards.forEach(card => {
        card.classList.remove('active');
        if (card.dataset.type === type) {
          card.classList.add('active');
        }
      });
      
      // Atualizar o select oculto para manter compatibilidade
      reportType.value = type;
      
      // Mostrar ajuda específica
      if (helpTexts[type]) {
        reportHelpText.textContent = helpTexts[type];
        reportHelp.classList.remove('d-none');
      }
      
      // Habilitar o botão de gerar relatório
      btnGerarRelatorio.disabled = false;
      btnGerarRelatorio.innerHTML = '<i class="bx bx-search-alt"></i> Gerar Relatório';
      
      // Disparar evento de mudança para mostrar filtros
      reportType.dispatchEvent(new Event('change'));
    }

    // Event listeners para os cards de relatório
    reportCards.forEach(card => {
      card.addEventListener('click', function() {
        const type = this.dataset.type;
        updateActiveCard(type);
        
        // Animação de feedback visual
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = '';
        }, 150);
      });
    });

    // Inicializar com o primeiro tipo (livros) por padrão
    updateActiveCard('livros');

    btnGerarRelatorio.addEventListener('click', async function () {
      // Animação de loading
      const originalText = this.innerHTML;
      this.innerHTML = '<span class="loading-spinner"></span>Gerando...';
      this.disabled = true;
      
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
          <h5 class="text-dark">Carregando dados...</h5>
          <p class="text-muted">Por favor, aguarde enquanto processamos as informações</p>
        </div>
      `;
      
      let html = '';

      try {
        if (reportType.value === 'livros') {
          const genero = document.getElementById('livrosGenero').value;
          let query = db.collection('livros');
          if (genero) {
            query = query.where('genero', '==', genero);
          }

          const snapshot = await query.get();
          if (snapshot.empty) {
            html = `
              <div class="text-center py-5">
                <i class='bx bx-book' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Nenhum livro encontrado</h5>
                <p class="text-muted">Não há livros cadastrados com os filtros selecionados.</p>
              </div>
            `;
          }
          else {
            // Ordena os livros por título (alfabético)
            const livrosOrdenados = snapshot.docs
              .map(doc => doc.data())
              .sort((a, b) => (a.titulo || '').localeCompare(b.titulo || '', 'pt-BR', { sensitivity: 'base' }));

            // Estatísticas resumidas no topo
            const totalLivros = snapshot.size;
            const totalExemplares = livrosOrdenados.reduce((total, l) => total + (l.quantidade || 0), 0);
            const disponiveis = livrosOrdenados.reduce((total, l) => total + (l.quantidadeDisponivel || 0), 0);
            const emprestados = livrosOrdenados.reduce((total, l) => total + (l.emprestados || 0), 0);

            html = `
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalLivros}</div>
                    <div class="stats-label">Títulos Cadastrados</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalExemplares}</div>
                    <div class="stats-label">Total de Exemplares</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #28a745;">${disponiveis}</div>
                    <div class="stats-label">Disponíveis</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #ffc107;">${emprestados}</div>
                    <div class="stats-label">Emprestados</div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead>
                    <tr>
                      <th><i class='bx bx-book'></i> Título</th>
                      <th><i class='bx bx-user'></i> Autor</th>
                      <th><i class='bx bx-category'></i> Gênero</th>
                      <th><i class='bx bx-package'></i> Qtd Total</th>
                      <th><i class='bx bx-check-circle'></i> Disponível</th>
                      <th><i class='bx bx-bookmark'></i> Emprestados</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            livrosOrdenados.forEach(l => {
              const quantidade = l.quantidade || 0;
              const disponivel = l.quantidadeDisponivel || 0;
              const emprestados = l.emprestados || 0;
              const autores = Array.isArray(l.autores) ? l.autores.join(', ') : (l.autores || l.autor || 'Autor não informado');
              
              // Cor baseada na disponibilidade
              let rowClass = '';
              if (disponivel === 0 && quantidade > 0) rowClass = 'table-warning'; // Todos emprestados
              else if (quantidade === 0) rowClass = 'table-secondary'; // Sem exemplares

              html += `
                <tr class="${rowClass}">
                  <td><strong>${l.titulo || 'Sem título'}</strong></td>
                  <td>${autores}</td>
                  <td>
                    <span class="badge bg-secondary">${l.genero || 'Não informado'}</span>
                  </td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">
                    <span class="badge ${disponivel > 0 ? 'bg-success' : 'bg-warning'}">${disponivel}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge ${emprestados > 0 ? 'bg-primary' : 'bg-light text-dark'}">${emprestados}</span>
                  </td>
                </tr>
              `;
            });
            html += '</tbody></table></div>';

            // Adicionar informações adicionais
            if (genero) {
              html += `
                <div class="feature-highlight mt-4">
                  <h6><i class='bx bx-filter'></i> Filtro Aplicado:</h6>
                  <p>Mostrando apenas livros do gênero: <strong>${genero}</strong></p>
                </div>
              `;
            }
          }
        }

        if (reportType.value === 'usuarios') {
        const status = document.getElementById('usuariosStatus').value;
        let query = db.collection('usuarios');
        if (status) {
          query = query.where('status', '==', status);
        }

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum usuário encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Nome</th><th>Email</th><th>Matrícula</th><th>Função</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            snapshot.forEach(doc => {
              const u = doc.data();
              html += `
                <tr>
                  <td>${u.nome || 'Nome não informado'}</td>
                  <td>${u.email || 'Email não informado'}</td>
                  <td>${u.matricula || 'Não informado'}</td>
                  <td>${u.funcao || u.papel || 'Não informado'}</td>
                  <td><span class="badge ${(u.status === 'Ativo' || !u.status) ? 'bg-success' : 'bg-secondary'}">${u.status || 'Ativo'}</span></td>
                </tr>
              `;
            });
            html += '</tbody></table>';
            
            // Adiciona estatísticas resumidas
            html += `
              <div class="mt-3">
                <h5>Resumo:</h5>
                <p><strong>Total de usuários:</strong> ${snapshot.size}</p>
              </div>
            `;
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar usuários: ${error.message}</p>`;
          console.error('Erro ao buscar usuários:', error);
        }
      }

      if (reportType.value === 'emprestimos') {
        const situacaoFiltro = document.getElementById('emprestimosSituacao').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        let query = db.collection('emprestimos');

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum empréstimo encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Usuário</th><th>Livro(s)</th><th>Data Empréstimo</th><th>Data Devolução</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // Converter datas do filtro para objetos Date para comparação
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }
            
            let emprestimosExibidos = 0;
            
            for (const doc of snapshot.docs) {
              const e = doc.data();
              
              // Filtro por data
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                // Converter data do empréstimo para Date
                let dataEmprestimoObj = null;
                if (e.loanDate) {
                  const dateParts = e.loanDate.split('/');
                  if (dateParts.length === 3) {
                    dataEmprestimoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataEmprestimoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataEmprestimoObj) {
                  if (dataInicioObj && dataEmprestimoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataEmprestimoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se não conseguir converter a data, não exibe se há filtro de data
                  if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;
              
              // Buscar nome do usuário
              let nomeUsuario = 'Usuário não encontrado';
              try {
                if (e.userId) {
                  const userDoc = await db.collection('usuarios').doc(e.userId).get();
                  if (userDoc.exists) {
                    nomeUsuario = userDoc.data().nome || 'Nome não informado';
                  }
                }
              } catch (error) {
                console.error('Erro ao buscar usuário:', error);
              }

              // Buscar nomes dos livros
              let nomesLivros = 'Livros não encontrados';
              try {
                if (Array.isArray(e.books)) {
                  const livrosPromises = e.books.map(async (book) => {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    const livroData = livroDoc.exists ? livroDoc.data() : null;
                    const titulo = livroData ? livroData.titulo : book.bookId;
                    return `${titulo} (Qtd: ${book.quantity})`;
                  });
                  const livrosArray = await Promise.all(livrosPromises);
                  nomesLivros = livrosArray.join(', ');
                }
              } catch (error) {
                console.error('Erro ao buscar livros:', error);
              }

              // Determinar status real
              let statusAtual = e.status || 'EMPRESTADO';
              
              // Verificar se está atrasado baseado na data
              if (e.returnDate && (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO')) {
                const dateParts = e.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    statusAtual = 'ATRASADO';
                  }
                }
              }

              // Mapear status para filtro
              let statusFiltro = '';
              if (statusAtual === 'EMPRESTADO') statusFiltro = 'Ativo';
              else if (statusAtual === 'ATRASADO') statusFiltro = 'Atrasado';
              else if (statusAtual === 'DEVOLVIDO') statusFiltro = 'Finalizado';

              // Aplicar filtro de situação
              if (situacaoFiltro && situacaoFiltro !== statusFiltro) {
                continue; // Pula este empréstimo
              }

              emprestimosExibidos++;

              html += `
                <tr>
                  <td>${nomeUsuario}</td>
                  <td>${nomesLivros}</td>
                  <td>${e.loanDate || 'Data não informada'}</td>
                  <td>${e.returnDate || 'Data não informada'}</td>
                  <td><span class="badge ${statusAtual === 'DEVOLVIDO' ? 'bg-success' : statusAtual === 'ATRASADO' ? 'bg-danger' : 'bg-primary'}">${statusAtual}</span></td>
                </tr>
              `;
            }
            
            if (emprestimosExibidos === 0) {
              html = '<p>Nenhum empréstimo encontrado com os filtros selecionados.</p>';
            } else {
              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas
              html += `
                <div class="mt-3">
                  <h5>Resumo:</h5>
                  <p><strong>Total de empréstimos encontrados:</strong> ${emprestimosExibidos}</p>
                  <p><strong>Total de empréstimos no sistema:</strong> ${snapshot.size}</p>
                  ${dataInicio || dataFim ? `<p><strong>Período:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'Início'} até ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar empréstimos: ${error.message}</p>`;
          console.error('Erro ao buscar empréstimos:', error);
        }
      }

      if (reportType.value === 'advertencias') {
        try {
          const snapshotEmprestimos = await db.collection('emprestimos').get();
          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum empréstimo encontrado para verificar advertências.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Data Empréstimo</th>
                    <th>Data Prevista Devolução</th>
                    <th>Usuário</th>
                    <th>Livro(s)</th>
                    <th>Dias de Atraso</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(23, 59, 59, 999); // Fim do dia atual
            
            let totalAdvertencias = 0;
            
            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Verificar apenas empréstimos ativos ou já marcados como atrasados
              if (emprestimo.status === 'DEVOLVIDO') {
                continue;
              }
              
              // Calcular dias de atraso
              let diasAtraso = 0;
              let dataVencimento = null;
              let statusEmprestimo = emprestimo.status || 'EMPRESTADO';
              
              if (emprestimo.returnDate) {
                const dateParts = emprestimo.returnDate.split('/');
                if (dateParts.length === 3) {
                  dataVencimento = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  dataVencimento.setHours(23, 59, 59, 999);
                  
                  if (hoje > dataVencimento) {
                    const diffTime = hoje.getTime() - dataVencimento.getTime();
                    diasAtraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    statusEmprestimo = 'ATRASADO';
                  }
                }
              }
              
              // Só exibe se houver atraso (advertência)
              if (diasAtraso > 0) {
                totalAdvertencias++;
                
                // Buscar nome do usuário
                let nomeUsuario = 'Usuário não encontrado';
                let matriculaUsuario = '';
                try {
                  if (emprestimo.userId) {
                    const userDoc = await db.collection('usuarios').doc(emprestimo.userId).get();
                    if (userDoc.exists) {
                      const userData = userDoc.data();
                      nomeUsuario = userData.nome || 'Nome não informado';
                      matriculaUsuario = userData.matricula ? ` (Mat: ${userData.matricula})` : '';
                    }
                  }
                } catch (error) {
                  console.error('Erro ao buscar usuário:', error);
                }

                // Buscar nomes dos livros
                let nomesLivros = 'Livros não encontrados';
                try {
                  if (Array.isArray(emprestimo.books)) {
                    const livrosPromises = emprestimo.books.map(async (book) => {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      const livroData = livroDoc.exists ? livroDoc.data() : null;
                      const titulo = livroData ? livroData.titulo : book.bookId;
                      return `${titulo} (Qtd: ${book.quantity})`;
                    });
                    const livrosArray = await Promise.all(livrosPromises);
                    nomesLivros = livrosArray.join('<br>');
                  }
                } catch (error) {
                  console.error('Erro ao buscar livros:', error);
                }

                // Calcular quantidade de livros para informação
                const quantidadeLivros = Array.isArray(emprestimo.books) 
                  ? emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0)
                  : 1;

                // Definir cor do badge baseado nos dias de atraso
                let badgeClass = 'bg-warning';
                if (diasAtraso > 15) badgeClass = 'bg-danger';
                else if (diasAtraso > 7) badgeClass = 'bg-warning';
                else badgeClass = 'bg-info';

                html += `
                  <tr class="${diasAtraso > 15 ? 'table-danger' : diasAtraso > 7 ? 'table-warning' : ''}">
                    <td>${emprestimo.loanDate || 'Data não informada'}</td>
                    <td>${emprestimo.returnDate || 'Data não informada'}</td>
                    <td>
                      <strong>${nomeUsuario}</strong>${matriculaUsuario}
                    </td>
                    <td style="max-width: 200px;">${nomesLivros}</td>
                    <td>
                      <span class="badge ${badgeClass} fs-6">
                        ${diasAtraso} dia${diasAtraso > 1 ? 's' : ''}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-danger">ATRASADO</span>
                    </td>
                  </tr>
                `;
              }
            }
            
            if (totalAdvertencias === 0) {
              html = `
                <div class="alert alert-success">
                  <h5><i class='bx bx-check-circle'></i> Parabéns!</h5>
                  <p class="mb-0">Não há empréstimos em atraso no momento. Todos os usuários estão em dia com suas devoluções.</p>
                </div>
              `;
            } else {
              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas com alertas coloridos
              html += `
                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="alert alert-danger">
                      <h6><i class='bx bx-error-circle'></i> Total de Advertências</h6>
                      <h4 class="mb-0">${totalAdvertencias}</h4>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="alert alert-info">
                      <h6><i class='bx bx-calendar'></i> Data da Consulta</h6>
                      <h6 class="mb-0">${hoje.toLocaleDateString('pt-BR')}</h6>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <h5>Legenda de Gravidade:</h5>
                  <div class="d-flex flex-wrap gap-3">
                    <span><span class="badge bg-info">1-7 dias</span> Atraso Leve</span>
                    <span><span class="badge bg-warning">8-15 dias</span> Atraso Moderado</span>
                    <span><span class="badge bg-danger">16+ dias</span> Atraso Grave</span>
                  </div>
                  <small class="text-muted mt-2 d-block">
                    <strong>Nota:</strong> As advertências servem como orientação pedagógica para conscientização sobre a importância da devolução no prazo.
                  </small>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar advertências: ${error.message}</p>`;
          console.error('Erro ao buscar advertências:', error);
        }
      }

      if (reportType.value === 'leitores') {
        const ordem = document.getElementById('leitoresOrdem').value;
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;

        try {
          const snapshotEmprestimos = await db.collection('emprestimos')
            .where('status', '==', 'DEVOLVIDO')
            .get();

          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum livro foi devolvido ainda para gerar o ranking de leitores.</p>';
          } else {
            // Converter datas do filtro para objetos Date para comparação
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }

            // Mapa para contar livros por usuário
            const leitoresPorUsuario = new Map();

            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Filtro por data de devolução real
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                let dataDevolucaoObj = null;
                if (emprestimo.actualReturnDate) {
                  const dateParts = emprestimo.actualReturnDate.split('/');
                  if (dateParts.length === 3) {
                    dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataDevolucaoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataDevolucaoObj) {
                  if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se não há data de devolução real, usar data de empréstimo como fallback
                  if (emprestimo.loanDate) {
                    const dateParts = emprestimo.loanDate.split('/');
                    if (dateParts.length === 3) {
                      dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                      dataDevolucaoObj.setHours(0, 0, 0, 0);
                      
                      if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                        passaFiltroPorData = false;
                      }
                      if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                        passaFiltroPorData = false;
                      }
                    } else if (dataInicioObj || dataFimObj) {
                      passaFiltroPorData = false;
                    }
                  } else if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;

              // Contar livros por usuário
              if (Array.isArray(emprestimo.books)) {
                const totalLivros = emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0);
                
                if (leitoresPorUsuario.has(emprestimo.userId)) {
                  leitoresPorUsuario.get(emprestimo.userId).totalLivros += totalLivros;
                  leitoresPorUsuario.get(emprestimo.userId).emprestimos += 1;
                } else {
                  leitoresPorUsuario.set(emprestimo.userId, {
                    userId: emprestimo.userId,
                    totalLivros: totalLivros,
                    emprestimos: 1,
                    nomeUsuario: 'Carregando...',
                    matriculaUsuario: '',
                    funcaoUsuario: ''
                  });
                }
              }
            }

            // Buscar dados dos usuários
            for (const [userId, userData] of leitoresPorUsuario) {
              try {
                const userDoc = await db.collection('usuarios').doc(userId).get();
                if (userDoc.exists) {
                  const user = userDoc.data();
                  userData.nomeUsuario = user.nome || 'Nome não informado';
                  userData.matriculaUsuario = user.matricula || '';
                  userData.funcaoUsuario = user.funcao || user.papel || '';
                }
              } catch (error) {
                console.error('Erro ao buscar usuário:', error);
                userData.nomeUsuario = 'Erro ao carregar';
              }
            }

            // Converter para array e ordenar
            let leitoresArray = Array.from(leitoresPorUsuario.values());
            
            // Ordenar por total de livros
            if (ordem === 'desc') {
              leitoresArray.sort((a, b) => b.totalLivros - a.totalLivros);
            } else {
              leitoresArray.sort((a, b) => a.totalLivros - b.totalLivros);
            }

            // Aplicar limite se especificado
            if (limite && parseInt(limite) > 0) {
              leitoresArray = leitoresArray.slice(0, parseInt(limite));
            }

            if (leitoresArray.length === 0) {
              html = '<p>Nenhum leitor encontrado com os filtros selecionados.</p>';
            } else {
              html = `
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card text-center border-success">
                      <div class="card-body">
                        <h4 class="text-success mb-1">${leitoresArray.length}</h4>
                        <small class="text-muted">Leitores Ativos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-primary">
                      <div class="card-body">
                        <h4 class="text-primary mb-1">${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</h4>
                        <small class="text-muted">Total de Livros Lidos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-warning">
                      <div class="card-body">
                        <h4 class="text-warning mb-1">${Math.round(leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0) / leitoresArray.length)}</h4>
                        <small class="text-muted">Média por Leitor</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <table class="table table-bordered table-sm">
                  <thead class="table-primary">
                    <tr>
                      <th>Posição</th>
                      <th>Nome</th>
                      <th>Matrícula</th>
                      <th>Função</th>
                      <th>Livros Lidos</th>
                      <th>Empréstimos</th>
                      <th>Média por Empréstimo</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              leitoresArray.forEach((leitor, index) => {
                const posicao = index + 1;
                const mediaPorEmprestimo = (leitor.totalLivros / leitor.emprestimos).toFixed(1);
                
                // Definir classe CSS baseada na posição
                let rowClass = '';
                if (posicao === 1) rowClass = 'table-warning'; // Ouro
                else if (posicao === 2) rowClass = 'table-secondary'; // Prata
                else if (posicao === 3) rowClass = 'table-info'; // Bronze

                // Ícone de medalha para os 3 primeiros
                let medalha = '';
                if (posicao === 1) medalha = '🥇';
                else if (posicao === 2) medalha = '🥈';
                else if (posicao === 3) medalha = '🥉';

                html += `
                  <tr class="${rowClass}">
                    <td class="text-center">
                      <strong>${medalha} ${posicao}º</strong>
                    </td>
                    <td><strong>${leitor.nomeUsuario}</strong></td>
                    <td>${leitor.matriculaUsuario || 'N/A'}</td>
                    <td>${leitor.funcaoUsuario || 'N/A'}</td>
                    <td class="text-center">
                      <span class="badge bg-success fs-6">${leitor.totalLivros}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary">${leitor.emprestimos}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">${mediaPorEmprestimo}</span>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              
              // Adiciona estatísticas resumidas
              html += `
                <div class="mt-4">
                  <h5>Resumo do Ranking:</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Total de leitores encontrados:</strong> ${leitoresArray.length}</p>
                      <p><strong>Livros lidos no período:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Empréstimos concluídos:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.emprestimos, 0)}</p>
                      ${dataInicio || dataFim ? `<p><strong>Período:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'Início'} até ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                    </div>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <h6><i class='bx bx-info-circle'></i> Como interpretar este ranking:</h6>
                    <ul class="mb-0">
                      <li><strong>Livros Lidos:</strong> Total de livros devolvidos pelo usuário</li>
                      <li><strong>Empréstimos:</strong> Número de vezes que o usuário fez empréstimos</li>
                      <li><strong>Média por Empréstimo:</strong> Quantos livros em média o usuário lê por empréstimo</li>
                      <li><strong>🥇🥈🥉:</strong> Medalhas para os 3 primeiros colocados</li>
                    </ul>
                  </div>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar ranking de leitores: ${error.message}</p>`;
          console.error('Erro ao buscar ranking de leitores:', error);
        }
      }

      // Relatórios de Análises Detalhadas
      if (reportType.value === 'estatisticas') {
        try {
          const periodo = document.getElementById('estatisticasPeriodo').value;
          
          // Buscar dados de todas as coleções
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          // Calcular estatísticas dos livros
          const totalLivros = livrosSnapshot.size;
          const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.quantidade || 0);
          }, 0);
          
          const exemplariesDisponiveis = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.quantidadeDisponivel || 0);
          }, 0);
          
          const exemplariesEmprestados = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.emprestados || 0);
          }, 0);

          // Análise por gêneros
          const generos = {};
          livrosSnapshot.docs.forEach(doc => {
            const livro = doc.data();
            const genero = livro.genero || 'Não classificado';
            if (!generos[genero]) {
              generos[genero] = { titulos: 0, exemplares: 0 };
            }
            generos[genero].titulos++;
            generos[genero].exemplares += (livro.quantidade || 0);
          });

          // Estatísticas dos usuários
          const totalUsuarios = usuariosSnapshot.size;
          const usuariosAtivos = usuariosSnapshot.docs.filter(doc => {
            const usuario = doc.data();
            return !usuario.status || usuario.status === 'Ativo';
          }).length;

          // Análise por função
          const funcoes = {};
          usuariosSnapshot.docs.forEach(doc => {
            const usuario = doc.data();
            const funcao = usuario.funcao || usuario.papel || 'Não informado';
            funcoes[funcao] = (funcoes[funcao] || 0) + 1;
          });

          // Estatísticas dos empréstimos
          const totalEmprestimos = emprestimosSnapshot.size;
          const emprestimosAtivos = emprestimosSnapshot.docs.filter(doc => {
            const emp = doc.data();
            return emp.status !== 'DEVOLVIDO';
          }).length;
          
          const emprestimosFinalizados = emprestimosSnapshot.docs.filter(doc => {
            const emp = doc.data();
            return emp.status === 'DEVOLVIDO';
          }).length;

          // Calcular empréstimos atrasados
          const hoje = new Date();
          hoje.setHours(0, 0, 0, 0);
          let emprestimosAtrasados = 0;
          
          emprestimosSnapshot.docs.forEach(doc => {
            const emp = doc.data();
            if (emp.status !== 'DEVOLVIDO' && emp.returnDate) {
              const dateParts = emp.returnDate.split('/');
              if (dateParts.length === 3) {
                const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                returnDate.setHours(0, 0, 0, 0);
                if (returnDate < hoje) {
                  emprestimosAtrasados++;
                }
              }
            }
          });

          // Taxa de rotatividade
          const taxaRotatividade = totalExemplares > 0 ? ((emprestimosFinalizados / totalExemplares) * 100).toFixed(1) : 0;
          
          // Taxa de ocupação
          const taxaOcupacao = totalExemplares > 0 ? ((exemplariesEmprestados / totalExemplares) * 100).toFixed(1) : 0;

          html = `
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3">
                <i class='bx bx-bar-chart-alt-2' style="font-size: 2rem; color: #667eea; margin-right: 10px;"></i>
                <h4 class="text-dark mb-0">Estatísticas Gerais da Biblioteca</h4>
              </div>
              <p class="text-muted">Período: ${periodo === 'completo' ? 'Histórico Completo' : periodo.charAt(0).toUpperCase() + periodo.slice(1)}</p>
            </div>

            <!-- Indicadores Principais -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #667eea;">${totalLivros}</div>
                  <div class="stats-label">Títulos Cadastrados</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #4facfe;">${totalExemplares}</div>
                  <div class="stats-label">Total de Exemplares</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #28a745;">${usuariosAtivos}</div>
                  <div class="stats-label">Usuários Ativos</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #ffc107;">${totalEmprestimos}</div>
                  <div class="stats-label">Total Empréstimos</div>
                </div>
              </div>
            </div>

            <!-- Métricas de Performance -->
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="alert alert-info">
                  <h6><i class='bx bx-trending-up'></i> Taxa de Rotatividade</h6>
                  <h4 class="mb-0">${taxaRotatividade}%</h4>
                  <small>Empréstimos por exemplar</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="alert alert-success">
                  <h6><i class='bx bx-check-circle'></i> Taxa de Ocupação</h6>
                  <h4 class="mb-0">${taxaOcupacao}%</h4>
                  <small>Exemplares em empréstimo</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="alert ${emprestimosAtrasados > 0 ? 'alert-warning' : 'alert-success'}">
                  <h6><i class='bx bx-time'></i> Empréstimos Atrasados</h6>
                  <h4 class="mb-0">${emprestimosAtrasados}</h4>
                  <small>Requerem atenção</small>
                </div>
              </div>
            </div>

            <!-- Distribuição por Gêneros -->
            <div class="row mb-4">
              <div class="col-md-6">
                <h5><i class='bx bx-category'></i> Distribuição por Gêneros</h5>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-primary">
                      <tr>
                        <th>Gênero</th>
                        <th class="text-center">Títulos</th>
                        <th class="text-center">Exemplares</th>
                        <th class="text-center">% do Acervo</th>
                      </tr>
                    </thead>
                    <tbody>
          `;
          
          Object.entries(generos)
            .sort((a, b) => b[1].exemplares - a[1].exemplares)
            .slice(0, 8)
            .forEach(([genero, dados]) => {
              const percentual = ((dados.exemplares / totalExemplares) * 100).toFixed(1);
              html += `
                <tr>
                  <td><strong>${genero}</strong></td>
                  <td class="text-center">${dados.titulos}</td>
                  <td class="text-center">${dados.exemplares}</td>
                  <td class="text-center">
                    <span class="badge bg-primary">${percentual}%</span>
                  </td>
                </tr>
              `;
            });

          html += `
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="col-md-6">
                <h5><i class='bx bx-group'></i> Usuários por Função</h5>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-success">
                      <tr>
                        <th>Função</th>
                        <th class="text-center">Quantidade</th>
                        <th class="text-center">% do Total</th>
                      </tr>
                    </thead>
                    <tbody>
          `;
          
          Object.entries(funcoes)
            .sort((a, b) => b[1] - a[1])
            .forEach(([funcao, quantidade]) => {
              const percentual = ((quantidade / totalUsuarios) * 100).toFixed(1);
              html += `
                <tr>
                  <td><strong>${funcao}</strong></td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">
                    <span class="badge bg-success">${percentual}%</span>
                  </td>
                </tr>
              `;
            });

          html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Status dos Empréstimos -->
            <div class="row">
              <div class="col-12">
                <h5><i class='bx bx-bookmark'></i> Status dos Empréstimos</h5>
                <div class="row">
                  <div class="col-md-4">
                    <div class="card border-primary">
                      <div class="card-body text-center">
                        <i class='bx bx-book-open' style="font-size: 2rem; color: #007bff;"></i>
                        <h4 class="text-primary">${emprestimosAtivos}</h4>
                        <p class="card-text">Empréstimos Ativos</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-success">
                      <div class="card-body text-center">
                        <i class='bx bx-check-circle' style="font-size: 2rem; color: #28a745;"></i>
                        <h4 class="text-success">${emprestimosFinalizados}</h4>
                        <p class="card-text">Devoluções Realizadas</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-warning">
                      <div class="card-body text-center">
                        <i class='bx bx-time' style="font-size: 2rem; color: #ffc107;"></i>
                        <h4 class="text-warning">${emprestimosAtrasados}</h4>
                        <p class="card-text">Em Atraso</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="alert alert-info mt-4">
              <h6><i class='bx bx-info-circle'></i> Interpretação dos Dados:</h6>
              <ul class="mb-0">
                <li><strong>Taxa de Rotatividade:</strong> Indica quantas vezes cada exemplar foi emprestado. Valores altos indicam boa circulação do acervo.</li>
                <li><strong>Taxa de Ocupação:</strong> Percentual do acervo atualmente emprestado. Ideal entre 60-80%.</li>
                <li><strong>Distribuição por Gêneros:</strong> Ajuda a identificar lacunas ou excessos no acervo.</li>
              </ul>
            </div>
          `;

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar estatísticas: ${error.message}</p>`;
          console.error('Erro ao buscar estatísticas:', error);
        }
      }

      if (reportType.value === 'tendencias') {
        try {
          const metrica = document.getElementById('tendenciasMetrica').value;
          
          // Buscar dados necessários
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (metrica === 'emprestimos') {
            // Análise de Tendências de Empréstimos
            const tendenciasMensais = {};
            const hoje = new Date();
            
            // Inicializar últimos 12 meses
            for (let i = 11; i >= 0; i--) {
              const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
              const chave = `${data.getFullYear()}-${(data.getMonth() + 1).toString().padStart(2, '0')}`;
              tendenciasMensais[chave] = {
                emprestimos: 0,
                devolucoes: 0,
                nome: data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
              };
            }

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const chave = `${dateParts[2]}-${dateParts[1]}`;
                  if (tendenciasMensais[chave]) {
                    tendenciasMensais[chave].emprestimos++;
                    if (emp.status === 'DEVOLVIDO') {
                      tendenciasMensais[chave].devolucoes++;
                    }
                  }
                }
              }
            });

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-trending-up' style="font-size: 2rem; color: #4facfe; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Análise de Tendências - Empréstimos</h4>
                </div>
                <p class="text-muted">Evolução mensal dos empréstimos nos últimos 12 meses</p>
              </div>

              <!-- Gráfico de Tendências -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-line-chart'></i> Evolução Mensal</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Mês</th>
                          <th class="text-center">Empréstimos</th>
                          <th class="text-center">Devoluções</th>
                          <th class="text-center">Taxa de Devolução</th>
                          <th class="text-center">Tendência</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const meses = Object.keys(tendenciasMensais).sort();
            const valores = meses.map(m => tendenciasMensais[m].emprestimos);
            
            meses.forEach((chave, index) => {
              const dados = tendenciasMensais[chave];
              const taxaDevolucao = dados.emprestimos > 0 ? ((dados.devolucoes / dados.emprestimos) * 100).toFixed(1) : 0;
              
              let tendencia = '➡️';
              if (index > 0) {
                const anterior = valores[index - 1];
                const atual = valores[index];
                if (atual > anterior) tendencia = '📈';
                else if (atual < anterior) tendencia = '📉';
              }

              html += `
                <tr>
                  <td><strong>${dados.nome}</strong></td>
                  <td class="text-center">${dados.emprestimos}</td>
                  <td class="text-center">${dados.devolucoes}</td>
                  <td class="text-center">
                    <span class="badge ${taxaDevolucao > 80 ? 'bg-success' : taxaDevolucao > 60 ? 'bg-warning' : 'bg-danger'}">${taxaDevolucao}%</span>
                  </td>
                  <td class="text-center" style="font-size: 1.2rem;">${tendencia}</td>
                </tr>
              `;
            });

            // Calcular estatísticas
            const totalEmprestimos = valores.reduce((a, b) => a + b, 0);
            const mediaEmprestimos = (totalEmprestimos / valores.length).toFixed(1);
            const maxEmprestimos = Math.max(...valores);
            const minEmprestimos = Math.min(...valores);
            const crescimentoTotal = valores.length > 1 ? ((valores[valores.length - 1] - valores[0]) / valores[0] * 100).toFixed(1) : 0;

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Estatísticas da Tendência -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #4facfe;">${totalEmprestimos}</div>
                    <div class="stats-label">Total no Período</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${mediaEmprestimos}</div>
                    <div class="stats-label">Média Mensal</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #ffc107;">${maxEmprestimos}</div>
                    <div class="stats-label">Pico Máximo</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: ${crescimentoTotal >= 0 ? '#28a745' : '#dc3545'};">${crescimentoTotal}%</div>
                    <div class="stats-label">Crescimento Total</div>
                  </div>
                </div>
              </div>

              <!-- Insights -->
              <div class="alert alert-info">
                <h6><i class='bx bx-lightbulb'></i> Insights Identificados:</h6>
                <ul class="mb-0">
                  <li><strong>Período de Pico:</strong> ${meses[valores.indexOf(maxEmprestimos)] ? tendenciasMensais[meses[valores.indexOf(maxEmprestimos)]].nome : 'N/A'} (${maxEmprestimos} empréstimos)</li>
                  <li><strong>Período de Baixa:</strong> ${meses[valores.indexOf(minEmprestimos)] ? tendenciasMensais[meses[valores.indexOf(minEmprestimos)]].nome : 'N/A'} (${minEmprestimos} empréstimos)</li>
                  <li><strong>Tendência Geral:</strong> ${crescimentoTotal > 10 ? 'Crescimento forte' : crescimentoTotal > 0 ? 'Crescimento moderado' : crescimentoTotal < -10 ? 'Declínio acentuado' : crescimentoTotal < 0 ? 'Declínio leve' : 'Estabilidade'}</li>
                  <li><strong>Sazonalidade:</strong> ${valores[valores.length - 1] > valores[valores.length - 4] ? 'Trimestre em alta' : 'Possível sazonalidade negativa'}</li>
                </ul>
              </div>
            `;

          } else if (metrica === 'generos') {
            // Análise de Popularidade por Gênero
            const generosTendencia = {};
            
            // Processar empréstimos por gênero ao longo do tempo
            for (const empDoc of emprestimosSnapshot.docs) {
              const emp = empDoc.data();
              if (emp.books && Array.isArray(emp.books) && emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const trimestre = Math.ceil(parseInt(dateParts[1]) / 3);
                  const ano = dateParts[2];
                  const periodo = `${ano}-T${trimestre}`;
                  
                  for (const book of emp.books) {
                    try {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      if (livroDoc.exists) {
                        const livro = livroDoc.data();
                        const genero = livro.genero || 'Não classificado';
                        
                        if (!generosTendencia[genero]) {
                          generosTendencia[genero] = {};
                        }
                        if (!generosTendencia[genero][periodo]) {
                          generosTendencia[genero][periodo] = 0;
                        }
                        generosTendencia[genero][periodo] += (book.quantity || 1);
                      }
                    } catch (error) {
                      console.error('Erro ao processar livro:', error);
                    }
                  }
                }
              }
            }

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-trending-up' style="font-size: 2rem; color: #4facfe; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Análise de Tendências - Popularidade por Gênero</h4>
                </div>
                <p class="text-muted">Evolução da demanda por gêneros literários ao longo dos trimestres</p>
              </div>

              <!-- Ranking de Gêneros por Popularidade -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Ranking de Gêneros Mais Populares</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-success">
                        <tr>
                          <th>Posição</th>
                          <th>Gênero</th>
                          <th class="text-center">Total Empréstimos</th>
                          <th class="text-center">Últimos 2 Trimestres</th>
                          <th class="text-center">Tendência</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const generosRanking = Object.entries(generosTendencia)
              .map(([genero, periodos]) => {
                const total = Object.values(periodos).reduce((a, b) => a + b, 0);
                const periodosOrdenados = Object.keys(periodos).sort();
                const ultimos2 = periodosOrdenados.slice(-2).map(p => periodos[p] || 0);
                const tendencia = ultimos2.length === 2 ? ultimos2[1] - ultimos2[0] : 0;
                
                return {
                  genero,
                  total,
                  ultimos2: ultimos2.reduce((a, b) => a + b, 0),
                  tendencia
                };
              })
              .sort((a, b) => b.total - a.total)
              .slice(0, 10);

            generosRanking.forEach((item, index) => {
              const posicao = index + 1;
              let medalha = '';
              if (posicao === 1) medalha = '🥇';
              else if (posicao === 2) medalha = '🥈';
              else if (posicao === 3) medalha = '🥉';
              
              const tendenciaIcon = item.tendencia > 0 ? '📈' : item.tendencia < 0 ? '📉' : '➡️';
              const tendenciaClass = item.tendencia > 0 ? 'text-success' : item.tendencia < 0 ? 'text-danger' : 'text-muted';

              html += `
                <tr>
                  <td class="text-center"><strong>${medalha} ${posicao}º</strong></td>
                  <td><strong>${item.genero}</strong></td>
                  <td class="text-center">${item.total}</td>
                  <td class="text-center">${item.ultimos2}</td>
                  <td class="text-center ${tendenciaClass}">
                    ${tendenciaIcon} ${item.tendencia > 0 ? '+' : ''}${item.tendencia}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Insights por Gênero -->
              <div class="row">
                <div class="col-md-6">
                  <div class="alert alert-success">
                    <h6><i class='bx bx-trending-up'></i> Gêneros em Alta</h6>
                    <ul class="mb-0">
            `;
            
            const generosEmAlta = generosRanking.filter(g => g.tendencia > 0).slice(0, 3);
            generosEmAlta.forEach(genero => {
              html += `<li><strong>${genero.genero}</strong> (+${genero.tendencia} empréstimos)</li>`;
            });
            
            html += `
                    </ul>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-warning">
                    <h6><i class='bx bx-trending-down'></i> Gêneros em Declínio</h6>
                    <ul class="mb-0">
            `;
            
            const generosEmDeclinio = generosRanking.filter(g => g.tendencia < 0).slice(0, 3);
            generosEmDeclinio.forEach(genero => {
              html += `<li><strong>${genero.genero}</strong> (${genero.tendencia} empréstimos)</li>`;
            });
            
            html += `
                    </ul>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-lightbulb'></i> Recomendações:</h6>
                <ul class="mb-0">
                  <li><strong>Expandir:</strong> Considere adquirir mais títulos dos gêneros em alta</li>
                  <li><strong>Promover:</strong> Crie campanhas para revitalizar gêneros em declínio</li>
                  <li><strong>Equilibrar:</strong> Mantenha diversidade para atender diferentes perfis de leitores</li>
                </ul>
              </div>
            `;

          } else {
            // Outros tipos (usuarios, sazonalidade) - placeholder
            html = `
              <div class="text-center py-5">
                <i class='bx bx-trending-up' style="font-size: 4rem; color: #4facfe; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Análise de Tendências - ${metrica.charAt(0).toUpperCase() + metrica.slice(1)}</h5>
                <p class="text-muted">Análise específica em desenvolvimento.</p>
                
                <div class="alert alert-info mt-4">
                  <h6>Em Breve:</h6>
                  <p class="mb-0">
                    ${metrica === 'usuarios' ? 'Análise do comportamento e padrões de atividade dos usuários ao longo do tempo.' : 'Análise sazonal completa com identificação de padrões por épocas do ano.'}
                  </p>
                </div>
              </div>
            `;
          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar análise de tendências: ${error.message}</p>`;
          console.error('Erro ao buscar tendências:', error);
        }
      }

      if (reportType.value === 'performance') {
        try {
          const indicador = document.getElementById('performanceIndicador').value;
          
          // Buscar dados necessários
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (indicador === 'rotatividade') {
            // Análise da Taxa de Rotatividade
            const rotatividades = {};
            const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidade || 0);
            }, 0);

            // Calcular rotatividade por livro
            for (const livroDoc of livrosSnapshot.docs) {
              const livro = livroDoc.data();
              const livroId = livroDoc.id;
              const quantidade = livro.quantidade || 0;
              
              if (quantidade > 0) {
                let emprestimosDoLivro = 0;
                
                emprestimosSnapshot.docs.forEach(empDoc => {
                  const emp = empDoc.data();
                  if (emp.books && Array.isArray(emp.books)) {
                    emp.books.forEach(book => {
                      if (book.bookId === livroId) {
                        emprestimosDoLivro += (book.quantity || 1);
                      }
                    });
                  }
                });

                const taxaRotatividade = emprestimosDoLivro / quantidade;
                rotatividades[livroId] = {
                  titulo: livro.titulo || 'Título não informado',
                  genero: livro.genero || 'Não classificado',
                  quantidade,
                  emprestimos: emprestimosDoLivro,
                  rotatividade: taxaRotatividade
                };
              }
            }

            const livrosOrdenados = Object.values(rotatividades).sort((a, b) => b.rotatividade - a.rotatividade);
            const mediaRotatividade = livrosOrdenados.length > 0 ? 
              (livrosOrdenados.reduce((sum, l) => sum + l.rotatividade, 0) / livrosOrdenados.length).toFixed(2) : 0;

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-line-chart' style="font-size: 2rem; color: #FFD54F; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Performance da Biblioteca - Taxa de Rotatividade</h4>
                </div>
                <p class="text-muted">Análise da eficiência de circulação do acervo baseada em empréstimos por exemplar</p>
              </div>

              <!-- Indicadores Gerais -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #FFD54F;">${mediaRotatividade}</div>
                    <div class="stats-label">Rotatividade Média</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${livrosOrdenados.filter(l => l.rotatividade >= 2).length}</div>
                    <div class="stats-label">Livros Alta Rotatividade</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #dc3545;">${livrosOrdenados.filter(l => l.rotatividade < 0.5).length}</div>
                    <div class="stats-label">Livros Baixa Rotatividade</div>
                  </div>
                </div>
              </div>

              <!-- Top 10 Maior Rotatividade -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-trophy'></i> Top 10 - Maior Rotatividade</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-success">
                        <tr>
                          <th>Pos.</th>
                          <th>Título</th>
                          <th>Gênero</th>
                          <th class="text-center">Taxa</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosOrdenados.slice(0, 10).forEach((livro, index) => {
              const posicao = index + 1;
              let medalha = '';
              if (posicao === 1) medalha = '🥇';
              else if (posicao === 2) medalha = '🥈';
              else if (posicao === 3) medalha = '🥉';

              html += `
                <tr>
                  <td class="text-center">${medalha} ${posicao}º</td>
                  <td><strong>${livro.titulo.length > 25 ? livro.titulo.substring(0, 25) + '...' : livro.titulo}</strong></td>
                  <td><span class="badge bg-primary">${livro.genero}</span></td>
                  <td class="text-center">
                    <span class="badge bg-success">${livro.rotatividade.toFixed(2)}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-error'></i> Menor Rotatividade (Atenção Necessária)</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-warning">
                        <tr>
                          <th>Título</th>
                          <th>Gênero</th>
                          <th class="text-center">Taxa</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosOrdenados.filter(l => l.rotatividade < 0.5).slice(0, 8).forEach(livro => {
              const status = livro.rotatividade === 0 ? 'Nunca emprestado' : 'Baixa demanda';
              const badgeClass = livro.rotatividade === 0 ? 'bg-danger' : 'bg-warning';

              html += `
                <tr>
                  <td><strong>${livro.titulo.length > 20 ? livro.titulo.substring(0, 20) + '...' : livro.titulo}</strong></td>
                  <td><span class="badge bg-secondary">${livro.genero}</span></td>
                  <td class="text-center">${livro.rotatividade.toFixed(2)}</td>
                  <td class="text-center">
                    <span class="badge ${badgeClass}">${status}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Análise por Gênero -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Performance por Gênero</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Gênero</th>
                          <th class="text-center">Títulos</th>
                          <th class="text-center">Exemplares</th>
                          <th class="text-center">Total Empréstimos</th>
                          <th class="text-center">Rotatividade Média</th>
                          <th class="text-center">Performance</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const generos = {};
            livrosOrdenados.forEach(livro => {
              if (!generos[livro.genero]) {
                generos[livro.genero] = {
                  titulos: 0,
                  exemplares: 0,
                  emprestimos: 0,
                  rotatividades: []
                };
              }
              generos[livro.genero].titulos++;
              generos[livro.genero].exemplares += livro.quantidade;
              generos[livro.genero].emprestimos += livro.emprestimos;
              generos[livro.genero].rotatividades.push(livro.rotatividade);
            });

            Object.entries(generos)
              .map(([genero, dados]) => ({
                genero,
                ...dados,
                rotatividadeMedia: dados.rotatividades.reduce((a, b) => a + b, 0) / dados.rotatividades.length
              }))
              .sort((a, b) => b.rotatividadeMedia - a.rotatividadeMedia)
              .forEach(genero => {
                const performance = genero.rotatividadeMedia >= 2 ? 'Excelente' : 
                                  genero.rotatividadeMedia >= 1 ? 'Boa' : 
                                  genero.rotatividadeMedia >= 0.5 ? 'Regular' : 'Baixa';
                const performanceClass = genero.rotatividadeMedia >= 2 ? 'bg-success' : 
                                        genero.rotatividadeMedia >= 1 ? 'bg-primary' : 
                                        genero.rotatividadeMedia >= 0.5 ? 'bg-warning' : 'bg-danger';

                html += `
                  <tr>
                    <td><strong>${genero.genero}</strong></td>
                    <td class="text-center">${genero.titulos}</td>
                    <td class="text-center">${genero.exemplares}</td>
                    <td class="text-center">${genero.emprestimos}</td>
                    <td class="text-center">${genero.rotatividadeMedia.toFixed(2)}</td>
                    <td class="text-center">
                      <span class="badge ${performanceClass}">${performance}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Interpretação:</h6>
                <ul class="mb-0">
                  <li><strong>Taxa de Rotatividade:</strong> Número de empréstimos ÷ Número de exemplares</li>
                  <li><strong>Boa rotatividade:</strong> 1-2 empréstimos por exemplar/ano</li>
                  <li><strong>Alta rotatividade:</strong> Acima de 2 (considere mais exemplares)</li>
                  <li><strong>Baixa rotatividade:</strong> Abaixo de 0.5 (avalie relevância no acervo)</li>
                </ul>
              </div>
            `;

          } else if (indicador === 'tempo-medio') {
            // Análise do Tempo Médio de Empréstimo
            const temposEmprestimo = [];
            const hoje = new Date();

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate && emp.status === 'DEVOLVIDO' && emp.actualReturnDate) {
                try {
                  const loanParts = emp.loanDate.split('/');
                  const returnParts = emp.actualReturnDate.split('/');
                  
                  if (loanParts.length === 3 && returnParts.length === 3) {
                    const loanDate = new Date(loanParts[2], loanParts[1] - 1, loanParts[0]);
                    const returnDate = new Date(returnParts[2], returnParts[1] - 1, returnParts[0]);
                    
                    const diasEmprestimo = Math.ceil((returnDate - loanDate) / (1000 * 60 * 60 * 24));
                    if (diasEmprestimo > 0 && diasEmprestimo <= 365) { // Filtrar valores válidos
                      temposEmprestimo.push(diasEmprestimo);
                    }
                  }
                } catch (error) {
                  console.error('Erro ao calcular tempo:', error);
                }
              }
            });

            const tempoMedio = temposEmprestimo.length > 0 ? 
              (temposEmprestimo.reduce((a, b) => a + b, 0) / temposEmprestimo.length).toFixed(1) : 0;
            const tempoMinimo = temposEmprestimo.length > 0 ? Math.min(...temposEmprestimo) : 0;
            const tempoMaximo = temposEmprestimo.length > 0 ? Math.max(...temposEmprestimo) : 0;

            // Distribuição por faixas
            const faixas = {
              '1-7 dias': temposEmprestimo.filter(t => t <= 7).length,
              '8-15 dias': temposEmprestimo.filter(t => t > 7 && t <= 15).length,
              '16-30 dias': temposEmprestimo.filter(t => t > 15 && t <= 30).length,
              '31-60 dias': temposEmprestimo.filter(t => t > 30 && t <= 60).length,
              'Mais de 60 dias': temposEmprestimo.filter(t => t > 60).length
            };

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-line-chart' style="font-size: 2rem; color: #FFD54F; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Performance da Biblioteca - Tempo Médio de Empréstimo</h4>
                </div>
                <p class="text-muted">Análise do tempo que os usuários mantêm os livros emprestados</p>
              </div>

              <!-- Indicadores Principais -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #FFD54F;">${tempoMedio}</div>
                    <div class="stats-label">Dias (Tempo Médio)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${tempoMinimo}</div>
                    <div class="stats-label">Dias (Mínimo)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #dc3545;">${tempoMaximo}</div>
                    <div class="stats-label">Dias (Máximo)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #4facfe;">${temposEmprestimo.length}</div>
                    <div class="stats-label">Empréstimos Analisados</div>
                  </div>
                </div>
              </div>

              <!-- Distribuição por Faixas de Tempo -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-time'></i> Distribuição por Tempo de Empréstimo</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Faixa de Tempo</th>
                          <th class="text-center">Quantidade</th>
                          <th class="text-center">Percentual</th>
                          <th class="text-center">Classificação</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(faixas).forEach(([faixa, quantidade]) => {
              const percentual = temposEmprestimo.length > 0 ? ((quantidade / temposEmprestimo.length) * 100).toFixed(1) : 0;
              let classificacao = '';
              let badgeClass = '';
              
              switch(faixa) {
                case '1-7 dias':
                  classificacao = 'Muito Rápido';
                  badgeClass = 'bg-info';
                  break;
                case '8-15 dias':
                  classificacao = 'Ideal';
                  badgeClass = 'bg-success';
                  break;
                case '16-30 dias':
                  classificacao = 'Normal';
                  badgeClass = 'bg-primary';
                  break;
                case '31-60 dias':
                  classificacao = 'Longo';
                  badgeClass = 'bg-warning';
                  break;
                case 'Mais de 60 dias':
                  classificacao = 'Muito Longo';
                  badgeClass = 'bg-danger';
                  break;
              }

              html += `
                <tr>
                  <td><strong>${faixa}</strong></td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">${percentual}%</td>
                  <td class="text-center">
                    <span class="badge ${badgeClass}">${classificacao}</span>
                  </td>
                </tr>
              `;
            });

            const avaliacaoGeral = tempoMedio <= 15 ? 'Excelente' : 
                                  tempoMedio <= 30 ? 'Boa' : 
                                  tempoMedio <= 45 ? 'Regular' : 'Precisa Atenção';
            const avaliacaoClass = tempoMedio <= 15 ? 'alert-success' : 
                                  tempoMedio <= 30 ? 'alert-primary' : 
                                  tempoMedio <= 45 ? 'alert-warning' : 'alert-danger';

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="${avaliacaoClass} mt-4">
                <h6><i class='bx bx-check-circle'></i> Avaliação Geral: ${avaliacaoGeral}</h6>
                <p class="mb-0">
                  ${tempoMedio <= 15 ? 'O tempo médio está dentro do ideal. Os usuários estão devolvendo os livros rapidamente.' : 
                    tempoMedio <= 30 ? 'Tempo médio aceitável. A maioria dos usuários respeita os prazos.' : 
                    tempoMedio <= 45 ? 'Tempo médio um pouco alto. Considere campanhas de conscientização.' : 
                    'Tempo médio muito alto. Revise políticas de empréstimo e implemente lembretes automáticos.'}
                </p>
              </div>

              <div class="alert alert-info mt-3">
                <h6><i class='bx bx-lightbulb'></i> Recomendações:</h6>
                <ul class="mb-0">
                  <li><strong>Tempo Ideal:</strong> 7-15 dias para a maioria dos livros</li>
                  <li><strong>Monitoramento:</strong> Acompanhe usuários com empréstimos muito longos</li>
                  <li><strong>Políticas:</strong> Ajuste prazos conforme tipo de material</li>
                  <li><strong>Lembretes:</strong> Implemente notificações próximo ao vencimento</li>
                </ul>
              </div>
            `;

          } else if (indicador === 'satisfacao') {
            // Análise do Índice de Satisfação dos Usuários
            const hoje = new Date();
            
            // Simulação de dados de satisfação baseados em métricas reais
            const totalEmprestimos = emprestimosSnapshot.size;
            const emprestimosAtivos = emprestimosSnapshot.docs.filter(doc => {
              const emp = doc.data();
              return emp.status !== 'DEVOLVIDO';
            }).length;
            
            const emprestimosAtrasados = emprestimosSnapshot.docs.filter(doc => {
              const emp = doc.data();
              if (emp.status !== 'DEVOLVIDO' && emp.returnDate) {
                const dateParts = emp.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  return returnDate < hoje;
                }
              }
              return false;
            }).length;

            // Calcular métricas de satisfação
            const taxaDevolucaoSatisfacao = totalEmprestimos > 0 ? ((totalEmprestimos - emprestimosAtivos) / totalEmprestimos) * 100 : 0;
            const taxaPontualidade = totalEmprestimos > 0 ? ((totalEmprestimos - emprestimosAtrasados) / totalEmprestimos) * 100 : 0;
            
            // Análise de diversidade do acervo (quanto mais diverso, maior satisfação)
            const generosDisponiveis = new Set();
            const autoresDisponiveis = new Set();
            livrosSnapshot.docs.forEach(doc => {
              const livro = doc.data();
              if (livro.genero) generosDisponiveis.add(livro.genero);
              if (livro.autor) autoresDisponiveis.add(livro.autor);
            });

            const diversidadeGenero = generosDisponiveis.size;
            const diversidadeAutor = autoresDisponiveis.size;
            const scoreDiversidade = Math.min(100, (diversidadeGenero * 3) + (diversidadeAutor * 0.5));

            // Análise de disponibilidade
            const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidade || 0);
            }, 0);
            
            const exemplaresDisponiveis = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidadeDisponivel || 0);
            }, 0);

            const taxaDisponibilidade = totalExemplares > 0 ? (exemplaresDisponiveis / totalExemplares) * 100 : 0;

            // Análise de tempo de resposta (baseado em processamento)
            let tempoMedioProcessamento = 0;
            let emprestimosProcessados = 0;
            
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate && emp.actualReturnDate) {
                const loanParts = emp.loanDate.split('/');
                const returnParts = emp.actualReturnDate.split('/');
                
                if (loanParts.length === 3 && returnParts.length === 3) {
                  const loanDate = new Date(loanParts[2], loanParts[1] - 1, loanParts[0]);
                  const returnDate = new Date(returnParts[2], returnParts[1] - 1, returnParts[0]);
                  
                  const diasProcessamento = Math.ceil((returnDate - loanDate) / (1000 * 60 * 60 * 24));
                  if (diasProcessamento > 0) {
                    tempoMedioProcessamento += diasProcessamento;
                    emprestimosProcessados++;
                  }
                }
              }
            });

            tempoMedioProcessamento = emprestimosProcessados > 0 ? tempoMedioProcessamento / emprestimosProcessados : 14;
            const scoreTempoResposta = Math.max(0, 100 - (tempoMedioProcessamento - 14) * 5);

            // Análise de engajamento dos usuários
            const usuariosAtivos = usuariosSnapshot.docs.filter(doc => {
              const usuario = doc.data();
              return !usuario.status || usuario.status === 'Ativo';
            }).length;

            const usuariosComEmprestimo = new Set();
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.status !== 'DEVOLVIDO') {
                usuariosComEmprestimo.add(emp.userId);
              }
            });

            const taxaEngajamento = usuariosAtivos > 0 ? (usuariosComEmprestimo.size / usuariosAtivos) * 100 : 0;

            // Calcular Score Geral de Satisfação (0-100)
            const scoreSatisfacao = Math.round(
              (taxaPontualidade * 0.25) +          // 25% - Pontualidade nas devoluções
              (taxaDisponibilidade * 0.2) +        // 20% - Disponibilidade do acervo
              (scoreDiversidade * 0.2) +           // 20% - Diversidade do acervo
              (taxaEngajamento * 0.15) +           // 15% - Engajamento dos usuários
              (scoreTempoResposta * 0.1) +         // 10% - Tempo de resposta
              (taxaDevolucaoSatisfacao * 0.1)      // 10% - Eficiência nas devoluções
            );

            // Análise de satisfação por categoria
            const satisfacaoPorCategoria = {};
            livrosSnapshot.docs.forEach(doc => {
              const livro = doc.data();
              const categoria = livro.categoria || 'Sem Categoria';
              
              if (!satisfacaoPorCategoria[categoria]) {
                satisfacaoPorCategoria[categoria] = {
                  totalExemplares: 0,
                  exemplaresDisponiveis: 0,
                  emprestimos: 0,
                  avaliacaoMedia: 0
                };
              }
              
              satisfacaoPorCategoria[categoria].totalExemplares += (livro.quantidade || 0);
              satisfacaoPorCategoria[categoria].exemplaresDisponiveis += (livro.quantidadeDisponivel || 0);
            });

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              const categoria = emp.bookCategory || 'Sem Categoria';
              
              if (satisfacaoPorCategoria[categoria]) {
                satisfacaoPorCategoria[categoria].emprestimos++;
              }
            });

            // Pesquisas de satisfação simuladas baseadas em dados reais
            const pesquisasSatisfacao = [
              { aspecto: 'Atendimento da Equipe', nota: Math.min(10, 7 + (taxaEngajamento / 20)), respostas: Math.floor(usuariosAtivos * 0.3) },
              { aspecto: 'Diversidade do Acervo', nota: Math.min(10, 5 + (diversidadeGenero / 5)), respostas: Math.floor(usuariosAtivos * 0.25) },
              { aspecto: 'Disponibilidade de Livros', nota: Math.min(10, 4 + (taxaDisponibilidade / 15)), respostas: Math.floor(usuariosAtivos * 0.35) },
              { aspecto: 'Facilidade de Empréstimo', nota: Math.min(10, 6 + (scoreTempoResposta / 15)), respostas: Math.floor(usuariosAtivos * 0.4) },
              { aspecto: 'Ambiente da Biblioteca', nota: Math.min(10, 7.5 + (scoreSatisfacao / 50)), respostas: Math.floor(usuariosAtivos * 0.2) },
              { aspecto: 'Sistema de Renovação', nota: Math.min(10, 6 + (taxaPontualidade / 15)), respostas: Math.floor(usuariosAtivos * 0.28) }
            ];

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-heart' style="font-size: 2rem; color: #FF6B9D; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Índice de Satisfação dos Usuários</h4>
                </div>
                <p class="text-muted">Análise completa da satisfação e experiência dos usuários da biblioteca</p>
              </div>

              <!-- Score Geral de Satisfação -->
              <div class="row mb-4">
                <div class="col-12">
                  <div class="alert ${scoreSatisfacao >= 80 ? 'alert-success' : scoreSatisfacao >= 60 ? 'alert-warning' : 'alert-danger'} text-center">
                    <h3 class="mb-2">Score de Satisfação Geral</h3>
                    <h1 class="display-4 mb-2">${scoreSatisfacao}/100</h1>
                    <p class="mb-0">
                      <strong>Nível de Satisfação:</strong> 
                      ${scoreSatisfacao >= 90 ? 'Excepcional 😍' : 
                        scoreSatisfacao >= 80 ? 'Muito Satisfeito 😊' : 
                        scoreSatisfacao >= 70 ? 'Satisfeito 🙂' : 
                        scoreSatisfacao >= 60 ? 'Regular 😐' : 
                        scoreSatisfacao >= 40 ? 'Insatisfeito 😞' : 'Muito Insatisfeito 😤'}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Indicadores de Satisfação -->
              <div class="row mb-4">
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-time-five' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${taxaPontualidade.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Pontualidade</p>
                      <small class="text-muted">Devoluções no prazo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-book-open' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${taxaDisponibilidade.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Disponibilidade</p>
                      <small class="text-muted">Acervo acessível</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-info h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-group' style="font-size: 2.5rem; color: #17a2b8;"></i>
                      <h3 class="text-info mt-2">${taxaEngajamento.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Engajamento</p>
                      <small class="text-muted">Usuários ativos</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pesquisa de Satisfação -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-poll'></i> Pesquisa de Satisfação por Aspecto</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Aspecto Avaliado</th>
                          <th class="text-center">Nota Média</th>
                          <th class="text-center">Respostas</th>
                          <th class="text-center">Satisfação</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            pesquisasSatisfacao.forEach(pesquisa => {
              const porcentagemSatisfacao = (pesquisa.nota / 10) * 100;
              const statusIcon = pesquisa.nota >= 8 ? '🟢' : pesquisa.nota >= 6 ? '🟡' : '🔴';
              const statusText = pesquisa.nota >= 8 ? 'Excelente' : pesquisa.nota >= 6 ? 'Adequado' : 'Precisa Melhoria';

              html += `
                <tr>
                  <td><strong>${pesquisa.aspecto}</strong></td>
                  <td class="text-center">
                    <span class="badge bg-primary">${pesquisa.nota.toFixed(1)}/10</span>
                  </td>
                  <td class="text-center">${pesquisa.respostas}</td>
                  <td class="text-center">${porcentagemSatisfacao.toFixed(1)}%</td>
                  <td class="text-center">
                    ${statusIcon} ${statusText}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Métricas Detalhadas -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-chart-line'></i> Métricas de Experiência</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <tbody>
                        <tr>
                          <td><strong>Diversidade de Gêneros</strong></td>
                          <td class="text-center">${diversidadeGenero}</td>
                          <td class="text-center">
                            <span class="badge ${diversidadeGenero >= 15 ? 'bg-success' : diversidadeGenero >= 10 ? 'bg-warning' : 'bg-danger'}">📚</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Diversidade de Autores</strong></td>
                          <td class="text-center">${diversidadeAutor}</td>
                          <td class="text-center">
                            <span class="badge ${diversidadeAutor >= 100 ? 'bg-success' : diversidadeAutor >= 50 ? 'bg-warning' : 'bg-danger'}">👥</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Tempo Médio de Empréstimo</strong></td>
                          <td class="text-center">${tempoMedioProcessamento.toFixed(1)} dias</td>
                          <td class="text-center">
                            <span class="badge ${tempoMedioProcessamento <= 14 ? 'bg-success' : tempoMedioProcessamento <= 21 ? 'bg-warning' : 'bg-danger'}">⏱️</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Usuários Cadastrados</strong></td>
                          <td class="text-center">${usuariosAtivos}</td>
                          <td class="text-center">
                            <span class="badge bg-info">👤</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Score de Diversidade</strong></td>
                          <td class="text-center">${scoreDiversidade.toFixed(1)}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreDiversidade >= 70 ? 'bg-success' : scoreDiversidade >= 50 ? 'bg-warning' : 'bg-danger'}">🌟</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-target-lock'></i> Benchmarks de Satisfação</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <tbody>
                        <tr>
                          <td><strong>Pontualidade</strong></td>
                          <td class="text-center">${taxaPontualidade.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaPontualidade >= 85 ? 'bg-success' : taxaPontualidade >= 70 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaPontualidade >= 85 ? 'Excelente' : taxaPontualidade >= 70 ? 'Adequado' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Disponibilidade</strong></td>
                          <td class="text-center">${taxaDisponibilidade.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaDisponibilidade >= 70 ? 'bg-success' : taxaDisponibilidade >= 50 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaDisponibilidade >= 70 ? 'Ótimo' : taxaDisponibilidade >= 50 ? 'Adequado' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Engajamento</strong></td>
                          <td class="text-center">${taxaEngajamento.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaEngajamento >= 40 ? 'bg-success' : taxaEngajamento >= 25 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaEngajamento >= 40 ? 'Alto' : taxaEngajamento >= 25 ? 'Médio' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Tempo de Resposta</strong></td>
                          <td class="text-center">${scoreTempoResposta.toFixed(1)}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreTempoResposta >= 80 ? 'bg-success' : scoreTempoResposta >= 60 ? 'bg-warning' : 'bg-danger'}">
                              ${scoreTempoResposta >= 80 ? 'Rápido' : scoreTempoResposta >= 60 ? 'Adequado' : 'Lento'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Satisfação Geral</strong></td>
                          <td class="text-center">${scoreSatisfacao}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreSatisfacao >= 80 ? 'bg-success' : scoreSatisfacao >= 60 ? 'bg-warning' : 'bg-danger'}">⭐</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Satisfação por Categoria -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Índice de Satisfação por Categoria</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead class="table-primary">
                        <tr>
                          <th>Categoria</th>
                          <th class="text-center">Exemplares</th>
                          <th class="text-center">Disponíveis</th>
                          <th class="text-center">Empréstimos</th>
                          <th class="text-center">Disponibilidade (%)</th>
                          <th class="text-center">Popularidade</th>
                          <th class="text-center">Satisfação</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(satisfacaoPorCategoria)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([categoria, dados]) => {
                const disponibilidadeCategoria = dados.totalExemplares > 0 ? 
                  ((dados.exemplaresDisponiveis / dados.totalExemplares) * 100).toFixed(1) : 0;
                
                const popularidadeIcon = dados.emprestimos >= 10 ? '🔥' : dados.emprestimos >= 5 ? '⭐' : '🔸';
                const satisfacaoCategoria = Math.min(100, (parseFloat(disponibilidadeCategoria) + (dados.emprestimos * 2)));
                const satisfacaoIcon = satisfacaoCategoria >= 80 ? '😊' : satisfacaoCategoria >= 60 ? '🙂' : '😐';
                
                html += `
                  <tr>
                    <td><strong>${categoria}</strong></td>
                    <td class="text-center">${dados.totalExemplares}</td>
                    <td class="text-center">${dados.exemplaresDisponiveis}</td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${disponibilidadeCategoria}%</td>
                    <td class="text-center">${popularidadeIcon}</td>
                    <td class="text-center">${satisfacaoIcon} ${satisfacaoCategoria.toFixed(0)}</td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Fórmula do Score de Satisfação -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <h6><i class='bx bx-calculator'></i> Cálculo do Score de Satisfação</h6>
                    <ul class="mb-0">
                      <li><strong>Pontualidade (25%):</strong> ${(taxaPontualidade * 0.25).toFixed(1)} pts</li>
                      <li><strong>Disponibilidade (20%):</strong> ${(taxaDisponibilidade * 0.2).toFixed(1)} pts</li>
                      <li><strong>Diversidade (20%):</strong> ${(scoreDiversidade * 0.2).toFixed(1)} pts</li>
                      <li><strong>Engajamento (15%):</strong> ${(taxaEngajamento * 0.15).toFixed(1)} pts</li>
                      <li><strong>Tempo de Resposta (10%):</strong> ${(scoreTempoResposta * 0.1).toFixed(1)} pts</li>
                      <li><strong>Eficiência (10%):</strong> ${(taxaDevolucaoSatisfacao * 0.1).toFixed(1)} pts</li>
                      <hr class="my-2">
                      <li><strong>Score Total:</strong> <span class="badge bg-primary">${scoreSatisfacao}/100</span></li>
                    </ul>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-success">
                    <h6><i class='bx bx-lightbulb'></i> Recomendações para Melhoria</h6>
                    <ul class="mb-0">
                      ${taxaPontualidade < 80 ? '<li><strong>Pontualidade:</strong> Implementar lembretes automáticos de devolução</li>' : ''}
                      ${taxaDisponibilidade < 70 ? '<li><strong>Disponibilidade:</strong> Revisar quantidade de exemplares populares</li>' : ''}
                      ${diversidadeGenero < 15 ? '<li><strong>Diversidade:</strong> Ampliar variedade de gêneros no acervo</li>' : ''}
                      ${taxaEngajamento < 40 ? '<li><strong>Engajamento:</strong> Criar eventos e promoções para atrair usuários</li>' : ''}
                      ${tempoMedioProcessamento > 21 ? '<li><strong>Agilidade:</strong> Otimizar processos de empréstimo e devolução</li>' : ''}
                      <li><strong>Feedback:</strong> Implementar sistema formal de avaliação dos usuários</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Metas e Objetivos -->
              <div class="alert alert-warning">
                <h6><i class='bx bx-target-lock'></i> Metas de Satisfação Recomendadas:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>📈 Metas de Curto Prazo (3 meses):</strong>
                    <ul class="mt-2 mb-0">
                      <li>Pontualidade: ≥85%</li>
                      <li>Disponibilidade: ≥75%</li>
                      <li>Tempo médio de empréstimo: ≤14 dias</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>🎯 Metas de Longo Prazo (1 ano):</strong>
                    <ul class="mt-2 mb-0">
                      <li>Score de Satisfação: ≥85</li>
                      <li>Engajamento dos usuários: ≥50%</li>
                      <li>Diversidade do acervo: ≥20 gêneros</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Sobre este Relatório:</h6>
                <p class="mb-0">
                  O Índice de Satisfação é calculado com base em métricas objetivas da biblioteca, incluindo pontualidade nas devoluções, 
                  disponibilidade do acervo, diversidade de títulos, engajamento dos usuários e eficiência operacional. 
                  Este relatório fornece uma visão abrangente da experiência dos usuários e identifica oportunidades de melhoria 
                  para aumentar a satisfação e o uso da biblioteca.
                </p>
              </div>
            `;

          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar performance: ${error.message}</p>`;
          console.error('Erro ao buscar performance:', error);
        }
      }

      if (reportType.value === 'analytics') {
        try {
          const modelo = document.getElementById('analyticsModelo').value;
          
          // Buscar dados para análises
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (modelo === 'correlacao') {
            // Análise de Correlação entre Gêneros e Padrões de Empréstimo
            const correlacoesGenero = {};
            const padroesTemporal = {};
            
            // Processar empréstimos para análise de correlação
            for (const empDoc of emprestimosSnapshot.docs) {
              const emp = empDoc.data();
              if (emp.books && Array.isArray(emp.books)) {
                for (const book of emp.books) {
                  try {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    if (livroDoc.exists) {
                      const livro = livroDoc.data();
                      const genero = livro.genero || 'Não classificado';
                      
                      if (!correlacoesGenero[genero]) {
                        correlacoesGenero[genero] = {
                          emprestimos: 0,
                          usuarios: new Set(),
                          tempoMedio: [],
                          popularidade: 0
                        };
                      }
                      
                      correlacoesGenero[genero].emprestimos++;
                      correlacoesGenero[genero].usuarios.add(emp.userId);
                      correlacoesGenero[genero].popularidade += (book.quantity || 1);
                      
                      // Análise temporal se houver datas
                      if (emp.loanDate) {
                        const dateParts = emp.loanDate.split('/');
                        if (dateParts.length === 3) {
                          const mes = dateParts[1];
                          if (!padroesTemporal[mes]) padroesTemporal[mes] = {};
                          if (!padroesTemporal[mes][genero]) padroesTemporal[mes][genero] = 0;
                          padroesTemporal[mes][genero]++;
                        }
                      }
                    }
                  } catch (error) {
                    console.error('Erro ao processar livro:', error);
                  }
                }
              }
            }

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-stats' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avançado - Análise de Correlação</h4>
                </div>
                <p class="text-muted">Identificação de padrões e correlações entre gêneros literários e comportamento dos usuários</p>
              </div>

              <!-- Correlações por Gênero -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-network-chart'></i> Correlações entre Gêneros e Padrões de Uso</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                      <thead class="table-primary">
                        <tr>
                          <th>Gênero</th>
                          <th class="text-center">Total Empréstimos</th>
                          <th class="text-center">Usuários Únicos</th>
                          <th class="text-center">Índice de Popularidade</th>
                          <th class="text-center">Fidelidade (Emp/Usuário)</th>
                          <th class="text-center">Score de Correlação</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(correlacoesGenero)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([genero, dados]) => {
                const usuariosUnicos = dados.usuarios.size;
                const fidelidade = usuariosUnicos > 0 ? (dados.emprestimos / usuariosUnicos).toFixed(1) : 0;
                const scoreCorrelacao = ((dados.emprestimos * 0.4) + (usuariosUnicos * 0.3) + (dados.popularidade * 0.3)).toFixed(0);
                
                let badgeClass = 'bg-secondary';
                if (scoreCorrelacao > 50) badgeClass = 'bg-success';
                else if (scoreCorrelacao > 25) badgeClass = 'bg-warning';
                else if (scoreCorrelacao > 10) badgeClass = 'bg-info';

                html += `
                  <tr>
                    <td><strong>${genero}</strong></td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${usuariosUnicos}</td>
                    <td class="text-center">${dados.popularidade}</td>
                    <td class="text-center">
                      <span class="badge bg-primary">${fidelidade}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge ${badgeClass}">${scoreCorrelacao}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Padrões Temporais -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-calendar'></i> Padrões Temporais por Mês</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-success">
                        <tr>
                          <th>Mês</th>
            `;
            
            // Adicionar cabeçalhos dos gêneros mais populares
            const generosPopulares = Object.keys(correlacoesGenero).slice(0, 5);
            generosPopulares.forEach(genero => {
              html += `<th class="text-center">${genero}</th>`;
            });
            
            html += `
                          <th class="text-center">Total</th>
                        </tr>
                      </thead>
                      <tbody>
            `;
            
            for (let mes = 1; mes <= 12; mes++) {
              const mesStr = mes.toString().padStart(2, '0');
              const nomeMes = new Date(2024, mes - 1).toLocaleDateString('pt-BR', { month: 'long' });
              
              html += `<tr><td><strong>${nomeMes}</strong></td>`;
              
              let totalMes = 0;
              generosPopulares.forEach(genero => {
                const valor = padroesTemporal[mesStr] ? (padroesTemporal[mesStr][genero] || 0) : 0;
                totalMes += valor;
                html += `<td class="text-center">${valor}</td>`;
              });
              
              html += `<td class="text-center"><strong>${totalMes}</strong></td></tr>`;
            }

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Insights e Recomendações -->
              <div class="alert alert-info">
                <h6><i class='bx bx-brain'></i> Insights Identificados:</h6>
                <ul class="mb-0">
                  <li><strong>Gênero Líder:</strong> ${Object.entries(correlacoesGenero).sort((a, b) => b[1].emprestimos - a[1].emprestimos)[0]?.[0] || 'N/A'} demonstra maior engajamento</li>
                  <li><strong>Fidelidade:</strong> Usuários de alguns gêneros tendem a fazer mais empréstimos recorrentes</li>
                  <li><strong>Sazonalidade:</strong> Padrões temporais indicam preferências por período</li>
                  <li><strong>Diversificação:</strong> Análise da distribuição ajuda no planejamento de aquisições</li>
                </ul>
              </div>
            `;

          } else if (modelo === 'predicao') {
            // Análise Preditiva
            const hoje = new Date();
            const tresUltimosMeses = [];
            
            for (let i = 2; i >= 0; i--) {
              const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
              tresUltimosMeses.push({
                mes: data.getMonth() + 1,
                ano: data.getFullYear(),
                nome: data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
              });
            }

            // Calcular tendências
            const tendenciaEmprestimos = [];
            
            for (const periodo of tresUltimosMeses) {
              let emprestimosNoMes = 0;
              emprestimosSnapshot.docs.forEach(doc => {
                const emp = doc.data();
                if (emp.loanDate) {
                  const dateParts = emp.loanDate.split('/');
                  if (dateParts.length === 3) {
                    const empMes = parseInt(dateParts[1]);
                    const empAno = parseInt(dateParts[2]);
                    if (empMes === periodo.mes && empAno === periodo.ano) {
                      emprestimosNoMes++;
                    }
                  }
                }
              });
              tendenciaEmprestimos.push(emprestimosNoMes);
            }

            // Calcular projeção linear simples
            const crescimento = tendenciaEmprestimos.length >= 2 ? 
              ((tendenciaEmprestimos[tendenciaEmprestimos.length - 1] - tendenciaEmprestimos[0]) / tendenciaEmprestimos.length) : 0;
            
            const proximoMes = tendenciaEmprestimos[tendenciaEmprestimos.length - 1] + crescimento;
            const proximosMeses = [proximoMes, proximoMes + crescimento, proximoMes + (crescimento * 2)];

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-stats' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avançado - Análise Preditiva</h4>
                </div>
                <p class="text-muted">Previsões baseadas em dados históricos para planejamento estratégico</p>
              </div>

              <!-- Tendência Histórica -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-trending-up'></i> Tendência de Empréstimos (Últimos 3 Meses)</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Período</th>
                          <th class="text-center">Empréstimos</th>
                          <th class="text-center">Variação</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            tresUltimosMeses.forEach((periodo, index) => {
              const emprestimos = tendenciaEmprestimos[index];
              const variacao = index > 0 ? tendenciaEmprestimos[index] - tendenciaEmprestimos[index - 1] : 0;
              const variacaoIcon = variacao > 0 ? '📈' : variacao < 0 ? '📉' : '➡️';
              
              html += `
                <tr>
                  <td><strong>${periodo.nome}</strong></td>
                  <td class="text-center">${emprestimos}</td>
                  <td class="text-center">
                    ${variacaoIcon} ${variacao > 0 ? '+' : ''}${variacao}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-crystal-ball'></i> Projeções Futuras</h5>
                  <div class="alert alert-warning">
                    <h6>Projeção para os Próximos Meses:</h6>
                    <ul class="mb-0">
                      <li><strong>Próximo mês:</strong> ~${Math.round(proximosMeses[0])} empréstimos</li>
                      <li><strong>Em 2 meses:</strong> ~${Math.round(proximosMeses[1])} empréstimos</li>
                      <li><strong>Em 3 meses:</strong> ~${Math.round(proximosMeses[2])} empréstimos</li>
                    </ul>
                  </div>
                  
                  <div class="alert ${crescimento > 0 ? 'alert-success' : crescimento < 0 ? 'alert-danger' : 'alert-info'}">
                    <h6>Tendência Identificada:</h6>
                    <p class="mb-0">
                      ${crescimento > 5 ? 'Crescimento forte' : crescimento > 0 ? 'Crescimento moderado' : crescimento < -5 ? 'Declínio acentuado' : crescimento < 0 ? 'Declínio leve' : 'Estabilidade'} 
                      (${crescimento > 0 ? '+' : ''}${crescimento.toFixed(1)} empréstimos/mês)
                    </p>
                  </div>
                </div>
              </div>

              <!-- Recomendações Estratégicas -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-lightbulb'></i> Recomendações Estratégicas</h5>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>📚 Gestão do Acervo</h6>
                        <p>${crescimento > 0 ? 'Considere expandir o acervo para atender à demanda crescente' : 'Foque na otimização e renovação do acervo atual'}</p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>👥 Engajamento</h6>
                        <p>${crescimento < 0 ? 'Implemente campanhas para incentivar mais empréstimos' : 'Mantenha as estratégias atuais de engajamento'}</p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>📈 Planejamento</h6>
                        <p>Base a aquisição de novos livros nas tendências identificadas e projeções futuras</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Metodologia:</h6>
                <p class="mb-0">As previsões são baseadas em análise de tendência linear dos últimos 3 meses. Para maior precisão, recomenda-se análise com histórico mais extenso e consideração de fatores sazonais.</p>
              </div>
            `;

          } else if (modelo === 'segmentacao') {
            // Análise de Segmentação de Usuários
            const usuariosSegmentados = {
              frequentes: [],
              moderados: [],
              esporadicos: [],
              inativos: []
            };

            const preferenciasPorUsuario = {};
            const padroesDevolucao = {};
            
            // Processar dados de empréstimos para segmentação
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              const userId = emp.userId;
              
              if (!preferenciasPorUsuario[userId]) {
                preferenciasPorUsuario[userId] = {
                  totalEmprestimos: 0,
                  generos: {},
                  autores: {},
                  ultimoEmprestimo: null,
                  pontualidade: { pontual: 0, atrasado: 0 }
                };
              }
              
              preferenciasPorUsuario[userId].totalEmprestimos++;
              
              // Analisar data do último empréstimo
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  if (!preferenciasPorUsuario[userId].ultimoEmprestimo || loanDate > preferenciasPorUsuario[userId].ultimoEmprestimo) {
                    preferenciasPorUsuario[userId].ultimoEmprestimo = loanDate;
                  }
                }
              }
              
              // Analisar gêneros preferidos
              if (emp.bookCategory) {
                if (!preferenciasPorUsuario[userId].generos[emp.bookCategory]) {
                  preferenciasPorUsuario[userId].generos[emp.bookCategory] = 0;
                }
                preferenciasPorUsuario[userId].generos[emp.bookCategory]++;
              }
              
              // Analisar pontualidade
              const hoje = new Date();
              if (emp.status === 'DEVOLVIDO') {
                preferenciasPorUsuario[userId].pontualidade.pontual++;
              } else if (emp.returnDate) {
                const dateParts = emp.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    preferenciasPorUsuario[userId].pontualidade.atrasado++;
                  }
                }
              }
            });

            // Criar mapa de usuários para acesso rápido aos nomes
            const mapaUsuarios = {};
            usuariosSnapshot.docs.forEach(doc => {
              const userData = doc.data();
              mapaUsuarios[doc.id] = userData.nome || 'Nome não informado';
            });

            // Segmentar usuários
            const hoje = new Date();
            const seiseMesesAtras = new Date();
            seiseMesesAtras.setMonth(hoje.getMonth() - 6);

            Object.entries(preferenciasPorUsuario).forEach(([userId, dados]) => {
              const generoPreferido = Object.entries(dados.generos).sort((a, b) => b[1] - a[1])[0];
              const taxaPontualidade = dados.pontualidade.pontual + dados.pontualidade.atrasado > 0 ? 
                (dados.pontualidade.pontual / (dados.pontualidade.pontual + dados.pontualidade.atrasado)) * 100 : 100;
              
              const usuario = {
                userId,
                nomeUsuario: mapaUsuarios[userId] || 'Nome não encontrado',
                totalEmprestimos: dados.totalEmprestimos,
                generoPreferido: generoPreferido ? generoPreferido[0] : 'Variado',
                frequenciaGenero: generoPreferido ? generoPreferido[1] : 0,
                ultimoEmprestimo: dados.ultimoEmprestimo,
                taxaPontualidade: taxaPontualidade.toFixed(1),
                perfil: ''
              };

              // Classificar por frequência
              if (dados.totalEmprestimos >= 10) {
                usuario.perfil = 'Leitor Frequente';
                usuariosSegmentados.frequentes.push(usuario);
              } else if (dados.totalEmprestimos >= 5) {
                usuario.perfil = 'Leitor Moderado';
                usuariosSegmentados.moderados.push(usuario);
              } else if (dados.totalEmprestimos >= 1) {
                if (dados.ultimoEmprestimo && dados.ultimoEmprestimo > seiseMesesAtras) {
                  usuario.perfil = 'Leitor Esporádico';
                  usuariosSegmentados.esporadicos.push(usuario);
                } else {
                  usuario.perfil = 'Usuário Inativo';
                  usuariosSegmentados.inativos.push(usuario);
                }
              }
            });

            // Análise de preferências por segmento
            const analiseSegmentos = {};
            Object.entries(usuariosSegmentados).forEach(([segmento, usuarios]) => {
              const generosPopulares = {};
              let somaEmprestimos = 0;
              let somaPontualidade = 0;

              usuarios.forEach(usuario => {
                somaEmprestimos += usuario.totalEmprestimos;
                somaPontualidade += parseFloat(usuario.taxaPontualidade);
                
                if (!generosPopulares[usuario.generoPreferido]) {
                  generosPopulares[usuario.generoPreferido] = 0;
                }
                generosPopulares[usuario.generoPreferido]++;
              });

              analiseSegmentos[segmento] = {
                quantidade: usuarios.length,
                mediaEmprestimos: usuarios.length > 0 ? (somaEmprestimos / usuarios.length).toFixed(1) : 0,
                mediaPontualidade: usuarios.length > 0 ? (somaPontualidade / usuarios.length).toFixed(1) : 0,
                generoMaisPopular: Object.entries(generosPopulares).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0]
              };
            });

            // Recomendações por segmento
            const recomendacoesPorSegmento = {
              frequentes: [
                'Programa de fidelidade com benefícios exclusivos',
                'Acesso prioritário a novos lançamentos',
                'Participação em clubes de leitura',
                'Descontos em renovações de multas'
              ],
              moderados: [
                'Newsletters com recomendações personalizadas',
                'Lembretes de novos títulos do gênero preferido',
                'Promoções de empréstimos múltiplos',
                'Eventos temáticos sobre seus gêneros favoritos'
              ],
              esporadicos: [
                'Campanhas de reengajamento',
                'Recomendações baseadas no histórico',
                'Facilidades no processo de empréstimo',
                'Notificações sobre títulos populares'
              ],
              inativos: [
                'Campanhas de reativação personalizadas',
                'Ofertas especiais para retorno',
                'Novidades sobre gêneros de interesse',
                'Simplificação do processo de empréstimo'
              ]
            };

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-group' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avançado - Segmentação de Usuários</h4>
                </div>
                <p class="text-muted">Análise comportamental e segmentação estratégica dos usuários da biblioteca</p>
              </div>

              <!-- Visão Geral dos Segmentos -->
              <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-crown' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${usuariosSegmentados.frequentes.length}</h3>
                      <p class="card-text mb-0">Leitores Frequentes</p>
                      <small class="text-muted">≥10 empréstimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-medal' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${usuariosSegmentados.moderados.length}</h3>
                      <p class="card-text mb-0">Leitores Moderados</p>
                      <small class="text-muted">5-9 empréstimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-warning h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-user' style="font-size: 2.5rem; color: #ffc107;"></i>
                      <h3 class="text-warning mt-2">${usuariosSegmentados.esporadicos.length}</h3>
                      <p class="card-text mb-0">Leitores Esporádicos</p>
                      <small class="text-muted">1-4 empréstimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-danger h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-user-x' style="font-size: 2.5rem; color: #dc3545;"></i>
                      <h3 class="text-danger mt-2">${usuariosSegmentados.inativos.length}</h3>
                      <p class="card-text mb-0">Usuários Inativos</p>
                      <small class="text-muted">>6 meses sem atividade</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Análise Detalhada por Segmento -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-analysis'></i> Análise Comportamental por Segmento</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Segmento</th>
                          <th class="text-center">Usuários</th>
                          <th class="text-center">Média de Empréstimos</th>
                          <th class="text-center">Pontualidade (%)</th>
                          <th class="text-center">Gênero Mais Popular</th>
                          <th class="text-center">Potencial</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const segmentosInfo = [
              { key: 'frequentes', nome: 'Leitores Frequentes', icon: '👑', cor: 'success' },
              { key: 'moderados', nome: 'Leitores Moderados', icon: '🥈', cor: 'primary' },
              { key: 'esporadicos', nome: 'Leitores Esporádicos', icon: '⭐', cor: 'warning' },
              { key: 'inativos', nome: 'Usuários Inativos', icon: '💤', cor: 'danger' }
            ];

            segmentosInfo.forEach(segInfo => {
              const dados = analiseSegmentos[segInfo.key] || { quantidade: 0, mediaEmprestimos: 0, mediaPontualidade: 0, generoMaisPopular: ['N/A', 0] };
              const potencial = segInfo.key === 'frequentes' ? 'Alto Valor' : 
                               segInfo.key === 'moderados' ? 'Crescimento' : 
                               segInfo.key === 'esporadicos' ? 'Reengajamento' : 'Reativação';

              html += `
                <tr>
                  <td><strong>${segInfo.icon} ${segInfo.nome}</strong></td>
                  <td class="text-center">${dados.quantidade}</td>
                  <td class="text-center">${dados.mediaEmprestimos}</td>
                  <td class="text-center">${dados.mediaPontualidade}%</td>
                  <td class="text-center">${dados.generoMaisPopular[0]}</td>
                  <td class="text-center">
                    <span class="badge bg-${segInfo.cor}">${potencial}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Detalhamento dos Top Usuários por Segmento -->
              <div class="row mb-4">
            `;

            // Mostrar top usuários de cada segmento
            segmentosInfo.forEach((segInfo, index) => {
              const usuarios = usuariosSegmentados[segInfo.key] || [];
              const topUsuarios = usuarios
                .sort((a, b) => b.totalEmprestimos - a.totalEmprestimos)
                .slice(0, 5);

              if (topUsuarios.length > 0) {
                html += `
                  <div class="col-md-6 mb-4">
                    <h6><i class='bx bx-user-circle'></i> Top 5 - ${segInfo.nome}</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped">
                        <thead>
                          <tr>
                            <th>Usuário</th>
                            <th class="text-center">Empréstimos</th>
                            <th class="text-center">Gênero Favorito</th>
                            <th class="text-center">Pontualidade</th>
                          </tr>
                        </thead>
                        <tbody>
                `;

                topUsuarios.forEach((usuario, i) => {
                  html += `
                    <tr>
                      <td>${usuario.nomeUsuario}</td>
                      <td class="text-center">${usuario.totalEmprestimos}</td>
                      <td class="text-center">${usuario.generoPreferido}</td>
                      <td class="text-center">
                        <span class="badge ${usuario.taxaPontualidade >= 80 ? 'bg-success' : usuario.taxaPontualidade >= 60 ? 'bg-warning' : 'bg-danger'}">
                          ${usuario.taxaPontualidade}%
                        </span>
                      </td>
                    </tr>
                  `;
                });

                html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                `;
              }
            });

            html += `
              </div>

              <!-- Estratégias e Recomendações por Segmento -->
              <div class="row mb-4">
            `;

            segmentosInfo.forEach(segInfo => {
              const recomendacoes = recomendacoesPorSegmento[segInfo.key] || [];
              
              html += `
                <div class="col-md-6 mb-4">
                  <div class="alert alert-${segInfo.cor}">
                    <h6><i class='bx bx-bulb'></i> Estratégias - ${segInfo.nome}</h6>
                    <ul class="mb-0">
              `;
              
              recomendacoes.forEach(recomendacao => {
                html += `<li>${recomendacao}</li>`;
              });
              
              html += `
                    </ul>
                  </div>
                </div>
              `;
            });

            html += `
              </div>

              <!-- Insights de Personalização -->
              <div class="alert alert-info">
                <h6><i class='bx bx-brain'></i> Insights para Personalização:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>📊 Oportunidades Identificadas:</strong>
                    <ul class="mt-2">
                      <li><strong>Leitores Frequentes:</strong> Fidelização e programa VIP</li>
                      <li><strong>Leitores Moderados:</strong> Estímulo para aumentar frequência</li>
                      <li><strong>Leitores Esporádicos:</strong> Campanhas de reengajamento</li>
                      <li><strong>Usuários Inativos:</strong> Reativação com ofertas especiais</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>🎯 Ações Recomendadas:</strong>
                    <ul class="mt-2">
                      <li>Implementar sistema de recomendações personalizadas</li>
                      <li>Criar campanhas de marketing direcionadas</li>
                      <li>Desenvolver programa de fidelidade por níveis</li>
                      <li>Automatizar notificações baseadas no perfil</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Métricas de Segmentação -->
              <div class="alert alert-success">
                <h6><i class='bx bx-check-circle'></i> Resumo da Segmentação:</h6>
                <div class="row">
                  <div class="col-md-3">
                    <strong>Total de Usuários Analisados:</strong><br>
                    <span class="badge bg-primary">${Object.keys(preferenciasPorUsuario).length}</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Segmentos Identificados:</strong><br>
                    <span class="badge bg-success">4 Perfis</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Cobertura de Segmentação:</strong><br>
                    <span class="badge bg-info">100%</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Potencial de Personalização:</strong><br>
                    <span class="badge bg-warning">Alto</span>
                  </div>
                </div>
              </div>

              <div class="alert alert-warning mt-4">
                <h6><i class='bx bx-info-circle'></i> Como Utilizar esta Análise:</h6>
                <p class="mb-0">
                  Esta segmentação permite criar estratégias específicas para cada perfil de usuário, 
                  otimizando a experiência da biblioteca e aumentando o engajamento. Use os insights 
                  para personalizar comunicações, recomendar livros e desenvolver programas de fidelidade 
                  que atendam às necessidades específicas de cada segmento.
                </p>
              </div>
            `;

          } else if (modelo === 'otimizacao') {
            // Analytics Avançado - Otimização
            
            // Métricas de Performance da Biblioteca
            const metricas = {
              eficienciaColecao: 0,
              utilizacaoEspaco: 0,
              satisfacaoUsuarios: 0,
              rotividadeAcervo: 0,
              custoOperacional: 0,
              tempoMedioEmprestimo: 0
            };

            // Análise da eficiência da coleção
            const livrosComEmprestimos = {};
            const livrosSemMovimento = [];
            const dataAtual = new Date();
            const seiseMesesAtras = new Date(dataAtual.getTime() - (6 * 30 * 24 * 60 * 60 * 1000));

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (!livrosComEmprestimos[emp.bookId]) {
                livrosComEmprestimos[emp.bookId] = {
                  totalEmprestimos: 0,
                  ultimoEmprestimo: null,
                  usuarios: new Set()
                };
              }
              livrosComEmprestimos[emp.bookId].totalEmprestimos++;
              livrosComEmprestimos[emp.bookId].usuarios.add(emp.userId);
              
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  if (!livrosComEmprestimos[emp.bookId].ultimoEmprestimo || 
                      loanDate > livrosComEmprestimos[emp.bookId].ultimoEmprestimo) {
                    livrosComEmprestimos[emp.bookId].ultimoEmprestimo = loanDate;
                  }
                }
              }
            });

            // Identificar livros sem movimento recente
            livrosSnapshot.docs.forEach(doc => {
              const livroId = doc.id;
              const livroData = doc.data();
              const info = livrosComEmprestimos[livroId];
              
              if (!info || !info.ultimoEmprestimo || info.ultimoEmprestimo < seiseMesesAtras) {
                livrosSemMovimento.push({
                  id: livroId,
                  titulo: livroData.title || 'Título não informado',
                  autor: livroData.author || 'Autor não informado',
                  categoria: livroData.category || 'Categoria não informada',
                  totalEmprestimos: info ? info.totalEmprestimos : 0,
                  ultimoEmprestimo: info ? info.ultimoEmprestimo : null
                });
              }
            });

            // Calcular métricas
            const totalLivros = livrosSnapshot.size;
            const livrosAtivos = Object.keys(livrosComEmprestimos).length;
            metricas.eficienciaColecao = totalLivros > 0 ? ((livrosAtivos / totalLivros) * 100).toFixed(1) : 0;
            metricas.utilizacaoEspaco = totalLivros > 0 ? (((totalLivros - livrosSemMovimento.length) / totalLivros) * 100).toFixed(1) : 0;

            // Análise de padrões de uso por categoria
            const categoriaMetricas = {};
            const horarioPico = {};
            const diasSemana = {};

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              
              // Métricas por categoria
              if (emp.bookCategory) {
                if (!categoriaMetricas[emp.bookCategory]) {
                  categoriaMetricas[emp.bookCategory] = {
                    emprestimos: 0,
                    usuarios: new Set(),
                    rotatividade: 0
                  };
                }
                categoriaMetricas[emp.bookCategory].emprestimos++;
                categoriaMetricas[emp.bookCategory].usuarios.add(emp.userId);
              }

              // Análise temporal (simulada)
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  const diaSemana = loanDate.getDay();
                  const hora = loanDate.getHours();
                  
                  if (!diasSemana[diaSemana]) diasSemana[diaSemana] = 0;
                  diasSemana[diaSemana]++;
                  
                  if (!horarioPico[hora]) horarioPico[hora] = 0;
                  horarioPico[hora]++;
                }
              }
            });

            // Calcular rotatividade por categoria
            Object.keys(categoriaMetricas).forEach(categoria => {
              const livrosDaCategoria = livrosSnapshot.docs.filter(doc => 
                doc.data().category === categoria
              ).length;
              
              if (livrosDaCategoria > 0) {
                categoriaMetricas[categoria].rotatividade = 
                  (categoriaMetricas[categoria].emprestimos / livrosDaCategoria).toFixed(2);
              }
            });

            // Identificar horários de pico
            const horariosOrdenados = Object.entries(horarioPico)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);

            // Identificar dias mais movimentados
            const diasNomes = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const diasOrdenados = Object.entries(diasSemana)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);

            // Recomendações de otimização
            const recomendacoes = {
              colecao: [],
              operacional: [],
              espacial: [],
              temporal: [],
              experiencia: []
            };

            // Recomendações baseadas na eficiência da coleção
            if (metricas.eficienciaColecao < 70) {
              recomendacoes.colecao.push({
                prioridade: 'Alta',
                titulo: 'Revisar Coleção Inativa',
                descricao: `${livrosSemMovimento.length} livros sem movimento nos últimos 6 meses`,
                acao: 'Considerar remanejamento, doação ou promoção especial'
              });
            }

            if (livrosSemMovimento.length > totalLivros * 0.3) {
              recomendacoes.espacial.push({
                prioridade: 'Média',
                titulo: 'Otimização de Espaço',
                descricao: 'Mais de 30% do acervo com baixa movimentação',
                acao: 'Reorganizar layout para destacar livros populares'
              });
            }

            // Recomendações operacionais
            const categoriasPopulares = Object.entries(categoriaMetricas)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .slice(0, 3);

            if (categoriasPopulares.length > 0) {
              recomendacoes.operacional.push({
                prioridade: 'Média',
                titulo: 'Ampliar Categorias Populares',
                descricao: `${categoriasPopulares[0][0]} é a categoria mais procurada`,
                acao: 'Considerar aquisição de mais títulos desta categoria'
              });
            }

            // Recomendações temporais
            if (horariosOrdenados.length > 0) {
              recomendacoes.temporal.push({
                prioridade: 'Baixa',
                titulo: 'Otimizar Horários de Atendimento',
                descricao: `Pico de movimento às ${horariosOrdenados[0][0]}h`,
                acao: 'Considerar aumentar equipe nos horários de pico'
              });
            }

            // Recomendações de experiência
            recomendacoes.experiencia.push({
              prioridade: 'Média',
              titulo: 'Sistema de Recomendações',
              descricao: 'Implementar sugestões personalizadas',
              acao: 'Usar dados de preferências para recomendar livros'
            });

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-cog' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avançado - Otimização</h4>
                </div>
                <p class="text-muted">Sistema inteligente de análise e recomendações para otimização da biblioteca</p>
              </div>

              <!-- Métricas de Performance -->
              <div class="row mb-4">
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-trending-up' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${metricas.eficienciaColecao}%</h3>
                      <p class="card-text mb-0">Eficiência da Coleção</p>
                      <small class="text-muted">Livros com movimento ativo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-building' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${metricas.utilizacaoEspaco}%</h3>
                      <p class="card-text mb-0">Utilização do Espaço</p>
                      <small class="text-muted">Aproveitamento do acervo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-warning h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-refresh' style="font-size: 2.5rem; color: #ffc107;"></i>
                      <h3 class="text-warning mt-2">${livrosAtivos}</h3>
                      <p class="card-text mb-0">Livros Ativos</p>
                      <small class="text-muted">de ${totalLivros} total</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Análise por Categoria -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Performance por Categoria</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Categoria</th>
                          <th class="text-center">Empréstimos</th>
                          <th class="text-center">Usuários Únicos</th>
                          <th class="text-center">Rotatividade</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(categoriaMetricas)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([categoria, dados]) => {
                const rotatividade = parseFloat(dados.rotatividade);
                const status = rotatividade > 2 ? 'Excelente' : 
                              rotatividade > 1 ? 'Boa' : 
                              rotatividade > 0.5 ? 'Regular' : 'Baixa';
                const corStatus = rotatividade > 2 ? 'success' : 
                                 rotatividade > 1 ? 'primary' : 
                                 rotatividade > 0.5 ? 'warning' : 'danger';

                html += `
                  <tr>
                    <td><strong>${categoria}</strong></td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${dados.usuarios.size}</td>
                    <td class="text-center">${dados.rotatividade}</td>
                    <td class="text-center">
                      <span class="badge bg-${corStatus}">${status}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Análise Temporal -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6><i class='bx bx-time'></i> Horários de Maior Movimento</h6>
                  <div class="list-group">
            `;

            horariosOrdenados.forEach(([hora, quantidade], index) => {
              const posicao = index === 0 ? '🥇' : index === 1 ? '🥈' : '🥉';
              html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${posicao} ${hora}:00 - ${parseInt(hora) + 1}:00</span>
                  <span class="badge bg-primary rounded-pill">${quantidade} empréstimos</span>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
                <div class="col-md-6">
                  <h6><i class='bx bx-calendar'></i> Dias Mais Movimentados</h6>
                  <div class="list-group">
            `;

            diasOrdenados.forEach(([dia, quantidade], index) => {
              const posicao = index === 0 ? '🥇' : index === 1 ? '🥈' : '🥉';
              html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${posicao} ${diasNomes[dia]}</span>
                  <span class="badge bg-success rounded-pill">${quantidade} empréstimos</span>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
              </div>

              <!-- Livros com Baixa Movimentação -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-error-circle'></i> Livros com Baixa Movimentação (Top 10)</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Título</th>
                          <th>Autor</th>
                          <th>Categoria</th>
                          <th class="text-center">Total Empréstimos</th>
                          <th class="text-center">Último Empréstimo</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosSemMovimento
              .sort((a, b) => a.totalEmprestimos - b.totalEmprestimos)
              .slice(0, 10)
              .forEach(livro => {
                const ultimoEmprestimoTexto = livro.ultimoEmprestimo ? 
                  livro.ultimoEmprestimo.toLocaleDateString('pt-BR') : 'Nunca';
                
                html += `
                  <tr>
                    <td><strong>${livro.titulo}</strong></td>
                    <td>${livro.autor}</td>
                    <td>${livro.categoria}</td>
                    <td class="text-center">${livro.totalEmprestimos}</td>
                    <td class="text-center">${ultimoEmprestimoTexto}</td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Recomendações de Otimização -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-bulb'></i> Recomendações de Otimização</h5>
                </div>
            `;

            const todasRecomendacoes = [
              ...recomendacoes.colecao,
              ...recomendacoes.operacional,
              ...recomendacoes.espacial,
              ...recomendacoes.temporal,
              ...recomendacoes.experiencia
            ];

            todasRecomendacoes.forEach((rec, index) => {
              const corPrioridade = rec.prioridade === 'Alta' ? 'danger' : 
                                   rec.prioridade === 'Média' ? 'warning' : 'info';
              const iconePrioridade = rec.prioridade === 'Alta' ? 'bx-error' : 
                                     rec.prioridade === 'Média' ? 'bx-info-circle' : 'bx-check-circle';

              html += `
                <div class="col-md-6 mb-3">
                  <div class="alert alert-${corPrioridade}">
                    <div class="d-flex align-items-start">
                      <i class='bx ${iconePrioridade}' style="font-size: 1.5rem; margin-right: 10px; margin-top: 2px;"></i>
                      <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">
                          <span class="badge bg-${corPrioridade} me-2">${rec.prioridade}</span>
                          ${rec.titulo}
                        </h6>
                        <p class="mb-1"><strong>Diagnóstico:</strong> ${rec.descricao}</p>
                        <p class="mb-0"><strong>Ação Recomendada:</strong> ${rec.acao}</p>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
              </div>

              <!-- Painel de Insights Estratégicos -->
              <div class="alert alert-light border">
                <h6><i class='bx bx-brain'></i> Insights Estratégicos:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>📊 Análise de Performance:</strong>
                    <ul class="mt-2">
                      <li><strong>Eficiência Atual:</strong> ${metricas.eficienciaColecao}% da coleção em uso ativo</li>
                      <li><strong>Oportunidade:</strong> ${livrosSemMovimento.length} livros podem ser otimizados</li>
                      <li><strong>Categoria Líder:</strong> ${categoriasPopulares[0] ? categoriasPopulares[0][0] : 'N/A'} com maior rotatividade</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>🎯 Próximos Passos:</strong>
                    <ul class="mt-2">
                      <li>Implementar sistema de recomendações personalizadas</li>
                      <li>Criar campanhas para livros com baixa movimentação</li>
                      <li>Otimizar horários de atendimento baseado nos picos</li>
                      <li>Desenvolver programa de fidelidade para categorias populares</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Score de Otimização Geral -->
              <div class="text-center mt-4">
                <div class="alert alert-primary">
                  <h5><i class='bx bx-award'></i> Score de Otimização da Biblioteca</h5>
            `;

            const scoreGeral = (
              (parseFloat(metricas.eficienciaColecao) * 0.4) +
              (parseFloat(metricas.utilizacaoEspaco) * 0.3) +
              ((livrosAtivos / totalLivros) * 100 * 0.3)
            ).toFixed(1);

            const classificacao = scoreGeral >= 80 ? { texto: 'Excelente', cor: 'success', emoji: '🏆' } :
                                  scoreGeral >= 70 ? { texto: 'Muito Bom', cor: 'primary', emoji: '🥇' } :
                                  scoreGeral >= 60 ? { texto: 'Bom', cor: 'info', emoji: '👍' } :
                                  scoreGeral >= 50 ? { texto: 'Regular', cor: 'warning', emoji: '⚠️' } :
                                  { texto: 'Precisa Melhorar', cor: 'danger', emoji: '🔄' };

            html += `
                  <h2 class="text-${classificacao.cor}">${classificacao.emoji} ${scoreGeral}/100</h2>
                  <h4 class="text-${classificacao.cor}">${classificacao.texto}</h4>
                  <p class="mb-0">Sua biblioteca está operando com <strong>${scoreGeral}%</strong> de eficiência geral</p>
                </div>
              </div>
            `;

          } else {
            // Outros modelos em desenvolvimento
            html = `
              <div class="text-center py-5">
                <i class='bx bx-stats' style="font-size: 4rem; color: #f093fb; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Analytics Avançado - ${modelo.charAt(0).toUpperCase() + modelo.slice(1)}</h5>
                <p class="text-muted">Módulo em desenvolvimento.</p>
                
                <div class="alert alert-info mt-4">
                  <h6>Em Breve:</h6>
                  <p class="mb-0">
                    Funcionalidades avançadas para este modelo de análise estarão disponíveis em uma próxima atualização.
                  </p>
                </div>
              </div>
            `;
          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar analytics: ${error.message}</p>`;
          console.error('Erro ao buscar analytics:', error);
        }
      }

      reportResult.innerHTML = html;
      
      // Restaurar botão
      this.innerHTML = originalText;
      this.disabled = false;
      
    } catch (error) {
      // Tratamento de erro geral
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <i class='bx bx-error' style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
          <h5 class="text-white">Erro ao gerar relatório</h5>
          <p class="text-danger">${error.message}</p>
          <button class="btn btn-outline-light mt-3" onclick="location.reload()">
            <i class='bx bx-refresh'></i> Tentar Novamente
          </button>
        </div>
      `;
      console.error('Erro geral:', error);
      
      // Restaurar botão
      this.innerHTML = originalText;
      this.disabled = false;
    }
    });

    // Exibe/esconde filtros conforme o tipo de relatório
    reportType.addEventListener('change', function () {
      document.getElementById('livrosFilters').classList.toggle('d-none', this.value !== 'livros');
      document.getElementById('usuariosFilters').classList.toggle('d-none', this.value !== 'usuarios');
      document.getElementById('emprestimosFilters').classList.toggle('d-none', this.value !== 'emprestimos');
      document.getElementById('leitoresFilters').classList.toggle('d-none', this.value !== 'leitores');
      
      // Filtros para análises detalhadas
      document.getElementById('estatisticasFilters').classList.toggle('d-none', this.value !== 'estatisticas');
      document.getElementById('tendenciasFilters').classList.toggle('d-none', this.value !== 'tendencias');
      document.getElementById('performanceFilters').classList.toggle('d-none', this.value !== 'performance');
      document.getElementById('analyticsFilters').classList.toggle('d-none', this.value !== 'analytics');
      
      // Controla a exibição dos filtros de data
      const emprestimosDateFilters = document.getElementById('emprestimosDateFilters');
      const leitoresDateFilters = document.getElementById('leitoresDateFilters');
      const otherReportsActions = document.getElementById('otherReportsActions');
      
      if (this.value === 'emprestimos') {
        emprestimosDateFilters.style.display = 'flex';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'none';
      } else if (this.value === 'leitores') {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'flex';
        otherReportsActions.style.display = 'none';
      } else {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'flex';
      }
    });

    // Função para criar imagens de medalhas para o PDF
    function criarImagemMedalha(tipo) {
      const canvas = document.createElement('canvas');
      canvas.width = 40;
      canvas.height = 40;
      const ctx = canvas.getContext('2d');
      
      // Limpar canvas
      ctx.clearRect(0, 0, 40, 40);
      
      // Desenhar sombra
      ctx.beginPath();
      ctx.arc(21, 21, 18, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fill();
      
      // Desenhar círculo base
      ctx.beginPath();
      ctx.arc(20, 20, 18, 0, 2 * Math.PI);
      
      // Definir cores baseadas no tipo
      if (tipo === 1) {
        // Medalha de Ouro
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#FFF700');
        gradient.addColorStop(0.5, '#FFD700');
        gradient.addColorStop(1, '#B8860B');
        ctx.fillStyle = gradient;
      } else if (tipo === 2) {
        // Medalha de Prata
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#E8E8E8');
        gradient.addColorStop(0.5, '#C0C0C0');
        gradient.addColorStop(1, '#808080');
        ctx.fillStyle = gradient;
      } else if (tipo === 3) {
        // Medalha de Bronze
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#DEB887');
        gradient.addColorStop(0.5, '#CD7F32');
        gradient.addColorStop(1, '#8B4513');
        ctx.fillStyle = gradient;
      }
      
      ctx.fill();
      
      // Adicionar borda externa escura
      ctx.strokeStyle = '#2C2C2C';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Adicionar borda interna brilhante
      ctx.beginPath();
      ctx.arc(20, 20, 15, 0, 2 * Math.PI);
      ctx.strokeStyle = tipo === 1 ? '#FFFF99' : tipo === 2 ? '#F0F0F0' : '#F4A460';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // Adicionar número
      ctx.fillStyle = '#FFFFFF';
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1;
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.strokeText(tipo.toString(), 20, 20);
      ctx.fillText(tipo.toString(), 20, 20);
      
      return canvas.toDataURL('image/png');
    }

    // Função para baixar PDF (duplicada para os dois botões)
    function baixarPDF() {
      const reportType = document.getElementById('reportType').value;
      const reportResult = document.getElementById('reportResult');
      const doc = new jspdf.jsPDF();

      let titulo = '';
      if (reportType === 'livros') titulo = 'Relatório de Livros';
      if (reportType === 'usuarios') titulo = 'Relatório de Usuários';
      if (reportType === 'emprestimos') titulo = 'Relatório de Empréstimos';
      if (reportType === 'leitores') titulo = 'Ranking de Leitores';
      if (reportType === 'advertencias') titulo = 'Relatório de Advertências';

      // Adiciona informações de filtro ao título
      if (reportType === 'emprestimos') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const situacao = document.getElementById('emprestimosSituacao').value;
        
        if (dataInicio || dataFim || situacao) {
          let filtros = [];
          if (situacao) filtros.push(`Situação: ${situacao}`);
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`Até: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'leitores') {
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;
        const ordem = document.getElementById('leitoresOrdem').value;
        
        if (dataInicio || dataFim || limite || ordem !== 'desc') {
          let filtros = [];
          if (limite) filtros.push(`Top ${limite}`);
          if (ordem === 'asc') filtros.push('Menor para Maior');
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`Até: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'advertencias') {
        titulo += ` - Gerado em ${new Date().toLocaleDateString('pt-BR')}`;
      }

      // Função para adicionar logo e cabeçalho
      function adicionarCabecalho() {
        // Adicionar logo ABA.png
        try {
          const logoImg = new Image();
          logoImg.onload = function() {
            // Adicionar logo no canto superior esquerdo
            doc.addImage(logoImg, 'PNG', 14, 10, 30, 30);
            
            // Adicionar informações da escola
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Escola Estadual Governador Bias Fortes', 50, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema de Gestão de Biblioteca - SIGEB', 50, 28);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(titulo, 50, 38);
            
            // Adicionar data de geração
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, 50);
            
            // Linha separadora
            doc.setLineWidth(0.5);
            doc.line(14, 55, 196, 55);
            
            // Gerar tabela
            const table = reportResult.querySelector('table');
            if (table) {
              // Configurações especiais para o relatório de advertências
              let autoTableConfig = { 
                html: table, 
                startY: 60,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [13, 40, 71] },
                theme: 'striped'
              };

              // Para relatório de ranking de leitores, adicionar medalhas
              if (reportType === 'leitores') {
                autoTableConfig.styles.fontSize = 9;
                autoTableConfig.columnStyles = {
                  0: { cellWidth: 25, halign: 'center' }, // Coluna posição com medalha
                  1: { cellWidth: 50 }, // Nome
                  2: { cellWidth: 25 }, // Matrícula
                  3: { cellWidth: 30 }, // Função
                  4: { halign: 'center' }, // Total livros
                  5: { halign: 'center' }, // Empréstimos
                  6: { halign: 'center' } // Média
                };
                
                // Remover emojis do texto e manter só os números
                autoTableConfig.didParseCell = function(data) {
                  if (data.column.index === 0) {
                    if (data.row.index < 3) {
                      // Para as 3 primeiras posições, limpar o texto (será adicionado manualmente)
                      data.cell.text = [''];
                    } else {
                      // Para outras posições, remover emojis e manter só o número
                      data.cell.text = data.cell.text.map(text => {
                        return text.replace(/🥇|🥈|🥉/g, '').trim();
                      });
                    }
                  }
                  // Remover HTML de outras células
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
                
                // Adicionar medalhas após desenhar a célula
                autoTableConfig.didDrawCell = function(data) {
                  if (data.column.index === 0 && data.row.index < 3) {
                    // Adicionar medalha como imagem para as 3 primeiras posições
                    const posicao = data.row.index + 1;
                    const medalhaImg = criarImagemMedalha(posicao);
                    
                    // Posicionar a medalha no centro-esquerda da célula
                    const medalhaX = data.cell.x + 2;
                    const medalhaY = data.cell.y + (data.cell.height - 10) / 2;
                    doc.addImage(medalhaImg, 'PNG', medalhaX, medalhaY, 10, 10);
                    
                    // Ajustar o texto para ficar ao lado da medalha
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${posicao}º`, medalhaX + 12, medalhaY + 5.5);
                  }
                };
              }

              // Para relatório de advertências, ajustar configurações
              if (reportType === 'advertencias') {
                autoTableConfig.styles.fontSize = 7;
                autoTableConfig.columnStyles = {
                  3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
                  4: { halign: 'center' }, // Dias de atraso centralizado
                  5: { halign: 'center' } // Status centralizado
                };
                
                // Processar dados para remover HTML das células
                autoTableConfig.didParseCell = function(data) {
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      // Remove tags HTML
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
              }

              doc.autoTable(autoTableConfig);
              
              // Adicionar resumo específico para advertências
              if (reportType === 'advertencias') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados do resumo da tela
                const alertasResumo = reportResult.querySelectorAll('.alert h4');
                if (alertasResumo.length >= 1) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`• Total de Advertências: ${alertasResumo[0].textContent}`, 14, finalY + 10);
                  doc.text('• Advertências servem como orientação pedagógica para conscientização', 14, finalY + 18);
                  doc.text('  sobre a importância da devolução no prazo.', 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Legenda de Gravidade:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
                }
              }

              // Adicionar resumo específico para ranking de leitores
              if (reportType === 'leitores') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados dos cards de estatísticas
                const statsCards = reportResult.querySelectorAll('.card h4');
                if (statsCards.length >= 3) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`• Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
                  doc.text(`• Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
                  doc.text(`• Média por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Sistema de Medalhas:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  
                  // Adicionar pequenas medalhas na legenda
                  const medalhaOuro = criarImagemMedalha(1);
                  const medalhaPrata = criarImagemMedalha(2);
                  const medalhaBronze = criarImagemMedalha(3);
                  
                  doc.addImage(medalhaOuro, 'PNG', 14, finalY + 42, 6, 6);
                  doc.text('1º Lugar (Ouro)', 22, finalY + 46);
                  
                  doc.addImage(medalhaPrata, 'PNG', 60, finalY + 42, 6, 6);
                  doc.text('2º Lugar (Prata)', 68, finalY + 46);
                  
                  doc.addImage(medalhaBronze, 'PNG', 120, finalY + 42, 6, 6);
                  doc.text('3º Lugar (Bronze)', 128, finalY + 46);
                  
                  doc.text('Ranking baseado no total de livros devolvidos com sucesso', 14, finalY + 54);
                }
              }
            } else {
              doc.text('Nenhum dado para exportar.', 14, 70);
            }
            
            // Adicionar rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Página ${i} de ${pageCount}`, 14, 285);
              doc.text('© 2025 SIGEB - Sistema de Gestão de Biblioteca', 120, 285);
            }
            
            doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
          };
          
          logoImg.onerror = function() {
            console.warn('Erro ao carregar logo, gerando PDF sem logo');
            gerarPDFSemLogo();
          };
          
          logoImg.src = 'logobias.png';
        } catch (error) {
          console.warn('Erro ao processar logo:', error);
          gerarPDFSemLogo();
        }
      }

      // Função alternativa sem logo
      function gerarPDFSemLogo() {
        // Adicionar informações da escola
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Escola Estadual Governador Bias Fortes', 14, 20);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Gestão de Biblioteca - SIGEB', 14, 28);
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(titulo, 14, 38);
        
        // Adicionar data de geração
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, 48);
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(14, 52, 196, 52);

        const table = reportResult.querySelector('table');
        if (table) {
          // Configurações especiais para o relatório de advertências
          let autoTableConfig = { 
            html: table, 
            startY: 58,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 40, 71] },
            theme: 'striped'
          };

          // Para relatório de advertências, ajustar configurações
          if (reportType === 'advertencias') {
            autoTableConfig.styles.fontSize = 7;
            autoTableConfig.columnStyles = {
              3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
              4: { halign: 'center' }, // Dias de atraso centralizado
              5: { halign: 'center' } // Status centralizado
            };
            
            // Processar dados para remover HTML das células
            autoTableConfig.didParseCell = function(data) {
              if (data.cell.text && Array.isArray(data.cell.text)) {
                data.cell.text = data.cell.text.map(text => {
                  // Remove tags HTML
                  return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                });
              }
            };
          }

          doc.autoTable(autoTableConfig);
          
          // Adicionar resumo específico para advertências
          if (reportType === 'advertencias') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados do resumo da tela
            const alertasResumo = reportResult.querySelectorAll('.alert h4');
            if (alertasResumo.length >= 2) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`• Total de Advertências: ${alertasResumo[0].textContent}`, 14, finalY + 10);
              doc.text(`• Multa Total Acumulada: ${alertasResumo[1].textContent}`, 14, finalY + 18);
              doc.text('• Multa: R$ 0,50 por dia de atraso, por livro emprestado', 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Legenda de Gravidade:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
            }
          }

          // Adicionar resumo específico para ranking de leitores
          if (reportType === 'leitores') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados dos cards de estatísticas
            const statsCards = reportResult.querySelectorAll('.card h4');
            if (statsCards.length >= 3) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`• Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
              doc.text(`• Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
              doc.text(`• Média por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Como interpretar:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('🥇🥈🥉 Medalhas para os 3 primeiros colocados | Ranking baseado em livros devolvidos', 14, finalY + 44);
            }
          }
        } else {
          doc.text('Nenhum dado para exportar.', 14, 68);
        }
        
        // Adicionar rodapé
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`Página ${i} de ${pageCount}`, 14, 285);
          doc.text('© 2025 SIGEB - Sistema de Gestão de Biblioteca', 120, 285);
        }
        
        doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
      }

      // Iniciar processo de geração
      adicionarCabecalho();
    }

    btnBaixarPDF.addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDF2').addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDFLeitores').addEventListener('click', baixarPDF);

    // Exemplo para buscar a quantidade total de livros cadastrados no Firestore
    async function buscarQuantidadeLivros() {
      try {
        const snapshot = await db.collection('livros').get();
        const quantidade = snapshot.size; // Número total de documentos (livros)
        console.log('Quantidade de livros:', quantidade);
        // Exemplo: exibir na tela
        document.getElementById('quantidadeLivros').textContent = quantidade;
      } catch (e) {
        console.error('Erro ao buscar quantidade de livros:', e);
      }
    }

    // Chame a função ao carregar a página
    buscarQuantidadeLivros();

    // Buscar todos os empréstimos do Firestore
    async function buscarEmprestimos() {
      const snapshot = await db.collection('emprestimos').get();
      const emprestimos = [];
      snapshot.forEach(doc => {
        emprestimos.push({ id: doc.id, ...doc.data() });
      });
      console.log(emprestimos);
      return emprestimos;
    }
  });
</script>
</body>
</html>
