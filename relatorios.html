<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGEB - Relat√≥rios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Reset e configura√ß√µes base */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Overlay para melhor contraste */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at top, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.2));
      pointer-events: none;
      z-index: -1;
    }
    
    /* Sidebar melhorada */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 260px;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 25px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-header {
      padding: 25px 0;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      margin-bottom: 25px;
    }
    
    .sidebar-header h3 {
      background: linear-gradient(135deg, #00f2fe, #4facfe, #00c9ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 1px;
      text-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    }
    
    .menu-items {
      padding: 0;
    }
    
    .menu-item {
      padding: 15px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(79, 172, 254, 0.2), rgba(0, 242, 254, 0.2));
      transition: width 0.3s ease;
    }
    
    .menu-item:hover::before, .menu-item.active::before {
      width: 100%;
    }
    
    .menu-item:hover, .menu-item.active {
      color: #4facfe;
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);
    }
    
    .menu-item i {
      margin-right: 15px;
      font-size: 1.3rem;
      z-index: 1;
      position: relative;
    }
    
    .menu-item span {
      z-index: 1;
      position: relative;
      font-weight: 500;
    }

    /* Main Content melhorado */
    .main-content {
      margin-left: 260px;
      padding: 30px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 100vh;
    }

    /* Header da p√°gina */
    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #4facfe);
    }
    
    .page-header h2 {
      margin: 0 0 10px 0;
      color: #1e293b;
      font-weight: 700;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .page-header p {
      margin: 0;
      color: #64748b;
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Cards do sistema (relat√≥rios, filtros, etc.) */
    .settings-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .settings-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .settings-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }
    
    .settings-card h4, .settings-card h5 {
      color: #1e293b;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .settings-card h4::before, .settings-card h5::before {
      content: '';
      width: 4px;
      height: 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    /* Report type cards */
    .report-type-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .report-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .report-card:hover::before {
      opacity: 1;
    }

    .report-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      border-color: rgba(102, 126, 234, 0.4);
    }

    .report-card.active {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transform: translateY(-5px);
    }

    .report-card-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 2rem;
      color: white;
      position: relative;
    }

    .report-card-icon.books { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .report-card-icon.users { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .report-card-icon.loans { background: linear-gradient(135deg, #FFD54F 0%, #FF9800 100%); }
    .report-card-icon.readers { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .report-card-icon.warnings { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }

    .report-card h4 {
      color: #1e293b;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .report-card h4::before {
      display: none;
    }

    .report-card p {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.4;
      margin: 0;
    }

    /* Form elements melhorados */
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255, 255, 255, 0.95);
      outline: none;
    }

    /* Bot√µes melhorados */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-gradient:hover::before {
      left: 100%;
    }
    
    .btn-gradient:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    .btn-outline-light {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #374151;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    /* Feature highlight */
    .feature-highlight {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
    }
    
    .feature-highlight h6 {
      color: #1e293b;
      margin-bottom: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Table styling */
    .table {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
    }

    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 15px;
    }

    .table tbody tr {
      transition: all 0.3s ease;
      border: none;
    }

    .table tbody tr:hover {
      background-color: rgba(102, 126, 234, 0.05);
      transform: scale(1.01);
    }

    .table tbody td {
      border-color: rgba(0, 0, 0, 0.05);
      padding: 12px 15px;
    }

    /* Stats cards */
    .stats-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .stats-label {
      color: #64748b;
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Tooltips */
    .tooltip-info {
      position: relative;
      display: inline-block;
      margin-left: 8px;
      cursor: help;
    }

    .tooltip-info .tooltip-text {
      visibility: hidden;
      width: 250px;
      background: rgba(30, 41, 59, 0.95);
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tooltip-info:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar { 
        position: static; 
        width: 100%; 
        height: auto;
      }
      .main-content { 
        margin-left: 0; 
        padding: 20px;
      }
      .report-type-cards {
        grid-template-columns: 1fr;
      }
      .page-header h2 {
        font-size: 1.8rem;
      }
      .page-header, .settings-card {
        padding: 20px;
      }
    }

    @media (max-width: 576px) {
      .main-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>SIGEB</h3>
    </div>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">
        <i class='bx bxs-dashboard'></i>
        <span>Dashboard</span>
      </a>
      <a href="livros.html" class="menu-item">
        <i class='bx bxs-book'></i>
        <span>Livros</span>
      </a>
      <a href="usuarios.html" class="menu-item">
        <i class='bx bxs-user'></i>
        <span>Usu√°rios</span>
      </a>
      <a href="emprestimos.html" class="menu-item">
        <i class='bx bxs-bookmark'></i>
        <span>Empr√©stimos</span>
      </a>
      <a href="relatorios.html" class="menu-item active">
        <i class='bx bxs-report'></i>
        <span>Relat√≥rios</span>
      </a>
      <a href="configuracoes.html" class="menu-item">
        <i class='bx bxs-cog'></i>
        <span>Configura√ß√µes</span>
      </a>
      <a href="index.html" class="menu-item">
        <i class='bx bxs-log-out'></i>
        <span>Sair</span>
      </a>
    </div>
  </div>
  <div class="main-content">
    <!-- Cabe√ßalho da P√°gina -->
    <div class="page-header">
      <h2><i class='bx bxs-report'></i> Relat√≥rios do Sistema</h2>
      <p>Gere relat√≥rios detalhados para an√°lise e acompanhamento da biblioteca</p>
    </div>

    <!-- Seletor de Tipo de Relat√≥rio -->
    <div class="settings-card">
      <h4>
        <i class='bx bx-list-check'></i> Escolha o Tipo de Relat√≥rio
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Selecione um dos relat√≥rios dispon√≠veis. Cada um oferece informa√ß√µes espec√≠ficas sobre diferentes aspectos da biblioteca.</span>
        </span>
      </h4>
      
      <div class="report-type-cards">
        <div class="report-card" data-type="livros">
          <div class="report-card-icon books">
            <i class='bx bxs-book'></i>
          </div>
          <h4>Relat√≥rio de Livros</h4>
          <p>Visualize todos os livros cadastrados, com filtros por g√™nero, disponibilidade e estat√≠sticas do acervo</p>
        </div>
        
        <div class="report-card" data-type="usuarios">
          <div class="report-card-icon users">
            <i class='bx bxs-user-detail'></i>
          </div>
          <h4>Relat√≥rio de Usu√°rios</h4>
          <p>Lista completa de usu√°rios cadastrados com informa√ß√µes de contato, status e fun√ß√£o no sistema</p>
        </div>
        
        <div class="report-card" data-type="emprestimos">
          <div class="report-card-icon loans">
            <i class='bx bxs-bookmark'></i>
          </div>
          <h4>Relat√≥rio de Empr√©stimos</h4>
          <p>Hist√≥rico detalhado de empr√©stimos com filtros por per√≠odo, status e situa√ß√£o das devolu√ß√µes</p>
        </div>
        
        <div class="report-card" data-type="leitores">
          <div class="report-card-icon readers">
            <i class='bx bxs-trophy'></i>
          </div>
          <h4>Ranking de Leitores</h4>
          <p>Classifica√ß√£o dos usu√°rios mais ativos, incentivando a leitura e reconhecendo os melhores leitores</p>
        </div>
        
        <div class="report-card" data-type="advertencias">
          <div class="report-card-icon warnings">
            <i class='bx bxs-error-alt'></i>
          </div>
          <h4>Relat√≥rio de Advert√™ncias</h4>
          <p>Acompanhe empr√©stimos em atraso e situa√ß√µes que necessitam aten√ß√£o especial</p>
        </div>
      </div>

      <!-- Cards de An√°lises Detalhadas -->
      <div class="settings-card mt-4">
        <h5>
          <i class='bx bx-chart-bar'></i> An√°lises Detalhadas
          <span class="tooltip-info">
            <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
            <span class="tooltip-text">Relat√≥rios avan√ßados com an√°lises estat√≠sticas e insights da biblioteca.</span>
          </span>
        </h5>
        
        <div class="report-type-cards mt-3">
          <div class="report-card" data-type="estatisticas">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class='bx bx-bar-chart-alt-2'></i>
            </div>
            <h4>Estat√≠sticas Gerais</h4>
            <p>An√°lise completa do acervo, empr√©stimos e usu√°rios com gr√°ficos e m√©tricas detalhadas</p>
          </div>
          
          <div class="report-card" data-type="tendencias">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
              <i class='bx bx-trending-up'></i>
            </div>
            <h4>An√°lise de Tend√™ncias</h4>
            <p>Identifica√ß√£o de padr√µes de empr√©stimo, livros mais populares e comportamento dos usu√°rios</p>
          </div>
          
          <div class="report-card" data-type="performance">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #FFD54F 0%, #FF9800 100%);">
              <i class='bx bx-line-chart'></i>
            </div>
            <h4>Performance da Biblioteca</h4>
            <p>M√©tricas de desempenho, rotatividade do acervo e efici√™ncia do sistema</p>
          </div>
          
          <div class="report-card" data-type="analytics">
            <div class="report-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
              <i class='bx bx-stats'></i>
            </div>
            <h4>Analytics Avan√ßado</h4>
            <p>An√°lises preditivas, correla√ß√µes e insights estrat√©gicos para gest√£o da biblioteca</p>
          </div>
        </div>
      </div>

      <!-- Campo oculto para manter compatibilidade -->
      <select class="form-select d-none" id="reportType" name="reportType">
        <option value="livros">Livros</option>
        <option value="usuarios">Usu√°rios</option>
        <option value="emprestimos">Empr√©stimos</option>
        <option value="leitores">Ranking de Leitores</option>
        <option value="advertencias">Advert√™ncias</option>
        <option value="estatisticas">Estat√≠sticas Gerais</option>
        <option value="tendencias">An√°lise de Tend√™ncias</option>
        <option value="performance">Performance da Biblioteca</option>
        <option value="analytics">Analytics Avan√ßado</option>
      </select>
    </div>

    <!-- Filtros e Configura√ß√µes -->
    <div class="settings-card">
      <h5>
        <i class='bx bx-filter-alt'></i> Filtros e Configura√ß√µes
        <span class="tooltip-info">
          <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #667eea;"></i>
          <span class="tooltip-text">Configure os filtros espec√≠ficos para personalizar seu relat√≥rio conforme suas necessidades.</span>
        </span>
      </h5>
      
      <div class="feature-highlight d-none" id="reportHelp">
        <h6><i class='bx bx-bulb'></i> Dica:</h6>
        <p id="reportHelpText">Selecione um tipo de relat√≥rio acima para ver as op√ß√µes de filtros dispon√≠veis.</p>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3 d-none" id="livrosFilters">
          <label class="form-label" for="livrosGenero">
            <i class='bx bx-category'></i> Filtrar por G√™nero
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Selecione um g√™nero espec√≠fico ou deixe "Todos" para incluir todos os g√™neros no relat√≥rio.</span>
            </span>
          </label>
          <select class="form-select" id="livrosGenero" name="livrosGenero">
            <option value="">Todos os G√™neros</option>
            <option value="AVENTURA">Aventura</option>
            <option value="AUTOAJUDA">Autoajuda</option>
            <option value="BIOGRAFIA">Biografia</option>
            <option value="CIENCIAS">Ci√™ncias</option>
            <option value="DRAMA">Drama</option>
            <option value="EDUCACAO">Educa√ß√£o</option>
            <option value="FANTASIA">Fantasia</option>
            <option value="FICCAO_CIENTIFICA">Fic√ß√£o Cient√≠fica</option>
            <option value="HISTORIA">Hist√≥ria</option>
            <option value="INFANTIL">Infantil</option>
            <option value="MISTERIO">Mist√©rio</option>
            <option value="OUTROS">Outros</option>
            <option value="POESIA">Poesia</option>
            <option value="ROMANCE">Romance</option>
            <option value="TECNOLOGIA">Tecnologia</option>
            <option value="TERROR">Terror</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="usuariosFilters">
          <label class="form-label" for="usuariosStatus">
            <i class='bx bx-user-check'></i> Status do Usu√°rio
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Filtre usu√°rios por status: Ativos (podem fazer empr√©stimos) ou Inativos (bloqueados).</span>
            </span>
          </label>
          <select class="form-select" id="usuariosStatus" name="usuariosStatus">
            <option value="">Todos os Status</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="emprestimosFilters">
          <label class="form-label" for="emprestimosSituacao">
            <i class='bx bx-time'></i> Situa√ß√£o
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Ativo: ainda n√£o devolvido | Finalizado: j√° devolvido | Atrasado: vencido</span>
            </span>
          </label>
          <select class="form-select" id="emprestimosSituacao" name="emprestimosSituacao">
            <option value="">Todas as Situa√ß√µes</option>
            <option value="Ativo">Ativo</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Atrasado">Atrasado</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="leitoresFilters">
          <label class="form-label" for="leitoresOrdem">
            <i class='bx bx-sort'></i> Ordena√ß√£o
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Escolha como ordenar o ranking: dos que mais leram para os que menos leram ou vice-versa.</span>
            </span>
          </label>
          <select class="form-select" id="leitoresOrdem" name="leitoresOrdem">
            <option value="desc">Maior para Menor</option>
            <option value="asc">Menor para Maior</option>
          </select>
        </div>
        
        <!-- Filtros para An√°lises Detalhadas -->
        <div class="col-md-3 d-none" id="estatisticasFilters">
          <label class="form-label" for="estatisticasPeriodo">
            <i class='bx bx-calendar'></i> Per√≠odo de An√°lise
          </label>
          <select class="form-select" id="estatisticasPeriodo" name="estatisticasPeriodo">
            <option value="atual">M√™s Atual</option>
            <option value="trimestre">√öltimo Trimestre</option>
            <option value="semestre">√öltimo Semestre</option>
            <option value="ano">√öltimo Ano</option>
            <option value="completo">Hist√≥rico Completo</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="tendenciasFilters">
          <label class="form-label" for="tendenciasMetrica">
            <i class='bx bx-trending-up'></i> M√©trica Principal
          </label>
          <select class="form-select" id="tendenciasMetrica" name="tendenciasMetrica">
            <option value="emprestimos">Tend√™ncia de Empr√©stimos</option>
            <option value="generos">Popularidade por G√™nero</option>
            <option value="usuarios">Atividade dos Usu√°rios</option>
            <option value="sazonalidade">An√°lise Sazonal</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="performanceFilters">
          <label class="form-label" for="performanceIndicador">
            <i class='bx bx-line-chart'></i> Indicador
          </label>
          <select class="form-select" id="performanceIndicador" name="performanceIndicador">
            <option value="rotatividade">Taxa de Rotatividade</option>
            <option value="tempo-medio">Tempo M√©dio de Empr√©stimo</option>
            <option value="eficiencia">Efici√™ncia do Sistema</option>
            <option value="satisfacao">√çndice de Satisfa√ß√£o</option>
          </select>
        </div>
        
        <div class="col-md-3 d-none" id="analyticsFilters">
          <label class="form-label" for="analyticsModelo">
            <i class='bx bx-stats'></i> Modelo de An√°lise
          </label>
          <select class="form-select" id="analyticsModelo" name="analyticsModelo">
            <option value="correlacao">An√°lise de Correla√ß√£o</option>
            <option value="predicao">Previs√µes Futuras</option>
            <option value="segmentacao">Segmenta√ß√£o de Usu√°rios</option>
            <option value="otimizacao">Sugest√µes de Otimiza√ß√£o</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <button class="btn btn-gradient w-100" id="btnGerarRelatorio" disabled>
            <i class='bx bx-search-alt'></i> Gerar Relat√≥rio
          </button>
        </div>
      </div>
      <!-- Filtros de data para empr√©stimos -->
      <div class="row g-3 align-items-end mt-2" id="emprestimosDateFilters" style="display: none;">
        <div class="col-md-3" id="emprestimosDataInicioFilter">
          <label class="form-label" for="dataInicio">
            <i class='bx bx-calendar'></i> Data In√≠cio
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empr√©stimos realizados a partir desta data ser√£o inclu√≠dos no relat√≥rio.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataInicio" name="dataInicio">
        </div>
        <div class="col-md-3" id="emprestimosDataFimFilter">
          <label class="form-label" for="dataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Empr√©stimos realizados at√© esta data ser√£o inclu√≠dos no relat√≥rio.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="dataFim" name="dataFim">
        </div>
        <div class="col-md-3">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF"><i class='bx bx-download'></i> Baixar PDF</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('dataInicio').value=''; document.getElementById('dataFim').value='';">
            <i class='bx bx-refresh'></i> Limpar Datas
          </button>
        </div>
      </div>
      <!-- Filtros de data para ranking de leitores -->
      <div class="row g-3 align-items-end mt-2" id="leitoresDateFilters" style="display: none;">
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataInicio">
            <i class='bx bx-calendar'></i> Data In√≠cio
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devolu√ß√µes realizadas a partir desta data ser√£o consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataInicio" name="leitoresDataInicio">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataFim">
            <i class='bx bx-calendar-check'></i> Data Fim
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Devolu√ß√µes realizadas at√© esta data ser√£o consideradas no ranking.</span>
            </span>
          </label>
          <input type="date" class="form-control" id="leitoresDataFim" name="leitoresDataFim">
        </div>
        <div class="col-md-2">
          <label class="form-label" for="leitoresLimite">
            <i class='bx bx-list-ol'></i> Limite de Resultados
            <span class="tooltip-info">
              <i class='bx bx-help-circle'></i>
              <span class="tooltip-text">Defina quantos leitores ser√£o exibidos no ranking (ex: Top 10, Top 20, etc.).</span>
            </span>
          </label>
          <select class="form-select" id="leitoresLimite" name="leitoresLimite">
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" id="btnBaixarPDFLeitores"><i class='bx bx-download'></i> PDF</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-light w-100" onclick="document.getElementById('leitoresDataInicio').value=''; document.getElementById('leitoresDataFim').value=''; document.getElementById('leitoresLimite').value='10';">
            <i class='bx bx-refresh'></i> Limpar
          </button>
        </div>
      </div>
      <!-- A√ß√µes para outros relat√≥rios -->
      <div class="row g-3 align-items-end mt-2" id="otherReportsActions">
        <div class="col-md-4">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF2">
            <i class='bx bx-download'></i> Baixar PDF
          </button>
        </div>
        <div class="col-md-8">
          <div class="feature-highlight">
            <h6><i class='bx bx-info-circle'></i> Dica de Exporta√ß√£o:</h6>
            <p class="mb-0">Ap√≥s gerar o relat√≥rio, clique em "Baixar PDF" para salvar uma vers√£o profissional do documento com o logo da escola.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Se√ß√£o de Resultados -->
    <div class="settings-card" id="reportResult">
      <div class="text-center py-5">
        <div class="mb-4">
          <i class='bx bx-file-blank' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
        </div>
        <h4 class="text-dark mb-3">Selecione um Tipo de Relat√≥rio</h4>
        <p class="text-muted mb-4">Escolha um dos cards acima para come√ßar a gerar seu relat√≥rio personalizado</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <div class="stats-card">
            <div class="stats-number">üìä</div>
            <div class="stats-label">An√°lises Detalhadas</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">üì±</div>
            <div class="stats-label">Interface Intuitiva</div>
          </div>
          <div class="stats-card">
            <div class="stats-number">üíæ</div>
            <div class="stats-label">Export em PDF</div>
          </div>
        </div>
      </div>
    </div>
    
    <span id="quantidadeLivros" style="display:none;"></span>
    </tbody>
    </table> 
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  let nomeEscola = 'Escola Exemplo';

  async function buscarEscolaUsuario() {
    if (auth.currentUser) {
      const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
      if (userDoc.exists && userDoc.data().escolaId) {
        const escolaDoc = await db.collection('escolas').doc(userDoc.data().escolaId).get();
        if (escolaDoc.exists && escolaDoc.data().nome) {
          nomeEscola = escolaDoc.data().nome;
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
    const reportType = document.getElementById('reportType');
    const reportResult = document.getElementById('reportResult');
    const btnBaixarPDF = document.getElementById('btnBaixarPDF');
    const reportCards = document.querySelectorAll('.report-card');
    const reportHelp = document.getElementById('reportHelp');
    const reportHelpText = document.getElementById('reportHelpText');

    // Textos de ajuda para cada tipo de relat√≥rio
    const helpTexts = {
      livros: "Este relat√≥rio mostra todos os livros do acervo. Voc√™ pode filtrar por g√™nero espec√≠fico para an√°lises mais direcionadas.",
      usuarios: "Lista todos os usu√°rios cadastrados no sistema. Filtre por status para ver apenas usu√°rios ativos ou inativos.",
      emprestimos: "Mostra o hist√≥rico completo de empr√©stimos. Use os filtros de data e situa√ß√£o para an√°lises espec√≠ficas de per√≠odo.",
      leitores: "Ranking dos usu√°rios mais ativos na biblioteca. Configure o per√≠odo e a quantidade de resultados para an√°lises customizadas.",
      advertencias: "Relat√≥rio de empr√©stimos em atraso para acompanhamento pedag√≥gico e gest√£o da biblioteca.",
      estatisticas: "An√°lise estat√≠stica completa da biblioteca com m√©tricas de acervo, usu√°rios e empr√©stimos em formato visual.",
      tendencias: "Identifica√ß√£o de padr√µes sazonais, livros em alta e comportamento dos usu√°rios ao longo do tempo.",
      performance: "M√©tricas de desempenho da biblioteca incluindo taxa de rotatividade, tempo m√©dio de empr√©stimo e efici√™ncia.",
      analytics: "An√°lises avan√ßadas com correla√ß√µes, previs√µes e insights estrat√©gicos para tomada de decis√µes."
    };

    // Fun√ß√£o para atualizar o card ativo
    function updateActiveCard(type) {
      reportCards.forEach(card => {
        card.classList.remove('active');
        if (card.dataset.type === type) {
          card.classList.add('active');
        }
      });
      
      // Atualizar o select oculto para manter compatibilidade
      reportType.value = type;
      
      // Mostrar ajuda espec√≠fica
      if (helpTexts[type]) {
        reportHelpText.textContent = helpTexts[type];
        reportHelp.classList.remove('d-none');
      }
      
      // Habilitar o bot√£o de gerar relat√≥rio
      btnGerarRelatorio.disabled = false;
      btnGerarRelatorio.innerHTML = '<i class="bx bx-search-alt"></i> Gerar Relat√≥rio';
      
      // Disparar evento de mudan√ßa para mostrar filtros
      reportType.dispatchEvent(new Event('change'));
    }

    // Event listeners para os cards de relat√≥rio
    reportCards.forEach(card => {
      card.addEventListener('click', function() {
        const type = this.dataset.type;
        updateActiveCard(type);
        
        // Anima√ß√£o de feedback visual
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = '';
        }, 150);
      });
    });

    // Inicializar com o primeiro tipo (livros) por padr√£o
    updateActiveCard('livros');

    btnGerarRelatorio.addEventListener('click', async function () {
      // Anima√ß√£o de loading
      const originalText = this.innerHTML;
      this.innerHTML = '<span class="loading-spinner"></span>Gerando...';
      this.disabled = true;
      
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
          <h5 class="text-dark">Carregando dados...</h5>
          <p class="text-muted">Por favor, aguarde enquanto processamos as informa√ß√µes</p>
        </div>
      `;
      
      let html = '';

      try {
        if (reportType.value === 'livros') {
          const genero = document.getElementById('livrosGenero').value;
          let query = db.collection('livros');
          if (genero) {
            query = query.where('genero', '==', genero);
          }

          const snapshot = await query.get();
          if (snapshot.empty) {
            html = `
              <div class="text-center py-5">
                <i class='bx bx-book' style="font-size: 4rem; color: #64748b; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Nenhum livro encontrado</h5>
                <p class="text-muted">N√£o h√° livros cadastrados com os filtros selecionados.</p>
              </div>
            `;
          }
          else {
            // Ordena os livros por t√≠tulo (alfab√©tico)
            const livrosOrdenados = snapshot.docs
              .map(doc => doc.data())
              .sort((a, b) => (a.titulo || '').localeCompare(b.titulo || '', 'pt-BR', { sensitivity: 'base' }));

            // Estat√≠sticas resumidas no topo
            const totalLivros = snapshot.size;
            const totalExemplares = livrosOrdenados.reduce((total, l) => total + (l.quantidade || 0), 0);
            const disponiveis = livrosOrdenados.reduce((total, l) => total + (l.quantidadeDisponivel || 0), 0);
            const emprestados = livrosOrdenados.reduce((total, l) => total + (l.emprestados || 0), 0);

            html = `
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalLivros}</div>
                    <div class="stats-label">T√≠tulos Cadastrados</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number">${totalExemplares}</div>
                    <div class="stats-label">Total de Exemplares</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #28a745;">${disponiveis}</div>
                    <div class="stats-label">Dispon√≠veis</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card">
                    <div class="stats-number" style="color: #ffc107;">${emprestados}</div>
                    <div class="stats-label">Emprestados</div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead>
                    <tr>
                      <th><i class='bx bx-book'></i> T√≠tulo</th>
                      <th><i class='bx bx-user'></i> Autor</th>
                      <th><i class='bx bx-category'></i> G√™nero</th>
                      <th><i class='bx bx-package'></i> Qtd Total</th>
                      <th><i class='bx bx-check-circle'></i> Dispon√≠vel</th>
                      <th><i class='bx bx-bookmark'></i> Emprestados</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            livrosOrdenados.forEach(l => {
              const quantidade = l.quantidade || 0;
              const disponivel = l.quantidadeDisponivel || 0;
              const emprestados = l.emprestados || 0;
              const autores = Array.isArray(l.autores) ? l.autores.join(', ') : (l.autores || l.autor || 'Autor n√£o informado');
              
              // Cor baseada na disponibilidade
              let rowClass = '';
              if (disponivel === 0 && quantidade > 0) rowClass = 'table-warning'; // Todos emprestados
              else if (quantidade === 0) rowClass = 'table-secondary'; // Sem exemplares

              html += `
                <tr class="${rowClass}">
                  <td><strong>${l.titulo || 'Sem t√≠tulo'}</strong></td>
                  <td>${autores}</td>
                  <td>
                    <span class="badge bg-secondary">${l.genero || 'N√£o informado'}</span>
                  </td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">
                    <span class="badge ${disponivel > 0 ? 'bg-success' : 'bg-warning'}">${disponivel}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge ${emprestados > 0 ? 'bg-primary' : 'bg-light text-dark'}">${emprestados}</span>
                  </td>
                </tr>
              `;
            });
            html += '</tbody></table></div>';

            // Adicionar informa√ß√µes adicionais
            if (genero) {
              html += `
                <div class="feature-highlight mt-4">
                  <h6><i class='bx bx-filter'></i> Filtro Aplicado:</h6>
                  <p>Mostrando apenas livros do g√™nero: <strong>${genero}</strong></p>
                </div>
              `;
            }
          }
        }

        if (reportType.value === 'usuarios') {
        const status = document.getElementById('usuariosStatus').value;
        let query = db.collection('usuarios');
        if (status) {
          query = query.where('status', '==', status);
        }

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum usu√°rio encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Nome</th><th>Email</th><th>Matr√≠cula</th><th>Fun√ß√£o</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            snapshot.forEach(doc => {
              const u = doc.data();
              html += `
                <tr>
                  <td>${u.nome || 'Nome n√£o informado'}</td>
                  <td>${u.email || 'Email n√£o informado'}</td>
                  <td>${u.matricula || 'N√£o informado'}</td>
                  <td>${u.funcao || u.papel || 'N√£o informado'}</td>
                  <td><span class="badge ${(u.status === 'Ativo' || !u.status) ? 'bg-success' : 'bg-secondary'}">${u.status || 'Ativo'}</span></td>
                </tr>
              `;
            });
            html += '</tbody></table>';
            
            // Adiciona estat√≠sticas resumidas
            html += `
              <div class="mt-3">
                <h5>Resumo:</h5>
                <p><strong>Total de usu√°rios:</strong> ${snapshot.size}</p>
              </div>
            `;
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar usu√°rios: ${error.message}</p>`;
          console.error('Erro ao buscar usu√°rios:', error);
        }
      }

      if (reportType.value === 'emprestimos') {
        const situacaoFiltro = document.getElementById('emprestimosSituacao').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        let query = db.collection('emprestimos');

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum empr√©stimo encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Usu√°rio</th><th>Livro(s)</th><th>Data Empr√©stimo</th><th>Data Devolu√ß√£o</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // Converter datas do filtro para objetos Date para compara√ß√£o
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }
            
            let emprestimosExibidos = 0;
            
            for (const doc of snapshot.docs) {
              const e = doc.data();
              
              // Filtro por data
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                // Converter data do empr√©stimo para Date
                let dataEmprestimoObj = null;
                if (e.loanDate) {
                  const dateParts = e.loanDate.split('/');
                  if (dateParts.length === 3) {
                    dataEmprestimoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataEmprestimoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataEmprestimoObj) {
                  if (dataInicioObj && dataEmprestimoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataEmprestimoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se n√£o conseguir converter a data, n√£o exibe se h√° filtro de data
                  if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;
              
              // Buscar nome do usu√°rio
              let nomeUsuario = 'Usu√°rio n√£o encontrado';
              try {
                if (e.userId) {
                  const userDoc = await db.collection('usuarios').doc(e.userId).get();
                  if (userDoc.exists) {
                    nomeUsuario = userDoc.data().nome || 'Nome n√£o informado';
                  }
                }
              } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
              }

              // Buscar nomes dos livros
              let nomesLivros = 'Livros n√£o encontrados';
              try {
                if (Array.isArray(e.books)) {
                  const livrosPromises = e.books.map(async (book) => {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    const livroData = livroDoc.exists ? livroDoc.data() : null;
                    const titulo = livroData ? livroData.titulo : book.bookId;
                    return `${titulo} (Qtd: ${book.quantity})`;
                  });
                  const livrosArray = await Promise.all(livrosPromises);
                  nomesLivros = livrosArray.join(', ');
                }
              } catch (error) {
                console.error('Erro ao buscar livros:', error);
              }

              // Determinar status real
              let statusAtual = e.status || 'EMPRESTADO';
              
              // Verificar se est√° atrasado baseado na data
              if (e.returnDate && (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO')) {
                const dateParts = e.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    statusAtual = 'ATRASADO';
                  }
                }
              }

              // Mapear status para filtro
              let statusFiltro = '';
              if (statusAtual === 'EMPRESTADO') statusFiltro = 'Ativo';
              else if (statusAtual === 'ATRASADO') statusFiltro = 'Atrasado';
              else if (statusAtual === 'DEVOLVIDO') statusFiltro = 'Finalizado';

              // Aplicar filtro de situa√ß√£o
              if (situacaoFiltro && situacaoFiltro !== statusFiltro) {
                continue; // Pula este empr√©stimo
              }

              emprestimosExibidos++;

              html += `
                <tr>
                  <td>${nomeUsuario}</td>
                  <td>${nomesLivros}</td>
                  <td>${e.loanDate || 'Data n√£o informada'}</td>
                  <td>${e.returnDate || 'Data n√£o informada'}</td>
                  <td><span class="badge ${statusAtual === 'DEVOLVIDO' ? 'bg-success' : statusAtual === 'ATRASADO' ? 'bg-danger' : 'bg-primary'}">${statusAtual}</span></td>
                </tr>
              `;
            }
            
            if (emprestimosExibidos === 0) {
              html = '<p>Nenhum empr√©stimo encontrado com os filtros selecionados.</p>';
            } else {
              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas
              html += `
                <div class="mt-3">
                  <h5>Resumo:</h5>
                  <p><strong>Total de empr√©stimos encontrados:</strong> ${emprestimosExibidos}</p>
                  <p><strong>Total de empr√©stimos no sistema:</strong> ${snapshot.size}</p>
                  ${dataInicio || dataFim ? `<p><strong>Per√≠odo:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'In√≠cio'} at√© ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar empr√©stimos: ${error.message}</p>`;
          console.error('Erro ao buscar empr√©stimos:', error);
        }
      }

      if (reportType.value === 'advertencias') {
        try {
          const snapshotEmprestimos = await db.collection('emprestimos').get();
          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum empr√©stimo encontrado para verificar advert√™ncias.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Data Empr√©stimo</th>
                    <th>Data Prevista Devolu√ß√£o</th>
                    <th>Usu√°rio</th>
                    <th>Livro(s)</th>
                    <th>Dias de Atraso</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(23, 59, 59, 999); // Fim do dia atual
            
            let totalAdvertencias = 0;
            
            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Verificar apenas empr√©stimos ativos ou j√° marcados como atrasados
              if (emprestimo.status === 'DEVOLVIDO') {
                continue;
              }
              
              // Calcular dias de atraso
              let diasAtraso = 0;
              let dataVencimento = null;
              let statusEmprestimo = emprestimo.status || 'EMPRESTADO';
              
              if (emprestimo.returnDate) {
                const dateParts = emprestimo.returnDate.split('/');
                if (dateParts.length === 3) {
                  dataVencimento = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  dataVencimento.setHours(23, 59, 59, 999);
                  
                  if (hoje > dataVencimento) {
                    const diffTime = hoje.getTime() - dataVencimento.getTime();
                    diasAtraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    statusEmprestimo = 'ATRASADO';
                  }
                }
              }
              
              // S√≥ exibe se houver atraso (advert√™ncia)
              if (diasAtraso > 0) {
                totalAdvertencias++;
                
                // Buscar nome do usu√°rio
                let nomeUsuario = 'Usu√°rio n√£o encontrado';
                let matriculaUsuario = '';
                try {
                  if (emprestimo.userId) {
                    const userDoc = await db.collection('usuarios').doc(emprestimo.userId).get();
                    if (userDoc.exists) {
                      const userData = userDoc.data();
                      nomeUsuario = userData.nome || 'Nome n√£o informado';
                      matriculaUsuario = userData.matricula ? ` (Mat: ${userData.matricula})` : '';
                    }
                  }
                } catch (error) {
                  console.error('Erro ao buscar usu√°rio:', error);
                }

                // Buscar nomes dos livros
                let nomesLivros = 'Livros n√£o encontrados';
                try {
                  if (Array.isArray(emprestimo.books)) {
                    const livrosPromises = emprestimo.books.map(async (book) => {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      const livroData = livroDoc.exists ? livroDoc.data() : null;
                      const titulo = livroData ? livroData.titulo : book.bookId;
                      return `${titulo} (Qtd: ${book.quantity})`;
                    });
                    const livrosArray = await Promise.all(livrosPromises);
                    nomesLivros = livrosArray.join('<br>');
                  }
                } catch (error) {
                  console.error('Erro ao buscar livros:', error);
                }

                // Calcular quantidade de livros para informa√ß√£o
                const quantidadeLivros = Array.isArray(emprestimo.books) 
                  ? emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0)
                  : 1;

                // Definir cor do badge baseado nos dias de atraso
                let badgeClass = 'bg-warning';
                if (diasAtraso > 15) badgeClass = 'bg-danger';
                else if (diasAtraso > 7) badgeClass = 'bg-warning';
                else badgeClass = 'bg-info';

                html += `
                  <tr class="${diasAtraso > 15 ? 'table-danger' : diasAtraso > 7 ? 'table-warning' : ''}">
                    <td>${emprestimo.loanDate || 'Data n√£o informada'}</td>
                    <td>${emprestimo.returnDate || 'Data n√£o informada'}</td>
                    <td>
                      <strong>${nomeUsuario}</strong>${matriculaUsuario}
                    </td>
                    <td style="max-width: 200px;">${nomesLivros}</td>
                    <td>
                      <span class="badge ${badgeClass} fs-6">
                        ${diasAtraso} dia${diasAtraso > 1 ? 's' : ''}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-danger">ATRASADO</span>
                    </td>
                  </tr>
                `;
              }
            }
            
            if (totalAdvertencias === 0) {
              html = `
                <div class="alert alert-success">
                  <h5><i class='bx bx-check-circle'></i> Parab√©ns!</h5>
                  <p class="mb-0">N√£o h√° empr√©stimos em atraso no momento. Todos os usu√°rios est√£o em dia com suas devolu√ß√µes.</p>
                </div>
              `;
            } else {
              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas com alertas coloridos
              html += `
                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="alert alert-danger">
                      <h6><i class='bx bx-error-circle'></i> Total de Advert√™ncias</h6>
                      <h4 class="mb-0">${totalAdvertencias}</h4>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="alert alert-info">
                      <h6><i class='bx bx-calendar'></i> Data da Consulta</h6>
                      <h6 class="mb-0">${hoje.toLocaleDateString('pt-BR')}</h6>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <h5>Legenda de Gravidade:</h5>
                  <div class="d-flex flex-wrap gap-3">
                    <span><span class="badge bg-info">1-7 dias</span> Atraso Leve</span>
                    <span><span class="badge bg-warning">8-15 dias</span> Atraso Moderado</span>
                    <span><span class="badge bg-danger">16+ dias</span> Atraso Grave</span>
                  </div>
                  <small class="text-muted mt-2 d-block">
                    <strong>Nota:</strong> As advert√™ncias servem como orienta√ß√£o pedag√≥gica para conscientiza√ß√£o sobre a import√¢ncia da devolu√ß√£o no prazo.
                  </small>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar advert√™ncias: ${error.message}</p>`;
          console.error('Erro ao buscar advert√™ncias:', error);
        }
      }

      if (reportType.value === 'leitores') {
        const ordem = document.getElementById('leitoresOrdem').value;
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;

        try {
          const snapshotEmprestimos = await db.collection('emprestimos')
            .where('status', '==', 'DEVOLVIDO')
            .get();

          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum livro foi devolvido ainda para gerar o ranking de leitores.</p>';
          } else {
            // Converter datas do filtro para objetos Date para compara√ß√£o
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }

            // Mapa para contar livros por usu√°rio
            const leitoresPorUsuario = new Map();

            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Filtro por data de devolu√ß√£o real
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                let dataDevolucaoObj = null;
                if (emprestimo.actualReturnDate) {
                  const dateParts = emprestimo.actualReturnDate.split('/');
                  if (dateParts.length === 3) {
                    dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataDevolucaoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataDevolucaoObj) {
                  if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se n√£o h√° data de devolu√ß√£o real, usar data de empr√©stimo como fallback
                  if (emprestimo.loanDate) {
                    const dateParts = emprestimo.loanDate.split('/');
                    if (dateParts.length === 3) {
                      dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                      dataDevolucaoObj.setHours(0, 0, 0, 0);
                      
                      if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                        passaFiltroPorData = false;
                      }
                      if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                        passaFiltroPorData = false;
                      }
                    } else if (dataInicioObj || dataFimObj) {
                      passaFiltroPorData = false;
                    }
                  } else if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;

              // Contar livros por usu√°rio
              if (Array.isArray(emprestimo.books)) {
                const totalLivros = emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0);
                
                if (leitoresPorUsuario.has(emprestimo.userId)) {
                  leitoresPorUsuario.get(emprestimo.userId).totalLivros += totalLivros;
                  leitoresPorUsuario.get(emprestimo.userId).emprestimos += 1;
                } else {
                  leitoresPorUsuario.set(emprestimo.userId, {
                    userId: emprestimo.userId,
                    totalLivros: totalLivros,
                    emprestimos: 1,
                    nomeUsuario: 'Carregando...',
                    matriculaUsuario: '',
                    funcaoUsuario: ''
                  });
                }
              }
            }

            // Buscar dados dos usu√°rios
            for (const [userId, userData] of leitoresPorUsuario) {
              try {
                const userDoc = await db.collection('usuarios').doc(userId).get();
                if (userDoc.exists) {
                  const user = userDoc.data();
                  userData.nomeUsuario = user.nome || 'Nome n√£o informado';
                  userData.matriculaUsuario = user.matricula || '';
                  userData.funcaoUsuario = user.funcao || user.papel || '';
                }
              } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
                userData.nomeUsuario = 'Erro ao carregar';
              }
            }

            // Converter para array e ordenar
            let leitoresArray = Array.from(leitoresPorUsuario.values());
            
            // Ordenar por total de livros
            if (ordem === 'desc') {
              leitoresArray.sort((a, b) => b.totalLivros - a.totalLivros);
            } else {
              leitoresArray.sort((a, b) => a.totalLivros - b.totalLivros);
            }

            // Aplicar limite se especificado
            if (limite && parseInt(limite) > 0) {
              leitoresArray = leitoresArray.slice(0, parseInt(limite));
            }

            if (leitoresArray.length === 0) {
              html = '<p>Nenhum leitor encontrado com os filtros selecionados.</p>';
            } else {
              html = `
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card text-center border-success">
                      <div class="card-body">
                        <h4 class="text-success mb-1">${leitoresArray.length}</h4>
                        <small class="text-muted">Leitores Ativos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-primary">
                      <div class="card-body">
                        <h4 class="text-primary mb-1">${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</h4>
                        <small class="text-muted">Total de Livros Lidos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-warning">
                      <div class="card-body">
                        <h4 class="text-warning mb-1">${Math.round(leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0) / leitoresArray.length)}</h4>
                        <small class="text-muted">M√©dia por Leitor</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <table class="table table-bordered table-sm">
                  <thead class="table-primary">
                    <tr>
                      <th>Posi√ß√£o</th>
                      <th>Nome</th>
                      <th>Matr√≠cula</th>
                      <th>Fun√ß√£o</th>
                      <th>Livros Lidos</th>
                      <th>Empr√©stimos</th>
                      <th>M√©dia por Empr√©stimo</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              leitoresArray.forEach((leitor, index) => {
                const posicao = index + 1;
                const mediaPorEmprestimo = (leitor.totalLivros / leitor.emprestimos).toFixed(1);
                
                // Definir classe CSS baseada na posi√ß√£o
                let rowClass = '';
                if (posicao === 1) rowClass = 'table-warning'; // Ouro
                else if (posicao === 2) rowClass = 'table-secondary'; // Prata
                else if (posicao === 3) rowClass = 'table-info'; // Bronze

                // √çcone de medalha para os 3 primeiros
                let medalha = '';
                if (posicao === 1) medalha = 'ü•á';
                else if (posicao === 2) medalha = 'ü•à';
                else if (posicao === 3) medalha = 'ü•â';

                html += `
                  <tr class="${rowClass}">
                    <td class="text-center">
                      <strong>${medalha} ${posicao}¬∫</strong>
                    </td>
                    <td><strong>${leitor.nomeUsuario}</strong></td>
                    <td>${leitor.matriculaUsuario || 'N/A'}</td>
                    <td>${leitor.funcaoUsuario || 'N/A'}</td>
                    <td class="text-center">
                      <span class="badge bg-success fs-6">${leitor.totalLivros}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary">${leitor.emprestimos}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">${mediaPorEmprestimo}</span>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas
              html += `
                <div class="mt-4">
                  <h5>Resumo do Ranking:</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Total de leitores encontrados:</strong> ${leitoresArray.length}</p>
                      <p><strong>Livros lidos no per√≠odo:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Empr√©stimos conclu√≠dos:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.emprestimos, 0)}</p>
                      ${dataInicio || dataFim ? `<p><strong>Per√≠odo:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'In√≠cio'} at√© ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                    </div>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <h6><i class='bx bx-info-circle'></i> Como interpretar este ranking:</h6>
                    <ul class="mb-0">
                      <li><strong>Livros Lidos:</strong> Total de livros devolvidos pelo usu√°rio</li>
                      <li><strong>Empr√©stimos:</strong> N√∫mero de vezes que o usu√°rio fez empr√©stimos</li>
                      <li><strong>M√©dia por Empr√©stimo:</strong> Quantos livros em m√©dia o usu√°rio l√™ por empr√©stimo</li>
                      <li><strong>ü•áü•àü•â:</strong> Medalhas para os 3 primeiros colocados</li>
                    </ul>
                  </div>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar ranking de leitores: ${error.message}</p>`;
          console.error('Erro ao buscar ranking de leitores:', error);
        }
      }

      // Relat√≥rios de An√°lises Detalhadas
      if (reportType.value === 'estatisticas') {
        try {
          const periodo = document.getElementById('estatisticasPeriodo').value;
          
          // Buscar dados de todas as cole√ß√µes
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          // Calcular estat√≠sticas dos livros
          const totalLivros = livrosSnapshot.size;
          const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.quantidade || 0);
          }, 0);
          
          const exemplariesDisponiveis = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.quantidadeDisponivel || 0);
          }, 0);
          
          const exemplariesEmprestados = livrosSnapshot.docs.reduce((total, doc) => {
            const livro = doc.data();
            return total + (livro.emprestados || 0);
          }, 0);

          // An√°lise por g√™neros
          const generos = {};
          livrosSnapshot.docs.forEach(doc => {
            const livro = doc.data();
            const genero = livro.genero || 'N√£o classificado';
            if (!generos[genero]) {
              generos[genero] = { titulos: 0, exemplares: 0 };
            }
            generos[genero].titulos++;
            generos[genero].exemplares += (livro.quantidade || 0);
          });

          // Estat√≠sticas dos usu√°rios
          const totalUsuarios = usuariosSnapshot.size;
          const usuariosAtivos = usuariosSnapshot.docs.filter(doc => {
            const usuario = doc.data();
            return !usuario.status || usuario.status === 'Ativo';
          }).length;

          // An√°lise por fun√ß√£o
          const funcoes = {};
          usuariosSnapshot.docs.forEach(doc => {
            const usuario = doc.data();
            const funcao = usuario.funcao || usuario.papel || 'N√£o informado';
            funcoes[funcao] = (funcoes[funcao] || 0) + 1;
          });

          // Estat√≠sticas dos empr√©stimos
          const totalEmprestimos = emprestimosSnapshot.size;
          const emprestimosAtivos = emprestimosSnapshot.docs.filter(doc => {
            const emp = doc.data();
            return emp.status !== 'DEVOLVIDO';
          }).length;
          
          const emprestimosFinalizados = emprestimosSnapshot.docs.filter(doc => {
            const emp = doc.data();
            return emp.status === 'DEVOLVIDO';
          }).length;

          // Calcular empr√©stimos atrasados
          const hoje = new Date();
          hoje.setHours(0, 0, 0, 0);
          let emprestimosAtrasados = 0;
          
          emprestimosSnapshot.docs.forEach(doc => {
            const emp = doc.data();
            if (emp.status !== 'DEVOLVIDO' && emp.returnDate) {
              const dateParts = emp.returnDate.split('/');
              if (dateParts.length === 3) {
                const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                returnDate.setHours(0, 0, 0, 0);
                if (returnDate < hoje) {
                  emprestimosAtrasados++;
                }
              }
            }
          });

          // Taxa de rotatividade
          const taxaRotatividade = totalExemplares > 0 ? ((emprestimosFinalizados / totalExemplares) * 100).toFixed(1) : 0;
          
          // Taxa de ocupa√ß√£o
          const taxaOcupacao = totalExemplares > 0 ? ((exemplariesEmprestados / totalExemplares) * 100).toFixed(1) : 0;

          html = `
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3">
                <i class='bx bx-bar-chart-alt-2' style="font-size: 2rem; color: #667eea; margin-right: 10px;"></i>
                <h4 class="text-dark mb-0">Estat√≠sticas Gerais da Biblioteca</h4>
              </div>
              <p class="text-muted">Per√≠odo: ${periodo === 'completo' ? 'Hist√≥rico Completo' : periodo.charAt(0).toUpperCase() + periodo.slice(1)}</p>
            </div>

            <!-- Indicadores Principais -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #667eea;">${totalLivros}</div>
                  <div class="stats-label">T√≠tulos Cadastrados</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #4facfe;">${totalExemplares}</div>
                  <div class="stats-label">Total de Exemplares</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #28a745;">${usuariosAtivos}</div>
                  <div class="stats-label">Usu√°rios Ativos</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <div class="stats-number" style="color: #ffc107;">${totalEmprestimos}</div>
                  <div class="stats-label">Total Empr√©stimos</div>
                </div>
              </div>
            </div>

            <!-- M√©tricas de Performance -->
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="alert alert-info">
                  <h6><i class='bx bx-trending-up'></i> Taxa de Rotatividade</h6>
                  <h4 class="mb-0">${taxaRotatividade}%</h4>
                  <small>Empr√©stimos por exemplar</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="alert alert-success">
                  <h6><i class='bx bx-check-circle'></i> Taxa de Ocupa√ß√£o</h6>
                  <h4 class="mb-0">${taxaOcupacao}%</h4>
                  <small>Exemplares em empr√©stimo</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="alert ${emprestimosAtrasados > 0 ? 'alert-warning' : 'alert-success'}">
                  <h6><i class='bx bx-time'></i> Empr√©stimos Atrasados</h6>
                  <h4 class="mb-0">${emprestimosAtrasados}</h4>
                  <small>Requerem aten√ß√£o</small>
                </div>
              </div>
            </div>

            <!-- Distribui√ß√£o por G√™neros -->
            <div class="row mb-4">
              <div class="col-md-6">
                <h5><i class='bx bx-category'></i> Distribui√ß√£o por G√™neros</h5>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-primary">
                      <tr>
                        <th>G√™nero</th>
                        <th class="text-center">T√≠tulos</th>
                        <th class="text-center">Exemplares</th>
                        <th class="text-center">% do Acervo</th>
                      </tr>
                    </thead>
                    <tbody>
          `;
          
          Object.entries(generos)
            .sort((a, b) => b[1].exemplares - a[1].exemplares)
            .slice(0, 8)
            .forEach(([genero, dados]) => {
              const percentual = ((dados.exemplares / totalExemplares) * 100).toFixed(1);
              html += `
                <tr>
                  <td><strong>${genero}</strong></td>
                  <td class="text-center">${dados.titulos}</td>
                  <td class="text-center">${dados.exemplares}</td>
                  <td class="text-center">
                    <span class="badge bg-primary">${percentual}%</span>
                  </td>
                </tr>
              `;
            });

          html += `
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="col-md-6">
                <h5><i class='bx bx-group'></i> Usu√°rios por Fun√ß√£o</h5>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-success">
                      <tr>
                        <th>Fun√ß√£o</th>
                        <th class="text-center">Quantidade</th>
                        <th class="text-center">% do Total</th>
                      </tr>
                    </thead>
                    <tbody>
          `;
          
          Object.entries(funcoes)
            .sort((a, b) => b[1] - a[1])
            .forEach(([funcao, quantidade]) => {
              const percentual = ((quantidade / totalUsuarios) * 100).toFixed(1);
              html += `
                <tr>
                  <td><strong>${funcao}</strong></td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">
                    <span class="badge bg-success">${percentual}%</span>
                  </td>
                </tr>
              `;
            });

          html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Status dos Empr√©stimos -->
            <div class="row">
              <div class="col-12">
                <h5><i class='bx bx-bookmark'></i> Status dos Empr√©stimos</h5>
                <div class="row">
                  <div class="col-md-4">
                    <div class="card border-primary">
                      <div class="card-body text-center">
                        <i class='bx bx-book-open' style="font-size: 2rem; color: #007bff;"></i>
                        <h4 class="text-primary">${emprestimosAtivos}</h4>
                        <p class="card-text">Empr√©stimos Ativos</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-success">
                      <div class="card-body text-center">
                        <i class='bx bx-check-circle' style="font-size: 2rem; color: #28a745;"></i>
                        <h4 class="text-success">${emprestimosFinalizados}</h4>
                        <p class="card-text">Devolu√ß√µes Realizadas</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-warning">
                      <div class="card-body text-center">
                        <i class='bx bx-time' style="font-size: 2rem; color: #ffc107;"></i>
                        <h4 class="text-warning">${emprestimosAtrasados}</h4>
                        <p class="card-text">Em Atraso</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="alert alert-info mt-4">
              <h6><i class='bx bx-info-circle'></i> Interpreta√ß√£o dos Dados:</h6>
              <ul class="mb-0">
                <li><strong>Taxa de Rotatividade:</strong> Indica quantas vezes cada exemplar foi emprestado. Valores altos indicam boa circula√ß√£o do acervo.</li>
                <li><strong>Taxa de Ocupa√ß√£o:</strong> Percentual do acervo atualmente emprestado. Ideal entre 60-80%.</li>
                <li><strong>Distribui√ß√£o por G√™neros:</strong> Ajuda a identificar lacunas ou excessos no acervo.</li>
              </ul>
            </div>
          `;

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar estat√≠sticas: ${error.message}</p>`;
          console.error('Erro ao buscar estat√≠sticas:', error);
        }
      }

      if (reportType.value === 'tendencias') {
        try {
          const metrica = document.getElementById('tendenciasMetrica').value;
          
          // Buscar dados necess√°rios
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (metrica === 'emprestimos') {
            // An√°lise de Tend√™ncias de Empr√©stimos
            const tendenciasMensais = {};
            const hoje = new Date();
            
            // Inicializar √∫ltimos 12 meses
            for (let i = 11; i >= 0; i--) {
              const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
              const chave = `${data.getFullYear()}-${(data.getMonth() + 1).toString().padStart(2, '0')}`;
              tendenciasMensais[chave] = {
                emprestimos: 0,
                devolucoes: 0,
                nome: data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
              };
            }

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const chave = `${dateParts[2]}-${dateParts[1]}`;
                  if (tendenciasMensais[chave]) {
                    tendenciasMensais[chave].emprestimos++;
                    if (emp.status === 'DEVOLVIDO') {
                      tendenciasMensais[chave].devolucoes++;
                    }
                  }
                }
              }
            });

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-trending-up' style="font-size: 2rem; color: #4facfe; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">An√°lise de Tend√™ncias - Empr√©stimos</h4>
                </div>
                <p class="text-muted">Evolu√ß√£o mensal dos empr√©stimos nos √∫ltimos 12 meses</p>
              </div>

              <!-- Gr√°fico de Tend√™ncias -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-line-chart'></i> Evolu√ß√£o Mensal</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>M√™s</th>
                          <th class="text-center">Empr√©stimos</th>
                          <th class="text-center">Devolu√ß√µes</th>
                          <th class="text-center">Taxa de Devolu√ß√£o</th>
                          <th class="text-center">Tend√™ncia</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const meses = Object.keys(tendenciasMensais).sort();
            const valores = meses.map(m => tendenciasMensais[m].emprestimos);
            
            meses.forEach((chave, index) => {
              const dados = tendenciasMensais[chave];
              const taxaDevolucao = dados.emprestimos > 0 ? ((dados.devolucoes / dados.emprestimos) * 100).toFixed(1) : 0;
              
              let tendencia = '‚û°Ô∏è';
              if (index > 0) {
                const anterior = valores[index - 1];
                const atual = valores[index];
                if (atual > anterior) tendencia = 'üìà';
                else if (atual < anterior) tendencia = 'üìâ';
              }

              html += `
                <tr>
                  <td><strong>${dados.nome}</strong></td>
                  <td class="text-center">${dados.emprestimos}</td>
                  <td class="text-center">${dados.devolucoes}</td>
                  <td class="text-center">
                    <span class="badge ${taxaDevolucao > 80 ? 'bg-success' : taxaDevolucao > 60 ? 'bg-warning' : 'bg-danger'}">${taxaDevolucao}%</span>
                  </td>
                  <td class="text-center" style="font-size: 1.2rem;">${tendencia}</td>
                </tr>
              `;
            });

            // Calcular estat√≠sticas
            const totalEmprestimos = valores.reduce((a, b) => a + b, 0);
            const mediaEmprestimos = (totalEmprestimos / valores.length).toFixed(1);
            const maxEmprestimos = Math.max(...valores);
            const minEmprestimos = Math.min(...valores);
            const crescimentoTotal = valores.length > 1 ? ((valores[valores.length - 1] - valores[0]) / valores[0] * 100).toFixed(1) : 0;

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Estat√≠sticas da Tend√™ncia -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #4facfe;">${totalEmprestimos}</div>
                    <div class="stats-label">Total no Per√≠odo</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${mediaEmprestimos}</div>
                    <div class="stats-label">M√©dia Mensal</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #ffc107;">${maxEmprestimos}</div>
                    <div class="stats-label">Pico M√°ximo</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: ${crescimentoTotal >= 0 ? '#28a745' : '#dc3545'};">${crescimentoTotal}%</div>
                    <div class="stats-label">Crescimento Total</div>
                  </div>
                </div>
              </div>

              <!-- Insights -->
              <div class="alert alert-info">
                <h6><i class='bx bx-lightbulb'></i> Insights Identificados:</h6>
                <ul class="mb-0">
                  <li><strong>Per√≠odo de Pico:</strong> ${meses[valores.indexOf(maxEmprestimos)] ? tendenciasMensais[meses[valores.indexOf(maxEmprestimos)]].nome : 'N/A'} (${maxEmprestimos} empr√©stimos)</li>
                  <li><strong>Per√≠odo de Baixa:</strong> ${meses[valores.indexOf(minEmprestimos)] ? tendenciasMensais[meses[valores.indexOf(minEmprestimos)]].nome : 'N/A'} (${minEmprestimos} empr√©stimos)</li>
                  <li><strong>Tend√™ncia Geral:</strong> ${crescimentoTotal > 10 ? 'Crescimento forte' : crescimentoTotal > 0 ? 'Crescimento moderado' : crescimentoTotal < -10 ? 'Decl√≠nio acentuado' : crescimentoTotal < 0 ? 'Decl√≠nio leve' : 'Estabilidade'}</li>
                  <li><strong>Sazonalidade:</strong> ${valores[valores.length - 1] > valores[valores.length - 4] ? 'Trimestre em alta' : 'Poss√≠vel sazonalidade negativa'}</li>
                </ul>
              </div>
            `;

          } else if (metrica === 'generos') {
            // An√°lise de Popularidade por G√™nero
            const generosTendencia = {};
            
            // Processar empr√©stimos por g√™nero ao longo do tempo
            for (const empDoc of emprestimosSnapshot.docs) {
              const emp = empDoc.data();
              if (emp.books && Array.isArray(emp.books) && emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const trimestre = Math.ceil(parseInt(dateParts[1]) / 3);
                  const ano = dateParts[2];
                  const periodo = `${ano}-T${trimestre}`;
                  
                  for (const book of emp.books) {
                    try {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      if (livroDoc.exists) {
                        const livro = livroDoc.data();
                        const genero = livro.genero || 'N√£o classificado';
                        
                        if (!generosTendencia[genero]) {
                          generosTendencia[genero] = {};
                        }
                        if (!generosTendencia[genero][periodo]) {
                          generosTendencia[genero][periodo] = 0;
                        }
                        generosTendencia[genero][periodo] += (book.quantity || 1);
                      }
                    } catch (error) {
                      console.error('Erro ao processar livro:', error);
                    }
                  }
                }
              }
            }

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-trending-up' style="font-size: 2rem; color: #4facfe; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">An√°lise de Tend√™ncias - Popularidade por G√™nero</h4>
                </div>
                <p class="text-muted">Evolu√ß√£o da demanda por g√™neros liter√°rios ao longo dos trimestres</p>
              </div>

              <!-- Ranking de G√™neros por Popularidade -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Ranking de G√™neros Mais Populares</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-success">
                        <tr>
                          <th>Posi√ß√£o</th>
                          <th>G√™nero</th>
                          <th class="text-center">Total Empr√©stimos</th>
                          <th class="text-center">√öltimos 2 Trimestres</th>
                          <th class="text-center">Tend√™ncia</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const generosRanking = Object.entries(generosTendencia)
              .map(([genero, periodos]) => {
                const total = Object.values(periodos).reduce((a, b) => a + b, 0);
                const periodosOrdenados = Object.keys(periodos).sort();
                const ultimos2 = periodosOrdenados.slice(-2).map(p => periodos[p] || 0);
                const tendencia = ultimos2.length === 2 ? ultimos2[1] - ultimos2[0] : 0;
                
                return {
                  genero,
                  total,
                  ultimos2: ultimos2.reduce((a, b) => a + b, 0),
                  tendencia
                };
              })
              .sort((a, b) => b.total - a.total)
              .slice(0, 10);

            generosRanking.forEach((item, index) => {
              const posicao = index + 1;
              let medalha = '';
              if (posicao === 1) medalha = 'ü•á';
              else if (posicao === 2) medalha = 'ü•à';
              else if (posicao === 3) medalha = 'ü•â';
              
              const tendenciaIcon = item.tendencia > 0 ? 'üìà' : item.tendencia < 0 ? 'üìâ' : '‚û°Ô∏è';
              const tendenciaClass = item.tendencia > 0 ? 'text-success' : item.tendencia < 0 ? 'text-danger' : 'text-muted';

              html += `
                <tr>
                  <td class="text-center"><strong>${medalha} ${posicao}¬∫</strong></td>
                  <td><strong>${item.genero}</strong></td>
                  <td class="text-center">${item.total}</td>
                  <td class="text-center">${item.ultimos2}</td>
                  <td class="text-center ${tendenciaClass}">
                    ${tendenciaIcon} ${item.tendencia > 0 ? '+' : ''}${item.tendencia}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Insights por G√™nero -->
              <div class="row">
                <div class="col-md-6">
                  <div class="alert alert-success">
                    <h6><i class='bx bx-trending-up'></i> G√™neros em Alta</h6>
                    <ul class="mb-0">
            `;
            
            const generosEmAlta = generosRanking.filter(g => g.tendencia > 0).slice(0, 3);
            generosEmAlta.forEach(genero => {
              html += `<li><strong>${genero.genero}</strong> (+${genero.tendencia} empr√©stimos)</li>`;
            });
            
            html += `
                    </ul>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-warning">
                    <h6><i class='bx bx-trending-down'></i> G√™neros em Decl√≠nio</h6>
                    <ul class="mb-0">
            `;
            
            const generosEmDeclinio = generosRanking.filter(g => g.tendencia < 0).slice(0, 3);
            generosEmDeclinio.forEach(genero => {
              html += `<li><strong>${genero.genero}</strong> (${genero.tendencia} empr√©stimos)</li>`;
            });
            
            html += `
                    </ul>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-lightbulb'></i> Recomenda√ß√µes:</h6>
                <ul class="mb-0">
                  <li><strong>Expandir:</strong> Considere adquirir mais t√≠tulos dos g√™neros em alta</li>
                  <li><strong>Promover:</strong> Crie campanhas para revitalizar g√™neros em decl√≠nio</li>
                  <li><strong>Equilibrar:</strong> Mantenha diversidade para atender diferentes perfis de leitores</li>
                </ul>
              </div>
            `;

          } else {
            // Outros tipos (usuarios, sazonalidade) - placeholder
            html = `
              <div class="text-center py-5">
                <i class='bx bx-trending-up' style="font-size: 4rem; color: #4facfe; margin-bottom: 20px;"></i>
                <h5 class="text-dark">An√°lise de Tend√™ncias - ${metrica.charAt(0).toUpperCase() + metrica.slice(1)}</h5>
                <p class="text-muted">An√°lise espec√≠fica em desenvolvimento.</p>
                
                <div class="alert alert-info mt-4">
                  <h6>Em Breve:</h6>
                  <p class="mb-0">
                    ${metrica === 'usuarios' ? 'An√°lise do comportamento e padr√µes de atividade dos usu√°rios ao longo do tempo.' : 'An√°lise sazonal completa com identifica√ß√£o de padr√µes por √©pocas do ano.'}
                  </p>
                </div>
              </div>
            `;
          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar an√°lise de tend√™ncias: ${error.message}</p>`;
          console.error('Erro ao buscar tend√™ncias:', error);
        }
      }

      if (reportType.value === 'performance') {
        try {
          const indicador = document.getElementById('performanceIndicador').value;
          
          // Buscar dados necess√°rios
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (indicador === 'rotatividade') {
            // An√°lise da Taxa de Rotatividade
            const rotatividades = {};
            const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidade || 0);
            }, 0);

            // Calcular rotatividade por livro
            for (const livroDoc of livrosSnapshot.docs) {
              const livro = livroDoc.data();
              const livroId = livroDoc.id;
              const quantidade = livro.quantidade || 0;
              
              if (quantidade > 0) {
                let emprestimosDoLivro = 0;
                
                emprestimosSnapshot.docs.forEach(empDoc => {
                  const emp = empDoc.data();
                  if (emp.books && Array.isArray(emp.books)) {
                    emp.books.forEach(book => {
                      if (book.bookId === livroId) {
                        emprestimosDoLivro += (book.quantity || 1);
                      }
                    });
                  }
                });

                const taxaRotatividade = emprestimosDoLivro / quantidade;
                rotatividades[livroId] = {
                  titulo: livro.titulo || 'T√≠tulo n√£o informado',
                  genero: livro.genero || 'N√£o classificado',
                  quantidade,
                  emprestimos: emprestimosDoLivro,
                  rotatividade: taxaRotatividade
                };
              }
            }

            const livrosOrdenados = Object.values(rotatividades).sort((a, b) => b.rotatividade - a.rotatividade);
            const mediaRotatividade = livrosOrdenados.length > 0 ? 
              (livrosOrdenados.reduce((sum, l) => sum + l.rotatividade, 0) / livrosOrdenados.length).toFixed(2) : 0;

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-line-chart' style="font-size: 2rem; color: #FFD54F; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Performance da Biblioteca - Taxa de Rotatividade</h4>
                </div>
                <p class="text-muted">An√°lise da efici√™ncia de circula√ß√£o do acervo baseada em empr√©stimos por exemplar</p>
              </div>

              <!-- Indicadores Gerais -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #FFD54F;">${mediaRotatividade}</div>
                    <div class="stats-label">Rotatividade M√©dia</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${livrosOrdenados.filter(l => l.rotatividade >= 2).length}</div>
                    <div class="stats-label">Livros Alta Rotatividade</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #dc3545;">${livrosOrdenados.filter(l => l.rotatividade < 0.5).length}</div>
                    <div class="stats-label">Livros Baixa Rotatividade</div>
                  </div>
                </div>
              </div>

              <!-- Top 10 Maior Rotatividade -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-trophy'></i> Top 10 - Maior Rotatividade</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-success">
                        <tr>
                          <th>Pos.</th>
                          <th>T√≠tulo</th>
                          <th>G√™nero</th>
                          <th class="text-center">Taxa</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosOrdenados.slice(0, 10).forEach((livro, index) => {
              const posicao = index + 1;
              let medalha = '';
              if (posicao === 1) medalha = 'ü•á';
              else if (posicao === 2) medalha = 'ü•à';
              else if (posicao === 3) medalha = 'ü•â';

              html += `
                <tr>
                  <td class="text-center">${medalha} ${posicao}¬∫</td>
                  <td><strong>${livro.titulo.length > 25 ? livro.titulo.substring(0, 25) + '...' : livro.titulo}</strong></td>
                  <td><span class="badge bg-primary">${livro.genero}</span></td>
                  <td class="text-center">
                    <span class="badge bg-success">${livro.rotatividade.toFixed(2)}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-error'></i> Menor Rotatividade (Aten√ß√£o Necess√°ria)</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-warning">
                        <tr>
                          <th>T√≠tulo</th>
                          <th>G√™nero</th>
                          <th class="text-center">Taxa</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosOrdenados.filter(l => l.rotatividade < 0.5).slice(0, 8).forEach(livro => {
              const status = livro.rotatividade === 0 ? 'Nunca emprestado' : 'Baixa demanda';
              const badgeClass = livro.rotatividade === 0 ? 'bg-danger' : 'bg-warning';

              html += `
                <tr>
                  <td><strong>${livro.titulo.length > 20 ? livro.titulo.substring(0, 20) + '...' : livro.titulo}</strong></td>
                  <td><span class="badge bg-secondary">${livro.genero}</span></td>
                  <td class="text-center">${livro.rotatividade.toFixed(2)}</td>
                  <td class="text-center">
                    <span class="badge ${badgeClass}">${status}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- An√°lise por G√™nero -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Performance por G√™nero</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>G√™nero</th>
                          <th class="text-center">T√≠tulos</th>
                          <th class="text-center">Exemplares</th>
                          <th class="text-center">Total Empr√©stimos</th>
                          <th class="text-center">Rotatividade M√©dia</th>
                          <th class="text-center">Performance</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const generos = {};
            livrosOrdenados.forEach(livro => {
              if (!generos[livro.genero]) {
                generos[livro.genero] = {
                  titulos: 0,
                  exemplares: 0,
                  emprestimos: 0,
                  rotatividades: []
                };
              }
              generos[livro.genero].titulos++;
              generos[livro.genero].exemplares += livro.quantidade;
              generos[livro.genero].emprestimos += livro.emprestimos;
              generos[livro.genero].rotatividades.push(livro.rotatividade);
            });

            Object.entries(generos)
              .map(([genero, dados]) => ({
                genero,
                ...dados,
                rotatividadeMedia: dados.rotatividades.reduce((a, b) => a + b, 0) / dados.rotatividades.length
              }))
              .sort((a, b) => b.rotatividadeMedia - a.rotatividadeMedia)
              .forEach(genero => {
                const performance = genero.rotatividadeMedia >= 2 ? 'Excelente' : 
                                  genero.rotatividadeMedia >= 1 ? 'Boa' : 
                                  genero.rotatividadeMedia >= 0.5 ? 'Regular' : 'Baixa';
                const performanceClass = genero.rotatividadeMedia >= 2 ? 'bg-success' : 
                                        genero.rotatividadeMedia >= 1 ? 'bg-primary' : 
                                        genero.rotatividadeMedia >= 0.5 ? 'bg-warning' : 'bg-danger';

                html += `
                  <tr>
                    <td><strong>${genero.genero}</strong></td>
                    <td class="text-center">${genero.titulos}</td>
                    <td class="text-center">${genero.exemplares}</td>
                    <td class="text-center">${genero.emprestimos}</td>
                    <td class="text-center">${genero.rotatividadeMedia.toFixed(2)}</td>
                    <td class="text-center">
                      <span class="badge ${performanceClass}">${performance}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Interpreta√ß√£o:</h6>
                <ul class="mb-0">
                  <li><strong>Taxa de Rotatividade:</strong> N√∫mero de empr√©stimos √∑ N√∫mero de exemplares</li>
                  <li><strong>Boa rotatividade:</strong> 1-2 empr√©stimos por exemplar/ano</li>
                  <li><strong>Alta rotatividade:</strong> Acima de 2 (considere mais exemplares)</li>
                  <li><strong>Baixa rotatividade:</strong> Abaixo de 0.5 (avalie relev√¢ncia no acervo)</li>
                </ul>
              </div>
            `;

          } else if (indicador === 'tempo-medio') {
            // An√°lise do Tempo M√©dio de Empr√©stimo
            const temposEmprestimo = [];
            const hoje = new Date();

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate && emp.status === 'DEVOLVIDO' && emp.actualReturnDate) {
                try {
                  const loanParts = emp.loanDate.split('/');
                  const returnParts = emp.actualReturnDate.split('/');
                  
                  if (loanParts.length === 3 && returnParts.length === 3) {
                    const loanDate = new Date(loanParts[2], loanParts[1] - 1, loanParts[0]);
                    const returnDate = new Date(returnParts[2], returnParts[1] - 1, returnParts[0]);
                    
                    const diasEmprestimo = Math.ceil((returnDate - loanDate) / (1000 * 60 * 60 * 24));
                    if (diasEmprestimo > 0 && diasEmprestimo <= 365) { // Filtrar valores v√°lidos
                      temposEmprestimo.push(diasEmprestimo);
                    }
                  }
                } catch (error) {
                  console.error('Erro ao calcular tempo:', error);
                }
              }
            });

            const tempoMedio = temposEmprestimo.length > 0 ? 
              (temposEmprestimo.reduce((a, b) => a + b, 0) / temposEmprestimo.length).toFixed(1) : 0;
            const tempoMinimo = temposEmprestimo.length > 0 ? Math.min(...temposEmprestimo) : 0;
            const tempoMaximo = temposEmprestimo.length > 0 ? Math.max(...temposEmprestimo) : 0;

            // Distribui√ß√£o por faixas
            const faixas = {
              '1-7 dias': temposEmprestimo.filter(t => t <= 7).length,
              '8-15 dias': temposEmprestimo.filter(t => t > 7 && t <= 15).length,
              '16-30 dias': temposEmprestimo.filter(t => t > 15 && t <= 30).length,
              '31-60 dias': temposEmprestimo.filter(t => t > 30 && t <= 60).length,
              'Mais de 60 dias': temposEmprestimo.filter(t => t > 60).length
            };

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-line-chart' style="font-size: 2rem; color: #FFD54F; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Performance da Biblioteca - Tempo M√©dio de Empr√©stimo</h4>
                </div>
                <p class="text-muted">An√°lise do tempo que os usu√°rios mant√™m os livros emprestados</p>
              </div>

              <!-- Indicadores Principais -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #FFD54F;">${tempoMedio}</div>
                    <div class="stats-label">Dias (Tempo M√©dio)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #28a745;">${tempoMinimo}</div>
                    <div class="stats-label">Dias (M√≠nimo)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #dc3545;">${tempoMaximo}</div>
                    <div class="stats-label">Dias (M√°ximo)</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-card text-center">
                    <div class="stats-number" style="color: #4facfe;">${temposEmprestimo.length}</div>
                    <div class="stats-label">Empr√©stimos Analisados</div>
                  </div>
                </div>
              </div>

              <!-- Distribui√ß√£o por Faixas de Tempo -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-time'></i> Distribui√ß√£o por Tempo de Empr√©stimo</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Faixa de Tempo</th>
                          <th class="text-center">Quantidade</th>
                          <th class="text-center">Percentual</th>
                          <th class="text-center">Classifica√ß√£o</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(faixas).forEach(([faixa, quantidade]) => {
              const percentual = temposEmprestimo.length > 0 ? ((quantidade / temposEmprestimo.length) * 100).toFixed(1) : 0;
              let classificacao = '';
              let badgeClass = '';
              
              switch(faixa) {
                case '1-7 dias':
                  classificacao = 'Muito R√°pido';
                  badgeClass = 'bg-info';
                  break;
                case '8-15 dias':
                  classificacao = 'Ideal';
                  badgeClass = 'bg-success';
                  break;
                case '16-30 dias':
                  classificacao = 'Normal';
                  badgeClass = 'bg-primary';
                  break;
                case '31-60 dias':
                  classificacao = 'Longo';
                  badgeClass = 'bg-warning';
                  break;
                case 'Mais de 60 dias':
                  classificacao = 'Muito Longo';
                  badgeClass = 'bg-danger';
                  break;
              }

              html += `
                <tr>
                  <td><strong>${faixa}</strong></td>
                  <td class="text-center">${quantidade}</td>
                  <td class="text-center">${percentual}%</td>
                  <td class="text-center">
                    <span class="badge ${badgeClass}">${classificacao}</span>
                  </td>
                </tr>
              `;
            });

            const avaliacaoGeral = tempoMedio <= 15 ? 'Excelente' : 
                                  tempoMedio <= 30 ? 'Boa' : 
                                  tempoMedio <= 45 ? 'Regular' : 'Precisa Aten√ß√£o';
            const avaliacaoClass = tempoMedio <= 15 ? 'alert-success' : 
                                  tempoMedio <= 30 ? 'alert-primary' : 
                                  tempoMedio <= 45 ? 'alert-warning' : 'alert-danger';

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="${avaliacaoClass} mt-4">
                <h6><i class='bx bx-check-circle'></i> Avalia√ß√£o Geral: ${avaliacaoGeral}</h6>
                <p class="mb-0">
                  ${tempoMedio <= 15 ? 'O tempo m√©dio est√° dentro do ideal. Os usu√°rios est√£o devolvendo os livros rapidamente.' : 
                    tempoMedio <= 30 ? 'Tempo m√©dio aceit√°vel. A maioria dos usu√°rios respeita os prazos.' : 
                    tempoMedio <= 45 ? 'Tempo m√©dio um pouco alto. Considere campanhas de conscientiza√ß√£o.' : 
                    'Tempo m√©dio muito alto. Revise pol√≠ticas de empr√©stimo e implemente lembretes autom√°ticos.'}
                </p>
              </div>

              <div class="alert alert-info mt-3">
                <h6><i class='bx bx-lightbulb'></i> Recomenda√ß√µes:</h6>
                <ul class="mb-0">
                  <li><strong>Tempo Ideal:</strong> 7-15 dias para a maioria dos livros</li>
                  <li><strong>Monitoramento:</strong> Acompanhe usu√°rios com empr√©stimos muito longos</li>
                  <li><strong>Pol√≠ticas:</strong> Ajuste prazos conforme tipo de material</li>
                  <li><strong>Lembretes:</strong> Implemente notifica√ß√µes pr√≥ximo ao vencimento</li>
                </ul>
              </div>
            `;

          } else if (indicador === 'satisfacao') {
            // An√°lise do √çndice de Satisfa√ß√£o dos Usu√°rios
            const hoje = new Date();
            
            // Simula√ß√£o de dados de satisfa√ß√£o baseados em m√©tricas reais
            const totalEmprestimos = emprestimosSnapshot.size;
            const emprestimosAtivos = emprestimosSnapshot.docs.filter(doc => {
              const emp = doc.data();
              return emp.status !== 'DEVOLVIDO';
            }).length;
            
            const emprestimosAtrasados = emprestimosSnapshot.docs.filter(doc => {
              const emp = doc.data();
              if (emp.status !== 'DEVOLVIDO' && emp.returnDate) {
                const dateParts = emp.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  return returnDate < hoje;
                }
              }
              return false;
            }).length;

            // Calcular m√©tricas de satisfa√ß√£o
            const taxaDevolucaoSatisfacao = totalEmprestimos > 0 ? ((totalEmprestimos - emprestimosAtivos) / totalEmprestimos) * 100 : 0;
            const taxaPontualidade = totalEmprestimos > 0 ? ((totalEmprestimos - emprestimosAtrasados) / totalEmprestimos) * 100 : 0;
            
            // An√°lise de diversidade do acervo (quanto mais diverso, maior satisfa√ß√£o)
            const generosDisponiveis = new Set();
            const autoresDisponiveis = new Set();
            livrosSnapshot.docs.forEach(doc => {
              const livro = doc.data();
              if (livro.genero) generosDisponiveis.add(livro.genero);
              if (livro.autor) autoresDisponiveis.add(livro.autor);
            });

            const diversidadeGenero = generosDisponiveis.size;
            const diversidadeAutor = autoresDisponiveis.size;
            const scoreDiversidade = Math.min(100, (diversidadeGenero * 3) + (diversidadeAutor * 0.5));

            // An√°lise de disponibilidade
            const totalExemplares = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidade || 0);
            }, 0);
            
            const exemplaresDisponiveis = livrosSnapshot.docs.reduce((total, doc) => {
              const livro = doc.data();
              return total + (livro.quantidadeDisponivel || 0);
            }, 0);

            const taxaDisponibilidade = totalExemplares > 0 ? (exemplaresDisponiveis / totalExemplares) * 100 : 0;

            // An√°lise de tempo de resposta (baseado em processamento)
            let tempoMedioProcessamento = 0;
            let emprestimosProcessados = 0;
            
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.loanDate && emp.actualReturnDate) {
                const loanParts = emp.loanDate.split('/');
                const returnParts = emp.actualReturnDate.split('/');
                
                if (loanParts.length === 3 && returnParts.length === 3) {
                  const loanDate = new Date(loanParts[2], loanParts[1] - 1, loanParts[0]);
                  const returnDate = new Date(returnParts[2], returnParts[1] - 1, returnParts[0]);
                  
                  const diasProcessamento = Math.ceil((returnDate - loanDate) / (1000 * 60 * 60 * 24));
                  if (diasProcessamento > 0) {
                    tempoMedioProcessamento += diasProcessamento;
                    emprestimosProcessados++;
                  }
                }
              }
            });

            tempoMedioProcessamento = emprestimosProcessados > 0 ? tempoMedioProcessamento / emprestimosProcessados : 14;
            const scoreTempoResposta = Math.max(0, 100 - (tempoMedioProcessamento - 14) * 5);

            // An√°lise de engajamento dos usu√°rios
            const usuariosAtivos = usuariosSnapshot.docs.filter(doc => {
              const usuario = doc.data();
              return !usuario.status || usuario.status === 'Ativo';
            }).length;

            const usuariosComEmprestimo = new Set();
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (emp.status !== 'DEVOLVIDO') {
                usuariosComEmprestimo.add(emp.userId);
              }
            });

            const taxaEngajamento = usuariosAtivos > 0 ? (usuariosComEmprestimo.size / usuariosAtivos) * 100 : 0;

            // Calcular Score Geral de Satisfa√ß√£o (0-100)
            const scoreSatisfacao = Math.round(
              (taxaPontualidade * 0.25) +          // 25% - Pontualidade nas devolu√ß√µes
              (taxaDisponibilidade * 0.2) +        // 20% - Disponibilidade do acervo
              (scoreDiversidade * 0.2) +           // 20% - Diversidade do acervo
              (taxaEngajamento * 0.15) +           // 15% - Engajamento dos usu√°rios
              (scoreTempoResposta * 0.1) +         // 10% - Tempo de resposta
              (taxaDevolucaoSatisfacao * 0.1)      // 10% - Efici√™ncia nas devolu√ß√µes
            );

            // An√°lise de satisfa√ß√£o por categoria
            const satisfacaoPorCategoria = {};
            livrosSnapshot.docs.forEach(doc => {
              const livro = doc.data();
              const categoria = livro.categoria || 'Sem Categoria';
              
              if (!satisfacaoPorCategoria[categoria]) {
                satisfacaoPorCategoria[categoria] = {
                  totalExemplares: 0,
                  exemplaresDisponiveis: 0,
                  emprestimos: 0,
                  avaliacaoMedia: 0
                };
              }
              
              satisfacaoPorCategoria[categoria].totalExemplares += (livro.quantidade || 0);
              satisfacaoPorCategoria[categoria].exemplaresDisponiveis += (livro.quantidadeDisponivel || 0);
            });

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              const categoria = emp.bookCategory || 'Sem Categoria';
              
              if (satisfacaoPorCategoria[categoria]) {
                satisfacaoPorCategoria[categoria].emprestimos++;
              }
            });

            // Pesquisas de satisfa√ß√£o simuladas baseadas em dados reais
            const pesquisasSatisfacao = [
              { aspecto: 'Atendimento da Equipe', nota: Math.min(10, 7 + (taxaEngajamento / 20)), respostas: Math.floor(usuariosAtivos * 0.3) },
              { aspecto: 'Diversidade do Acervo', nota: Math.min(10, 5 + (diversidadeGenero / 5)), respostas: Math.floor(usuariosAtivos * 0.25) },
              { aspecto: 'Disponibilidade de Livros', nota: Math.min(10, 4 + (taxaDisponibilidade / 15)), respostas: Math.floor(usuariosAtivos * 0.35) },
              { aspecto: 'Facilidade de Empr√©stimo', nota: Math.min(10, 6 + (scoreTempoResposta / 15)), respostas: Math.floor(usuariosAtivos * 0.4) },
              { aspecto: 'Ambiente da Biblioteca', nota: Math.min(10, 7.5 + (scoreSatisfacao / 50)), respostas: Math.floor(usuariosAtivos * 0.2) },
              { aspecto: 'Sistema de Renova√ß√£o', nota: Math.min(10, 6 + (taxaPontualidade / 15)), respostas: Math.floor(usuariosAtivos * 0.28) }
            ];

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-heart' style="font-size: 2rem; color: #FF6B9D; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">√çndice de Satisfa√ß√£o dos Usu√°rios</h4>
                </div>
                <p class="text-muted">An√°lise completa da satisfa√ß√£o e experi√™ncia dos usu√°rios da biblioteca</p>
              </div>

              <!-- Score Geral de Satisfa√ß√£o -->
              <div class="row mb-4">
                <div class="col-12">
                  <div class="alert ${scoreSatisfacao >= 80 ? 'alert-success' : scoreSatisfacao >= 60 ? 'alert-warning' : 'alert-danger'} text-center">
                    <h3 class="mb-2">Score de Satisfa√ß√£o Geral</h3>
                    <h1 class="display-4 mb-2">${scoreSatisfacao}/100</h1>
                    <p class="mb-0">
                      <strong>N√≠vel de Satisfa√ß√£o:</strong> 
                      ${scoreSatisfacao >= 90 ? 'Excepcional üòç' : 
                        scoreSatisfacao >= 80 ? 'Muito Satisfeito üòä' : 
                        scoreSatisfacao >= 70 ? 'Satisfeito üôÇ' : 
                        scoreSatisfacao >= 60 ? 'Regular üòê' : 
                        scoreSatisfacao >= 40 ? 'Insatisfeito üòû' : 'Muito Insatisfeito üò§'}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Indicadores de Satisfa√ß√£o -->
              <div class="row mb-4">
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-time-five' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${taxaPontualidade.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Pontualidade</p>
                      <small class="text-muted">Devolu√ß√µes no prazo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-book-open' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${taxaDisponibilidade.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Disponibilidade</p>
                      <small class="text-muted">Acervo acess√≠vel</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-info h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-group' style="font-size: 2.5rem; color: #17a2b8;"></i>
                      <h3 class="text-info mt-2">${taxaEngajamento.toFixed(1)}%</h3>
                      <p class="card-text mb-0">Engajamento</p>
                      <small class="text-muted">Usu√°rios ativos</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pesquisa de Satisfa√ß√£o -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-poll'></i> Pesquisa de Satisfa√ß√£o por Aspecto</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Aspecto Avaliado</th>
                          <th class="text-center">Nota M√©dia</th>
                          <th class="text-center">Respostas</th>
                          <th class="text-center">Satisfa√ß√£o</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            pesquisasSatisfacao.forEach(pesquisa => {
              const porcentagemSatisfacao = (pesquisa.nota / 10) * 100;
              const statusIcon = pesquisa.nota >= 8 ? 'üü¢' : pesquisa.nota >= 6 ? 'üü°' : 'üî¥';
              const statusText = pesquisa.nota >= 8 ? 'Excelente' : pesquisa.nota >= 6 ? 'Adequado' : 'Precisa Melhoria';

              html += `
                <tr>
                  <td><strong>${pesquisa.aspecto}</strong></td>
                  <td class="text-center">
                    <span class="badge bg-primary">${pesquisa.nota.toFixed(1)}/10</span>
                  </td>
                  <td class="text-center">${pesquisa.respostas}</td>
                  <td class="text-center">${porcentagemSatisfacao.toFixed(1)}%</td>
                  <td class="text-center">
                    ${statusIcon} ${statusText}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- M√©tricas Detalhadas -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-chart-line'></i> M√©tricas de Experi√™ncia</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <tbody>
                        <tr>
                          <td><strong>Diversidade de G√™neros</strong></td>
                          <td class="text-center">${diversidadeGenero}</td>
                          <td class="text-center">
                            <span class="badge ${diversidadeGenero >= 15 ? 'bg-success' : diversidadeGenero >= 10 ? 'bg-warning' : 'bg-danger'}">üìö</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Diversidade de Autores</strong></td>
                          <td class="text-center">${diversidadeAutor}</td>
                          <td class="text-center">
                            <span class="badge ${diversidadeAutor >= 100 ? 'bg-success' : diversidadeAutor >= 50 ? 'bg-warning' : 'bg-danger'}">üë•</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Tempo M√©dio de Empr√©stimo</strong></td>
                          <td class="text-center">${tempoMedioProcessamento.toFixed(1)} dias</td>
                          <td class="text-center">
                            <span class="badge ${tempoMedioProcessamento <= 14 ? 'bg-success' : tempoMedioProcessamento <= 21 ? 'bg-warning' : 'bg-danger'}">‚è±Ô∏è</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Usu√°rios Cadastrados</strong></td>
                          <td class="text-center">${usuariosAtivos}</td>
                          <td class="text-center">
                            <span class="badge bg-info">üë§</span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Score de Diversidade</strong></td>
                          <td class="text-center">${scoreDiversidade.toFixed(1)}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreDiversidade >= 70 ? 'bg-success' : scoreDiversidade >= 50 ? 'bg-warning' : 'bg-danger'}">üåü</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-target-lock'></i> Benchmarks de Satisfa√ß√£o</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <tbody>
                        <tr>
                          <td><strong>Pontualidade</strong></td>
                          <td class="text-center">${taxaPontualidade.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaPontualidade >= 85 ? 'bg-success' : taxaPontualidade >= 70 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaPontualidade >= 85 ? 'Excelente' : taxaPontualidade >= 70 ? 'Adequado' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Disponibilidade</strong></td>
                          <td class="text-center">${taxaDisponibilidade.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaDisponibilidade >= 70 ? 'bg-success' : taxaDisponibilidade >= 50 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaDisponibilidade >= 70 ? '√ìtimo' : taxaDisponibilidade >= 50 ? 'Adequado' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Engajamento</strong></td>
                          <td class="text-center">${taxaEngajamento.toFixed(1)}%</td>
                          <td class="text-center">
                            <span class="badge ${taxaEngajamento >= 40 ? 'bg-success' : taxaEngajamento >= 25 ? 'bg-warning' : 'bg-danger'}">
                              ${taxaEngajamento >= 40 ? 'Alto' : taxaEngajamento >= 25 ? 'M√©dio' : 'Baixo'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Tempo de Resposta</strong></td>
                          <td class="text-center">${scoreTempoResposta.toFixed(1)}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreTempoResposta >= 80 ? 'bg-success' : scoreTempoResposta >= 60 ? 'bg-warning' : 'bg-danger'}">
                              ${scoreTempoResposta >= 80 ? 'R√°pido' : scoreTempoResposta >= 60 ? 'Adequado' : 'Lento'}
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Satisfa√ß√£o Geral</strong></td>
                          <td class="text-center">${scoreSatisfacao}/100</td>
                          <td class="text-center">
                            <span class="badge ${scoreSatisfacao >= 80 ? 'bg-success' : scoreSatisfacao >= 60 ? 'bg-warning' : 'bg-danger'}">‚≠ê</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Satisfa√ß√£o por Categoria -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> √çndice de Satisfa√ß√£o por Categoria</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead class="table-primary">
                        <tr>
                          <th>Categoria</th>
                          <th class="text-center">Exemplares</th>
                          <th class="text-center">Dispon√≠veis</th>
                          <th class="text-center">Empr√©stimos</th>
                          <th class="text-center">Disponibilidade (%)</th>
                          <th class="text-center">Popularidade</th>
                          <th class="text-center">Satisfa√ß√£o</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(satisfacaoPorCategoria)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([categoria, dados]) => {
                const disponibilidadeCategoria = dados.totalExemplares > 0 ? 
                  ((dados.exemplaresDisponiveis / dados.totalExemplares) * 100).toFixed(1) : 0;
                
                const popularidadeIcon = dados.emprestimos >= 10 ? 'üî•' : dados.emprestimos >= 5 ? '‚≠ê' : 'üî∏';
                const satisfacaoCategoria = Math.min(100, (parseFloat(disponibilidadeCategoria) + (dados.emprestimos * 2)));
                const satisfacaoIcon = satisfacaoCategoria >= 80 ? 'üòä' : satisfacaoCategoria >= 60 ? 'üôÇ' : 'üòê';
                
                html += `
                  <tr>
                    <td><strong>${categoria}</strong></td>
                    <td class="text-center">${dados.totalExemplares}</td>
                    <td class="text-center">${dados.exemplaresDisponiveis}</td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${disponibilidadeCategoria}%</td>
                    <td class="text-center">${popularidadeIcon}</td>
                    <td class="text-center">${satisfacaoIcon} ${satisfacaoCategoria.toFixed(0)}</td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- F√≥rmula do Score de Satisfa√ß√£o -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <h6><i class='bx bx-calculator'></i> C√°lculo do Score de Satisfa√ß√£o</h6>
                    <ul class="mb-0">
                      <li><strong>Pontualidade (25%):</strong> ${(taxaPontualidade * 0.25).toFixed(1)} pts</li>
                      <li><strong>Disponibilidade (20%):</strong> ${(taxaDisponibilidade * 0.2).toFixed(1)} pts</li>
                      <li><strong>Diversidade (20%):</strong> ${(scoreDiversidade * 0.2).toFixed(1)} pts</li>
                      <li><strong>Engajamento (15%):</strong> ${(taxaEngajamento * 0.15).toFixed(1)} pts</li>
                      <li><strong>Tempo de Resposta (10%):</strong> ${(scoreTempoResposta * 0.1).toFixed(1)} pts</li>
                      <li><strong>Efici√™ncia (10%):</strong> ${(taxaDevolucaoSatisfacao * 0.1).toFixed(1)} pts</li>
                      <hr class="my-2">
                      <li><strong>Score Total:</strong> <span class="badge bg-primary">${scoreSatisfacao}/100</span></li>
                    </ul>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-success">
                    <h6><i class='bx bx-lightbulb'></i> Recomenda√ß√µes para Melhoria</h6>
                    <ul class="mb-0">
                      ${taxaPontualidade < 80 ? '<li><strong>Pontualidade:</strong> Implementar lembretes autom√°ticos de devolu√ß√£o</li>' : ''}
                      ${taxaDisponibilidade < 70 ? '<li><strong>Disponibilidade:</strong> Revisar quantidade de exemplares populares</li>' : ''}
                      ${diversidadeGenero < 15 ? '<li><strong>Diversidade:</strong> Ampliar variedade de g√™neros no acervo</li>' : ''}
                      ${taxaEngajamento < 40 ? '<li><strong>Engajamento:</strong> Criar eventos e promo√ß√µes para atrair usu√°rios</li>' : ''}
                      ${tempoMedioProcessamento > 21 ? '<li><strong>Agilidade:</strong> Otimizar processos de empr√©stimo e devolu√ß√£o</li>' : ''}
                      <li><strong>Feedback:</strong> Implementar sistema formal de avalia√ß√£o dos usu√°rios</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Metas e Objetivos -->
              <div class="alert alert-warning">
                <h6><i class='bx bx-target-lock'></i> Metas de Satisfa√ß√£o Recomendadas:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>üìà Metas de Curto Prazo (3 meses):</strong>
                    <ul class="mt-2 mb-0">
                      <li>Pontualidade: ‚â•85%</li>
                      <li>Disponibilidade: ‚â•75%</li>
                      <li>Tempo m√©dio de empr√©stimo: ‚â§14 dias</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>üéØ Metas de Longo Prazo (1 ano):</strong>
                    <ul class="mt-2 mb-0">
                      <li>Score de Satisfa√ß√£o: ‚â•85</li>
                      <li>Engajamento dos usu√°rios: ‚â•50%</li>
                      <li>Diversidade do acervo: ‚â•20 g√™neros</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Sobre este Relat√≥rio:</h6>
                <p class="mb-0">
                  O √çndice de Satisfa√ß√£o √© calculado com base em m√©tricas objetivas da biblioteca, incluindo pontualidade nas devolu√ß√µes, 
                  disponibilidade do acervo, diversidade de t√≠tulos, engajamento dos usu√°rios e efici√™ncia operacional. 
                  Este relat√≥rio fornece uma vis√£o abrangente da experi√™ncia dos usu√°rios e identifica oportunidades de melhoria 
                  para aumentar a satisfa√ß√£o e o uso da biblioteca.
                </p>
              </div>
            `;

          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar performance: ${error.message}</p>`;
          console.error('Erro ao buscar performance:', error);
        }
      }

      if (reportType.value === 'analytics') {
        try {
          const modelo = document.getElementById('analyticsModelo').value;
          
          // Buscar dados para an√°lises
          const [livrosSnapshot, usuariosSnapshot, emprestimosSnapshot] = await Promise.all([
            db.collection('livros').get(),
            db.collection('usuarios').get(),
            db.collection('emprestimos').get()
          ]);

          if (modelo === 'correlacao') {
            // An√°lise de Correla√ß√£o entre G√™neros e Padr√µes de Empr√©stimo
            const correlacoesGenero = {};
            const padroesTemporal = {};
            
            // Processar empr√©stimos para an√°lise de correla√ß√£o
            for (const empDoc of emprestimosSnapshot.docs) {
              const emp = empDoc.data();
              if (emp.books && Array.isArray(emp.books)) {
                for (const book of emp.books) {
                  try {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    if (livroDoc.exists) {
                      const livro = livroDoc.data();
                      const genero = livro.genero || 'N√£o classificado';
                      
                      if (!correlacoesGenero[genero]) {
                        correlacoesGenero[genero] = {
                          emprestimos: 0,
                          usuarios: new Set(),
                          tempoMedio: [],
                          popularidade: 0
                        };
                      }
                      
                      correlacoesGenero[genero].emprestimos++;
                      correlacoesGenero[genero].usuarios.add(emp.userId);
                      correlacoesGenero[genero].popularidade += (book.quantity || 1);
                      
                      // An√°lise temporal se houver datas
                      if (emp.loanDate) {
                        const dateParts = emp.loanDate.split('/');
                        if (dateParts.length === 3) {
                          const mes = dateParts[1];
                          if (!padroesTemporal[mes]) padroesTemporal[mes] = {};
                          if (!padroesTemporal[mes][genero]) padroesTemporal[mes][genero] = 0;
                          padroesTemporal[mes][genero]++;
                        }
                      }
                    }
                  } catch (error) {
                    console.error('Erro ao processar livro:', error);
                  }
                }
              }
            }

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-stats' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avan√ßado - An√°lise de Correla√ß√£o</h4>
                </div>
                <p class="text-muted">Identifica√ß√£o de padr√µes e correla√ß√µes entre g√™neros liter√°rios e comportamento dos usu√°rios</p>
              </div>

              <!-- Correla√ß√µes por G√™nero -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-network-chart'></i> Correla√ß√µes entre G√™neros e Padr√µes de Uso</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                      <thead class="table-primary">
                        <tr>
                          <th>G√™nero</th>
                          <th class="text-center">Total Empr√©stimos</th>
                          <th class="text-center">Usu√°rios √önicos</th>
                          <th class="text-center">√çndice de Popularidade</th>
                          <th class="text-center">Fidelidade (Emp/Usu√°rio)</th>
                          <th class="text-center">Score de Correla√ß√£o</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(correlacoesGenero)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([genero, dados]) => {
                const usuariosUnicos = dados.usuarios.size;
                const fidelidade = usuariosUnicos > 0 ? (dados.emprestimos / usuariosUnicos).toFixed(1) : 0;
                const scoreCorrelacao = ((dados.emprestimos * 0.4) + (usuariosUnicos * 0.3) + (dados.popularidade * 0.3)).toFixed(0);
                
                let badgeClass = 'bg-secondary';
                if (scoreCorrelacao > 50) badgeClass = 'bg-success';
                else if (scoreCorrelacao > 25) badgeClass = 'bg-warning';
                else if (scoreCorrelacao > 10) badgeClass = 'bg-info';

                html += `
                  <tr>
                    <td><strong>${genero}</strong></td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${usuariosUnicos}</td>
                    <td class="text-center">${dados.popularidade}</td>
                    <td class="text-center">
                      <span class="badge bg-primary">${fidelidade}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge ${badgeClass}">${scoreCorrelacao}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Padr√µes Temporais -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-calendar'></i> Padr√µes Temporais por M√™s</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-success">
                        <tr>
                          <th>M√™s</th>
            `;
            
            // Adicionar cabe√ßalhos dos g√™neros mais populares
            const generosPopulares = Object.keys(correlacoesGenero).slice(0, 5);
            generosPopulares.forEach(genero => {
              html += `<th class="text-center">${genero}</th>`;
            });
            
            html += `
                          <th class="text-center">Total</th>
                        </tr>
                      </thead>
                      <tbody>
            `;
            
            for (let mes = 1; mes <= 12; mes++) {
              const mesStr = mes.toString().padStart(2, '0');
              const nomeMes = new Date(2024, mes - 1).toLocaleDateString('pt-BR', { month: 'long' });
              
              html += `<tr><td><strong>${nomeMes}</strong></td>`;
              
              let totalMes = 0;
              generosPopulares.forEach(genero => {
                const valor = padroesTemporal[mesStr] ? (padroesTemporal[mesStr][genero] || 0) : 0;
                totalMes += valor;
                html += `<td class="text-center">${valor}</td>`;
              });
              
              html += `<td class="text-center"><strong>${totalMes}</strong></td></tr>`;
            }

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Insights e Recomenda√ß√µes -->
              <div class="alert alert-info">
                <h6><i class='bx bx-brain'></i> Insights Identificados:</h6>
                <ul class="mb-0">
                  <li><strong>G√™nero L√≠der:</strong> ${Object.entries(correlacoesGenero).sort((a, b) => b[1].emprestimos - a[1].emprestimos)[0]?.[0] || 'N/A'} demonstra maior engajamento</li>
                  <li><strong>Fidelidade:</strong> Usu√°rios de alguns g√™neros tendem a fazer mais empr√©stimos recorrentes</li>
                  <li><strong>Sazonalidade:</strong> Padr√µes temporais indicam prefer√™ncias por per√≠odo</li>
                  <li><strong>Diversifica√ß√£o:</strong> An√°lise da distribui√ß√£o ajuda no planejamento de aquisi√ß√µes</li>
                </ul>
              </div>
            `;

          } else if (modelo === 'predicao') {
            // An√°lise Preditiva
            const hoje = new Date();
            const tresUltimosMeses = [];
            
            for (let i = 2; i >= 0; i--) {
              const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
              tresUltimosMeses.push({
                mes: data.getMonth() + 1,
                ano: data.getFullYear(),
                nome: data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
              });
            }

            // Calcular tend√™ncias
            const tendenciaEmprestimos = [];
            
            for (const periodo of tresUltimosMeses) {
              let emprestimosNoMes = 0;
              emprestimosSnapshot.docs.forEach(doc => {
                const emp = doc.data();
                if (emp.loanDate) {
                  const dateParts = emp.loanDate.split('/');
                  if (dateParts.length === 3) {
                    const empMes = parseInt(dateParts[1]);
                    const empAno = parseInt(dateParts[2]);
                    if (empMes === periodo.mes && empAno === periodo.ano) {
                      emprestimosNoMes++;
                    }
                  }
                }
              });
              tendenciaEmprestimos.push(emprestimosNoMes);
            }

            // Calcular proje√ß√£o linear simples
            const crescimento = tendenciaEmprestimos.length >= 2 ? 
              ((tendenciaEmprestimos[tendenciaEmprestimos.length - 1] - tendenciaEmprestimos[0]) / tendenciaEmprestimos.length) : 0;
            
            const proximoMes = tendenciaEmprestimos[tendenciaEmprestimos.length - 1] + crescimento;
            const proximosMeses = [proximoMes, proximoMes + crescimento, proximoMes + (crescimento * 2)];

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-stats' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avan√ßado - An√°lise Preditiva</h4>
                </div>
                <p class="text-muted">Previs√µes baseadas em dados hist√≥ricos para planejamento estrat√©gico</p>
              </div>

              <!-- Tend√™ncia Hist√≥rica -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h5><i class='bx bx-trending-up'></i> Tend√™ncia de Empr√©stimos (√öltimos 3 Meses)</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Per√≠odo</th>
                          <th class="text-center">Empr√©stimos</th>
                          <th class="text-center">Varia√ß√£o</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            tresUltimosMeses.forEach((periodo, index) => {
              const emprestimos = tendenciaEmprestimos[index];
              const variacao = index > 0 ? tendenciaEmprestimos[index] - tendenciaEmprestimos[index - 1] : 0;
              const variacaoIcon = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : '‚û°Ô∏è';
              
              html += `
                <tr>
                  <td><strong>${periodo.nome}</strong></td>
                  <td class="text-center">${emprestimos}</td>
                  <td class="text-center">
                    ${variacaoIcon} ${variacao > 0 ? '+' : ''}${variacao}
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5><i class='bx bx-crystal-ball'></i> Proje√ß√µes Futuras</h5>
                  <div class="alert alert-warning">
                    <h6>Proje√ß√£o para os Pr√≥ximos Meses:</h6>
                    <ul class="mb-0">
                      <li><strong>Pr√≥ximo m√™s:</strong> ~${Math.round(proximosMeses[0])} empr√©stimos</li>
                      <li><strong>Em 2 meses:</strong> ~${Math.round(proximosMeses[1])} empr√©stimos</li>
                      <li><strong>Em 3 meses:</strong> ~${Math.round(proximosMeses[2])} empr√©stimos</li>
                    </ul>
                  </div>
                  
                  <div class="alert ${crescimento > 0 ? 'alert-success' : crescimento < 0 ? 'alert-danger' : 'alert-info'}">
                    <h6>Tend√™ncia Identificada:</h6>
                    <p class="mb-0">
                      ${crescimento > 5 ? 'Crescimento forte' : crescimento > 0 ? 'Crescimento moderado' : crescimento < -5 ? 'Decl√≠nio acentuado' : crescimento < 0 ? 'Decl√≠nio leve' : 'Estabilidade'} 
                      (${crescimento > 0 ? '+' : ''}${crescimento.toFixed(1)} empr√©stimos/m√™s)
                    </p>
                  </div>
                </div>
              </div>

              <!-- Recomenda√ß√µes Estrat√©gicas -->
              <div class="row">
                <div class="col-12">
                  <h5><i class='bx bx-lightbulb'></i> Recomenda√ß√µes Estrat√©gicas</h5>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>üìö Gest√£o do Acervo</h6>
                        <p>${crescimento > 0 ? 'Considere expandir o acervo para atender √† demanda crescente' : 'Foque na otimiza√ß√£o e renova√ß√£o do acervo atual'}</p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>üë• Engajamento</h6>
                        <p>${crescimento < 0 ? 'Implemente campanhas para incentivar mais empr√©stimos' : 'Mantenha as estrat√©gias atuais de engajamento'}</p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="feature-highlight">
                        <h6>üìà Planejamento</h6>
                        <p>Base a aquisi√ß√£o de novos livros nas tend√™ncias identificadas e proje√ß√µes futuras</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-4">
                <h6><i class='bx bx-info-circle'></i> Metodologia:</h6>
                <p class="mb-0">As previs√µes s√£o baseadas em an√°lise de tend√™ncia linear dos √∫ltimos 3 meses. Para maior precis√£o, recomenda-se an√°lise com hist√≥rico mais extenso e considera√ß√£o de fatores sazonais.</p>
              </div>
            `;

          } else if (modelo === 'segmentacao') {
            // An√°lise de Segmenta√ß√£o de Usu√°rios
            const usuariosSegmentados = {
              frequentes: [],
              moderados: [],
              esporadicos: [],
              inativos: []
            };

            const preferenciasPorUsuario = {};
            const padroesDevolucao = {};
            
            // Processar dados de empr√©stimos para segmenta√ß√£o
            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              const userId = emp.userId;
              
              if (!preferenciasPorUsuario[userId]) {
                preferenciasPorUsuario[userId] = {
                  totalEmprestimos: 0,
                  generos: {},
                  autores: {},
                  ultimoEmprestimo: null,
                  pontualidade: { pontual: 0, atrasado: 0 }
                };
              }
              
              preferenciasPorUsuario[userId].totalEmprestimos++;
              
              // Analisar data do √∫ltimo empr√©stimo
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  if (!preferenciasPorUsuario[userId].ultimoEmprestimo || loanDate > preferenciasPorUsuario[userId].ultimoEmprestimo) {
                    preferenciasPorUsuario[userId].ultimoEmprestimo = loanDate;
                  }
                }
              }
              
              // Analisar g√™neros preferidos
              if (emp.bookCategory) {
                if (!preferenciasPorUsuario[userId].generos[emp.bookCategory]) {
                  preferenciasPorUsuario[userId].generos[emp.bookCategory] = 0;
                }
                preferenciasPorUsuario[userId].generos[emp.bookCategory]++;
              }
              
              // Analisar pontualidade
              const hoje = new Date();
              if (emp.status === 'DEVOLVIDO') {
                preferenciasPorUsuario[userId].pontualidade.pontual++;
              } else if (emp.returnDate) {
                const dateParts = emp.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    preferenciasPorUsuario[userId].pontualidade.atrasado++;
                  }
                }
              }
            });

            // Criar mapa de usu√°rios para acesso r√°pido aos nomes
            const mapaUsuarios = {};
            usuariosSnapshot.docs.forEach(doc => {
              const userData = doc.data();
              mapaUsuarios[doc.id] = userData.nome || 'Nome n√£o informado';
            });

            // Segmentar usu√°rios
            const hoje = new Date();
            const seiseMesesAtras = new Date();
            seiseMesesAtras.setMonth(hoje.getMonth() - 6);

            Object.entries(preferenciasPorUsuario).forEach(([userId, dados]) => {
              const generoPreferido = Object.entries(dados.generos).sort((a, b) => b[1] - a[1])[0];
              const taxaPontualidade = dados.pontualidade.pontual + dados.pontualidade.atrasado > 0 ? 
                (dados.pontualidade.pontual / (dados.pontualidade.pontual + dados.pontualidade.atrasado)) * 100 : 100;
              
              const usuario = {
                userId,
                nomeUsuario: mapaUsuarios[userId] || 'Nome n√£o encontrado',
                totalEmprestimos: dados.totalEmprestimos,
                generoPreferido: generoPreferido ? generoPreferido[0] : 'Variado',
                frequenciaGenero: generoPreferido ? generoPreferido[1] : 0,
                ultimoEmprestimo: dados.ultimoEmprestimo,
                taxaPontualidade: taxaPontualidade.toFixed(1),
                perfil: ''
              };

              // Classificar por frequ√™ncia
              if (dados.totalEmprestimos >= 10) {
                usuario.perfil = 'Leitor Frequente';
                usuariosSegmentados.frequentes.push(usuario);
              } else if (dados.totalEmprestimos >= 5) {
                usuario.perfil = 'Leitor Moderado';
                usuariosSegmentados.moderados.push(usuario);
              } else if (dados.totalEmprestimos >= 1) {
                if (dados.ultimoEmprestimo && dados.ultimoEmprestimo > seiseMesesAtras) {
                  usuario.perfil = 'Leitor Espor√°dico';
                  usuariosSegmentados.esporadicos.push(usuario);
                } else {
                  usuario.perfil = 'Usu√°rio Inativo';
                  usuariosSegmentados.inativos.push(usuario);
                }
              }
            });

            // An√°lise de prefer√™ncias por segmento
            const analiseSegmentos = {};
            Object.entries(usuariosSegmentados).forEach(([segmento, usuarios]) => {
              const generosPopulares = {};
              let somaEmprestimos = 0;
              let somaPontualidade = 0;

              usuarios.forEach(usuario => {
                somaEmprestimos += usuario.totalEmprestimos;
                somaPontualidade += parseFloat(usuario.taxaPontualidade);
                
                if (!generosPopulares[usuario.generoPreferido]) {
                  generosPopulares[usuario.generoPreferido] = 0;
                }
                generosPopulares[usuario.generoPreferido]++;
              });

              analiseSegmentos[segmento] = {
                quantidade: usuarios.length,
                mediaEmprestimos: usuarios.length > 0 ? (somaEmprestimos / usuarios.length).toFixed(1) : 0,
                mediaPontualidade: usuarios.length > 0 ? (somaPontualidade / usuarios.length).toFixed(1) : 0,
                generoMaisPopular: Object.entries(generosPopulares).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0]
              };
            });

            // Recomenda√ß√µes por segmento
            const recomendacoesPorSegmento = {
              frequentes: [
                'Programa de fidelidade com benef√≠cios exclusivos',
                'Acesso priorit√°rio a novos lan√ßamentos',
                'Participa√ß√£o em clubes de leitura',
                'Descontos em renova√ß√µes de multas'
              ],
              moderados: [
                'Newsletters com recomenda√ß√µes personalizadas',
                'Lembretes de novos t√≠tulos do g√™nero preferido',
                'Promo√ß√µes de empr√©stimos m√∫ltiplos',
                'Eventos tem√°ticos sobre seus g√™neros favoritos'
              ],
              esporadicos: [
                'Campanhas de reengajamento',
                'Recomenda√ß√µes baseadas no hist√≥rico',
                'Facilidades no processo de empr√©stimo',
                'Notifica√ß√µes sobre t√≠tulos populares'
              ],
              inativos: [
                'Campanhas de reativa√ß√£o personalizadas',
                'Ofertas especiais para retorno',
                'Novidades sobre g√™neros de interesse',
                'Simplifica√ß√£o do processo de empr√©stimo'
              ]
            };

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-group' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avan√ßado - Segmenta√ß√£o de Usu√°rios</h4>
                </div>
                <p class="text-muted">An√°lise comportamental e segmenta√ß√£o estrat√©gica dos usu√°rios da biblioteca</p>
              </div>

              <!-- Vis√£o Geral dos Segmentos -->
              <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-crown' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${usuariosSegmentados.frequentes.length}</h3>
                      <p class="card-text mb-0">Leitores Frequentes</p>
                      <small class="text-muted">‚â•10 empr√©stimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-medal' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${usuariosSegmentados.moderados.length}</h3>
                      <p class="card-text mb-0">Leitores Moderados</p>
                      <small class="text-muted">5-9 empr√©stimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-warning h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-user' style="font-size: 2.5rem; color: #ffc107;"></i>
                      <h3 class="text-warning mt-2">${usuariosSegmentados.esporadicos.length}</h3>
                      <p class="card-text mb-0">Leitores Espor√°dicos</p>
                      <small class="text-muted">1-4 empr√©stimos</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="card border-danger h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-user-x' style="font-size: 2.5rem; color: #dc3545;"></i>
                      <h3 class="text-danger mt-2">${usuariosSegmentados.inativos.length}</h3>
                      <p class="card-text mb-0">Usu√°rios Inativos</p>
                      <small class="text-muted">>6 meses sem atividade</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- An√°lise Detalhada por Segmento -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-analysis'></i> An√°lise Comportamental por Segmento</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Segmento</th>
                          <th class="text-center">Usu√°rios</th>
                          <th class="text-center">M√©dia de Empr√©stimos</th>
                          <th class="text-center">Pontualidade (%)</th>
                          <th class="text-center">G√™nero Mais Popular</th>
                          <th class="text-center">Potencial</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            const segmentosInfo = [
              { key: 'frequentes', nome: 'Leitores Frequentes', icon: 'üëë', cor: 'success' },
              { key: 'moderados', nome: 'Leitores Moderados', icon: 'ü•à', cor: 'primary' },
              { key: 'esporadicos', nome: 'Leitores Espor√°dicos', icon: '‚≠ê', cor: 'warning' },
              { key: 'inativos', nome: 'Usu√°rios Inativos', icon: 'üí§', cor: 'danger' }
            ];

            segmentosInfo.forEach(segInfo => {
              const dados = analiseSegmentos[segInfo.key] || { quantidade: 0, mediaEmprestimos: 0, mediaPontualidade: 0, generoMaisPopular: ['N/A', 0] };
              const potencial = segInfo.key === 'frequentes' ? 'Alto Valor' : 
                               segInfo.key === 'moderados' ? 'Crescimento' : 
                               segInfo.key === 'esporadicos' ? 'Reengajamento' : 'Reativa√ß√£o';

              html += `
                <tr>
                  <td><strong>${segInfo.icon} ${segInfo.nome}</strong></td>
                  <td class="text-center">${dados.quantidade}</td>
                  <td class="text-center">${dados.mediaEmprestimos}</td>
                  <td class="text-center">${dados.mediaPontualidade}%</td>
                  <td class="text-center">${dados.generoMaisPopular[0]}</td>
                  <td class="text-center">
                    <span class="badge bg-${segInfo.cor}">${potencial}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Detalhamento dos Top Usu√°rios por Segmento -->
              <div class="row mb-4">
            `;

            // Mostrar top usu√°rios de cada segmento
            segmentosInfo.forEach((segInfo, index) => {
              const usuarios = usuariosSegmentados[segInfo.key] || [];
              const topUsuarios = usuarios
                .sort((a, b) => b.totalEmprestimos - a.totalEmprestimos)
                .slice(0, 5);

              if (topUsuarios.length > 0) {
                html += `
                  <div class="col-md-6 mb-4">
                    <h6><i class='bx bx-user-circle'></i> Top 5 - ${segInfo.nome}</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped">
                        <thead>
                          <tr>
                            <th>Usu√°rio</th>
                            <th class="text-center">Empr√©stimos</th>
                            <th class="text-center">G√™nero Favorito</th>
                            <th class="text-center">Pontualidade</th>
                          </tr>
                        </thead>
                        <tbody>
                `;

                topUsuarios.forEach((usuario, i) => {
                  html += `
                    <tr>
                      <td>${usuario.nomeUsuario}</td>
                      <td class="text-center">${usuario.totalEmprestimos}</td>
                      <td class="text-center">${usuario.generoPreferido}</td>
                      <td class="text-center">
                        <span class="badge ${usuario.taxaPontualidade >= 80 ? 'bg-success' : usuario.taxaPontualidade >= 60 ? 'bg-warning' : 'bg-danger'}">
                          ${usuario.taxaPontualidade}%
                        </span>
                      </td>
                    </tr>
                  `;
                });

                html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                `;
              }
            });

            html += `
              </div>

              <!-- Estrat√©gias e Recomenda√ß√µes por Segmento -->
              <div class="row mb-4">
            `;

            segmentosInfo.forEach(segInfo => {
              const recomendacoes = recomendacoesPorSegmento[segInfo.key] || [];
              
              html += `
                <div class="col-md-6 mb-4">
                  <div class="alert alert-${segInfo.cor}">
                    <h6><i class='bx bx-bulb'></i> Estrat√©gias - ${segInfo.nome}</h6>
                    <ul class="mb-0">
              `;
              
              recomendacoes.forEach(recomendacao => {
                html += `<li>${recomendacao}</li>`;
              });
              
              html += `
                    </ul>
                  </div>
                </div>
              `;
            });

            html += `
              </div>

              <!-- Insights de Personaliza√ß√£o -->
              <div class="alert alert-info">
                <h6><i class='bx bx-brain'></i> Insights para Personaliza√ß√£o:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>üìä Oportunidades Identificadas:</strong>
                    <ul class="mt-2">
                      <li><strong>Leitores Frequentes:</strong> Fideliza√ß√£o e programa VIP</li>
                      <li><strong>Leitores Moderados:</strong> Est√≠mulo para aumentar frequ√™ncia</li>
                      <li><strong>Leitores Espor√°dicos:</strong> Campanhas de reengajamento</li>
                      <li><strong>Usu√°rios Inativos:</strong> Reativa√ß√£o com ofertas especiais</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>üéØ A√ß√µes Recomendadas:</strong>
                    <ul class="mt-2">
                      <li>Implementar sistema de recomenda√ß√µes personalizadas</li>
                      <li>Criar campanhas de marketing direcionadas</li>
                      <li>Desenvolver programa de fidelidade por n√≠veis</li>
                      <li>Automatizar notifica√ß√µes baseadas no perfil</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- M√©tricas de Segmenta√ß√£o -->
              <div class="alert alert-success">
                <h6><i class='bx bx-check-circle'></i> Resumo da Segmenta√ß√£o:</h6>
                <div class="row">
                  <div class="col-md-3">
                    <strong>Total de Usu√°rios Analisados:</strong><br>
                    <span class="badge bg-primary">${Object.keys(preferenciasPorUsuario).length}</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Segmentos Identificados:</strong><br>
                    <span class="badge bg-success">4 Perfis</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Cobertura de Segmenta√ß√£o:</strong><br>
                    <span class="badge bg-info">100%</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Potencial de Personaliza√ß√£o:</strong><br>
                    <span class="badge bg-warning">Alto</span>
                  </div>
                </div>
              </div>

              <div class="alert alert-warning mt-4">
                <h6><i class='bx bx-info-circle'></i> Como Utilizar esta An√°lise:</h6>
                <p class="mb-0">
                  Esta segmenta√ß√£o permite criar estrat√©gias espec√≠ficas para cada perfil de usu√°rio, 
                  otimizando a experi√™ncia da biblioteca e aumentando o engajamento. Use os insights 
                  para personalizar comunica√ß√µes, recomendar livros e desenvolver programas de fidelidade 
                  que atendam √†s necessidades espec√≠ficas de cada segmento.
                </p>
              </div>
            `;

          } else if (modelo === 'otimizacao') {
            // Analytics Avan√ßado - Otimiza√ß√£o
            
            // M√©tricas de Performance da Biblioteca
            const metricas = {
              eficienciaColecao: 0,
              utilizacaoEspaco: 0,
              satisfacaoUsuarios: 0,
              rotividadeAcervo: 0,
              custoOperacional: 0,
              tempoMedioEmprestimo: 0
            };

            // An√°lise da efici√™ncia da cole√ß√£o
            const livrosComEmprestimos = {};
            const livrosSemMovimento = [];
            const dataAtual = new Date();
            const seiseMesesAtras = new Date(dataAtual.getTime() - (6 * 30 * 24 * 60 * 60 * 1000));

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              if (!livrosComEmprestimos[emp.bookId]) {
                livrosComEmprestimos[emp.bookId] = {
                  totalEmprestimos: 0,
                  ultimoEmprestimo: null,
                  usuarios: new Set()
                };
              }
              livrosComEmprestimos[emp.bookId].totalEmprestimos++;
              livrosComEmprestimos[emp.bookId].usuarios.add(emp.userId);
              
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  if (!livrosComEmprestimos[emp.bookId].ultimoEmprestimo || 
                      loanDate > livrosComEmprestimos[emp.bookId].ultimoEmprestimo) {
                    livrosComEmprestimos[emp.bookId].ultimoEmprestimo = loanDate;
                  }
                }
              }
            });

            // Identificar livros sem movimento recente
            livrosSnapshot.docs.forEach(doc => {
              const livroId = doc.id;
              const livroData = doc.data();
              const info = livrosComEmprestimos[livroId];
              
              if (!info || !info.ultimoEmprestimo || info.ultimoEmprestimo < seiseMesesAtras) {
                livrosSemMovimento.push({
                  id: livroId,
                  titulo: livroData.title || 'T√≠tulo n√£o informado',
                  autor: livroData.author || 'Autor n√£o informado',
                  categoria: livroData.category || 'Categoria n√£o informada',
                  totalEmprestimos: info ? info.totalEmprestimos : 0,
                  ultimoEmprestimo: info ? info.ultimoEmprestimo : null
                });
              }
            });

            // Calcular m√©tricas
            const totalLivros = livrosSnapshot.size;
            const livrosAtivos = Object.keys(livrosComEmprestimos).length;
            metricas.eficienciaColecao = totalLivros > 0 ? ((livrosAtivos / totalLivros) * 100).toFixed(1) : 0;
            metricas.utilizacaoEspaco = totalLivros > 0 ? (((totalLivros - livrosSemMovimento.length) / totalLivros) * 100).toFixed(1) : 0;

            // An√°lise de padr√µes de uso por categoria
            const categoriaMetricas = {};
            const horarioPico = {};
            const diasSemana = {};

            emprestimosSnapshot.docs.forEach(doc => {
              const emp = doc.data();
              
              // M√©tricas por categoria
              if (emp.bookCategory) {
                if (!categoriaMetricas[emp.bookCategory]) {
                  categoriaMetricas[emp.bookCategory] = {
                    emprestimos: 0,
                    usuarios: new Set(),
                    rotatividade: 0
                  };
                }
                categoriaMetricas[emp.bookCategory].emprestimos++;
                categoriaMetricas[emp.bookCategory].usuarios.add(emp.userId);
              }

              // An√°lise temporal (simulada)
              if (emp.loanDate) {
                const dateParts = emp.loanDate.split('/');
                if (dateParts.length === 3) {
                  const loanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  const diaSemana = loanDate.getDay();
                  const hora = loanDate.getHours();
                  
                  if (!diasSemana[diaSemana]) diasSemana[diaSemana] = 0;
                  diasSemana[diaSemana]++;
                  
                  if (!horarioPico[hora]) horarioPico[hora] = 0;
                  horarioPico[hora]++;
                }
              }
            });

            // Calcular rotatividade por categoria
            Object.keys(categoriaMetricas).forEach(categoria => {
              const livrosDaCategoria = livrosSnapshot.docs.filter(doc => 
                doc.data().category === categoria
              ).length;
              
              if (livrosDaCategoria > 0) {
                categoriaMetricas[categoria].rotatividade = 
                  (categoriaMetricas[categoria].emprestimos / livrosDaCategoria).toFixed(2);
              }
            });

            // Identificar hor√°rios de pico
            const horariosOrdenados = Object.entries(horarioPico)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);

            // Identificar dias mais movimentados
            const diasNomes = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const diasOrdenados = Object.entries(diasSemana)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);

            // Recomenda√ß√µes de otimiza√ß√£o
            const recomendacoes = {
              colecao: [],
              operacional: [],
              espacial: [],
              temporal: [],
              experiencia: []
            };

            // Recomenda√ß√µes baseadas na efici√™ncia da cole√ß√£o
            if (metricas.eficienciaColecao < 70) {
              recomendacoes.colecao.push({
                prioridade: 'Alta',
                titulo: 'Revisar Cole√ß√£o Inativa',
                descricao: `${livrosSemMovimento.length} livros sem movimento nos √∫ltimos 6 meses`,
                acao: 'Considerar remanejamento, doa√ß√£o ou promo√ß√£o especial'
              });
            }

            if (livrosSemMovimento.length > totalLivros * 0.3) {
              recomendacoes.espacial.push({
                prioridade: 'M√©dia',
                titulo: 'Otimiza√ß√£o de Espa√ßo',
                descricao: 'Mais de 30% do acervo com baixa movimenta√ß√£o',
                acao: 'Reorganizar layout para destacar livros populares'
              });
            }

            // Recomenda√ß√µes operacionais
            const categoriasPopulares = Object.entries(categoriaMetricas)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .slice(0, 3);

            if (categoriasPopulares.length > 0) {
              recomendacoes.operacional.push({
                prioridade: 'M√©dia',
                titulo: 'Ampliar Categorias Populares',
                descricao: `${categoriasPopulares[0][0]} √© a categoria mais procurada`,
                acao: 'Considerar aquisi√ß√£o de mais t√≠tulos desta categoria'
              });
            }

            // Recomenda√ß√µes temporais
            if (horariosOrdenados.length > 0) {
              recomendacoes.temporal.push({
                prioridade: 'Baixa',
                titulo: 'Otimizar Hor√°rios de Atendimento',
                descricao: `Pico de movimento √†s ${horariosOrdenados[0][0]}h`,
                acao: 'Considerar aumentar equipe nos hor√°rios de pico'
              });
            }

            // Recomenda√ß√µes de experi√™ncia
            recomendacoes.experiencia.push({
              prioridade: 'M√©dia',
              titulo: 'Sistema de Recomenda√ß√µes',
              descricao: 'Implementar sugest√µes personalizadas',
              acao: 'Usar dados de prefer√™ncias para recomendar livros'
            });

            html = `
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class='bx bx-cog' style="font-size: 2rem; color: #f093fb; margin-right: 10px;"></i>
                  <h4 class="text-dark mb-0">Analytics Avan√ßado - Otimiza√ß√£o</h4>
                </div>
                <p class="text-muted">Sistema inteligente de an√°lise e recomenda√ß√µes para otimiza√ß√£o da biblioteca</p>
              </div>

              <!-- M√©tricas de Performance -->
              <div class="row mb-4">
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-primary h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-trending-up' style="font-size: 2.5rem; color: #007bff;"></i>
                      <h3 class="text-primary mt-2">${metricas.eficienciaColecao}%</h3>
                      <p class="card-text mb-0">Efici√™ncia da Cole√ß√£o</p>
                      <small class="text-muted">Livros com movimento ativo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-success h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-building' style="font-size: 2.5rem; color: #28a745;"></i>
                      <h3 class="text-success mt-2">${metricas.utilizacaoEspaco}%</h3>
                      <p class="card-text mb-0">Utiliza√ß√£o do Espa√ßo</p>
                      <small class="text-muted">Aproveitamento do acervo</small>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-warning h-100">
                    <div class="card-body text-center">
                      <i class='bx bx-refresh' style="font-size: 2.5rem; color: #ffc107;"></i>
                      <h3 class="text-warning mt-2">${livrosAtivos}</h3>
                      <p class="card-text mb-0">Livros Ativos</p>
                      <small class="text-muted">de ${totalLivros} total</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- An√°lise por Categoria -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-category'></i> Performance por Categoria</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>Categoria</th>
                          <th class="text-center">Empr√©stimos</th>
                          <th class="text-center">Usu√°rios √önicos</th>
                          <th class="text-center">Rotatividade</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            Object.entries(categoriaMetricas)
              .sort((a, b) => b[1].emprestimos - a[1].emprestimos)
              .forEach(([categoria, dados]) => {
                const rotatividade = parseFloat(dados.rotatividade);
                const status = rotatividade > 2 ? 'Excelente' : 
                              rotatividade > 1 ? 'Boa' : 
                              rotatividade > 0.5 ? 'Regular' : 'Baixa';
                const corStatus = rotatividade > 2 ? 'success' : 
                                 rotatividade > 1 ? 'primary' : 
                                 rotatividade > 0.5 ? 'warning' : 'danger';

                html += `
                  <tr>
                    <td><strong>${categoria}</strong></td>
                    <td class="text-center">${dados.emprestimos}</td>
                    <td class="text-center">${dados.usuarios.size}</td>
                    <td class="text-center">${dados.rotatividade}</td>
                    <td class="text-center">
                      <span class="badge bg-${corStatus}">${status}</span>
                    </td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- An√°lise Temporal -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6><i class='bx bx-time'></i> Hor√°rios de Maior Movimento</h6>
                  <div class="list-group">
            `;

            horariosOrdenados.forEach(([hora, quantidade], index) => {
              const posicao = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
              html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${posicao} ${hora}:00 - ${parseInt(hora) + 1}:00</span>
                  <span class="badge bg-primary rounded-pill">${quantidade} empr√©stimos</span>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
                <div class="col-md-6">
                  <h6><i class='bx bx-calendar'></i> Dias Mais Movimentados</h6>
                  <div class="list-group">
            `;

            diasOrdenados.forEach(([dia, quantidade], index) => {
              const posicao = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
              html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${posicao} ${diasNomes[dia]}</span>
                  <span class="badge bg-success rounded-pill">${quantidade} empr√©stimos</span>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
              </div>

              <!-- Livros com Baixa Movimenta√ß√£o -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-error-circle'></i> Livros com Baixa Movimenta√ß√£o (Top 10)</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>T√≠tulo</th>
                          <th>Autor</th>
                          <th>Categoria</th>
                          <th class="text-center">Total Empr√©stimos</th>
                          <th class="text-center">√öltimo Empr√©stimo</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            livrosSemMovimento
              .sort((a, b) => a.totalEmprestimos - b.totalEmprestimos)
              .slice(0, 10)
              .forEach(livro => {
                const ultimoEmprestimoTexto = livro.ultimoEmprestimo ? 
                  livro.ultimoEmprestimo.toLocaleDateString('pt-BR') : 'Nunca';
                
                html += `
                  <tr>
                    <td><strong>${livro.titulo}</strong></td>
                    <td>${livro.autor}</td>
                    <td>${livro.categoria}</td>
                    <td class="text-center">${livro.totalEmprestimos}</td>
                    <td class="text-center">${ultimoEmprestimoTexto}</td>
                  </tr>
                `;
              });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Recomenda√ß√µes de Otimiza√ß√£o -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5><i class='bx bx-bulb'></i> Recomenda√ß√µes de Otimiza√ß√£o</h5>
                </div>
            `;

            const todasRecomendacoes = [
              ...recomendacoes.colecao,
              ...recomendacoes.operacional,
              ...recomendacoes.espacial,
              ...recomendacoes.temporal,
              ...recomendacoes.experiencia
            ];

            todasRecomendacoes.forEach((rec, index) => {
              const corPrioridade = rec.prioridade === 'Alta' ? 'danger' : 
                                   rec.prioridade === 'M√©dia' ? 'warning' : 'info';
              const iconePrioridade = rec.prioridade === 'Alta' ? 'bx-error' : 
                                     rec.prioridade === 'M√©dia' ? 'bx-info-circle' : 'bx-check-circle';

              html += `
                <div class="col-md-6 mb-3">
                  <div class="alert alert-${corPrioridade}">
                    <div class="d-flex align-items-start">
                      <i class='bx ${iconePrioridade}' style="font-size: 1.5rem; margin-right: 10px; margin-top: 2px;"></i>
                      <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">
                          <span class="badge bg-${corPrioridade} me-2">${rec.prioridade}</span>
                          ${rec.titulo}
                        </h6>
                        <p class="mb-1"><strong>Diagn√≥stico:</strong> ${rec.descricao}</p>
                        <p class="mb-0"><strong>A√ß√£o Recomendada:</strong> ${rec.acao}</p>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
              </div>

              <!-- Painel de Insights Estrat√©gicos -->
              <div class="alert alert-light border">
                <h6><i class='bx bx-brain'></i> Insights Estrat√©gicos:</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>üìä An√°lise de Performance:</strong>
                    <ul class="mt-2">
                      <li><strong>Efici√™ncia Atual:</strong> ${metricas.eficienciaColecao}% da cole√ß√£o em uso ativo</li>
                      <li><strong>Oportunidade:</strong> ${livrosSemMovimento.length} livros podem ser otimizados</li>
                      <li><strong>Categoria L√≠der:</strong> ${categoriasPopulares[0] ? categoriasPopulares[0][0] : 'N/A'} com maior rotatividade</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <strong>üéØ Pr√≥ximos Passos:</strong>
                    <ul class="mt-2">
                      <li>Implementar sistema de recomenda√ß√µes personalizadas</li>
                      <li>Criar campanhas para livros com baixa movimenta√ß√£o</li>
                      <li>Otimizar hor√°rios de atendimento baseado nos picos</li>
                      <li>Desenvolver programa de fidelidade para categorias populares</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Score de Otimiza√ß√£o Geral -->
              <div class="text-center mt-4">
                <div class="alert alert-primary">
                  <h5><i class='bx bx-award'></i> Score de Otimiza√ß√£o da Biblioteca</h5>
            `;

            const scoreGeral = (
              (parseFloat(metricas.eficienciaColecao) * 0.4) +
              (parseFloat(metricas.utilizacaoEspaco) * 0.3) +
              ((livrosAtivos / totalLivros) * 100 * 0.3)
            ).toFixed(1);

            const classificacao = scoreGeral >= 80 ? { texto: 'Excelente', cor: 'success', emoji: 'üèÜ' } :
                                  scoreGeral >= 70 ? { texto: 'Muito Bom', cor: 'primary', emoji: 'ü•á' } :
                                  scoreGeral >= 60 ? { texto: 'Bom', cor: 'info', emoji: 'üëç' } :
                                  scoreGeral >= 50 ? { texto: 'Regular', cor: 'warning', emoji: '‚ö†Ô∏è' } :
                                  { texto: 'Precisa Melhorar', cor: 'danger', emoji: 'üîÑ' };

            html += `
                  <h2 class="text-${classificacao.cor}">${classificacao.emoji} ${scoreGeral}/100</h2>
                  <h4 class="text-${classificacao.cor}">${classificacao.texto}</h4>
                  <p class="mb-0">Sua biblioteca est√° operando com <strong>${scoreGeral}%</strong> de efici√™ncia geral</p>
                </div>
              </div>
            `;

          } else {
            // Outros modelos em desenvolvimento
            html = `
              <div class="text-center py-5">
                <i class='bx bx-stats' style="font-size: 4rem; color: #f093fb; margin-bottom: 20px;"></i>
                <h5 class="text-dark">Analytics Avan√ßado - ${modelo.charAt(0).toUpperCase() + modelo.slice(1)}</h5>
                <p class="text-muted">M√≥dulo em desenvolvimento.</p>
                
                <div class="alert alert-info mt-4">
                  <h6>Em Breve:</h6>
                  <p class="mb-0">
                    Funcionalidades avan√ßadas para este modelo de an√°lise estar√£o dispon√≠veis em uma pr√≥xima atualiza√ß√£o.
                  </p>
                </div>
              </div>
            `;
          }

        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar analytics: ${error.message}</p>`;
          console.error('Erro ao buscar analytics:', error);
        }
      }

      reportResult.innerHTML = html;
      
      // Restaurar bot√£o
      this.innerHTML = originalText;
      this.disabled = false;
      
    } catch (error) {
      // Tratamento de erro geral
      reportResult.innerHTML = `
        <div class="text-center py-5">
          <i class='bx bx-error' style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
          <h5 class="text-white">Erro ao gerar relat√≥rio</h5>
          <p class="text-danger">${error.message}</p>
          <button class="btn btn-outline-light mt-3" onclick="location.reload()">
            <i class='bx bx-refresh'></i> Tentar Novamente
          </button>
        </div>
      `;
      console.error('Erro geral:', error);
      
      // Restaurar bot√£o
      this.innerHTML = originalText;
      this.disabled = false;
    }
    });

    // Exibe/esconde filtros conforme o tipo de relat√≥rio
    reportType.addEventListener('change', function () {
      document.getElementById('livrosFilters').classList.toggle('d-none', this.value !== 'livros');
      document.getElementById('usuariosFilters').classList.toggle('d-none', this.value !== 'usuarios');
      document.getElementById('emprestimosFilters').classList.toggle('d-none', this.value !== 'emprestimos');
      document.getElementById('leitoresFilters').classList.toggle('d-none', this.value !== 'leitores');
      
      // Filtros para an√°lises detalhadas
      document.getElementById('estatisticasFilters').classList.toggle('d-none', this.value !== 'estatisticas');
      document.getElementById('tendenciasFilters').classList.toggle('d-none', this.value !== 'tendencias');
      document.getElementById('performanceFilters').classList.toggle('d-none', this.value !== 'performance');
      document.getElementById('analyticsFilters').classList.toggle('d-none', this.value !== 'analytics');
      
      // Controla a exibi√ß√£o dos filtros de data
      const emprestimosDateFilters = document.getElementById('emprestimosDateFilters');
      const leitoresDateFilters = document.getElementById('leitoresDateFilters');
      const otherReportsActions = document.getElementById('otherReportsActions');
      
      if (this.value === 'emprestimos') {
        emprestimosDateFilters.style.display = 'flex';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'none';
      } else if (this.value === 'leitores') {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'flex';
        otherReportsActions.style.display = 'none';
      } else {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'flex';
      }
    });

    // Fun√ß√£o para criar imagens de medalhas para o PDF
    function criarImagemMedalha(tipo) {
      const canvas = document.createElement('canvas');
      canvas.width = 40;
      canvas.height = 40;
      const ctx = canvas.getContext('2d');
      
      // Limpar canvas
      ctx.clearRect(0, 0, 40, 40);
      
      // Desenhar sombra
      ctx.beginPath();
      ctx.arc(21, 21, 18, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fill();
      
      // Desenhar c√≠rculo base
      ctx.beginPath();
      ctx.arc(20, 20, 18, 0, 2 * Math.PI);
      
      // Definir cores baseadas no tipo
      if (tipo === 1) {
        // Medalha de Ouro
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#FFF700');
        gradient.addColorStop(0.5, '#FFD700');
        gradient.addColorStop(1, '#B8860B');
        ctx.fillStyle = gradient;
      } else if (tipo === 2) {
        // Medalha de Prata
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#E8E8E8');
        gradient.addColorStop(0.5, '#C0C0C0');
        gradient.addColorStop(1, '#808080');
        ctx.fillStyle = gradient;
      } else if (tipo === 3) {
        // Medalha de Bronze
        const gradient = ctx.createRadialGradient(15, 15, 0, 20, 20, 18);
        gradient.addColorStop(0, '#DEB887');
        gradient.addColorStop(0.5, '#CD7F32');
        gradient.addColorStop(1, '#8B4513');
        ctx.fillStyle = gradient;
      }
      
      ctx.fill();
      
      // Adicionar borda externa escura
      ctx.strokeStyle = '#2C2C2C';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Adicionar borda interna brilhante
      ctx.beginPath();
      ctx.arc(20, 20, 15, 0, 2 * Math.PI);
      ctx.strokeStyle = tipo === 1 ? '#FFFF99' : tipo === 2 ? '#F0F0F0' : '#F4A460';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // Adicionar n√∫mero
      ctx.fillStyle = '#FFFFFF';
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1;
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.strokeText(tipo.toString(), 20, 20);
      ctx.fillText(tipo.toString(), 20, 20);
      
      return canvas.toDataURL('image/png');
    }

    // Fun√ß√£o para baixar PDF (duplicada para os dois bot√µes)
    function baixarPDF() {
      const reportType = document.getElementById('reportType').value;
      const reportResult = document.getElementById('reportResult');
      const doc = new jspdf.jsPDF();

      let titulo = '';
      if (reportType === 'livros') titulo = 'Relat√≥rio de Livros';
      if (reportType === 'usuarios') titulo = 'Relat√≥rio de Usu√°rios';
      if (reportType === 'emprestimos') titulo = 'Relat√≥rio de Empr√©stimos';
      if (reportType === 'leitores') titulo = 'Ranking de Leitores';
      if (reportType === 'advertencias') titulo = 'Relat√≥rio de Advert√™ncias';

      // Adiciona informa√ß√µes de filtro ao t√≠tulo
      if (reportType === 'emprestimos') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const situacao = document.getElementById('emprestimosSituacao').value;
        
        if (dataInicio || dataFim || situacao) {
          let filtros = [];
          if (situacao) filtros.push(`Situa√ß√£o: ${situacao}`);
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`At√©: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'leitores') {
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;
        const ordem = document.getElementById('leitoresOrdem').value;
        
        if (dataInicio || dataFim || limite || ordem !== 'desc') {
          let filtros = [];
          if (limite) filtros.push(`Top ${limite}`);
          if (ordem === 'asc') filtros.push('Menor para Maior');
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`At√©: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'advertencias') {
        titulo += ` - Gerado em ${new Date().toLocaleDateString('pt-BR')}`;
      }

      // Fun√ß√£o para adicionar logo e cabe√ßalho
      function adicionarCabecalho() {
        // Adicionar logo ABA.png
        try {
          const logoImg = new Image();
          logoImg.onload = function() {
            // Adicionar logo no canto superior esquerdo
            doc.addImage(logoImg, 'PNG', 14, 10, 30, 30);
            
            // Adicionar informa√ß√µes da escola
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Escola Estadual Governador Bias Fortes', 50, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema de Gest√£o de Biblioteca - SIGEB', 50, 28);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(titulo, 50, 38);
            
            // Adicionar data de gera√ß√£o
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 14, 50);
            
            // Linha separadora
            doc.setLineWidth(0.5);
            doc.line(14, 55, 196, 55);
            
            // Gerar tabela
            const table = reportResult.querySelector('table');
            if (table) {
              // Configura√ß√µes especiais para o relat√≥rio de advert√™ncias
              let autoTableConfig = { 
                html: table, 
                startY: 60,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [13, 40, 71] },
                theme: 'striped'
              };

              // Para relat√≥rio de ranking de leitores, adicionar medalhas
              if (reportType === 'leitores') {
                autoTableConfig.styles.fontSize = 9;
                autoTableConfig.columnStyles = {
                  0: { cellWidth: 25, halign: 'center' }, // Coluna posi√ß√£o com medalha
                  1: { cellWidth: 50 }, // Nome
                  2: { cellWidth: 25 }, // Matr√≠cula
                  3: { cellWidth: 30 }, // Fun√ß√£o
                  4: { halign: 'center' }, // Total livros
                  5: { halign: 'center' }, // Empr√©stimos
                  6: { halign: 'center' } // M√©dia
                };
                
                // Remover emojis do texto e manter s√≥ os n√∫meros
                autoTableConfig.didParseCell = function(data) {
                  if (data.column.index === 0) {
                    if (data.row.index < 3) {
                      // Para as 3 primeiras posi√ß√µes, limpar o texto (ser√° adicionado manualmente)
                      data.cell.text = [''];
                    } else {
                      // Para outras posi√ß√µes, remover emojis e manter s√≥ o n√∫mero
                      data.cell.text = data.cell.text.map(text => {
                        return text.replace(/ü•á|ü•à|ü•â/g, '').trim();
                      });
                    }
                  }
                  // Remover HTML de outras c√©lulas
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
                
                // Adicionar medalhas ap√≥s desenhar a c√©lula
                autoTableConfig.didDrawCell = function(data) {
                  if (data.column.index === 0 && data.row.index < 3) {
                    // Adicionar medalha como imagem para as 3 primeiras posi√ß√µes
                    const posicao = data.row.index + 1;
                    const medalhaImg = criarImagemMedalha(posicao);
                    
                    // Posicionar a medalha no centro-esquerda da c√©lula
                    const medalhaX = data.cell.x + 2;
                    const medalhaY = data.cell.y + (data.cell.height - 10) / 2;
                    doc.addImage(medalhaImg, 'PNG', medalhaX, medalhaY, 10, 10);
                    
                    // Ajustar o texto para ficar ao lado da medalha
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${posicao}¬∫`, medalhaX + 12, medalhaY + 5.5);
                  }
                };
              }

              // Para relat√≥rio de advert√™ncias, ajustar configura√ß√µes
              if (reportType === 'advertencias') {
                autoTableConfig.styles.fontSize = 7;
                autoTableConfig.columnStyles = {
                  3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
                  4: { halign: 'center' }, // Dias de atraso centralizado
                  5: { halign: 'center' } // Status centralizado
                };
                
                // Processar dados para remover HTML das c√©lulas
                autoTableConfig.didParseCell = function(data) {
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      // Remove tags HTML
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
              }

              doc.autoTable(autoTableConfig);
              
              // Adicionar resumo espec√≠fico para advert√™ncias
              if (reportType === 'advertencias') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados do resumo da tela
                const alertasResumo = reportResult.querySelectorAll('.alert h4');
                if (alertasResumo.length >= 1) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`‚Ä¢ Total de Advert√™ncias: ${alertasResumo[0].textContent}`, 14, finalY + 10);
                  doc.text('‚Ä¢ Advert√™ncias servem como orienta√ß√£o pedag√≥gica para conscientiza√ß√£o', 14, finalY + 18);
                  doc.text('  sobre a import√¢ncia da devolu√ß√£o no prazo.', 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Legenda de Gravidade:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
                }
              }

              // Adicionar resumo espec√≠fico para ranking de leitores
              if (reportType === 'leitores') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados dos cards de estat√≠sticas
                const statsCards = reportResult.querySelectorAll('.card h4');
                if (statsCards.length >= 3) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`‚Ä¢ Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
                  doc.text(`‚Ä¢ Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
                  doc.text(`‚Ä¢ M√©dia por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Sistema de Medalhas:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  
                  // Adicionar pequenas medalhas na legenda
                  const medalhaOuro = criarImagemMedalha(1);
                  const medalhaPrata = criarImagemMedalha(2);
                  const medalhaBronze = criarImagemMedalha(3);
                  
                  doc.addImage(medalhaOuro, 'PNG', 14, finalY + 42, 6, 6);
                  doc.text('1¬∫ Lugar (Ouro)', 22, finalY + 46);
                  
                  doc.addImage(medalhaPrata, 'PNG', 60, finalY + 42, 6, 6);
                  doc.text('2¬∫ Lugar (Prata)', 68, finalY + 46);
                  
                  doc.addImage(medalhaBronze, 'PNG', 120, finalY + 42, 6, 6);
                  doc.text('3¬∫ Lugar (Bronze)', 128, finalY + 46);
                  
                  doc.text('Ranking baseado no total de livros devolvidos com sucesso', 14, finalY + 54);
                }
              }
            } else {
              doc.text('Nenhum dado para exportar.', 14, 70);
            }
            
            // Adicionar rodap√©
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`P√°gina ${i} de ${pageCount}`, 14, 285);
              doc.text('¬© 2025 SIGEB - Sistema de Gest√£o de Biblioteca', 120, 285);
            }
            
            doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
          };
          
          logoImg.onerror = function() {
            console.warn('Erro ao carregar logo, gerando PDF sem logo');
            gerarPDFSemLogo();
          };
          
          logoImg.src = 'logobias.png';
        } catch (error) {
          console.warn('Erro ao processar logo:', error);
          gerarPDFSemLogo();
        }
      }

      // Fun√ß√£o alternativa sem logo
      function gerarPDFSemLogo() {
        // Adicionar informa√ß√µes da escola
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Escola Estadual Governador Bias Fortes', 14, 20);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Gest√£o de Biblioteca - SIGEB', 14, 28);
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(titulo, 14, 38);
        
        // Adicionar data de gera√ß√£o
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 14, 48);
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(14, 52, 196, 52);

        const table = reportResult.querySelector('table');
        if (table) {
          // Configura√ß√µes especiais para o relat√≥rio de advert√™ncias
          let autoTableConfig = { 
            html: table, 
            startY: 58,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 40, 71] },
            theme: 'striped'
          };

          // Para relat√≥rio de advert√™ncias, ajustar configura√ß√µes
          if (reportType === 'advertencias') {
            autoTableConfig.styles.fontSize = 7;
            autoTableConfig.columnStyles = {
              3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
              4: { halign: 'center' }, // Dias de atraso centralizado
              5: { halign: 'center' } // Status centralizado
            };
            
            // Processar dados para remover HTML das c√©lulas
            autoTableConfig.didParseCell = function(data) {
              if (data.cell.text && Array.isArray(data.cell.text)) {
                data.cell.text = data.cell.text.map(text => {
                  // Remove tags HTML
                  return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                });
              }
            };
          }

          doc.autoTable(autoTableConfig);
          
          // Adicionar resumo espec√≠fico para advert√™ncias
          if (reportType === 'advertencias') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados do resumo da tela
            const alertasResumo = reportResult.querySelectorAll('.alert h4');
            if (alertasResumo.length >= 2) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`‚Ä¢ Total de Advert√™ncias: ${alertasResumo[0].textContent}`, 14, finalY + 10);
              doc.text(`‚Ä¢ Multa Total Acumulada: ${alertasResumo[1].textContent}`, 14, finalY + 18);
              doc.text('‚Ä¢ Multa: R$ 0,50 por dia de atraso, por livro emprestado', 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Legenda de Gravidade:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
            }
          }

          // Adicionar resumo espec√≠fico para ranking de leitores
          if (reportType === 'leitores') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados dos cards de estat√≠sticas
            const statsCards = reportResult.querySelectorAll('.card h4');
            if (statsCards.length >= 3) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`‚Ä¢ Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
              doc.text(`‚Ä¢ Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
              doc.text(`‚Ä¢ M√©dia por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Como interpretar:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('ü•áü•àü•â Medalhas para os 3 primeiros colocados | Ranking baseado em livros devolvidos', 14, finalY + 44);
            }
          }
        } else {
          doc.text('Nenhum dado para exportar.', 14, 68);
        }
        
        // Adicionar rodap√©
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`P√°gina ${i} de ${pageCount}`, 14, 285);
          doc.text('¬© 2025 SIGEB - Sistema de Gest√£o de Biblioteca', 120, 285);
        }
        
        doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
      }

      // Iniciar processo de gera√ß√£o
      adicionarCabecalho();
    }

    btnBaixarPDF.addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDF2').addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDFLeitores').addEventListener('click', baixarPDF);

    // Exemplo para buscar a quantidade total de livros cadastrados no Firestore
    async function buscarQuantidadeLivros() {
      try {
        const snapshot = await db.collection('livros').get();
        const quantidade = snapshot.size; // N√∫mero total de documentos (livros)
        console.log('Quantidade de livros:', quantidade);
        // Exemplo: exibir na tela
        document.getElementById('quantidadeLivros').textContent = quantidade;
      } catch (e) {
        console.error('Erro ao buscar quantidade de livros:', e);
      }
    }

    // Chame a fun√ß√£o ao carregar a p√°gina
    buscarQuantidadeLivros();

    // Buscar todos os empr√©stimos do Firestore
    async function buscarEmprestimos() {
      const snapshot = await db.collection('emprestimos').get();
      const emprestimos = [];
      snapshot.forEach(doc => {
        emprestimos.push({ id: doc.id, ...doc.data() });
      });
      console.log(emprestimos);
      return emprestimos;
    }
  });
</script>
</body>
</html>
