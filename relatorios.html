<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGEB - Relat√≥rios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; }
    .main-content { margin-left: 250px; padding: 20px; }
    .sidebar {
      position: fixed; top: 0; left: 0; height: 100%; width: 250px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white; padding: 20px; z-index: 1000;
    }
    .sidebar-header { padding: 20px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);}
    .sidebar-header h3 { background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin: 0; font-weight: 600;}
    .menu-items { padding: 20px 0; }
    .menu-item { padding: 12px 20px; color: white; text-decoration: none; display: flex; align-items: center; border-radius: 8px; margin-bottom: 5px; }
    .menu-item.active, .menu-item:hover { background: rgba(255,255,255,0.1); color: #4facfe; }
    .menu-item i { margin-right: 10px; font-size: 1.2rem; }
    .report-filters { background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 24px; }
    .report-section { background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 24px; }
    .btn-gradient { background: linear-gradient(90deg, #00f2fe, #4facfe); color: white; border: none; }
    @media (max-width: 768px) {
      .sidebar { position: static; width: 100%; }
      .main-content { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>SIGEB</h3>
    </div>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item"><i class='bx bxs-dashboard'></i>Dashboard</a>
      <a href="livros.html" class="menu-item"><i class='bx bxs-book'></i>Livros</a>
      <a href="usuarios.html" class="menu-item"><i class='bx bxs-user'></i>Usu√°rios</a>
      <a href="emprestimos.html" class="menu-item"><i class='bx bxs-bookmark'></i>Empr√©stimos</a>
      <a href="relatorios.html" class="menu-item active" style="position:sticky;top:0;z-index:1100;"><i class='bx bxs-report'></i>Relat√≥rios</a>
      <a href="configuracoes.html" class="menu-item"><i class='bx bxs-cog'></i>Configura√ß√µes</a>
      <a href="index.html" class="menu-item"><i class='bx bxs-log-out'></i>Sair</a>
    </div>
  </div>
  <div class="main-content">
    <h2 class="mb-4">Relat√≥rios</h2>
    <div class="report-filters mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label" for="reportType">Tipo de Relat√≥rio</label>
          <select class="form-select" id="reportType" name="reportType">
            <option value="livros">Livros</option>
            <option value="usuarios">Usu√°rios</option>
            <option value="emprestimos">Empr√©stimos</option>
            <option value="leitores">Ranking de Leitores</option>
            <option value="advertencias">Advert√™ncias</option>
          </select>
        </div>
        <div class="col-md-3" id="livrosFilters">
          <label class="form-label" for="livrosGenero">G√™nero</label>
          <select class="form-select" id="livrosGenero" name="livrosGenero">
            <option value="">Todos</option>
            <option value="AVENTURA">Aventura</option>
            <option value="AUTOAJUDA">Autoajuda</option>
            <option value="BIOGRAFIA">Biografia</option>
            <option value="CIENCIAS">Ci√™ncias</option>
            <option value="DRAMA">Drama</option>
            <option value="EDUCACAO">Educa√ß√£o</option>
            <option value="FANTASIA">Fantasia</option>
            <option value="FICCAO_CIENTIFICA">Fic√ß√£o Cient√≠fica</option>
            <option value="HISTORIA">Hist√≥ria</option>
            <option value="INFANTIL">Infantil</option>
            <option value="MISTERIO">Mist√©rio</option>
            <option value="OUTROS">Outros</option>
            <option value="POESIA">Poesia</option>
            <option value="ROMANCE">Romance</option>
            <option value="TECNOLOGIA">Tecnologia</option>
            <option value="TERROR">Terror</option>
          </select>
        </div>
        <div class="col-md-3 d-none" id="usuariosFilters">
          <label class="form-label" for="usuariosStatus">Status</label>
          <select class="form-select" id="usuariosStatus" name="usuariosStatus">
            <option value="">Todos</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        <div class="col-md-3 d-none" id="emprestimosFilters">
          <label class="form-label" for="emprestimosSituacao">Situa√ß√£o</label>
          <select class="form-select" id="emprestimosSituacao" name="emprestimosSituacao">
            <option value="">Todos</option>
            <option value="Ativo">Ativo</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Atrasado">Atrasado</option>
          </select>
        </div>
        <div class="col-md-3 d-none" id="leitoresFilters">
          <label class="form-label" for="leitoresOrdem">Ordena√ß√£o</label>
          <select class="form-select" id="leitoresOrdem" name="leitoresOrdem">
            <option value="desc">Maior para Menor</option>
            <option value="asc">Menor para Maior</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-gradient w-100" id="btnGerarRelatorio"><i class='bx bx-printer'></i> Gerar Relat√≥rio</button>
        </div>
      </div>
      <!-- Segunda linha para filtros de data dos empr√©stimos -->
      <div class="row g-3 align-items-end mt-2" id="emprestimosDateFilters" style="display: none;">
        <div class="col-md-3" id="emprestimosDataInicioFilter">
          <label class="form-label" for="dataInicio">Data In√≠cio</label>
          <input type="date" class="form-control" id="dataInicio" name="dataInicio">
          <small class="text-muted">Empr√©stimos a partir desta data</small>
        </div>
        <div class="col-md-3" id="emprestimosDataFimFilter">
          <label class="form-label" for="dataFim">Data Fim</label>
          <input type="date" class="form-control" id="dataFim" name="dataFim">
          <small class="text-muted">Empr√©stimos at√© esta data</small>
        </div>
        <div class="col-md-3">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF"><i class='bx bx-download'></i> Baixar PDF</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('dataInicio').value=''; document.getElementById('dataFim').value='';">
            <i class='bx bx-refresh'></i> Limpar Datas
          </button>
        </div>
      </div>
      <!-- Filtros de data para ranking de leitores -->
      <div class="row g-3 align-items-end mt-2" id="leitoresDateFilters" style="display: none;">
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataInicio">Data In√≠cio</label>
          <input type="date" class="form-control" id="leitoresDataInicio" name="leitoresDataInicio">
          <small class="text-muted">Devolu√ß√µes a partir desta data</small>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="leitoresDataFim">Data Fim</label>
          <input type="date" class="form-control" id="leitoresDataFim" name="leitoresDataFim">
          <small class="text-muted">Devolu√ß√µes at√© esta data</small>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="leitoresLimite">Limite de Resultados</label>
          <select class="form-select" id="leitoresLimite" name="leitoresLimite">
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('leitoresDataInicio').value=''; document.getElementById('leitoresDataFim').value=''; document.getElementById('leitoresLimite').value='10';">
            <i class='bx bx-refresh'></i> Limpar Filtros
          </button>
        </div>
      </div>
      <!-- Bot√£o PDF para outros relat√≥rios -->
      <div class="row g-3 align-items-end mt-2" id="otherReportsActions">
        <div class="col-md-3">
          <button class="btn btn-secondary w-100" id="btnBaixarPDF2"><i class='bx bx-download'></i> Baixar PDF</button>
        </div>
      </div>
    </div>
    <div class="report-section" id="reportResult">
      <p>Selecione o tipo de relat√≥rio e filtros desejados para visualizar e imprimir.</p>
    </div>
    <span id="quantidadeLivros" style="display:none;"></span>
    </tbody>
    </table> 
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC558ddNk5dGkB-GgTxbnNVfcciiCwEQP8",
    authDomain: "biblitech-35d1c.firebaseapp.com",
    projectId: "biblitech-35d1c",
    storageBucket: "biblitech-35d1c.firebasestorage.app",
    messagingSenderId: "972405171947",
    appId: "1:972405171947:web:acbc479d1410dff21480ae",
    measurementId: "G-4WQTEHF4DS"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  let nomeEscola = 'Escola Exemplo';

  async function buscarEscolaUsuario() {
    if (auth.currentUser) {
      const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
      if (userDoc.exists && userDoc.data().escolaId) {
        const escolaDoc = await db.collection('escolas').doc(userDoc.data().escolaId).get();
        if (escolaDoc.exists && escolaDoc.data().nome) {
          nomeEscola = escolaDoc.data().nome;
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
    const reportType = document.getElementById('reportType');
    const reportResult = document.getElementById('reportResult');
    const btnBaixarPDF = document.getElementById('btnBaixarPDF');

    // Inicializa os filtros vis√≠veis com base no tipo de relat√≥rio padr√£o (Livros)
    reportType.dispatchEvent(new Event('change'));

    btnGerarRelatorio.addEventListener('click', async function () {
      reportResult.innerHTML = '<p>Carregando dados...</p>';
      let html = '';

      if (reportType.value === 'livros') {
        const genero = document.getElementById('livrosGenero').value;
        let query = db.collection('livros');
        if (genero) {
          query = query.where('genero', '==', genero);
        }

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum livro encontrado com os filtros selecionados.</p>';
          } else {
            // Ordena os livros por t√≠tulo (alfab√©tico)
            const livrosOrdenados = snapshot.docs
              .map(doc => doc.data())
              .sort((a, b) => (a.titulo || '').localeCompare(b.titulo || '', 'pt-BR', { sensitivity: 'base' }));

            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>T√≠tulo</th><th>Autor</th><th>G√™nero</th><th>Qtd Total</th><th>Dispon√≠vel</th><th>Emprestados</th></tr>
                </thead>
                <tbody>
            `;
            livrosOrdenados.forEach(l => {
              const quantidade = l.quantidade || 0;
              const disponivel = l.quantidadeDisponivel || 0;
              const emprestados = l.emprestados || 0;
              const autores = Array.isArray(l.autores) ? l.autores.join(', ') : (l.autores || l.autor || 'Autor n√£o informado');

              html += `
                <tr>
                  <td>${l.titulo || 'Sem t√≠tulo'}</td>
                  <td>${autores}</td>
                  <td>${l.genero || 'N√£o informado'}</td>
                  <td>${quantidade}</td>
                  <td>${disponivel}</td>
                  <td>${emprestados}</td>
                </tr>
              `;
            });
            html += '</tbody></table>';
            
            // Adiciona estat√≠sticas resumidas
            html += `
              <div class="mt-3">
                <h5>Resumo:</h5>
                <p><strong>Total de livros cadastrados:</strong> ${snapshot.size}</p>
              </div>
            `;
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar livros: ${error.message}</p>`;
          console.error('Erro ao buscar livros:', error);
        }
      }

      if (reportType.value === 'usuarios') {
        const status = document.getElementById('usuariosStatus').value;
        let query = db.collection('usuarios');
        if (status) {
          query = query.where('status', '==', status);
        }

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum usu√°rio encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Nome</th><th>Email</th><th>Matr√≠cula</th><th>Fun√ß√£o</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            snapshot.forEach(doc => {
              const u = doc.data();
              html += `
                <tr>
                  <td>${u.nome || 'Nome n√£o informado'}</td>
                  <td>${u.email || 'Email n√£o informado'}</td>
                  <td>${u.matricula || 'N√£o informado'}</td>
                  <td>${u.funcao || u.papel || 'N√£o informado'}</td>
                  <td><span class="badge ${(u.status === 'Ativo' || !u.status) ? 'bg-success' : 'bg-secondary'}">${u.status || 'Ativo'}</span></td>
                </tr>
              `;
            });
            html += '</tbody></table>';
            
            // Adiciona estat√≠sticas resumidas
            html += `
              <div class="mt-3">
                <h5>Resumo:</h5>
                <p><strong>Total de usu√°rios:</strong> ${snapshot.size}</p>
              </div>
            `;
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar usu√°rios: ${error.message}</p>`;
          console.error('Erro ao buscar usu√°rios:', error);
        }
      }

      if (reportType.value === 'emprestimos') {
        const situacaoFiltro = document.getElementById('emprestimosSituacao').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        let query = db.collection('emprestimos');

        try {
          const snapshot = await query.get();
          if (snapshot.empty) {
            html = '<p>Nenhum empr√©stimo encontrado com os filtros selecionados.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr><th>Usu√°rio</th><th>Livro(s)</th><th>Data Empr√©stimo</th><th>Data Devolu√ß√£o</th><th>Status</th></tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // Converter datas do filtro para objetos Date para compara√ß√£o
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }
            
            let emprestimosExibidos = 0;
            
            for (const doc of snapshot.docs) {
              const e = doc.data();
              
              // Filtro por data
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                // Converter data do empr√©stimo para Date
                let dataEmprestimoObj = null;
                if (e.loanDate) {
                  const dateParts = e.loanDate.split('/');
                  if (dateParts.length === 3) {
                    dataEmprestimoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataEmprestimoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataEmprestimoObj) {
                  if (dataInicioObj && dataEmprestimoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataEmprestimoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se n√£o conseguir converter a data, n√£o exibe se h√° filtro de data
                  if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;
              
              // Buscar nome do usu√°rio
              let nomeUsuario = 'Usu√°rio n√£o encontrado';
              try {
                if (e.userId) {
                  const userDoc = await db.collection('usuarios').doc(e.userId).get();
                  if (userDoc.exists) {
                    nomeUsuario = userDoc.data().nome || 'Nome n√£o informado';
                  }
                }
              } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
              }

              // Buscar nomes dos livros
              let nomesLivros = 'Livros n√£o encontrados';
              try {
                if (Array.isArray(e.books)) {
                  const livrosPromises = e.books.map(async (book) => {
                    const livroDoc = await db.collection('livros').doc(book.bookId).get();
                    const livroData = livroDoc.exists ? livroDoc.data() : null;
                    const titulo = livroData ? livroData.titulo : book.bookId;
                    return `${titulo} (Qtd: ${book.quantity})`;
                  });
                  const livrosArray = await Promise.all(livrosPromises);
                  nomesLivros = livrosArray.join(', ');
                }
              } catch (error) {
                console.error('Erro ao buscar livros:', error);
              }

              // Determinar status real
              let statusAtual = e.status || 'EMPRESTADO';
              
              // Verificar se est√° atrasado baseado na data
              if (e.returnDate && (statusAtual === 'EMPRESTADO' || statusAtual === 'ATRASADO')) {
                const dateParts = e.returnDate.split('/');
                if (dateParts.length === 3) {
                  const returnDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  returnDate.setHours(0, 0, 0, 0);
                  if (returnDate < hoje) {
                    statusAtual = 'ATRASADO';
                  }
                }
              }

              // Mapear status para filtro
              let statusFiltro = '';
              if (statusAtual === 'EMPRESTADO') statusFiltro = 'Ativo';
              else if (statusAtual === 'ATRASADO') statusFiltro = 'Atrasado';
              else if (statusAtual === 'DEVOLVIDO') statusFiltro = 'Finalizado';

              // Aplicar filtro de situa√ß√£o
              if (situacaoFiltro && situacaoFiltro !== statusFiltro) {
                continue; // Pula este empr√©stimo
              }

              emprestimosExibidos++;

              html += `
                <tr>
                  <td>${nomeUsuario}</td>
                  <td>${nomesLivros}</td>
                  <td>${e.loanDate || 'Data n√£o informada'}</td>
                  <td>${e.returnDate || 'Data n√£o informada'}</td>
                  <td><span class="badge ${statusAtual === 'DEVOLVIDO' ? 'bg-success' : statusAtual === 'ATRASADO' ? 'bg-danger' : 'bg-primary'}">${statusAtual}</span></td>
                </tr>
              `;
            }
            
            if (emprestimosExibidos === 0) {
              html = '<p>Nenhum empr√©stimo encontrado com os filtros selecionados.</p>';
            } else {
              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas
              html += `
                <div class="mt-3">
                  <h5>Resumo:</h5>
                  <p><strong>Total de empr√©stimos encontrados:</strong> ${emprestimosExibidos}</p>
                  <p><strong>Total de empr√©stimos no sistema:</strong> ${snapshot.size}</p>
                  ${dataInicio || dataFim ? `<p><strong>Per√≠odo:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'In√≠cio'} at√© ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar empr√©stimos: ${error.message}</p>`;
          console.error('Erro ao buscar empr√©stimos:', error);
        }
      }

      if (reportType.value === 'advertencias') {
        try {
          const snapshotEmprestimos = await db.collection('emprestimos').get();
          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum empr√©stimo encontrado para verificar advert√™ncias.</p>';
          } else {
            html = `
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Data Empr√©stimo</th>
                    <th>Data Prevista Devolu√ß√£o</th>
                    <th>Usu√°rio</th>
                    <th>Livro(s)</th>
                    <th>Dias de Atraso</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            const hoje = new Date();
            hoje.setHours(23, 59, 59, 999); // Fim do dia atual
            
            let totalAdvertencias = 0;
            
            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Verificar apenas empr√©stimos ativos ou j√° marcados como atrasados
              if (emprestimo.status === 'DEVOLVIDO') {
                continue;
              }
              
              // Calcular dias de atraso
              let diasAtraso = 0;
              let dataVencimento = null;
              let statusEmprestimo = emprestimo.status || 'EMPRESTADO';
              
              if (emprestimo.returnDate) {
                const dateParts = emprestimo.returnDate.split('/');
                if (dateParts.length === 3) {
                  dataVencimento = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                  dataVencimento.setHours(23, 59, 59, 999);
                  
                  if (hoje > dataVencimento) {
                    const diffTime = hoje.getTime() - dataVencimento.getTime();
                    diasAtraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    statusEmprestimo = 'ATRASADO';
                  }
                }
              }
              
              // S√≥ exibe se houver atraso (advert√™ncia)
              if (diasAtraso > 0) {
                totalAdvertencias++;
                
                // Buscar nome do usu√°rio
                let nomeUsuario = 'Usu√°rio n√£o encontrado';
                let matriculaUsuario = '';
                try {
                  if (emprestimo.userId) {
                    const userDoc = await db.collection('usuarios').doc(emprestimo.userId).get();
                    if (userDoc.exists) {
                      const userData = userDoc.data();
                      nomeUsuario = userData.nome || 'Nome n√£o informado';
                      matriculaUsuario = userData.matricula ? ` (Mat: ${userData.matricula})` : '';
                    }
                  }
                } catch (error) {
                  console.error('Erro ao buscar usu√°rio:', error);
                }

                // Buscar nomes dos livros
                let nomesLivros = 'Livros n√£o encontrados';
                try {
                  if (Array.isArray(emprestimo.books)) {
                    const livrosPromises = emprestimo.books.map(async (book) => {
                      const livroDoc = await db.collection('livros').doc(book.bookId).get();
                      const livroData = livroDoc.exists ? livroDoc.data() : null;
                      const titulo = livroData ? livroData.titulo : book.bookId;
                      return `${titulo} (Qtd: ${book.quantity})`;
                    });
                    const livrosArray = await Promise.all(livrosPromises);
                    nomesLivros = livrosArray.join('<br>');
                  }
                } catch (error) {
                  console.error('Erro ao buscar livros:', error);
                }

                // Calcular quantidade de livros para informa√ß√£o
                const quantidadeLivros = Array.isArray(emprestimo.books) 
                  ? emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0)
                  : 1;

                // Definir cor do badge baseado nos dias de atraso
                let badgeClass = 'bg-warning';
                if (diasAtraso > 15) badgeClass = 'bg-danger';
                else if (diasAtraso > 7) badgeClass = 'bg-warning';
                else badgeClass = 'bg-info';

                html += `
                  <tr class="${diasAtraso > 15 ? 'table-danger' : diasAtraso > 7 ? 'table-warning' : ''}">
                    <td>${emprestimo.loanDate || 'Data n√£o informada'}</td>
                    <td>${emprestimo.returnDate || 'Data n√£o informada'}</td>
                    <td>
                      <strong>${nomeUsuario}</strong>${matriculaUsuario}
                    </td>
                    <td style="max-width: 200px;">${nomesLivros}</td>
                    <td>
                      <span class="badge ${badgeClass} fs-6">
                        ${diasAtraso} dia${diasAtraso > 1 ? 's' : ''}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-danger">ATRASADO</span>
                    </td>
                  </tr>
                `;
              }
            }
            
            if (totalAdvertencias === 0) {
              html = `
                <div class="alert alert-success">
                  <h5><i class='bx bx-check-circle'></i> Parab√©ns!</h5>
                  <p class="mb-0">N√£o h√° empr√©stimos em atraso no momento. Todos os usu√°rios est√£o em dia com suas devolu√ß√µes.</p>
                </div>
              `;
            } else {
              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas com alertas coloridos
              html += `
                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="alert alert-danger">
                      <h6><i class='bx bx-error-circle'></i> Total de Advert√™ncias</h6>
                      <h4 class="mb-0">${totalAdvertencias}</h4>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="alert alert-info">
                      <h6><i class='bx bx-calendar'></i> Data da Consulta</h6>
                      <h6 class="mb-0">${hoje.toLocaleDateString('pt-BR')}</h6>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <h5>Legenda de Gravidade:</h5>
                  <div class="d-flex flex-wrap gap-3">
                    <span><span class="badge bg-info">1-7 dias</span> Atraso Leve</span>
                    <span><span class="badge bg-warning">8-15 dias</span> Atraso Moderado</span>
                    <span><span class="badge bg-danger">16+ dias</span> Atraso Grave</span>
                  </div>
                  <small class="text-muted mt-2 d-block">
                    <strong>Nota:</strong> As advert√™ncias servem como orienta√ß√£o pedag√≥gica para conscientiza√ß√£o sobre a import√¢ncia da devolu√ß√£o no prazo.
                  </small>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar advert√™ncias: ${error.message}</p>`;
          console.error('Erro ao buscar advert√™ncias:', error);
        }
      }

      if (reportType.value === 'leitores') {
        const ordem = document.getElementById('leitoresOrdem').value;
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;

        try {
          const snapshotEmprestimos = await db.collection('emprestimos')
            .where('status', '==', 'DEVOLVIDO')
            .get();

          if (snapshotEmprestimos.empty) {
            html = '<p>Nenhum livro foi devolvido ainda para gerar o ranking de leitores.</p>';
          } else {
            // Converter datas do filtro para objetos Date para compara√ß√£o
            let dataInicioObj = null;
            let dataFimObj = null;
            
            if (dataInicio) {
              dataInicioObj = new Date(dataInicio);
              dataInicioObj.setHours(0, 0, 0, 0);
            }
            
            if (dataFim) {
              dataFimObj = new Date(dataFim);
              dataFimObj.setHours(23, 59, 59, 999);
            }

            // Mapa para contar livros por usu√°rio
            const leitoresPorUsuario = new Map();

            for (const doc of snapshotEmprestimos.docs) {
              const emprestimo = doc.data();
              
              // Filtro por data de devolu√ß√£o real
              let passaFiltroPorData = true;
              if (dataInicioObj || dataFimObj) {
                let dataDevolucaoObj = null;
                if (emprestimo.actualReturnDate) {
                  const dateParts = emprestimo.actualReturnDate.split('/');
                  if (dateParts.length === 3) {
                    dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    dataDevolucaoObj.setHours(0, 0, 0, 0);
                  }
                }
                
                if (dataDevolucaoObj) {
                  if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                    passaFiltroPorData = false;
                  }
                  if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                    passaFiltroPorData = false;
                  }
                } else {
                  // Se n√£o h√° data de devolu√ß√£o real, usar data de empr√©stimo como fallback
                  if (emprestimo.loanDate) {
                    const dateParts = emprestimo.loanDate.split('/');
                    if (dateParts.length === 3) {
                      dataDevolucaoObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                      dataDevolucaoObj.setHours(0, 0, 0, 0);
                      
                      if (dataInicioObj && dataDevolucaoObj < dataInicioObj) {
                        passaFiltroPorData = false;
                      }
                      if (dataFimObj && dataDevolucaoObj > dataFimObj) {
                        passaFiltroPorData = false;
                      }
                    } else if (dataInicioObj || dataFimObj) {
                      passaFiltroPorData = false;
                    }
                  } else if (dataInicioObj || dataFimObj) {
                    passaFiltroPorData = false;
                  }
                }
              }
              
              if (!passaFiltroPorData) continue;

              // Contar livros por usu√°rio
              if (Array.isArray(emprestimo.books)) {
                const totalLivros = emprestimo.books.reduce((total, book) => total + (book.quantity || 1), 0);
                
                if (leitoresPorUsuario.has(emprestimo.userId)) {
                  leitoresPorUsuario.get(emprestimo.userId).totalLivros += totalLivros;
                  leitoresPorUsuario.get(emprestimo.userId).emprestimos += 1;
                } else {
                  leitoresPorUsuario.set(emprestimo.userId, {
                    userId: emprestimo.userId,
                    totalLivros: totalLivros,
                    emprestimos: 1,
                    nomeUsuario: 'Carregando...',
                    matriculaUsuario: '',
                    funcaoUsuario: ''
                  });
                }
              }
            }

            // Buscar dados dos usu√°rios
            for (const [userId, userData] of leitoresPorUsuario) {
              try {
                const userDoc = await db.collection('usuarios').doc(userId).get();
                if (userDoc.exists) {
                  const user = userDoc.data();
                  userData.nomeUsuario = user.nome || 'Nome n√£o informado';
                  userData.matriculaUsuario = user.matricula || '';
                  userData.funcaoUsuario = user.funcao || user.papel || '';
                }
              } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
                userData.nomeUsuario = 'Erro ao carregar';
              }
            }

            // Converter para array e ordenar
            let leitoresArray = Array.from(leitoresPorUsuario.values());
            
            // Ordenar por total de livros
            if (ordem === 'desc') {
              leitoresArray.sort((a, b) => b.totalLivros - a.totalLivros);
            } else {
              leitoresArray.sort((a, b) => a.totalLivros - b.totalLivros);
            }

            // Aplicar limite se especificado
            if (limite && parseInt(limite) > 0) {
              leitoresArray = leitoresArray.slice(0, parseInt(limite));
            }

            if (leitoresArray.length === 0) {
              html = '<p>Nenhum leitor encontrado com os filtros selecionados.</p>';
            } else {
              html = `
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card text-center border-success">
                      <div class="card-body">
                        <h4 class="text-success mb-1">${leitoresArray.length}</h4>
                        <small class="text-muted">Leitores Ativos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-primary">
                      <div class="card-body">
                        <h4 class="text-primary mb-1">${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</h4>
                        <small class="text-muted">Total de Livros Lidos</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card text-center border-warning">
                      <div class="card-body">
                        <h4 class="text-warning mb-1">${Math.round(leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0) / leitoresArray.length)}</h4>
                        <small class="text-muted">M√©dia por Leitor</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <table class="table table-bordered table-sm">
                  <thead class="table-primary">
                    <tr>
                      <th>Posi√ß√£o</th>
                      <th>Nome</th>
                      <th>Matr√≠cula</th>
                      <th>Fun√ß√£o</th>
                      <th>Livros Lidos</th>
                      <th>Empr√©stimos</th>
                      <th>M√©dia por Empr√©stimo</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              leitoresArray.forEach((leitor, index) => {
                const posicao = index + 1;
                const mediaPorEmprestimo = (leitor.totalLivros / leitor.emprestimos).toFixed(1);
                
                // Definir classe CSS baseada na posi√ß√£o
                let rowClass = '';
                if (posicao === 1) rowClass = 'table-warning'; // Ouro
                else if (posicao === 2) rowClass = 'table-secondary'; // Prata
                else if (posicao === 3) rowClass = 'table-info'; // Bronze

                // √çcone de medalha para os 3 primeiros
                let medalha = '';
                if (posicao === 1) medalha = 'ü•á';
                else if (posicao === 2) medalha = 'ü•à';
                else if (posicao === 3) medalha = 'ü•â';

                html += `
                  <tr class="${rowClass}">
                    <td class="text-center">
                      <strong>${medalha} ${posicao}¬∫</strong>
                    </td>
                    <td><strong>${leitor.nomeUsuario}</strong></td>
                    <td>${leitor.matriculaUsuario || 'N/A'}</td>
                    <td>${leitor.funcaoUsuario || 'N/A'}</td>
                    <td class="text-center">
                      <span class="badge bg-success fs-6">${leitor.totalLivros}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary">${leitor.emprestimos}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">${mediaPorEmprestimo}</span>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              
              // Adiciona estat√≠sticas resumidas
              html += `
                <div class="mt-4">
                  <h5>Resumo do Ranking:</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Total de leitores encontrados:</strong> ${leitoresArray.length}</p>
                      <p><strong>Livros lidos no per√≠odo:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.totalLivros, 0)}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Empr√©stimos conclu√≠dos:</strong> ${leitoresArray.reduce((total, leitor) => total + leitor.emprestimos, 0)}</p>
                      ${dataInicio || dataFim ? `<p><strong>Per√≠odo:</strong> ${dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : 'In√≠cio'} at√© ${dataFim ? new Date(dataFim).toLocaleDateString('pt-BR') : 'Fim'}</p>` : ''}
                    </div>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <h6><i class='bx bx-info-circle'></i> Como interpretar este ranking:</h6>
                    <ul class="mb-0">
                      <li><strong>Livros Lidos:</strong> Total de livros devolvidos pelo usu√°rio</li>
                      <li><strong>Empr√©stimos:</strong> N√∫mero de vezes que o usu√°rio fez empr√©stimos</li>
                      <li><strong>M√©dia por Empr√©stimo:</strong> Quantos livros em m√©dia o usu√°rio l√™ por empr√©stimo</li>
                      <li><strong>ü•áü•àü•â:</strong> Medalhas para os 3 primeiros colocados</li>
                    </ul>
                  </div>
                </div>
              `;
            }
          }
        } catch (error) {
          html = `<p class="text-danger">Erro ao carregar ranking de leitores: ${error.message}</p>`;
          console.error('Erro ao buscar ranking de leitores:', error);
        }
      }

      reportResult.innerHTML = html;
    });

    // Exibe/esconde filtros conforme o tipo de relat√≥rio
    reportType.addEventListener('change', function () {
      document.getElementById('livrosFilters').classList.toggle('d-none', this.value !== 'livros');
      document.getElementById('usuariosFilters').classList.toggle('d-none', this.value !== 'usuarios');
      document.getElementById('emprestimosFilters').classList.toggle('d-none', this.value !== 'emprestimos');
      document.getElementById('leitoresFilters').classList.toggle('d-none', this.value !== 'leitores');
      
      // Controla a exibi√ß√£o dos filtros de data
      const emprestimosDateFilters = document.getElementById('emprestimosDateFilters');
      const leitoresDateFilters = document.getElementById('leitoresDateFilters');
      const otherReportsActions = document.getElementById('otherReportsActions');
      
      if (this.value === 'emprestimos') {
        emprestimosDateFilters.style.display = 'flex';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'none';
      } else if (this.value === 'leitores') {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'flex';
        otherReportsActions.style.display = 'none';
      } else {
        emprestimosDateFilters.style.display = 'none';
        leitoresDateFilters.style.display = 'none';
        otherReportsActions.style.display = 'flex';
      }
    });

    // Fun√ß√£o para baixar PDF (duplicada para os dois bot√µes)
    function baixarPDF() {
      const reportType = document.getElementById('reportType').value;
      const reportResult = document.getElementById('reportResult');
      const doc = new jspdf.jsPDF();

      let titulo = '';
      if (reportType === 'livros') titulo = 'Relat√≥rio de Livros';
      if (reportType === 'usuarios') titulo = 'Relat√≥rio de Usu√°rios';
      if (reportType === 'emprestimos') titulo = 'Relat√≥rio de Empr√©stimos';
      if (reportType === 'leitores') titulo = 'Ranking de Leitores';
      if (reportType === 'advertencias') titulo = 'Relat√≥rio de Advert√™ncias';

      // Adiciona informa√ß√µes de filtro ao t√≠tulo
      if (reportType === 'emprestimos') {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const situacao = document.getElementById('emprestimosSituacao').value;
        
        if (dataInicio || dataFim || situacao) {
          let filtros = [];
          if (situacao) filtros.push(`Situa√ß√£o: ${situacao}`);
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`At√©: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'leitores') {
        const dataInicio = document.getElementById('leitoresDataInicio').value;
        const dataFim = document.getElementById('leitoresDataFim').value;
        const limite = document.getElementById('leitoresLimite').value;
        const ordem = document.getElementById('leitoresOrdem').value;
        
        if (dataInicio || dataFim || limite || ordem !== 'desc') {
          let filtros = [];
          if (limite) filtros.push(`Top ${limite}`);
          if (ordem === 'asc') filtros.push('Menor para Maior');
          if (dataInicio) filtros.push(`De: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`);
          if (dataFim) filtros.push(`At√©: ${new Date(dataFim).toLocaleDateString('pt-BR')}`);
          titulo += ` (${filtros.join(', ')})`;
        }
      }

      if (reportType === 'advertencias') {
        titulo += ` - Gerado em ${new Date().toLocaleDateString('pt-BR')}`;
      }

      // Fun√ß√£o para adicionar logo e cabe√ßalho
      function adicionarCabecalho() {
        // Adicionar logo ABA.png
        try {
          const logoImg = new Image();
          logoImg.onload = function() {
            // Adicionar logo no canto superior esquerdo
            doc.addImage(logoImg, 'PNG', 14, 10, 30, 30);
            
            // Adicionar informa√ß√µes da escola
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Escola Estadual Governador Bias Fortes', 50, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema de Gest√£o de Biblioteca - SIGEB', 50, 28);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(titulo, 50, 38);
            
            // Adicionar data de gera√ß√£o
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 14, 50);
            
            // Linha separadora
            doc.setLineWidth(0.5);
            doc.line(14, 55, 196, 55);
            
            // Gerar tabela
            const table = reportResult.querySelector('table');
            if (table) {
              // Configura√ß√µes especiais para o relat√≥rio de advert√™ncias
              let autoTableConfig = { 
                html: table, 
                startY: 60,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [13, 40, 71] },
                theme: 'striped'
              };

              // Para relat√≥rio de advert√™ncias, ajustar configura√ß√µes
              if (reportType === 'advertencias') {
                autoTableConfig.styles.fontSize = 7;
                autoTableConfig.columnStyles = {
                  3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
                  4: { halign: 'center' }, // Dias de atraso centralizado
                  5: { halign: 'center' } // Status centralizado
                };
                
                // Processar dados para remover HTML das c√©lulas
                autoTableConfig.didParseCell = function(data) {
                  if (data.cell.text && Array.isArray(data.cell.text)) {
                    data.cell.text = data.cell.text.map(text => {
                      // Remove tags HTML
                      return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    });
                  }
                };
              }

              doc.autoTable(autoTableConfig);
              
              // Adicionar resumo espec√≠fico para advert√™ncias
              if (reportType === 'advertencias') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados do resumo da tela
                const alertasResumo = reportResult.querySelectorAll('.alert h4');
                if (alertasResumo.length >= 1) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`‚Ä¢ Total de Advert√™ncias: ${alertasResumo[0].textContent}`, 14, finalY + 10);
                  doc.text('‚Ä¢ Advert√™ncias servem como orienta√ß√£o pedag√≥gica para conscientiza√ß√£o', 14, finalY + 18);
                  doc.text('  sobre a import√¢ncia da devolu√ß√£o no prazo.', 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Legenda de Gravidade:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
                }
              }

              // Adicionar resumo espec√≠fico para ranking de leitores
              if (reportType === 'leitores') {
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Buscar dados dos cards de estat√≠sticas
                const statsCards = reportResult.querySelectorAll('.card h4');
                if (statsCards.length >= 3) {
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'bold');
                  doc.text('RESUMO EXECUTIVO', 14, finalY);
                  
                  doc.setFontSize(10);
                  doc.setFont('helvetica', 'normal');
                  doc.text(`‚Ä¢ Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
                  doc.text(`‚Ä¢ Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
                  doc.text(`‚Ä¢ M√©dia por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
                  
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.text('Como interpretar:', 14, finalY + 36);
                  doc.setFont('helvetica', 'normal');
                  doc.text('ü•áü•àü•â Medalhas para os 3 primeiros colocados | Ranking baseado em livros devolvidos', 14, finalY + 44);
                }
              }
            } else {
              doc.text('Nenhum dado para exportar.', 14, 70);
            }
            
            // Adicionar rodap√©
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`P√°gina ${i} de ${pageCount}`, 14, 285);
              doc.text('¬© 2025 SIGEB - Sistema de Gest√£o de Biblioteca', 120, 285);
            }
            
            doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
          };
          
          logoImg.onerror = function() {
            console.warn('Erro ao carregar logo, gerando PDF sem logo');
            gerarPDFSemLogo();
          };
          
          logoImg.src = 'logobias.png';
        } catch (error) {
          console.warn('Erro ao processar logo:', error);
          gerarPDFSemLogo();
        }
      }

      // Fun√ß√£o alternativa sem logo
      function gerarPDFSemLogo() {
        // Adicionar informa√ß√µes da escola
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Escola Estadual Governador Bias Fortes', 14, 20);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Gest√£o de Biblioteca - SIGEB', 14, 28);
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(titulo, 14, 38);
        
        // Adicionar data de gera√ß√£o
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 14, 48);
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(14, 52, 196, 52);

        const table = reportResult.querySelector('table');
        if (table) {
          // Configura√ß√µes especiais para o relat√≥rio de advert√™ncias
          let autoTableConfig = { 
            html: table, 
            startY: 58,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 40, 71] },
            theme: 'striped'
          };

          // Para relat√≥rio de advert√™ncias, ajustar configura√ß√µes
          if (reportType === 'advertencias') {
            autoTableConfig.styles.fontSize = 7;
            autoTableConfig.columnStyles = {
              3: { cellWidth: 50 }, // Coluna Livro(s) mais larga
              4: { halign: 'center' }, // Dias de atraso centralizado
              5: { halign: 'center' } // Status centralizado
            };
            
            // Processar dados para remover HTML das c√©lulas
            autoTableConfig.didParseCell = function(data) {
              if (data.cell.text && Array.isArray(data.cell.text)) {
                data.cell.text = data.cell.text.map(text => {
                  // Remove tags HTML
                  return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                });
              }
            };
          }

          doc.autoTable(autoTableConfig);
          
          // Adicionar resumo espec√≠fico para advert√™ncias
          if (reportType === 'advertencias') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados do resumo da tela
            const alertasResumo = reportResult.querySelectorAll('.alert h4');
            if (alertasResumo.length >= 2) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`‚Ä¢ Total de Advert√™ncias: ${alertasResumo[0].textContent}`, 14, finalY + 10);
              doc.text(`‚Ä¢ Multa Total Acumulada: ${alertasResumo[1].textContent}`, 14, finalY + 18);
              doc.text('‚Ä¢ Multa: R$ 0,50 por dia de atraso, por livro emprestado', 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Legenda de Gravidade:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('1-7 dias: Atraso Leve  |  8-15 dias: Atraso Moderado  |  16+ dias: Atraso Grave', 14, finalY + 44);
            }
          }

          // Adicionar resumo espec√≠fico para ranking de leitores
          if (reportType === 'leitores') {
            const finalY = doc.lastAutoTable.finalY + 10;
            
            // Buscar dados dos cards de estat√≠sticas
            const statsCards = reportResult.querySelectorAll('.card h4');
            if (statsCards.length >= 3) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('RESUMO EXECUTIVO', 14, finalY);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text(`‚Ä¢ Leitores Ativos: ${statsCards[0].textContent}`, 14, finalY + 10);
              doc.text(`‚Ä¢ Total de Livros Lidos: ${statsCards[1].textContent}`, 14, finalY + 18);
              doc.text(`‚Ä¢ M√©dia por Leitor: ${statsCards[2].textContent} livros`, 14, finalY + 26);
              
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text('Como interpretar:', 14, finalY + 36);
              doc.setFont('helvetica', 'normal');
              doc.text('ü•áü•àü•â Medalhas para os 3 primeiros colocados | Ranking baseado em livros devolvidos', 14, finalY + 44);
            }
          }
        } else {
          doc.text('Nenhum dado para exportar.', 14, 68);
        }
        
        // Adicionar rodap√©
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`P√°gina ${i} de ${pageCount}`, 14, 285);
          doc.text('¬© 2025 SIGEB - Sistema de Gest√£o de Biblioteca', 120, 285);
        }
        
        doc.save(`${titulo.replace(/\s/g, '_').toLowerCase()}.pdf`);
      }

      // Iniciar processo de gera√ß√£o
      adicionarCabecalho();
    }

    btnBaixarPDF.addEventListener('click', baixarPDF);
    document.getElementById('btnBaixarPDF2').addEventListener('click', baixarPDF);

    // Exemplo para buscar a quantidade total de livros cadastrados no Firestore
    async function buscarQuantidadeLivros() {
      try {
        const snapshot = await db.collection('livros').get();
        const quantidade = snapshot.size; // N√∫mero total de documentos (livros)
        console.log('Quantidade de livros:', quantidade);
        // Exemplo: exibir na tela
        document.getElementById('quantidadeLivros').textContent = quantidade;
      } catch (e) {
        console.error('Erro ao buscar quantidade de livros:', e);
      }
    }

    // Chame a fun√ß√£o ao carregar a p√°gina
    buscarQuantidadeLivros();

    // Buscar todos os empr√©stimos do Firestore
    async function buscarEmprestimos() {
      const snapshot = await db.collection('emprestimos').get();
      const emprestimos = [];
      snapshot.forEach(doc => {
        emprestimos.push({ id: doc.id, ...doc.data() });
      });
      console.log(emprestimos);
      return emprestimos;
    }
  });
</script>
</body>
</html>
